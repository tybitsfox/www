<HTML><HEAD><TITLE>文件上传处理</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.7"><LINK REL="HOME" TITLE="PHP 手册" HREF="index-2.html"><LINK REL="UP" TITLE="特点" HREF="features.html"><LINK REL="PREVIOUS" TITLE="Cookies" HREF="features.cookies.html"><LINK REL="NEXT" TITLE="关于错误信息的解释" HREF="features.file-upload.errors.html"><META HTTP-EQUIV="Content-type" CONTENT="text/html; charset=gb2312"><LINK REL="stylesheet" HREF="style.css"></HEAD><BODY TOPMARGIN="0" LEFTMARGIN="0" CLASS="chapter" BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#0000FF" VLINK="#840084" ALINK="#0000FF"><TABLE BORDER="0" WIDTH="100%" HEIGHT="100%" CELLSPACING="0" CELLPADDING="0"><TR><TD COLSPAN="3"><DIV CLASS="NAVHEADER"><TABLE BGCOLOR="#CCCCFF" BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="100%"><TR><TD><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="3" CELLSPACING="0"><TR><TH COLSPAN="3" ALIGN="center">PHP 手册</TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="bottom"><A HREF="features.cookies.html" ACCESSKEY="P">后退</A></TD><TD WIDTH="80%" ALIGN="center" VALIGN="bottom"></TD><TD WIDTH="10%" ALIGN="right" VALIGN="bottom"><A HREF="features.file-upload.errors.html" ACCESSKEY="N">前进</A></TD></TR></TABLE></TD></TR><TR BGCOLOR="#333366"><TD><IMG SRC="spacer.gif" BORDER="0" WIDTH="1" HEIGHT="1"><BR></TD></TR></TABLE></DIV></TD></TR><TR><TD><IMG SRC="spacer.gif" WIDTH="10" HEIGHT="1"></TD><TD HEIGHT="100%" VALIGN="TOP" WIDTH="100%"><BR><DIV CLASS="chapter"><H1><A NAME="features.file-upload">章 18. 文件上传处理</A></H1><DIV CLASS="TOC"><DL><DT><B>目录</B></DT><DT><A HREF="features.file-upload.html#features.file-upload.post-method">POST 方法上传</A></DT><DT><A HREF="features.file-upload.errors.html">关于错误信息的解释</A></DT><DT><A HREF="features.file-upload.common-pitfalls.html">一些注意事项</A></DT><DT><A HREF="features.file-upload.multiple.html">上传多个文件</A></DT><DT><A HREF="features.file-upload.put-method.html">对 PUT 方法的支持</A></DT></DL></DIV><DIV CLASS="sect1"><H1 CLASS="sect1"><A NAME="features.file-upload.post-method"></A>POST 方法上传</H1><P>&#13; PHP 能够接受任何来自符合 RFC-1867 标准的浏览器（包括 Netscape Navigator 3 及更高版本，Microsoft Internet Explorer 3 加微软补丁，或者更高版本）上传的文件。PHP 的这种特性使得我们既可以上传文本文件，也可以上传二进制文件。利用 PHP 的认证和文件操作函数，您就可以控制谁有上传的权限，以及在文件上传后进行哪些处理。
</P><DIV CLASS="note"><BLOCKQUOTE CLASS="note"><P><B>相关的设置: </B>
请参阅 <TT CLASS="filename">php.ini</TT> 的 <A HREF="configuration.directives.html#ini.file-uploads">file_uploads</A>、
<A HREF="configuration.directives.html#ini.upload-max-filesize">upload_max_filesize</A>、<A HREF="configuration.directives.html#ini.upload-tmp-dir">upload_tmp_dir</A> 以及 <A HREF="configuration.directives.html#ini.post-max-size">post_max_size</A> 设置选项。
</P></BLOCKQUOTE></DIV><P>&#13; 请注意 PHP 也支持 PUT 方法的文件上传，Netscape Composer 和 W3C 的 Amaya 客户端使用这种方法。请参阅 <A HREF="features.file-upload.put-method.html">PUT 方法支持</A>以获取更多信息。
</P><P>&#13; 您可以如下建立一个特殊的表单来支持文件上传：
</P><P>&#13; <TABLE WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0" CLASS="EXAMPLE"><TR><TD><DIV CLASS="example"><A NAME="AEN6460"></A><P><B>例子 18-1. 文件上传表单</B></P><TABLE BORDER="0" BGCOLOR="#E0E0E0" CELLPADDING="5"><TR><TD><PRE CLASS="html">&#60;form enctype="multipart/form-data" action="_URL_" method="POST"&#62;
&#60;input type="hidden" name="MAX_FILE_SIZE" value="30000"&#62;
Send this file: &#60;input name="userfile" type="file"&#62;
&#60;input type="submit" value="Send File"&#62;
&#60;/form&#62;</PRE></TD></TR></TABLE></DIV></TD></TR></TABLE>
</P><P>&#13; 以上范例中的“_URL_”应该替换成指向一个 PHP 文件的真实 URL。MAX_FILE_SIZE 隐藏域（单位为字节）必须先于文件输入域，其值为接收文件的最大尺寸。同时，要保证您的文件上传表单中要有 <TT CLASS="literal">enctype="multipart/form-data"</TT>，否则文件上传将不能工作。
<DIV CLASS="warning"><P></P><TABLE CLASS="warning" BORDER="1" WIDTH="100%"><TR><TD ALIGN="CENTER"><B>警告</B></TD></TR><TR><TD ALIGN="LEFT"><P>&#13; MAX_FILE_SIZE 的值只是对浏览器的一个建议，实际上它可以被简单的绕过。因此不要把对浏览器的限制寄希望于该值。实际上，PHP
设置中的上传文件最大值，是不会失效的。但是最好还是在表单中加上
MAX_FILE_SIZE，因为它可以避免用户在花时间等待上传大文件之后才发现该文件太大了的麻烦。
</P></TD></TR></TABLE></DIV>
</P><P>&#13; 为上传文件定义的变量会根据 PHP 的版本及设置的不同而不同。<A HREF="language.variables.predefined.html#language.variables.superglobals">自动全局变量</A> <A HREF="reserved.variables.html#reserved.variables.files">$_FILES</A> 从 PHP 4.1.0 版本开始被支持。在这之前，从 4.0.0 版本开始，PHP 支持 <TT CLASS="varname">$HTTP_POST_FILES</TT> 数组。这些数组将包含所有关于您上传的文件的信息，其中，我们推荐您使用 <TT CLASS="varname">$_FILES</TT>。如果 PHP 的设置选项 <A HREF="configuration.directives.html#ini.register-globals">register_globals</A> 为 <SPAN CLASS="emphasis"><I CLASS="emphasis">on</I></SPAN>，则相关的变量名将也会存在。从 PHP 4.2.0 版本开始，<A HREF="configuration.directives.html#ini.register-globals">register_globals</A> 的默认值被设为 <SPAN CLASS="emphasis"><I CLASS="emphasis">off</I></SPAN>。
</P><P>&#13; 以上范例中 <A HREF="reserved.variables.html#reserved.variables.files">$_FILES</A> 数组的内容如下所示。我们假设文件上传字段的名称如上例所示，为 <SPAN CLASS="emphasis"><I CLASS="emphasis">userfile</I></SPAN>。名称可随意命名。
<P></P><DIV CLASS="variablelist"><DL><DT><TT CLASS="varname">$_FILES['userfile']['name']</TT></DT><DD><P>&#13; 客户端机器文件的原名称。
</P></DD><DT><TT CLASS="varname">$_FILES['userfile']['type']</TT></DT><DD><P>&#13; 文件的 MIME 类型，需要浏览器提供该信息的支持，例如“<TT CLASS="literal">image/gif</TT>”。
</P></DD><DT><TT CLASS="varname">$_FILES['userfile']['size']</TT></DT><DD><P>&#13; 已上传文件的大小，单位为字节。
</P></DD><DT><TT CLASS="varname">$_FILES['userfile']['tmp_name']</TT></DT><DD><P>&#13; 文件被上传后在服务端储存的临时文件名。
</P></DD><DT><TT CLASS="varname">$_FILES['userfile']['error']</TT></DT><DD><P>&#13; 和该文件上传相关的<A HREF="features.file-upload.errors.html">错误代码</A>。<SPAN CLASS="emphasis"><I CLASS="emphasis">['error']</I></SPAN> 是在 PHP 4.2.0 版本中增加的。
</P></DD></DL></DIV>
</P><DIV CLASS="note"><BLOCKQUOTE CLASS="note"><P><B>注: </B>
在 PHP 4.1.0 版本以前该数组的名称为 <TT CLASS="varname">$HTTP_POST_FILES</TT>，它并不像 <TT CLASS="varname">$_FILES</TT> 一样是<A HREF="language.variables.predefined.html#language.variables.superglobals">自动全局变量</A>。PHP 3 不支持 <TT CLASS="varname">$HTTP_POST_FILES</TT> 数组。
</P></BLOCKQUOTE></DIV><P>&#13; 当 <TT CLASS="filename">php.ini</TT> 中的 <A HREF="configuration.directives.html#ini.register-globals">register_globals</A> 被设置为 <SPAN CLASS="emphasis"><I CLASS="emphasis">on</I></SPAN> 时，您可以使用更多的变量。例如，<TT CLASS="varname">$userfile_name</TT> 等价于 <TT CLASS="varname">$_FILES['userfile']['name']</TT>，<TT CLASS="varname">$userfile_type</TT> 等价于 <TT CLASS="varname">$_FILES['userfile']['type']</TT> 等。请记住从 PHP 4.2.0 开始，<A HREF="configuration.directives.html#ini.register-globals">register_globals</A> 的默认值为 <TT CLASS="literal">off</TT>，因此我们建议您不要依赖于改设置项而使用刚刚提到的那些附加变量。
</P><P>&#13; 文件被上传后，默认地会被储存到服务端的默认临时目录中，除非您将 <TT CLASS="filename">php.ini</TT> 中的 <A HREF="configuration.directives.html#ini.upload-tmp-dir">upload_tmp_dir</A> 设置为了其它的路径。服务端的默认临时目录可以通过更改 PHP 运行环境的环境变量 <TT CLASS="envar">TMPDIR</TT> 来重新设置，但是在 PHP 脚本内部通过运行 <A HREF="function.putenv.html"><B CLASS="function">putenv()</B></A> 函数来设置是不起作用的。该环境变量也可以用来确认其它的操作也是在上传的文件上进行的。
<TABLE WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0" CLASS="EXAMPLE"><TR><TD><DIV CLASS="example"><A NAME="AEN6529"></A><P><B>例子 18-2. 使文件上传生效</B></P><P>&#13; 请查阅函数 <A HREF="function.is-uploaded-file.html"><B CLASS="function">is_uploaded_file()</B></A> 和 <A HREF="function.move-uploaded-file.html"><B CLASS="function">move_uploaded_file()</B></A> 以获取进一步的信息。以下范例处理由表单提供的文件上传。
</P><TABLE BORDER="0" BGCOLOR="#E0E0E0" CELLPADDING="5"><TR><TD><code><font color="#000000">
<font color="#0000BB">&lt;?php<br /></font><font color="#FF8000">// 在 4.1.0 以前的 PHP 中，需要用 $HTTP_POST_FILES 代替 $_FILES。<br />// 在 4.0.3 以前的 PHP 中，需要用 copy() 和 is_uploaded_file() 来代替 move_uploaded_file()。<br /><br /></font><font color="#0000BB">$uploaddir </font><font color="#007700">= </font><font color="#DD0000">'/var/www/uploads/'</font><font color="#007700">;<br /></font><font color="#0000BB">$uploadfile </font><font color="#007700">= </font><font color="#0000BB">$uploaddir</font><font color="#007700">. </font><font color="#0000BB">$_FILES</font><font color="#007700">[</font><font color="#DD0000">'userfile'</font><font color="#007700">][</font><font color="#DD0000">'name'</font><font color="#007700">];<br />print </font><font color="#DD0000">"&lt;pre&gt;"</font><font color="#007700">;<br />if (</font><font color="#0000BB">move_uploaded_file</font><font color="#007700">(</font><font color="#0000BB">$_FILES</font><font color="#007700">[</font><font color="#DD0000">'userfile'</font><font color="#007700">][</font><font color="#DD0000">'tmp_name'</font><font color="#007700">], </font><font color="#0000BB">$uploaddir </font><font color="#007700">. </font><font color="#0000BB">$_FILES</font><font color="#007700">[</font><font color="#DD0000">'userfile'</font><font color="#007700">][</font><font color="#DD0000">'name'</font><font color="#007700">])) {<br />&nbsp;&nbsp;&nbsp;&nbsp;print </font><font color="#DD0000">"File is valid, and was successfully uploaded.&nbsp;&nbsp;Here's some more debugging info:\n"</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">print_r</font><font color="#007700">(</font><font color="#0000BB">$_FILES</font><font color="#007700">);<br />} else {<br />&nbsp;&nbsp;&nbsp;&nbsp;print </font><font color="#DD0000">"Possible file upload attack!&nbsp;&nbsp;Here's some debugging info:\n"</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">print_r</font><font color="#007700">(</font><font color="#0000BB">$_FILES</font><font color="#007700">);<br />}<br />print </font><font color="#DD0000">"&lt;/pre&gt;"</font><font color="#007700">;<br /></font><font color="#0000BB">?&gt;</font>
</font>
</code></TD></TR></TABLE></DIV></TD></TR></TABLE>
</P><P>&#13; 接受上传文件的 PHP 脚本必须在文件上传后进行判断，来决定接下来要对该文件进行那些操作。例如，您可以通过 <TT CLASS="varname">$_FILES['userfile']['size']</TT> 变量来忽略尺寸太大或太小的文件，也可以通过 <TT CLASS="varname">$_FILES['userfile']['type']</TT> 变量来过滤文件类型和某种标准不相符合的文件。在 PHP 4.2.0 以上版本，您还可以通过 <TT CLASS="varname">$_FILES['userfile']['error']</TT> 变量来根据不同的<A HREF="features.file-upload.errors.html">错误代码</A>来做相关的判断。不管做何种的判断，您必须将该文件从临时目录中删除，要么将其移动到其它的地方。
</P><P>&#13; 如果表单中没有选择上传的文件，则 PHP 变量
$_FILES['userfile']['size'] 的值将为 0，$_FILES['userfile']['tmp_name']
将为 none。
</P><P>&#13; 如果该文件没有被移动到其它地方也没有被改名，则该文件将在表单请求结束时被删除。
</P></DIV></DIV><BR></TD><TD><IMG SRC="spacer.gif" WIDTH="10" HEIGHT="1"></TD></TR><TR><TD COLSPAN="3"><DIV CLASS="NAVFOOTER"><TABLE BGCOLOR="#CCCCFF" BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="100%"><TR BGCOLOR="#333366"><TD><IMG SRC="spacer.gif" BORDER="0" WIDTH="1" HEIGHT="1"><BR></TD></TR><TR><TD><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="3" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="features.cookies.html" ACCESSKEY="P">后退</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="index-2.html" ACCESSKEY="H">起点</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="features.file-upload.errors.html" ACCESSKEY="N">前进</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">Cookies</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="features.html" ACCESSKEY="U">上一级</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">关于错误信息的解释</TD></TR></TABLE></TD></TR></TABLE></DIV></TD></TR></TABLE>
<p style="text-align:center;"><script type="text/javascript" src="http://www.veryhuo.com/plus/js/manual.js"></script></p>
<div style="display:none;">
<script type="text/javascript" src="/liehuo.net/js/stat.js"></script>
</div>
</body>
</html>
