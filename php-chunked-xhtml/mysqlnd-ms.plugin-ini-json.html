<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Plugin configuration file (&gt;=1.1.x)</title>

 </head>
 <body><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqlnd-ms.configuration.html">运行时配置</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqlnd-ms.plugin-ini-v1.html">Plugin configuration file (&lt;= 1.0.x)</a></div>
 <div class="up"><a href="mysqlnd-ms.setup.html">安装／配置</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mysqlnd-ms.plugin-ini-json" class="section">
  <h2 class="title">Plugin configuration file (&gt;=1.1.x)</h2>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <strong>Changelog: Feature was added in PECL/mysqlnd_ms 1.1.0-beta</strong><br />
   <p class="para">
    下面的描述信息仅仅适用于 PECL/mysqlnd_ms &gt;= 1.1.0-beta 即以上版本，
    并不适用于这以前的版本。
   </p>
  </p></blockquote>
  <p class="para">
   插件使用自己的独立配置文件，其中包括 MySQL 主从同步的 master 服务器、
   slave 服务器、负载均衡策略、错误处理策略和是否使用被动连接。
  </p>
  <p class="para">
   插件将在 WEB 被请求的时候装载他的配置文件，并且配置会被缓存在内存当中，为后续的
   WEB 请求提供服务。这样，并不需要在更改配置以后，重新启动 PHP。对于配置文件的变更
   将立即启用。
  </p>
  <p class="para">
   插件的配置文件通过 PHP 配置文件中使用
   <a href="mysqlnd-ms.configuration.html#ini.mysqlnd-ms.config-file" class="link"><em>mysqlnd_ms.config_file</em></a>
   指定。请注意，PHP 配置文件指令并不会针对每个 WEB 请求而加载。所以，配置插件的
   配置文件名称和路径需要重新启动 PHP。但是不需要再已经读取的插件配置变更时，
   重新启动 PHP。
  </p>
  <p class="para">
   使用和解析 <acronym title="JavaScript Object Notation">JSON</acronym> 更有效率，并且使用 <acronym title="JavaScript Object Notation">JSON</acronym> 来表达层级的数据结构更容易，所以插件配置并没有采用类似于
   <var class="filename">php.ini</var> 的文件格式。
  </p>
  <p class="para">
   <div class="example" id="example-1833">
    <p><strong>Example #1 将 PHP 数组(hash) 转换为 JSON 格式</strong></p>
    <div class="example-contents"><p>
     可能，开发人员对于 PHP <span class="type"><a href="language.types.array.html" class="type array">array</a></span> 更加习惯，所以这个范例展示了如何将它
     转化为 <acronym title="JavaScript Object Notation">JSON</acronym> 格式。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$config&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"myapp"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"master"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"master_0"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"host"&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"socket"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"/tmp/mysql.sock"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"slave"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(),<br />&nbsp;&nbsp;),<br />);<br /><br /></span><span style="color: #0000BB">file_put_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_ms.ini"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">json_encode</span><span style="color: #007700">(</span><span style="color: #0000BB">$config</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">JSON_PRETTY_PRINT</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_ms.ini&nbsp;file&nbsp;created...\n"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Dumping&nbsp;file&nbsp;contents...\n"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">));<br />echo&nbsp;</span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_ms.ini"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"\n%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上例程会输出：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
mysqlnd_ms.ini file created...
Dumping file contents...
--------------------------------------------------------------------------------
{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: [

        ]
    }
}
--------------------------------------------------------------------------------
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   插件的配置文件，由一个或者多个章节组成。在 <acronym title="JavaScript Object Notation">JSON</acronym> 文件当中，
   每个章节是一个最高级别的对象。章节也可以叫做 <em class="emphasis">configuration names</em>。
  </p>
  <p class="para">
   应用程序使用章节的名称，作为一个 host 名称传送给各种连接方法
   <a href="ref.mysqli.html" class="link">mysqli</a>,
   <a href="ref.mysql.html" class="link">mysql</a> 和
   <a href="ref.pdo-mysql.html" class="link">PDO_MYSQL</a>。在连接时，
   <a href="book.mysqlnd.html" class="link">mysqlnd</a> 插件，将根据配置文件转化这些
   章节名称。如果找到匹配的内容，那么他将装载这个章节的所有设定。  </p>
  <p class="para" id="mysqlnd-ms.plugin-ini-json.using-section">
   <div class="example" id="example-1834">
    <p><strong>Example #2 使用章节名称的范例</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: 3306
            }
        }
    },
    &quot;localhost&quot;: {
        &quot;master&quot;: [
            {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/path\/to\/mysql.sock&quot;
            }
        ],
        &quot;slave&quot;: [
            {
                &quot;host&quot;: &quot;192.168.3.24&quot;,
                &quot;port&quot;: &quot;3305&quot;
            },
            {
                &quot;host&quot;: &quot;192.168.3.65&quot;,
                &quot;port&quot;: &quot;3309&quot;
            }
        ]
    }
}</pre>
</div>
    </div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;下面所有的连接调用都将使用负载均衡&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$pdo&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'mysql:host=myapp;dbname=database'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'username'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'password'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysql_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   章节名称是一个字符串，他可以使用
   <em>192.168.2.1</em>, <em>127.0.0.1</em> 或者
   <em>localhost</em> 作为合法的值。例如，这里定义了
   <em>localhost</em>，应用程序去连接 <em>localhost</em>
   的时候，连接控制就被接管。应用程序将不直接在 <em>localhost</em>
   运行，而是使用插件提供的连接池工作，相关操作将遵循 <em>localhost</em>
   章节中的设定运行。这样可以在不改变应用程序代码的基础上使用插件进行负载均衡。
   请注意，范例的配置可能并不适用于你实际的情况。使用章节名称可以看做是一种
   替代 hostname 的手段。
  </p>
  <p class="para" id="mysqlnd-ms.plugin-ini-json.server-list-syntax">
   配置中每个章节至少要包含，master 列表和 slave 列表。master 列表使用
   <em>master</em> 标记，slave 列表使用 <em>slave</em> 标记。
   错误的 slave 列表，和空的 slave 列表将产生一个 <strong><code>E_ERROR</code></strong>
   级别的错误。这里可以不设定 slave，当然仅仅建议在同步集群中使用。可以参考
   <a href="mysqlnd-ms.supportedclusters.html" class="link">supported clusters</a>。
   而本文档的主要目的是提供对异步的 MySQL 主从同步提供帮助。
  </p>
  <p class="para">
   master 和 slave 列表中的服务器，可以不定义每个服务器的名称。
  </p>
  <p class="para">
   <div class="example" id="example-1835">
    <p><strong>Example #3 匿名 slave 列表</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;slave&quot;: [
    {
        &quot;host&quot;: &quot;192.168.3.24&quot;,
        &quot;port&quot;: &quot;3305&quot;
    },
    {
        &quot;host&quot;: &quot;192.168.3.65&quot;,
        &quot;port&quot;: &quot;3309&quot;
    }
]</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   上面是一个匿名列表的 <em>JSON array</em> 格式。当然也可以给每个列表中
   的服务器起一个满足 <em>JSON object</em> 要求的别名。
  </p>
  <p class="para">
   <div class="example" id="example-1836">
    <p><strong>Example #4 使用别名的 master 列表</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;master&quot;: {
    &quot;master_0&quot;: {
        &quot;host&quot;: &quot;localhost&quot;
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   我们建议使用命名的服务器列表，在错误信息中我们将看到这些服务器命名。
  </p>
  <p class="para">
   服务器列表，会按照顺序加载到 mysqlnd_ms 当中，这样如果采用 round robin 
   负载均衡策略，那么第一个 <em>SELECT</em> 将在第一个定义的
   slave 服务器中运行。
  </p>
  <p class="para">
   配置的服务器，可以使用 <em>host</em>,
   <em>port</em>, <em>socket</em>, <em>db</em>,
   <em>user</em>, <em>password</em> 和 <em>connect_flags</em>
   进行设定。其中 <em>host</em> 是必须设定的内容，其他的是可选设定。
  </p>
  <p class="para">
   <div class="example" id="example-1837">
    <p><strong>Example #5 Keywords to configure a server</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;db_server_host&quot;,
                &quot;port&quot;: &quot;db_server_port&quot;,
                &quot;socket&quot;: &quot;db_server_socket&quot;,
                &quot;db&quot;: &quot;database_resp_schema&quot;,
                &quot;user&quot;: &quot;user&quot;,
                &quot;password&quot;: &quot;password&quot;,
                &quot;connect_flags&quot;: 0
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;db_server_host&quot;,
                &quot;port&quot;: &quot;db_server_port&quot;,
                &quot;socket&quot;: &quot;db_server_socket&quot;
            }
        }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   如果参数遗漏了，那么插件将使用用户打开连接设定的参数替代它。可以参考
   <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.using-section" class="link">using section names example</a>
   获得更多信息。
  </p>
  <p class="para">
   配置文件的格式在 1.1.0-beta 版本更改，为了适应过滤器的使用。过滤器负责过滤服务器列表
   的服务器来执行相关的语句。使用 <em>filter</em> 定义过滤器。mysqlnd_ms 将
   按照过滤器中的顺序执行。当然过滤器定义是可选的。
  </p>
  <p class="para">
   过滤器渠道以前版本中
   <a href="mysqlnd-ms.plugin-ini-v1.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><em>pick[]</em></a>
   的使用，并且通过新的 <em>random</em> 和 <em>roundrobin</em>
   来提供相同的功能。
  </p>
  <p class="para">
   <div class="example" id="example-1838">
    <p><strong>Example #6 New <em>roundrobin</em> filter, old functionality</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.137&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;roundrobin&quot;: [

            ]
        }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span> 函数已经不再使用。回调策略
   设定使用 <em>user</em> 实现。一些过滤器需要设定参数，例如 <em>user</em>
   需要设定回调函数的名称，他相当于以前版本中，在
   <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span> 中的设定内容。
   <div class="example" id="example-1839">
    <p><strong>Example #7 The <em>user</em> filter replaces <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span></strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;filters&quot;: {
    &quot;user&quot;: {
        &quot;callback&quot;: &quot;pick_server&quot;
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para" id="mysqlnd-ms.plugin-ini-json.debug_config">
   The validity of the configuration file is checked both when reading the
   configuration file and later when establishing a connection. The configuration
   file is read during PHP request startup. At this early stage a PHP extension
   may not display error messages properly. In the worst case, no error
   is shown and a connection attempt fails without an adequate error message.
   This problem has been cured in version 1.5.0.
  </p>
  <p class="para">
   <div class="example" id="example-1840">
    <p><strong>Example #8 Common error message in case of configuration file issues (upto version 1.5.0)</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上例程会输出：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Warning: mysqli::mysqli(): (mysqlnd_ms) (mysqlnd_ms) Failed to parse config file [s1.json]. Please, verify the JSON in Command line code

Warning: mysqli::mysqli(): (HY000/2002): php_network_getaddresses: getaddrinfo failed: Name or service not known in Command line code on line 1

Warning: mysqli::query(): Couldn&#039;t fetch mysqli in Command line code on line 1

Fatal error: Call to a member function fetch_assoc() on a non-object in Command line code on line 1
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Since version 1.5.0 startup errors are additionally buffered and emitted when
   a connection attempt is made. Use the configuration directive
   <a href="mysqlnd-ms.configuration.html#ini.mysqlnd-ms.force-config-usage" class="link"><em>mysqlnd_ms.force_config_usage</em></a>
   to set the error type used to display buffered errors. By default an error
   of type <em>E_WARNING</em> will be emitted.
 </p>
 <p class="para">
   <div class="example" id="example-1841">
    <p><strong>Example #9 Improved configuration file validation since 1.5.0</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上例程会输出：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Warning: mysqli::mysqli(): (mysqlnd_ms) (mysqlnd_ms) Failed to parse config file [s1.json]. Please, verify the JSON in Command line code on line 1
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   It can be useful to set <a href="mysqlnd-ms.configuration.html#ini.mysqlnd-ms.force-config-usage" class="link"><em>mysqlnd_ms.force_config_usage = 1</em></a>
   when debugging potential configuration file errors. This will not only turn the
   type of buffered startup errors into <em>E_RECOVERABLE_ERROR</em> but also
   help detecting misspelled section names.
  </p>
  <p class="para">
   <div class="example" id="example-1842">
    <p><strong>Example #10 Possibly more precise error due to <em>mysqlnd_ms.force_config_usage=1</em></strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_ms.force_config_usage=1</pre>
</div>
    </div>

     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"invalid_section"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

<div class="example-contents"><p>以上例程会输出：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Warning: mysqli::mysqli(): (mysqlnd_ms) Exclusive usage of configuration enforced but did not find the correct INI file section (invalid_section) in Command line code on line 1 line 1
</pre></div>
    </div>

   </div>
  </p>
  <p class="para">
   Here is a short explanation of the configuration directives that can be used.
  </p>
  <p class="para">
  <dl>

   
     <dt id="ini.mysqlnd-ms-plugin-config-v2.master">
      <code class="parameter">master</code>
      <span class="type"><span class="type array or object">array or object</span></span>
     </dt>

     <dd>

      <p class="para">
       List of MySQL replication master servers. The list of either
       of the <em>JSON type array</em> to declare an anonymous list
       of servers or of the <em>JSON type object</em>. Please,
       see <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.server-list-syntax" class="link">above</a>
       for examples.
      </p>
      <p class="para">
       Setting at least one master server is mandatory. The plugin will issue an
       error of type <em>E_ERROR</em> if the user has failed to
       provide a master server list for a configuration section.
       The fatal error may read
       <em>(mysqlnd_ms) Section [master] doesn&#039;t exist for host
       [name_of_a_config_section] in %s on line %d</em>.
      </p>
      <p class="para">
       A server is described with
       the <em>host</em>, <em>port</em>,
       <em>socket</em>, <em>db</em>,
       <em>user</em>, <em>password</em> and
       <em>connect_flags</em>. It is mandatory to
       provide at  a value for <em>host</em>. If any of the
       other values is not given, it will be taken from the user
       API connect call, please, see also:
       <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.using-section" class="link">using section names example</a>.
      </p>
      <p class="para" id="mysqlnd-ms.plugin-ini-json.server-config-keywords">
       Table of server configuration keywords.
      </p>
      <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
           <td>
             <em>host</em>
           </td>
           <td>
            <p class="para">
             Database server host. This is a mandatory setting.
             Failing to provide, will cause an error of type <em>E_RECOVERABLE_ERROR</em>
             when the plugin tries to connect to the server. The error message may
             read <em>(mysqlnd_ms) Cannot find [host] in
             [%s] section in config in %s on line %d</em>.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>port</em>
           </td>
           <td>
            <p class="para">
              Database server TCP/IP port.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>socket</em>
           </td>
           <td>
            <p class="para">
              Database server Unix domain socket.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>db</em>
           </td>
           <td>
            <p class="para">
              Database (schemata).
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>user</em>
           </td>
           <td>
            <p class="para">
              MySQL database user.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>password</em>
           </td>
           <td>
            <p class="para">
              MySQL database user password.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>connect_flags</em>
           </td>
           <td>
            <p class="para">
              Connection flags.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

        </tbody>
       
      </table>

      <p class="para">
       The plugin supports using only one master server. An experimental
       setting exists to enable multi-master support. The details are
       not documented. The setting is meant for development only.
      </p>
     </dd>

    
    
    <dt id="ini.mysqlnd-ms-plugin-config-v2.slave">
      <code class="parameter">slave</code>
      <span class="type"><span class="type array or object">array or object</span></span>
     </dt>

     <dd>

      <p class="para">
       List of one or more MySQL replication slave servers. The syntax is
       identical to setting master servers, please, see
       <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.master" class="link"><em>master</em></a>
       above for details.
      </p>
      <p class="para">
       The plugin supports using one or more slave servers.
      </p>
      <p class="para">
       Setting a list of slave servers is mandatory. The plugin will report
       an error of the type <em>E_ERROR</em> if <em>slave</em>
       is not given for a configuration section. The fatal error message may read
       <em>(mysqlnd_ms) Section [slave] doesn&#039;t exist for host [%s] in %s on line %d</em>.
       Note, that it is valid to use an empty slave server list.
       The error has been introduced to prevent accidently setting no slaves by
       forgetting about the <em>slave</em> setting.
       A master-only setup is still possible using an empty slave server list.
      </p>
      <p class="para">
       If an empty slave list is configured and an attempt is made to
       execute a statement on a slave the plugin may emit a warning like
       <em>mysqlnd_ms) Couldn&#039;t find the appropriate slave connection.
       0 slaves to choose from.</em> upon statement execution.
       It is possible that another warning follows such as
       <em>(mysqlnd_ms) No connection selected by the last filter</em>.
      </p>
     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.gtid">
      <code class="parameter">global_transaction_id_injection</code>
      <span class="type"><span class="type array or object">array or object</span></span>
     </dt>

     <dd>

      <p class="para">
       全局同步标识，可以配置为使用服务器内置的 GTID，也可以使用客户端模拟的。
      </p>
      <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td>
            <em>fetch_last_gtid</em>
          </td>
          <td>
           <p class="para">
            用于查询最新 GTID 的 SQL 语句，当插件需要得到最新的 GTID 的时候会执行这个语句。
            他也可以用于检查 MySQL 主从同步的 slave 状态。<span class="function"><strong>mysqlnd_ms_get_laster_gtid()</strong></span>
            也很会使用这个设定。
           </p>
          </td>
          <td>Since 1.2.0.</td>
         </tr>

         <tr>
          <td>
            <em>check_for_gtid</em>
          </td>
          <td>
           <p class="para">
            SQL 语句，他用于检查要查询的相关内容是否已经被同步。当使用比最终一致性
            更高的服务一致性级别的时候会被使用。这个 SQL 语句中必须包含
            <em>#GTID</em> 占位符，在执行的时候他将有插件替换成需要的 GTID。
            可以参考 <a href="mysqlnd-ms.quickstart.gtid.html" class="link">quickstart</a>
            查询相关范例。
           </p>
          </td>
          <td>Since 1.2.0.</td>
         </tr>

         <tr>
          <td>
            <em>report_errors</em>
          </td>
          <td>
           <p class="para">
            当执行相关配置的 SQL 语句的时候若发生错误是否进行报警。
           </p>
          </td>
          <td>Since 1.2.0.</td>
         </tr>

         <tr>
          <td>
           <em>on_commit</em>
          </td>
          <td>
           <p class="para">
            客户端 GTID 模拟使用的 SQL 语句，当 master 执行语句以后，会使用这个
            SQL 语句更新模拟的 GTID，可以参考
            <a href="mysqlnd-ms.quickstart.gtid.html" class="link">quickstart</a>
            查看相关范例。
           </p>
          </td>
          <td>Since 1.2.0.</td>
          </tr>

          <tr>
          <td>
           <em>wait_for_gtid_timeout</em>
          </td>
          <td>
           <p class="para">
            插件等待 <em>wait_for_gtid_timeout</em> 秒，看 slave 是否能够
            满足 Session 一致性的要求。这个参数限制了 slave 状态的轮循时间，如果轮循
            的时间非常长，那么总体小号的时间会超过 <em>wait_for_gtid_timeout</em>。
            在两次轮循之间，插件会调用 <em>sleep(1)</em> 去等待 1 秒。
           </p>
           <p class="para">
            这个参数可以在客户端模拟 GTID 或者在 MySQL 5.6 版本使用服务器端内置的
            GTID 的时候使用。
           </p>
           <p class="para">
            等待 slave 能够同步到 Session 一致性要求的 GTID，意味着将调节客户端。
            这种调节，可以在 master 上间接的降低写负载。基于复制的系统，例如 MySQL
            主从同步会消耗大量的时间在一致性同步上，这种设置可以防止 master 过载。
           </p>
          </td>
          <td>Since 1.4.0.</td>
          </tr>

         </tbody>
        
       </table>

     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.filters">
      <code class="parameter">filters</code>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </dt>

     <dd>

      <p class="para">
       List of filters. A filter is responsible to filter the list of available
       servers for executing a given statement. Filters can be chained.
       The <em>random</em> and <em>roundrobin</em> filter
       replace the
       <a href="mysqlnd-ms.plugin-ini-v1.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><em>pick[]</em></a>
       directive used in prior version to select a load balancing policy.
       The <em>user</em> filter replaces the
       <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span> function.
      </p>
      <p class="para">
       Filters may accept parameters to refine their actions.
      </p>
      <p class="para">
       If no load balancing policy is set, the plugin will default to
       <em>random_once</em>. The <em>random_once</em>
       policy picks a random slave server when running the first read-only
       statement. The slave server will be used for all read-only
       statements until the PHP script execution ends. No load balancing
       policy is set and thus, defaulting takes place,
       if neither the <em>random</em> nor the
       <em>roundrobin</em> are part of a configuration section.
      </p>
      <p class="para">
       If a filter chain is configured so that a filter which output no
       more than once server is used as input for a filter which should be given
       more than one server as input, the plugin may emit a warning upon
       opening a connection. The warning may read: <em>(mysqlnd_ms) Error while creating
       filter &#039;%s&#039; . Non-multi filter &#039;%s&#039; already created.
       Stopping in %s on line %d</em>. Furthermore, an error of
       the error code <em>2000</em>, the sql state <em>HY000</em>
       and an error message similar to the warning may be set on the connection
       handle.
      </p>
      <p class="para">
       <div class="example" id="example-1843">
        <p><strong>Example #11 Invalid filter sequence</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;roundrobin&quot;,
            &quot;random&quot;
        ]
    }
}</pre>
</div>
         </div>

         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$link&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"test"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br /></span><span style="color: #0000BB">$link</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;1&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

         <div class="example-contents"><p>以上例程会输出：</p></div>
        <div class="example-contents screen">
<div class="cdata"><pre>
PHP Warning:  mysqli::mysqli(): (HY000/2000): (mysqlnd_ms) Error while creating filter &#039;random&#039; . Non-multi filter &#039;roundrobin&#039; already created. Stopping in filter_warning.php on line 1
[2000] (mysqlnd_ms) Error while creating filter &#039;random&#039; . Non-multi filter &#039;roundrobin&#039; already created. Stopping
PHP Warning:  mysqli::query(): Couldn&#039;t fetch mysqli in filter_warning.php on line 3
</pre></div>
        </div>
       </div>
      </p>
    </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-random">
      Filter: <code class="parameter">random</code>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </dt>

     <dd>

      <p class="para">
       <em>random</em> 过滤器提供 random 或者 random_once 负载均衡策略，
       老版本的使用可以参考 
       <a href="mysqlnd-ms.plugin-ini-v1.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><em>pick[]</em></a>。
      </p>
      <p class="para">
       当执行只读语句的时候，随机策略会随机挑选一个服务器，random_once 会在页面第一次
       请求的时候随机挑选一个服务器，然后在页面后续的访问中使用同一个服务器。random_once
       是默认设置。
      </p>
      <p class="para">
       如果 <em>random</em> 过滤器没有设定任何参数，那么会使用随机负载均衡策略。
      </p>
      <p class="para">
       <div class="example" id="example-1844">
        <p><strong>Example #12 Random load balancing with <em>random</em> filter</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.137&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;random&quot;
        ]
    }
}</pre>
</div>
         </div>

       </div>
      </p>
      <p class="para">
       可以设置 <em>sticky</em> 参数，如果设置了这个参数 <em>1</em>
       过滤器将采用 random_once 策略。
      </p>
      <p class="para">
       <div class="example" id="example-1845">
        <p><strong>Example #13 Random once load balancing with <em>random</em> filter</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;filters&quot;: {
        &quot;random&quot;: {
            &quot;sticky&quot;: &quot;1&quot;
        }
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       从 1.4.0 版本开始，<em>random</em> 和 <em>roundrobin</em>
       过滤器都可以设定服务器权重 (优先级)。如果要使用权重，那么所有的服务器都需要
       分配 <em>weight</em>。使用权重，那么 master 和 slave 都需要
       使用命名设定。
      </p>
      <p class="para">
       <div class="example" id="example-1846">
        <p><strong>Example #14 Referencing error</strong></p>
        <div class="example-contents screen">
<div class="cdata"><pre>
[E_RECOVERABLE_ERROR] mysqli_real_connect(): (mysqlnd_ms) Unknown server &#039;slave3&#039; in &#039;random&#039; filter configuration. Stopping in %s on line %d
</pre></div>
        </div>
       </div>
      </p>
      <p class="para">
       如果对于一个非法的服务器命名设定 <em>weight</em>，那么会产生一个
       类似于上面的错误信息。
      </p>
      <p class="para">
       如果遗漏了 <em>weight</em> 设定，所有服务器的权重是 1。
      </p>
      <p class="para">
       <div class="example" id="example-1847">
        <p><strong>Example #15 Assigning a <em>weight</em> for load balancing</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
   &quot;myapp&quot;: {
       &quot;master&quot;: {
           &quot;master1&quot;:{
               &quot;host&quot;:&quot;localhost&quot;,
               &quot;socket&quot;:&quot;\/var\/run\/mysql\/mysql.sock&quot;
           }
       },
       &quot;slave&quot;: {
           &quot;slave1&quot;: {
               &quot;host&quot;:&quot;192.168.2.28&quot;,
               &quot;port&quot;:3306
           },
           &quot;slave2&quot;: {
               &quot;host&quot;:&quot;192.168.2.29&quot;,
               &quot;port&quot;:3306
           },
           &quot;slave3&quot;: {
               &quot;host&quot;:&quot;192.0.43.10&quot;,
               &quot;port&quot;:3306
           },
       },
       &quot;filters&quot;: {
           &quot;random&quot;: {
               &quot;weights&quot;: {
                   &quot;slave1&quot;:8,
                   &quot;slave2&quot;:4,
                   &quot;slave3&quot;:1,
                   &quot;master1&quot;:1
               }
           }
       }
   }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       如果服务器的权重设置为 2，那么他使用的次数将是那些权重为 1 的服务器的两倍。
       不同的权重设定，可以基于不同的服务器性能、网络延迟、或者你更喜欢的原因。
       基于网络延迟的原因，可以给服务器设置一个比较低的权重，例如上面的范例中，对于
       <em>slave3</em> 只有 1/8 的使用权重，这样他比 <em>slave1</em>、
       <em>slave2</em> 只有很少的使用几率。只有当其他两台设备都产生错误时，
       <em>slave3</em> 使用率才会上升。在使用权重的时候，一定要查看错误处理
       相关的说明。
      </p>
      <p class="para">
       可以设定 1 - 65535 之间的数字
      </p>
      <p class="para">
       非法的参数将会被忽略，而不会进行任何报警。
      </p>
      <p class="para">
       如果过滤器使用一个或者多个 master，一个 slave，那么使用 <em>random</em>、
       <em>roundrobin</em> 执行语句，会产生一个报警或者错误信息。
      </p>
      <p class="para">
       过滤器的参数
      </p>
      <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td>
            <em>sticky</em>
          </td>
          <td>
           <p class="para">
            是否激活 random_once 负载均衡策略
           </p>
          </td>
          <td>Since 1.2.0.</td>
         </tr>

         <tr>
          <td>
            <em>weight</em>
          </td>
          <td>
           <p class="para">
            为服务器设置负载均衡权重 (优先级)
           </p>
          </td>
          <td>Since 1.4.0.</td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-roundrobin">
      Filter: <code class="parameter">roundrobin</code>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </dt>

     <dd>

      <p class="para">
       如果使用 <em>roundrobin</em> 过滤器，插件会轮循配置文件中
       所有配置的 slaver。如果插件已经使用的 slave 列表的结尾，他会重新从列表
       头开始使用 slave 服务器。
      </p>
      <p class="para">
       <div class="example" id="example-1848">
        <p><strong>Example #16 <em>roundrobin</em> filter</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;roundrobin&quot;
        ]
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
        如果设定了一个或者多个 master，而只设置了一个 slave，那么采用
       <em>roundrobin</em>, <em>random</em> 在执行语句的
       时候，会在连接中产生一个报警或者错误信息。
      </p>
      <p class="para">
       过滤器使用的参数。
      </p>
      <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td>
            <em>weight</em>
          </td>
          <td>
           <p class="para">
            设置服务器的权重（优先级），可以参考
            <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.filter-random" class="link">above</a>
            的说明。
           </p>
          </td>
          <td>Since 1.4.0.</td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-user">
      Filter: <code class="parameter">user</code>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </dt>

     <dd>

      <p class="para">
        The <em>user</em> replaces
       <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span> function,
       which was removed in 1.1.0-beta. The filter sets a callback for user-defined
       read/write splitting and server selection.
      </p>
      <p class="para">
        The plugins built-in read/write query split mechanism decisions can be
        overwritten in two ways. The easiest way is to prepend a query string
        with the SQL hints <strong><code>MYSQLND_MS_MASTER_SWITCH</code></strong>,
        <strong><code>MYSQLND_MS_SLAVE_SWITCH</code></strong> or
        <strong><code>MYSQLND_MS_LAST_USED_SWITCH</code></strong>. Using SQL hints one can
        control, for example, whether a query shall be send to the MySQL replication
        master server or one of the slave servers. By help of SQL hints it is
        not possible to pick a certain slave server for query execution.
      </p>
      <p class="para">
       Full control on server selection can be gained using a callback function.
       Use of a callback is recommended to expert users only because the callback
       has to cover all cases otherwise handled by the plugin.
      </p>
      <p class="para">
       The plugin will invoke the callback function for selecting a server from the
       lists of configured master and slave servers. The callback function
       inspects the query to run and picks a server for query execution by returning
       the hosts URI, as found in the master and slave list.
      </p>
      <p class="para">
       If the lazy connections are enabled and the callback chooses a slave server for
       which no connection has been established so far and establishing the connection
       to the slave fails, the plugin will return an error upon the next action
       on the failed connection, for example, when running a query. It is the
       responsibility of the application developer to handle the error. For example,
       the application can re-run the query to trigger a new server selection and
       callback invocation. If so, the callback must make sure to select
       a different slave, or check slave availability, before returning to
       the plugin to prevent an endless loop.
      </p>
      <p class="para">
       <div class="example" id="example-1849">
        <p><strong>Example #17 Setting a callback</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;user&quot;: {
                &quot;callback&quot;: &quot;pick_server&quot;
            }
        }
    }
}</pre>
</div>
         </div>

       </div>
      </p>
      <p class="para">
       The callback is supposed to return a host to run the query on.
       The host URI is to be taken from the master and slave connection lists
       passed to the callback function. If callback returns a value neither
       found in the master nor in the slave connection lists the plugin
       will emit an error of the type <em>E_RECOVERABLE_ERROR</em>
       The error may read like
       <em>  (mysqlnd_ms) User filter callback has returned an unknown server.
       The server &#039;server that is not in master or slave list&#039; can neither be found
       in the master list nor in the slave list</em>.
       If the application catches the error to ignore it, follow up errors
       may be set on the connection handle, for example,
       <em>(mysqlnd_ms) No connection selected by the last filter</em> with
       the error code <em>2000</em> and the sqlstate <em>HY000</em>.
       Furthermore a warning may be emitted.
      </p>
      <p class="para">
       Referencing a non-existing function as a callback will result
       in any error of the type <em>E_RECOVERABLE_ERROR</em> whenever
       the plugin tries to callback function. The error message may reads like:
       <em>(mysqlnd_ms) Specified callback (pick_server) is
       not a valid callback</em>. If the application catches the error to
       ignore it, follow up errors may be set on the connection handle, for example,
       <em>(mysqlnd_ms) Specified callback (pick_server) is
       not a valid callback</em> with the error code <em>2000</em>
       and the sqlstate <em>HY000</em>. Furthermore a warning
       may be emitted.
      </p>
      <p class="para">
       The following parameters are passed from the plugin to the callback.
      </p>
      <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Parameter</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
           <td>
             <em>connected_host</em>
           </td>
           <td>
            <p class="para">
             URI of the currently connected database server.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>query</em>
           </td>
           <td>
            <p class="para">
             Query string of the statement for which a server needs
             to be picked.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>masters</em>
           </td>
           <td>
            <p class="para">
             List of master servers to choose from. Note, that the list of master
             servers may not be identical to the list of configured master
             servers if the filter is not the first in the filter chain.
             Previously run filters may have reduced the master
             list already.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>slaves</em>
           </td>
           <td>
            <p class="para">
             List of slave servers to choose from. Note, that the list of master
             servers may not be identical to the list of configured master
             servers if the filter is not the first in the filter chain.
             Previously run filters may have reduced the master
             list already.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>last_used_connection</em>
           </td>
           <td>
            <p class="para">
              URI of the server of the connection used to execute the previous
              statement on.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>in_transaction</em>
           </td>
           <td>
            <p class="para">
             Boolean flag indicating whether the statement is
             part of an open transaction. If autocommit mode is turned
             off, this will be set to <strong><code>TRUE</code></strong>. Otherwise
             it is set to <strong><code>FALSE</code></strong>.
            </p>
            <p class="para">
             Transaction detection is based on monitoring the
             mysqlnd library call <em>set_autocommit</em>.
             Monitoring is not possible before PHP 5.4.0. Please, see
             <a href="mysqlnd-ms.pooling.html" class="link">connection pooling and switching</a>
             concepts discussion for further details.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

        </tbody>
       
      </table>

     <p class="para">
      <div class="example" id="example-1850">
        <p><strong>Example #18 Using a callback</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;user&quot;: {
                &quot;callback&quot;: &quot;pick_server&quot;
            }
        }
    }
}</pre>
</div>
         </div>

         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">pick_server</span><span style="color: #007700">(</span><span style="color: #0000BB">$connected</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$in_transaction</span><span style="color: #007700">)<br />{<br />&nbsp;static&nbsp;</span><span style="color: #0000BB">$slave_idx&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />&nbsp;static&nbsp;</span><span style="color: #0000BB">$num_slaves&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br />&nbsp;if&nbsp;(</span><span style="color: #0000BB">is_null</span><span style="color: #007700">(</span><span style="color: #0000BB">$num_slaves</span><span style="color: #007700">))<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$num_slaves&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">);<br /><br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;default:&nbsp;fallback&nbsp;to&nbsp;the&nbsp;plugins&nbsp;build-in&nbsp;logic&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br /><br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"User&nbsp;has&nbsp;connected&nbsp;to&nbsp;'%s'...\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$connected</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;deciding&nbsp;where&nbsp;to&nbsp;run&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br /><br />&nbsp;</span><span style="color: #0000BB">$where&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_query_is_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br />&nbsp;switch&nbsp;(</span><span style="color: #0000BB">$where</span><span style="color: #007700">)<br />&nbsp;{<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_USE_MASTER</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;using&nbsp;master\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_USE_SLAVE</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;SELECT&nbsp;or&nbsp;SQL&nbsp;hint&nbsp;for&nbsp;using&nbsp;slave&nbsp;*/<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">stristr</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"FROM&nbsp;table_on_slave_a_only"</span><span style="color: #007700">))<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;a&nbsp;table&nbsp;which&nbsp;is&nbsp;only&nbsp;on&nbsp;the&nbsp;first&nbsp;configured&nbsp;slave&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;access&nbsp;to&nbsp;table&nbsp;available&nbsp;only&nbsp;on&nbsp;slave&nbsp;A&nbsp;detected\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;round&nbsp;robin&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;some&nbsp;read-only&nbsp;query&nbsp;for&nbsp;a&nbsp;slave\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">[</span><span style="color: #0000BB">$slave_idx</span><span style="color: #007700">++&nbsp;%&nbsp;</span><span style="color: #0000BB">$num_slaves</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_LAST_USED</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;using&nbsp;last&nbsp;used&nbsp;server\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;}<br /><br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;ret&nbsp;=&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">);<br />&nbsp;return&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"test"</span><span style="color: #007700">);<br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;1&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;2&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;*&nbsp;FROM&nbsp;table_on_slave_a_only"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

         <div class="example-contents"><p>以上例程会输出：</p></div>
         <div class="example-contents screen">
<div class="cdata"><pre>
User has connected to &#039;myapp&#039;...
... deciding where to run &#039;SELECT 1 FROM DUAL&#039;
... some read-only query for a slave
... ret = &#039;tcp://192.168.2.27:3306&#039;
User has connected to &#039;myapp&#039;...
... deciding where to run &#039;SELECT 2 FROM DUAL&#039;
... some read-only query for a slave
... ret = &#039;tcp://192.168.78.136:3306&#039;
User has connected to &#039;myapp&#039;...
... deciding where to run &#039;SELECT * FROM table_on_slave_a_only&#039;
... access to table available only on slave A detected
... ret = &#039;tcp://192.168.2.27:3306&#039;
</pre></div>
         </div>
       </div>
      </p>
     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-user-multi">
      Filter: <code class="parameter">user_multi</code>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </dt>

     <dd>

      <p class="para">
       The <em>user_multi</em> differs from the <em>user</em>
       only in one aspect. Otherwise, their syntax is identical.
       The <em>user</em> filter must pick
       and return exactly one node for statement execution. A filter chain
       usually ends with a filter that emits only one node. The filter chain
       shall reduce the list of candidates for statement execution down to
       one. This, only one node left, is the case after the <em>user</em>
       filter has been run.
      </p>
      <p class="para">
       The <em>user_multi</em> filter is a multi filter. It returns a
       list of slave and a list of master servers. This list needs further filtering
       to identify exactly one node for statement execution. A multi filter is typically
       placed at the top of the filter chain. The <em>quality_of_service</em>
       filter is another example of a multi filter.
      </p>
      <p class="para">
       The return value of the callback set for <em>user_multi</em> must
       be an an array with two elements. The first element holds a list of selected master
       servers. The second element contains a list of selected slave servers. The
       lists shall contain the keys of the slave and master servers as found in
       the slave and master lists passed to the callback. The below example returns
       random master and slave lists extracted from the functions input.
      </p>
      <p class="para">
      <div class="example" id="example-1851">
        <p><strong>Example #19 Returning random masters and slaves</strong></p>
        <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">pick_server</span><span style="color: #007700">(</span><span style="color: #0000BB">$connected</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$in_transaction</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_masters&nbsp;</span><span style="color: #007700">=&nbsp;array()<br />&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$masters&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$value</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">mt_rand</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">)&nbsp;&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_masters</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_slaves&nbsp;</span><span style="color: #007700">=&nbsp;array()<br />&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$slaves&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$value</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">mt_rand</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">)&nbsp;&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_slaves</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;return&nbsp;array(</span><span style="color: #0000BB">$picked_masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$picked_slaves</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

       </div>
      </p>
      <p class="para">
       The plugin will issue an
       error of type <em>E_RECOVERABLE</em> if the callback fails to return
       a server list. The error may read <em>(mysqlnd_ms) User multi
       filter callback has not returned a list of servers to use.
       The callback must return an array in %s on line %d</em>. In case the
       server list is not empty but has invalid servers key/ids in it, an error
       of type <em>E_RECOVERABLE</em> will the thrown with an
       error message like <em>(mysqlnd_ms) User multi filter callback
       has returned an invalid list of servers to use.
       Server id is negative in %s on line %d</em>, or similar.
      </p>
      <p class="para">
       Whether an error is emitted in case of an empty slave or master list
       depends on the configuration. If an empty master list is returned
       for a write operation, it is likely that the plugin will emit a
       warning that may read <em>(mysqlnd_ms) Couldn&#039;t find the appropriate
       master connection. 0 masters to choose from. Something is wrong in %s on line %d</em>.
       Typically a follow up error of type <em>E_ERROR</em> will happen.
       In case of a read operation and an empty slave list the behavior depends
       on the fail over configuration. If fail over to master is enabled, no
       error should appear. If fail over to master is deactivated the plugin will
       emit a warning that may read <em>(mysqlnd_ms) Couldn&#039;t find the appropriate
       slave connection. 0 slaves to choose from. Something is wrong in %s on line %d</em>.
      </p>
     </dd>

    


    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-node-groups">
      Filter: <code class="parameter">node_groups</code>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </dt>

     <dd>

      <p class="para">
       The <em>node_groups</em> filter lets you group cluster nodes
       and query selected groups, for example, to support data partitioning.
       Data partitioning can be required for manual sharding, primary copy based
       clusters running multiple masters, or to avoid hot spots in update everywhere
       clusters that have no built-in partitioning. The filter is a multi filter
       which returns zero, one or multiple of its input servers. Thus, it
       must be followed by other filters to reduce the number of candidates
       down to one for statement execution.
      </p>
       <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
           <td>
             <em>user defined node group name</em>
           </td>
           <td>
            <p class="para">
             One or more node groups must be defined. A node group can have an
             arbitrary user defined name. The name is used in combination with
             a SQL hint to restrict query execution to the nodes listed for the
             node group. To run a query on any of the servers of a node group,
             the query must begin with the SQL hint
             <em>/*user defined node group name*/</em>.
             Please note, no white space is allowed around
             <em>user defined node group name</em>. Because
             <em>user defined node group name</em> is used as-is
             as part of a SQL hint, you should choose the name that is compliant
             with the SQL language.
            </p>
            <p class="para">
             Each node group entry must contain a list of <em>master</em>
             servers. Additional <em>slave</em> servers are allowed.
             Failing to provide a list of <em>master</em> for a node group
             <em>name_of_group</em> may cause an
             error of type <strong><code>E_RECOVERABLE_ERROR</code></strong> like
             <em>(mysqlnd_ms) No masters configured in node group &#039;name_of_group&#039; for &#039;node_groups&#039; filter</em>.
            </p>
            <p class="para">
             The list of master and slave servers must reference corresponding
             entries in the
             <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.master" class="link">global master</a>
             respectively <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.slave" class="link">slave</a>
             server list. Referencing an unknown server in either of the both server
             lists may cause an <strong><code>E_RECOVERABLE_ERROR</code></strong> error like
             <em>(mysqlnd_ms) Unknown master &#039;server_alias_name&#039; (section &#039;name_of_group&#039;) in &#039;node_groups&#039; filter configuration</em>.
            </p>
            <p class="para">
             <div class="example" id="example-1852">
               <p><strong>Example #20 Manual partitioning</strong></p>
                <div class="example-contents">
<div class="inicode"><pre class="inicode">{
  &quot;myapp&quot;: {
       &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.28&quot;,
                &quot;port&quot;: 3306
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;127.0.0.1&quot;,
                &quot;port&quot;: 3311
            }
        },
        &quot;filters&quot;: {
            &quot;node_groups&quot;: {
                &quot;Partition_A&quot; : {
                    &quot;master&quot;: [&quot;master_0&quot;],
                    &quot;slave&quot;: [&quot;slave_0&quot;]
                }
            },
           &quot;roundrobin&quot;: []
        }
    }
}</pre>
</div>
              </div>

             </div>
            </p>
            <p class="para">
              Please note, if a filter chain
              generates an empty slave list and the PHP configuration directive
              <em>mysqlnd_ms.multi_master=0</em> is used, the plugin may
              emit a warning.
            </p>
          </td>
          <td>Since 1.5.0.</td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    

    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-qos">
      Filter: <code class="parameter">quality_of_service</code>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </dt>

     <dd>

      <p class="para">
       <em>quality_of_service</em> 用于设定群组的服务级别。
       The <em>quality_of_service</em> identifies cluster nodes
       capable of delivering a certain quality of service. It is a multi filter
       which returns zero, one or multiple of its input servers. Thus, it
       must be followed by other filters to reduce the number of candidates
       down to one for statement execution.
      </p>
      <p class="para">
       The <em>quality_of_service</em> filter has been introduced in 1.2.0-alpha.
       In the 1.2 series the filters focus is on the consistency aspect of
       service quality. Different types of clusters offer different
       default data consistencies. For example, an asynchronous MySQL
       replication slave offers eventual consistency. The slave may not
       be able to deliver requested data because it has not replicated the write,
       it may serve stale database because its lagging behind or it may serve
       current information. Often, this is acceptable. In some cases
       higher consistency levels are needed for the application to work correct.
       In those cases, the <em>quality_of_service</em> can filter out cluster nodes
       which cannot deliver the necessary quality of service.
      </p>
      <p class="para">
       The <em>quality_of_service</em> filter can be replaced or created
       at runtime. A successful call to
       <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>
       removes all existing <em>qos</em> filter entries from the
       filter list and installs a new one at the very beginning. All settings
       that can be made through
       <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>
       can also be in the plugins configuration file. However, use of the function
       is by far the most common use case. Instead of setting session consistency and
       strong consistency service levels in the plugins configuration file it is
       recommended to define only masters and no slaves. Both service levels will
       force the use of masters only. Using an empty slave list shortens the
       configuration file, thus improving readability. The only service level for which
       there is a case of defining in the plugins configuration file is the combination
       of eventual consistency and maximum slave lag.
      </p>
      <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
           <td>
             <em>eventual_consistency</em>
           </td>
           <td>
            <p class="para">
             Request eventual consistency. Allows the use of all
             master and slave servers. Data returned may or may not be current.
            </p>
            <p class="para">
             Eventual consistency accepts an optional <em>age</em>
             parameter. If <em>age</em> is given the plugin considers
             only slaves for reading for which MySQL replication reports
             a slave lag less or equal to <em>age</em>.
             The replication lag is measure using <em>SHOW SLAVE STATUS</em>.
             If the plugin fails to fetch the replication lag, the slave tested
             is skipped. Implementation details and tips are given in the
             <a href="mysqlnd-ms.qos-consistency.html" class="link">quality of service concepts section</a>.
            </p>
            <p class="para">
              Please note, if a filter chain
              generates an empty slave list and the PHP configuration directive
              <em>mysqlnd_ms.multi_master=0</em> is used, the plugin may
              emit a warning.
            </p>
            <p class="para">
             <div class="example" id="example-1853">
               <p><strong>Example #21 Global limit on slave lag</strong></p>
                <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;quality_of_service&quot;: {
                &quot;eventual_consistency&quot;: {
                    &quot;age&quot;:123
                }
            }
        }
    }
}</pre>
</div>
              </div>

             </div>
            </p>
          </td>
          <td>Since 1.2.0.</td>
         </tr>

         <tr>
           <td>
             <em>session_consistency</em>
           </td>
           <td>
            <p class="para">
              Request session consistency (read your writes). Allows use of all masters
              and all slaves which are in sync with the master.
              If no further parameters are given slaves are filtered out
              as there is no reliable way to test if a slave has caught up
              to the master or is lagging behind. Please note, if a filter chain
              generates an empty slave list and the PHP configuration directive
              <em>mysqlnd_ms.multi_master=0</em> is used, the plugin may
              emit a warning.
            </p>
            <p class="para">
             Session consistency temporarily requested using
             <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span> is a valuable alternative
             to using <em>master_on_write</em>.
             <em>master_on_write</em> is likely to send more statements
             to the master than needed. The application may be able to continue
             operation at a lower consistency level after it has done
             some critical reads.
            </p>
          </td>
          <td>Since 1.1.0.</td>
         </tr>

         <tr>
           <td>
             <em>strong_consistency</em>
           </td>
           <td>
            <p class="para">
              Request strong consistency. Only masters will be used.
            </p>
          </td>
          <td>Since 1.2.0.</td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.failover">
      <code class="parameter">failover</code>
      1.3.x 版本以前(包含): <span class="type"><a href="language.types.string.html" class="type string">string</a></span>.
      1.4.0 版本以后: <span class="type"><a href="language.types.object.html" class="type object">object</a></span>.
     </dt>

     <dd>

      <p class="para">
       错误处理策略，支持：<em>disabled</em> (默认), 
       <em>master</em>, <em>loop_before_master</em> (Since 1.4.0).
      </p>
      <p class="para">
       如果没有设定错误处理策略 (<em>failover=disabled</em>) 插件不会做
       任何的自动错误处理。这样，只要插件连接服务器出现错误，他将抛出一个报警信息，
       并且设定连接中的错误编号和信息。
      </p>
      <p class="para">
       请注意，自动错误处理只对已经打开的链接起作用。如果一个连接再没有自动处理前已经
       打开，那么产生错误的时候他会重新被打开。例如，如果一个服务器的链接已经关闭，
       用户尝试在这个链接上执行语句，那么在没有自动错误处理的时候，将不会被重试，而是
       直接报告错误。
      </p>
      <p class="para">
       如果设置 <em>failover=master</em>，插件将自己到 master 进行尝试，
       请参考概念文档查看鞥多关于错误处理和使用 <em>failover=master</em>
       可能产生的风险。
      </p>
      <p class="para">
       <div class="example" id="example-1854">
        <p><strong>Example #22 Optional master failover when failing to connect to slave (PECL/mysqlnd_ms &lt; 1.4.0)</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;failover&quot;: &quot;master&quot;
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       从 1.4.0 版本开始，配置文件更改为对象定义方式。
      </p>
      <p class="para">
       <div class="example" id="example-1855">
        <p><strong>Example #23 New syntax since 1.4.0</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;failover&quot;: {&quot;strategy&quot;: &quot;master&quot; }
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td>
           <em>strategy</em>
          </td>
          <td>
           <p class="para">
            错误处理策略，可以使用
            <em>disabled</em> (默认), <em>master</em>,
            <em>loop_before_master</em>
           </p>
           <p class="para">
            <em>disabled</em> 将会禁用自动错误处理。
           </p>
           <p class="para">
            <em>master</em> 设置将会在连接 slave 出现错误的时候
            尝试连接 master。如果 master 连接错误，插件将在错误处理循环中处理，
            并且返回一个错误给用户。
           </p>
           <p class="para">
            如果 <em>loop_before_master</em> 设置，对于 slave 请求，
            插件会在其他 slave 尝试，然后才在 master 尝试。如果设定了多个 master
            并且启用了多 master 设定，那么插件也会在其他 master 进行尝试，都失败后
            才会报告错误给用户。
           </p>
          </td>
          <td>Since 1.4.0.</td>
         </tr>

         <tr>
          <td>
           <em>remember_failed</em>
          </td>
          <td>
           <p class="para">
            在 WEB 请求期间记住产生错误的服务器，默认值 <em>false</em>。
            </p>
            <p class="para">
             如果设置为 <em>true</em>，当前 WEB 页面的请求期间，
             插件将记住失败的主机，并且在后面的负载均衡过程中自动跳过这个出错的主机。
            </p>
          </td>
          <td>
           从 1.4.0 版本开始，这个功能只能与 <em>random</em> 和 
           <em>roundrobin</em> 负载均衡策略同时使用，建议使用这个参数。
          </td>
         </tr>

         <tr>
           <td>
            <em>max_retries</em>
           </td>
           <td>
            <p class="para">
             在跳过一个主机前尝试的次数，默认值：<em>0</em> (不限制)
            </p>
            <p class="para">
             这个设定用于禁止在第一次产生错误的时候，就将这个主机从主机列表中剔除，
             插件将在出现错误后继续在主机列表中保留这个主机。这个主机将不会在出现
             第一次连接错误的时候被剔除，在负载均衡的使用过程中，出现
             <em>n</em> 次错误以后，才会被剔除掉。
            </p>
          </td>
          <td>
           从 1.4.0 版本开始，这个设定只能与 <em>random</em> 和
           <em>roundrobin</em> 负载均衡策略同时使用。
          </td>
         </tr>

        </tbody>
       
      </table>

      <p class="para">
       如果设定 <em>failover</em> 的值不是 <em>disabled</em>、
       <em>master</em> 或者 <em>loop_before_master</em>，那么
       将产生一个报警信息或者是错误。
      </p>
     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.lazy-connections">
      <code class="parameter">lazy_connections</code>
      <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span>
     </dt>

     <dd>

      <p class="para">
       被动连接是默认的选项，他在第一次发送执行语句的时候才真正建立连接。
      </p>
      <p class="para">
       我们强烈建议使用被动连接模式，他可以有效的降低连接数。如果禁用了被动连接
       模式，如果配置了一个 MySQL 主从同步 master 和两个 slave，那么即使应用程序
       只使用了 master 执行了一条语句，也会建立 3 个链接。
      </p>
      <p class="para">
       使用被动连接会对用户更改连接状态信息产生风险。插件并不能分派所有的链接
       状态信息到连接池中的每个连接上，只有少量的操作会被分发到已经打开的连接中，
       处于被动连接模式中还没有打开的连接无法得到改变。只有部分的设置会被记住，
       并且会在被动连接模式下的链接真正建立的时候设置。
      </p>
      <p class="para">
       <div class="example" id="example-1856">
        <p><strong>Example #24 禁用被动连接模式</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;lazy_connections&quot;: 0
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       请参考 <em>server_charset</em> 处理可能产生的服务器默认字符集
       和使用的字符集产生的影响。
      </p>
     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.server-charset">
      <code class="parameter">server_charset</code>
      <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
     </dt>

     <dd>

      <p class="para">
       这个设置从 1.4.0 版本开始使用，建议在被动连接的时候使用。
      </p>
      <p class="para">
       这个参数设定有两个目的，在连接建立完成以后设定返回的字符串的字符集，并且
       当服务器采用不同的字符集时避免产生字符集转换的错误。
      </p>
      <p class="para">
       字符集转换是设定在连接上的，当连接没有打开或者字符集不合法的时候字符集转换
       将不起作用。如果使用的是被动连接，那么在实际的语句没有发送以前，连接是不打开的。
      </p>
      <p class="para">
       应用程序在使用被动连接时，在没有发送任何执行语句以前尝试进行字符集转换，
       会产生一个 <em>E_WARNING</em> 级别的错误，因为这时连接其实
       并没有建立。会在错误处理中得到一个类似于 <em>(mysqlnd_ms)
       string escaping doesn&#039;t work without established connection.
       Possible solution is to add server_charset to your configuration</em>
       的错误信息。
      </p>
      <p class="para">
       <em>server_charset</em> 设置可以在被动连接启动以前设置，这样当连接
       建立以后，会使用这个字符集作为字符集转换的目标。
      </p>
      <p class="para">
       在配置中指定字符集，可以避免由于服务器字符集不同而导致出现的错误。这个设定
       还有一个附加的好处，迫使所有的服务器采用同样的字符集设定。无论服务器本身的
       字符集设定是什么，插件将统一按照配置中的设定作为默认字符集使用。
      </p>
      <p class="para">
       插件不会阻止任何时候用户通过调用 <span class="function"><strong>set_charset()</strong></span> 或者在 SQL
       语句中设定字符集。但是请注意，在 SQL 语句中设置字符集是不建议使用的，因为插件
       无法监控到这种变化。在被动连接模式下，用户可以在连接建立以后，更改默认字符集。
       在配置文件中设定的字符集，将在连接建立后使用，而不管服务器的字符集设定，也不管
       用户之前的设定。在实际连接建立以前，<em>set_charset</em> 的设定没有
       任何作用。
      </p>
      <p class="para">
       <div class="example" id="example-1857">
        <p><strong>Example #25 在被动连接模式下，字符集转换控制</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;lazy_connections&quot;: 1,
        &quot;server_charset&quot; : &quot;utf8&quot;
    }
}</pre>
</div>
        </div>

        <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;译者注：下面将被转换为&nbsp;UTF8，因为配置中这样设定的&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">real_escape</span><span style="color: #007700">(</span><span style="color: #DD0000">"this&nbsp;will&nbsp;be&nbsp;escaped&nbsp;using&nbsp;the&nbsp;server_charset&nbsp;setting&nbsp;-&nbsp;utf8"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;译者注：下面的语句么有任何作用&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">set_charset</span><span style="color: #007700">(</span><span style="color: #DD0000">"latin1"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;译者注：下面由于&nbsp;mysqli&nbsp;对象自己的字符集被上一条语句改变，所以本地字符转换会遵循对象内的设定被转换为&nbsp;latin1&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">real_escape</span><span style="color: #007700">(</span><span style="color: #DD0000">"this&nbsp;will&nbsp;be&nbsp;escaped&nbsp;using&nbsp;latin1"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;执行语句，相当于实际连接建立，配置文件中的设定会导致&nbsp;mysqli&nbsp;对象中的字符集重新被设定位&nbsp;UTF8&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;'This&nbsp;connection&nbsp;will&nbsp;be&nbsp;set&nbsp;to&nbsp;server_charset&nbsp;upon&nbsp;establishing'&nbsp;AS&nbsp;_msg&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;这时进行设定，后面的相关默认字符集针对实际连接才被转换为&nbsp;latin1&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">set_charset</span><span style="color: #007700">(</span><span style="color: #DD0000">"latin1"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

       </div>
      </p>
     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.master-on-write">
      <code class="parameter">master_on_write</code>
      <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span>
     </dt>

     <dd>

      <p class="para">
       如果设定这个参数，那么插件将从第一次在 master 执行语句以后，将后面
       所有的语句发送给 master 执行。当然应用程序依然可以使用 SQL hints
       来让插件自动判断是否从 slave 执行相关语句。
      </p>
      <p class="para">
       这个设置是为了解决同步延迟问题的。如果应用程序执行了一条
       <em>INSERT</em> 语句，那么插件将默认将后面的所有操作，包括
       <em>SELECT</em> 语句发送到 master 执行。这样将有助于解决
       从 slave 服务器中查询没有完成 <em>INSETER</em> 同步的问题。
      </p>
      <p class="para">
       <div class="example" id="example-1858">
        <p><strong>Example #26 Master on write for consistent reads</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;master_on_write&quot;: 1
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       请注意，从 1.2.0-alpha 版本开始，<em>quality_of_service</em> 已经可以使用了。
       如果希望更好的完成这种控制，可以使用 <a href="mysqlnd-ms.qos-consistency.html" class="link">服务级别</a>
       来更好的控制。
      </p>
      <p class="para">
       所有的 <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.trx-stickiness" class="link">transaction stickiness</a> 设置，
       包括 <em>trx_stickiness=on</em> 将推翻 <em>master_on_write=1</em> 的设定。
      </p>
     </dd>

    
    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">
      <code class="parameter">trx_stickiness</code>
      <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
     </dt>

     <dd>

      <p class="para">
       事务控制策略，支持 <em>disabled</em> (默认)，<em>master</em>。
      </p>
      <p class="para">
       这个设置需要使用 PHP 5.4.0 以上版本，如果再以前的版本使用，将会叨叨类似下面
       <em>(mysqlnd_ms) trx_stickiness strategy is not supported before PHP 5.3.99</em>
       的一条警告信息。
      </p>
      <p class="para">
       如果没有设定这个参数，或者设置 <em>trx_stickiness=disabled</em>
       那么插件将不关心事务处理。这样在事务处理的中间，可能由于负载均衡而切换链接。
       为了避免这个情况，就必须使用 SQL hints 来暂时屏蔽连接切换。
      </p>
      <p class="para">
       从 PHP 5.4.0 版本开始，mysqlnd 允许插件通过 <em>set_autocommit()</em>
       函数监控 <em>autocommit</em> 的设定值。如果设置
       <em>set_stickiness=master</em> 并且 <em>autocommit</em> 被
       PHP MySQL 扩展通过 <em>set_autocommit()</em> 设置为禁用，插件就会认为
       事务处理已经开始了。这时，插件会停止负载均衡，将所有的语句发送给 master，
       直到 <em>autocommit</em> 被启用。当然整个过程中，不需要使用 SQL hints。
      </p>
      <p class="para">
       例如 <span class="function"><a href="mysqli.autocommit.html" class="function">mysqli_autocommit()</a></span> 会调用 <em>mysqlnd</em>
       内的 <em>set_autocommit()</em> 方法，控制 <em>autocommit</em>
       的状态。
      </p>
      <p class="para">
       当然，即使设定了 <em>trx_stickiness=master</em> 插件也无法监控到 SQL 语句
       当中 <em>SET AUTOCOMMIT=0</em> 或者 <em>BEGIN</em> 的使用。
      </p>
      <p class="para">
       从 PHP 5.5.0 版本开始，mysqlnd 库增加了控制事务处理的 C API。控制级别可以匹配 SQL
       语句中的的意图，<em>mysqlid</em> 使用这些嗲用的 API 被更改。这样，从
       1.5.0 版本开始，插件不仅仅可以监控 <span class="function"><a href="mysqli.autocommit.html" class="function">mysqli_autocommit()</a></span>，也可以
       监控<span class="function"><strong>mysqli_begin()</strong></span>，<span class="function"><a href="mysqli.commit.html" class="function">mysqli_commit()</a></span> 和 
       <span class="function"><a href="mysqli.rollback.html" class="function">mysqli_rollback()</a></span>。这就可以识别事务处理的边界，并且在执行事务处理
       过程中停止负载均衡。
      </p>
      <p class="para">
       <div class="example" id="example-1859">
        <p><strong>Example #27 使用 master 执行事务处理</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;trx_stickiness&quot;: &quot;master&quot;
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       从 1.5.0 版本开始，事务处理过程中自动的和沉默的错误处理被禁用。如果事务处理的边界
       被识别，事务处理控制被启动，如果服务器产生错误，无论配置中如何设定的错误处理策略，
       插件将不试图连接下一个服务器去处理故障，用户必须处理这种错误。根据配置文件的设定，
       插件可能发出一个 <em>E_WARNING</em> 级别的错误信息，类似
       <em>(mysqlnd_ms) Automatic failover is not permitted in the middle of a transaction</em>。
       并且错误可能被重写成
       <em>(mysqlnd_ms) No connection selected by the last filter</em>。
       这些错误也可能是由于失败的查询函数产生。
      </p>
      <p class="para">
       <div class="example" id="example-1860">
        <p><strong>Example #28 没有自动错误处理的错误处理</strong></p>
        <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;假设：配置了自动错误处理&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;设置插件内部状态&nbsp;in_trx&nbsp;=&nbsp;1&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">autocommit</span><span style="color: #007700">(</span><span style="color: #0000BB">false</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;假设：服务器错误&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;'Assume&nbsp;this&nbsp;query&nbsp;fails'&nbsp;AS&nbsp;_msg&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))&nbsp;{<br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;处理事务错误，插件内部状态依然是&nbsp;in_trx&nbsp;=&nbsp;1&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #FF8000">/*<br />&nbsp;&nbsp;如果使用&nbsp;autocommit()&nbsp;进行事务判断，那么必须调用&nbsp;autocommit(true)，<br />&nbsp;&nbsp;否则插件将假设目前还在事务处理过程中，依然禁止负载均衡。<br />&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">autocommit</span><span style="color: #007700">(</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;当然，你还可以开始一个新的事务处理&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">autocommit</span><span style="color: #007700">(</span><span style="color: #0000BB">false</span><span style="color: #007700">);<br />}<br /></span><span style="color: #FF8000">/*&nbsp;latin1&nbsp;used&nbsp;from&nbsp;now&nbsp;on&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">set_charset</span><span style="color: #007700">(</span><span style="color: #DD0000">"latin1"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

       </div>
      </p>
      <p class="para">
       如果再一个事务处理执行的过程中产生了服务器错误，那么插件将继续禁止
       连接切换，直到事务完成。应该重新调用 API 命令，让插件检测到事务处理边界。
       例如，你必须开启 autocommit 状态，这样插件就就能够继续继续负载均衡和
       连接切换。同样的，如果你如果还想执行一个新的事务，那么可以再次禁用
       autocommit 状态。
      </p>
      <p class="para">
       如果不处理错误，不使用 API 调用停止一个失败的事务，可能会引起类似下面的
       报警信息<em>Commands out of sync; you can&#039;t run this command now</em>。
       错误处理是非常必要的。
      </p>
     </dd>

    

    
     <dt id="ini.mysqlnd-ms-plugin-config-v2.transient_error">
       <code class="parameter">transient_error</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </dt>

     <dd>

      <p class="para">
       The setting has been introduced in 1.6.0.
      </p>
      <p class="para">
       A database cluster node may reply a transient error to a client. The client
       can then repeat the operation on the same node, fail over to a different node
       or abort the operation. Per definition is it safe for a client to
       retry the same operation on the same node before giving up.
      </p>
      <p class="para">
       <em>PECL/mysqlnd_ms</em> can perform the retry
       loop on behalf of the application.
       By configuring <em>transient_error</em> the plugin can be
       instructed to repeat operations failing with a certain error code for
       a certain maximum number of times with a pause between the retries.
       If the transient error disappears during loop execution, it is
       hidden from the application. Otherwise, the error is
       forwarded to the application by the end of the loop.
      </p>
      <p class="para">
       <div class="example" id="example-1861">
        <p><strong>Example #29 Retry loop for transient errors</strong></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
       },
       &quot;transient_error&quot;: {
          &quot;mysql_error_codes&quot;: [
            1297
          ],
          &quot;max_retries&quot;: 2,
          &quot;usleep_retry&quot;: 100
       }
    }
}</pre>
</div>
        </div>

      </div>
     </p>
      <table class="doctable informaltable">
       
        <col width="1*" />
        <col width="7*" />
        <col width="2*" />
        <thead>
         <tr>
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td>
           <em>mysql_error_codes</em>
          </td>
          <td>
           <p class="para">
            List of transient error codes. You may add any MySQL error code
            to the list. It is possible to consider any error as transient
            not only <em>1297</em>
            (<em>HY000 (ER_GET_TEMPORARY_ERRMSG),
            Message: Got temporary error %d &#039;%s&#039; from %s</em>).
            Before adding other codes but <em>1297</em> to the list,
            make sure your cluster supports a new attempt without impacting
            the state of your application.
           </p>
          </td>
          <td>Since 1.6.0.</td>
         </tr>

         <tr>
          <td>
           <em>max_retries</em>
          </td>
          <td>
           <p class="para">
            How often to retry an operation which
            fails with a transient error before forwarding the
            failure to the user.
           </p>
           <p class="para">
             Default: <em>1</em>
           </p>
          </td>
          <td>Since 1.6.0.</td>
         </tr>

         <tr>
          <td>
           <em>usleep_retry</em>
          </td>
          <td>
           <p class="para">
            Milliseconds to sleep between transient error retries.
            The value is passed to the C function <span class="function"><a href="function.usleep.html" class="function">usleep()</a></span>,
            hence the name.
           </p>
           <p class="para">
             Default: <em>100</em>
           </p>
          </td>
          <td>Since 1.6.0.</td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    

   </dl>

  </p>

</div><hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqlnd-ms.configuration.html">运行时配置</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqlnd-ms.plugin-ini-v1.html">Plugin configuration file (&lt;= 1.0.x)</a></div>
 <div class="up"><a href="mysqlnd-ms.setup.html">安装／配置</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
