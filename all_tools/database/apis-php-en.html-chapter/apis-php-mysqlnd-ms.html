<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Chapter 7 Mysqlnd replication and load balancing plugin</title>
<link rel="stylesheet" href="mvl.css" type="text/css" />
<meta name="generator" content="DocBook XSL Stylesheets + chunker.py v1.9.2" />
<link rel="start" href="index.html" title="{book-title}" />
<link rel="up" href="" title="" />
<link rel="prev" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver" />
<link rel="next" href="apis-php-mysqlnd-qc.html" title="Chapter 8 Mysqlnd query result cache plugin" />
<script language="javascript" type="text/javascript">
  function addOnload(theFunc)
  {
    var previous = window.onload;
    if (typeof window.onload != 'function')
    {
      window.onload = theFunc;
    }
    else
    {
      window.onload = function()
      {
        previous();
        theFunc();
      }
    }
  }

  addOnload(function()
  {
    var base = new Date(1463505695*1000);
    var now = new Date();
    var diff = ((now-base)/1000)/(24*3600);

    if (diff > 90) {
      var nodes = document.getElementsByClassName('titlepage');
      nodes[0].innerHTML = '<p style="border: 5px #ff0000 solid; padding: 5px; margin 5px">' +
        'This copy of the manual is more than 90 days old. We encourage you to download a ' +
        'new version from <a href="http://dev.mysql.com">dev.mysql.com/doc</a>.</p>' + nodes[0].innerHTML;
    }
  });
</script>
<noscript></noscript>
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr>
<th colspan="3" align="center">Chapter 7 Mysqlnd replication and load balancing plugin</th>
</tr>
<tr>
<td width="20%" align="left"><a accesskey="p" href="apis-php-mysqlnd.html">Prev</a> </td>
<th width="60%" align="center"></th>
<td width="20%" align="right"> <a accesskey="n" href="apis-php-mysqlnd-qc.html">Next</a></td>
</tr>
</table>
<hr>
</div>
<div class="chapter">
<div class="titlepage">
<div>
<div>
<h1 class="title"><a name="apis-php-mysqlnd-ms"></a>Chapter 7 Mysqlnd replication and load balancing plugin</h1>

</div>

</div>

</div>
<div class="toc">
<p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.key-features">7.1 Key Features</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.limitations">7.2 Limitations</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.name">7.3 On the name</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart">7.4 Quickstart and Examples</a></span></dt><dd><dl><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.configuration">7.4.1 Setup</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.usage">7.4.2 Running statements</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.connectionpooling">7.4.3 Connection state</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.sqlhints">7.4.4 SQL Hints</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.transactions">7.4.5 Local transactions</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.xa_transactions">7.4.6 XA/Distributed Transactions</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.qos-consistency">7.4.7 Service level and consistency</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.gtid">7.4.8 Global transaction IDs</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.cache">7.4.9 Cache integration</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.failover">7.4.10 Failover</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.partitioning">7.4.11 Partitioning and Sharding</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.mysql_fabric">7.4.12 MySQL Fabric</a></span></dt></dl></dd><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.concepts">7.5 Concepts</a></span></dt><dd><dl><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.architecture">7.5.1 Architecture</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.pooling">7.5.2 Connection pooling and switching</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transaction">7.5.3 Local transaction handling</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.errorhandling">7.5.4 Error handling</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transient_errors">7.5.5 Transient errors</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.failover">7.5.6 Failover</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.loadbalancing">7.5.7 Load balancing</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.rwsplit">7.5.8 Read-write splitting</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.filter">7.5.9 Filter</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.qos-consistency">7.5.10 Service level and consistency</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid">7.5.11 Global transaction IDs</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.concept_cache">7.5.12 Cache integration</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.supportedclusters">7.5.13 Supported clusters</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.concept_xa_trx">7.5.14 XA/Distributed transactions</a></span></dt></dl></dd><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.setup">7.6 Installing/Configuring</a></span></dt><dd><dl><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.requirements">7.6.1 Requirements</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.installation">7.6.2 Installation</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration">7.6.3 Runtime Configuration</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json">7.6.4 Plugin configuration file (&gt;=1.1.x)</a></span></dt></dl></dd><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.constants">7.7 Predefined Constants</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-ref.mysqlnd-ms">7.8 Mysqlnd_ms Functions</a></span></dt><dd><dl><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-dump-servers">7.8.1 <code class="literal">mysqlnd_ms_dump_servers</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-global">7.8.2 <code class="literal">mysqlnd_ms_fabric_select_global</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-shard">7.8.3 <code class="literal">mysqlnd_ms_fabric_select_shard</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid">7.8.4 <code class="literal">mysqlnd_ms_get_last_gtid</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-used-connection">7.8.5 <code class="literal">mysqlnd_ms_get_last_used_connection</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats">7.8.6 <code class="literal">mysqlnd_ms_get_stats</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-match-wild">7.8.7 <code class="literal">mysqlnd_ms_match_wild</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-query-is-select">7.8.8 <code class="literal">mysqlnd_ms_query_is_select</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos">7.8.9 <code class="literal">mysqlnd_ms_set_qos</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server">7.8.10 <code class="literal">mysqlnd_ms_set_user_pick_server</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin">7.8.11 <code class="literal">mysqlnd_ms_xa_begin</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit">7.8.12 <code class="literal">mysqlnd_ms_xa_commit</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-gc">7.8.13 <code class="literal">mysqlnd_ms_xa_gc</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-rollback">7.8.14 <code class="literal">mysqlnd_ms_xa_rollback</code></a></span></dt></dl></dd><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes">7.9 Change History</a></span></dt><dd><dl><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-six">7.9.1 PECL/mysqlnd_ms 1.6 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-five">7.9.2 PECL/mysqlnd_ms 1.5 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-four">7.9.3 PECL/mysqlnd_ms 1.4 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-three">7.9.4 PECL/mysqlnd_ms 1.3 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-two">7.9.5 PECL/mysqlnd_ms 1.2 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-one">7.9.6 PECL/mysqlnd_ms 1.1 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-o">7.9.7 PECL/mysqlnd_ms 1.0 series</a></span></dt></dl></dd></dl>
</div>
<p>
    <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
    Documentation Group.</a>
  </p><p>
    The mysqlnd replication and load balancing plugin
    (<code class="literal">mysqlnd_ms</code>) adds easy to use MySQL replication
    support to all PHP MySQL extensions that use
    <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a>.
  </p><p>
    As of version PHP 5.3.3 the MySQL native driver for PHP
    (<code class="literal">mysqlnd</code>) features an internal plugin C API. C
    plugins, such as the replication and load balancing plugin, can
    extend the functionality of
    <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a>.
  </p><p>
    The MySQL native driver for PHP is a C library that ships together
    with PHP as of PHP 5.3.0. It serves as a drop-in replacement for the
    MySQL Client Library (libmysqlclient). Using mysqlnd has several
    advantages: no extra downloads are required because it's
    bundled with PHP, it's under the PHP license, there is lower
    memory consumption in certain cases, and it contains new
    functionality such as asynchronous queries.
  </p><p>
    Mysqlnd plugins like <code class="literal">mysqlnd_ms</code> operate, for the
    most part, transparently from a user perspective. The replication
    and load balancing plugin supports all PHP applications, and all
    MySQL PHP extensions. It does not change existing APIs. Therefore,
    it can easily be used with existing PHP applications.
</p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-mysqlnd-ms.key-features"></a>7.1 Key Features</h2>
</div>
</div>
</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
    </p><p>
      The key features of PECL/mysqlnd_ms are as follows.
    </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Transparent and therefore easy to use.
          </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  Supports all of the PHP MySQL extensions.
                </p></li><li class="listitem"><p>
                  SSL support.
                </p></li><li class="listitem"><p>
                  A consistent <acronym class="acronym">API</acronym>.
                </p></li><li class="listitem"><p>
                  Little to no application changes required, dependent
                  on the required usage scenario.
                </p></li><li class="listitem"><p>
                  Lazy connections: connections to master and slave
                  servers are not opened before a SQL statement is
                  executed.
                </p></li><li class="listitem"><p>
                  Optional: automatic use of master after the first
                  write in a web request, to lower the possible impact
                  of replication lag.
</p></li></ul>
</div>
<p>
          </p></li><li class="listitem"><p>
            Can be used with any MySQL clustering solution.
          </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  MySQL Replication: Read-write splitting is done by the
                  plugin. Primary focus of the plugin.
                </p></li><li class="listitem"><p>
                  MySQL Cluster: Read-write splitting can be disabled.
                  Configuration of multiple masters possible
                </p></li><li class="listitem"><p>
                  Third-party solutions: the plugin is optimized for
                  MySQL Replication but can be used with any other kind
                  of MySQL clustering solution.
</p></li></ul>
</div>
<p>
          </p></li><li class="listitem"><p>
            Featured read-write split strategies
          </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  Automatic detection of SELECT.
                </p></li><li class="listitem"><p>
                  Supports SQL hints to overrule automatism.
                </p></li><li class="listitem"><p>
                  User-defined.
                </p></li><li class="listitem"><p>
                  Can be disabled for, for example, when using
                  synchronous clusters such as MySQL Cluster.
</p></li></ul>
</div>
<p>
          </p></li><li class="listitem"><p>
            Featured load balancing strategies
          </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  Round Robin: choose a different slave in round-robin
                  fashion for every slave request.
                </p></li><li class="listitem"><p>
                  Random: choose a random slave for every slave request.
                </p></li><li class="listitem"><p>
                  Random once (sticky): choose a random slave once to
                  run all slave requests for the duration of a web
                  request.
                </p></li><li class="listitem"><p>
                  User-defined. The application can register callbacks
                  with mysqlnd_ms.
                </p></li><li class="listitem"><p>
                  PHP 5.4.0 or newer: transaction aware when using API
                  calls only to control transactions.
                </p></li><li class="listitem"><p>
                  Weighted load balancing: servers can be assigned
                  different priorities, for example, to direct more
                  requests to a powerful machine than to another less
                  powerful machine. Or, to prefer nearby machines to
                  reduce latency.
</p></li></ul>
</div>
<p>
          </p></li><li class="listitem"><p>
            Global transaction ID
          </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  Client-side emulation. Makes manual master server
                  failover and slave promotion easier with asynchronous
                  clusters, such as MySQL Replication.
                </p></li><li class="listitem"><p>
                  Support for built-in global transaction identifier
                  feature of MySQL 5.6.5 or newer.
                </p></li><li class="listitem"><p>
                  Supports using transaction ids to identify up-to-date
                  asynchronous slaves for reading when session
                  consistency is required. Please, note the restrictions
                  mentioned in the manual.
                </p></li><li class="listitem"><p>
                  Throttling: optionally, the plugin can wait for a
                  slave to become "synchronous" before
                  continuing.
</p></li></ul>
</div>
<p>
          </p></li><li class="listitem"><p>
            Service and consistency levels
          </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  Applications can request eventual, session and strong
                  consistency service levels for connections.
                  Appropriate cluster nodes will be searched
                  automatically.
                </p></li><li class="listitem"><p>
                  Eventual consistent MySQL Replication slave accesses
                  can be replaced with fast local cache accesses
                  transparently to reduce server load.
</p></li></ul>
</div>
<p>
          </p></li><li class="listitem"><p>
            Partitioning and sharding
          </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  Servers of a replication cluster can be organized into
                  groups. SQL hints can be used to manually direct
                  queries to a specific group. Grouping can be used to
                  partition (shard) the data, or to cure the issue of
                  hotspots with updates.
                </p></li><li class="listitem"><p>
                  MySQL Replication filters are supported through the
                  table filter.
</p></li></ul>
</div>
<p>
          </p></li><li class="listitem"><p>
            MySQL Fabric
          </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.mysql_fabric" title="7.4.12 MySQL Fabric">Experimental
                  support</a> for MySQL Fabric is included.
</p></li></ul>
</div>
<p>
</p></li></ul>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-mysqlnd-ms.limitations"></a>7.2 Limitations</h2>

</div>

</div>

</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
    </p><p>
      The built-in read-write-split mechanism is very basic. Every query
      which starts with <code class="literal">SELECT</code> is considered a read
      request to be sent to a MySQL slave server. All other queries
      (such as <code class="literal">SHOW</code> statements) are considered as
      write requests that are sent to the MySQL master server. The
      build-in behavior can be overruled using
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.constants" title="7.7 Predefined Constants">SQL hints</a>, or
      a user-defined
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-user">callback
      function</a>.
    </p><p>
      The read-write splitter is not aware of multi-statements.
      Multi-statements are considered as one statement. The decision of
      where to run the statement will be based on the beginning of the
      statement string. For example, if using
      <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.multi-query" title="3.9.34 mysqli::multi_query, mysqli_multi_query"><code class="function">mysqli_multi_query</code></a>
      to execute the multi-statement <code class="literal">SELECT id FROM test ;
      INSERT INTO test(id) VALUES (1)</code>, the statement will be
      redirected to a slave server because it begins with
      <code class="literal">SELECT</code>. The <code class="literal">INSERT</code>
      statement, which is also part of the multi-statement, will not be
      redirected to a master server.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
        Applications must be aware of the consequences of connection
        switches that are performed for load balancing purposes. Please
        check the documentation on
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.pooling" title="7.5.2 Connection pooling and switching">connection pooling
        and switching</a>,
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transaction" title="7.5.3 Local transaction handling">transaction
        handling</a>,
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.failover" title="7.5.6 Failover">failover</a>
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.loadbalancing" title="7.5.7 Load balancing">load
        balancing</a> and
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.rwsplit" title="7.5.8 Read-write splitting">read-write
        splitting</a>.
</p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-mysqlnd-ms.name"></a>7.3 On the name</h2>

</div>

</div>

</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
    </p><p>
      The shortcut <code class="literal">mysqlnd_ms</code> stands for
      <code class="literal">mysqlnd master slave plugin</code>. The name was
      chosen for a quick-and-dirty proof-of-concept. In the beginning
      the developers did not expect to continue using the code base.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-mysqlnd-ms.quickstart"></a>7.4 Quickstart and Examples</h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.configuration">7.4.1 Setup</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.usage">7.4.2 Running statements</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.connectionpooling">7.4.3 Connection state</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.sqlhints">7.4.4 SQL Hints</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.transactions">7.4.5 Local transactions</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.xa_transactions">7.4.6 XA/Distributed Transactions</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.qos-consistency">7.4.7 Service level and consistency</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.gtid">7.4.8 Global transaction IDs</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.cache">7.4.9 Cache integration</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.failover">7.4.10 Failover</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.partitioning">7.4.11 Partitioning and Sharding</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.mysql_fabric">7.4.12 MySQL Fabric</a></span></dt></dl>
</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
    </p><p>
      The mysqlnd replication load balancing plugin is easy to use. This
      quickstart will demo typical use-cases, and provide practical
      advice on getting started.
    </p><p>
      It is strongly recommended to read the reference sections in
      addition to the quickstart. The quickstart tries to avoid
      discussing theoretical concepts and limitations. Instead, it will
      link to the reference sections. It is safe to begin with the
      quickstart. However, before using the plugin in mission critical
      environments we urge you to read additionally the background
      information from the reference sections.
    </p><p>
      The focus is on using PECL mysqlnd_ms for work with an
      asynchronous MySQL cluster, namely MySQL replication. Generally
      speaking an asynchronous cluster is more difficult to use than a
      synchronous one. Thus, users of, for example, MySQL Cluster will
      find more information than needed.
</p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.configuration"></a>7.4.1 Setup</h3>
</div>
</div>
</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        The plugin is implemented as a PHP extension. See also the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.installation" title="7.6.2 Installation">installation
        instructions</a> to install the
        <a class="ulink" href="http://pecl.php.net/package/mysqlnd_ms" target="_top">PECL/mysqlnd_ms</a>
        extension.
      </p><p>
        Compile or configure the PHP MySQL extension (API)
        (<a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
        <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>,
        <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a>) that you plan
        to use with support for the
        <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> library.
        PECL/mysqlnd_ms is a plugin for the mysqlnd library. To use the
        plugin with any of the PHP MySQL extensions, the extension has
        to use the mysqlnd library.
      </p><p>
        Then, load the extension into PHP and activate the plugin in the
        PHP configuration file using the PHP configuration directive
        named
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.enable">mysqlnd_ms.enable</a>.
      </p><p>
</p>
<div class="example">
<a name="idm139660446212000"></a><p class="title"><b>Example 7.1 Enabling the plugin (php.ini)</b></p>
<div class="example-contents">
<pre class="programlisting">

mysqlnd_ms.enable=1
mysqlnd_ms.config_file=/path/to/mysqlnd_ms_plugin.ini

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The plugin uses its own configuration file. Use the PHP
        configuration directive
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.config-file">mysqlnd_ms.config_file</a>
        to set the full file path to the plugin-specific configuration
        file. This file must be readable by PHP (e.g., the web server
        user). Please note, the configuration directive
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.config-file">mysqlnd_ms.config_file</a>
        superseeds
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.ini-file">mysqlnd_ms.ini_file</a>
        since 1.4.0. It is a common pitfall to use the old, no longer
        available configuration directive.
      </p><p>
        Create a plugin-specific configuration file. Save the file to
        the path set by the PHP configuration directive
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.config-file">mysqlnd_ms.config_file</a>.
      </p><p>
        The plugins
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json" title="7.6.4 Plugin configuration file (&gt;=1.1.x)">configuration
        file</a> is <acronym class="acronym">JSON</acronym> based. It is divided into
        one or more sections. Each section has a name, for example,
        <code class="literal">myapp</code>. Every section makes its own set of
        configuration settings.
      </p><p>
        A section must, at a minimum, list the MySQL replication master
        server, and set a list of slaves. The plugin supports using only
        one master server per section. Multi-master MySQL replication
        setups are not yet fully supported. Use the configuration
        setting
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.master">master</a>
        to set the hostname, and the port or socket of the MySQL master
        server. MySQL slave servers are configured using the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.slave">slave</a>
        keyword.
      </p><p>
</p>
<div class="example">
<a name="idm139660446198944"></a><p class="title"><b>Example 7.2 Minimal plugin-specific configuration file (mysqlnd_ms_plugin.ini)</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": [

        ]
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Configuring a MySQL slave server list is required, although it
        may contain an empty list. It is recommended to always configure
        at least one slave server.
      </p><p>
        Server lists can use
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.server-list-syntax">
        anonymous or non-anonymous syntax</a>. Non-anonymous lists
        include alias names for the servers, such as
        <code class="literal">master_0</code> for the master in the above example.
        The quickstart uses the more verbose non-anonymous syntax.
      </p><p>
</p>
<div class="example">
<a name="idm139660446193920"></a><p class="title"><b>Example 7.3 Recommended minimal plugin-specific config (mysqlnd_ms_plugin.ini)</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.27",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        If there are at least two servers in total, the plugin can start
        to load balance and switch connections. Switching connections is
        not always transparent and can cause issues in certain cases.
        The reference sections about
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.pooling" title="7.5.2 Connection pooling and switching">connection pooling
        and switching</a>,
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transaction" title="7.5.3 Local transaction handling">transaction
        handling</a>,
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.failover" title="7.5.6 Failover">fail over</a>
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.loadbalancing" title="7.5.7 Load balancing">load
        balancing</a> and
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.rwsplit" title="7.5.8 Read-write splitting">read-write
        splitting</a> all provide more details. And potential
        pitfalls are described later in this guide.
      </p><p>
        It is the responsibility of the application to handle potential
        issues caused by connection switches, by configuring a master
        with at least one slave server, which allows switching to work
        therefore related problems can be found.
      </p><p>
        The MySQL master and MySQL slave servers, which you configure,
        do not need to be part of MySQL replication setup. For testing
        purpose you can use single MySQL server and make it known to the
        plugin as a master and slave server as shown below. This could
        help you to detect many potential issues with connection
        switches. However, such a setup will not be prone to the issues
        caused by replication lag.
      </p><p>
</p>
<div class="example">
<a name="idm139660446185072"></a><p class="title"><b>Example 7.4 Using one server as a master and as a slave (testing only!)</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The plugin attempts to notify you of invalid configurations.
        Since 1.5.0 it will throw a warning during PHP startup if the
        configuration file cannot be read, is empty or parsing the JSON
        failed. Depending on your PHP settings those errors may appear
        in some log files only. Further validation is done when a
        connection is to be established and the configuration file is
        searched for valid sections. Setting
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.force-config-usage">mysqlnd_ms.force_config_usage</a>
        may help debugging a faulty setup. Please, see also
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.debug_config">configuration
        file debugging notes</a>.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.usage"></a>7.4.2 Running statements</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        The plugin can be used with any PHP MySQL extension
        (<a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
        <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a>, and
        <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>) that is
        compiled to use the
        <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> library.
        <code class="literal">PECL/mysqlnd_ms</code> plugs into the
        <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> library. It does
        not change the API or behavior of those extensions.
      </p><p>
        Whenever a connection to MySQL is being opened, the plugin
        compares the host parameter value of the connect call, with the
        section names from the plugin specific configuration file. If,
        for example, the plugin specific configuration file has a
        section <code class="literal">myapp</code> then the section should be
        referenced by opening a MySQL connection to the host
        <code class="literal">myapp</code>
      </p><p>
</p>
<div class="example">
<a name="idm139660446169648"></a><p class="title"><b>Example 7.5 Plugin specific configuration file (mysqlnd_ms_plugin.ini)</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.27",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660446167424"></a><p class="title"><b>Example 7.6 Opening a load balanced connection</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
/* Load balanced following "myapp" section rules from the plugins config file */
$mysqli = new mysqli("myapp", "username", "password", "database");
$pdo = new PDO('mysql:host=myapp;dbname=database', 'username', 'password');
$mysql = mysql_connect("myapp", "username", "password");
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The connection examples above will be load balanced. The plugin
        will send read-only statements to the MySQL slave server with
        the IP <code class="literal">192.168.2.27</code> and will listen on port
        <code class="literal">3306</code> for the MySQL client connection. All
        other statements will be directed to the MySQL master server
        running on the host <code class="literal">localhost</code>. If on Unix
        like operating systems, the master on
        <code class="literal">localhost</code> will be accepting MySQL client
        connections on the Unix domain socket
        <code class="literal">/tmp/mysql.sock</code>, while TCP/IP is the default
        port on Windows. The plugin will use the user name
        <code class="literal">username</code> and the password
        <code class="literal">password</code> to connect to any of the MySQL
        servers listed in the section <code class="literal">myapp</code> of the
        plugins configuration file. Upon connect, the plugin will select
        <code class="literal">database</code> as the current schemata.
      </p><p>
        The username, password and schema name are taken from the
        connect API calls and used for all servers. In other words: you
        must use the same username and password for every MySQL server
        listed in a plugin configuration file section. The is not a
        general limitation. As of <code class="literal">PECL/mysqlnd_ms</code>
        1.1.0, it is possible to set the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.server-config-keywords">username</a>
        and
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.server-config-keywords">password</a>
        for any server in the plugins configuration file, to be used
        instead of the credentials passed to the API call.
      </p><p>
        The plugin does not change the API for running statements.
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.rwsplit" title="7.5.8 Read-write splitting">Read-write
        splitting</a> works out of the box. The following example
        assumes that there is no significant replication lag between the
        master and the slave.
      </p><p>
</p>
<div class="example">
<a name="idm139660446152240"></a><p class="title"><b>Example 7.7 Executing statements</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
/* Load balanced following "myapp" section rules from the plugins config file */
$mysqli = new mysqli("myapp", "username", "password", "database");
if (mysqli_connect_errno()) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Statements will be run on the master */
if (!$mysqli-&gt;query("DROP TABLE IF EXISTS test")) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}
if (!$mysqli-&gt;query("CREATE TABLE test(id INT)")) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}
if (!$mysqli-&gt;query("INSERT INTO test(id) VALUES (1)")) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}

/* read-only: statement will be run on a slave */
if (!($res = $mysqli-&gt;query("SELECT id FROM test"))) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
} else {
    $row = $res-&gt;fetch_assoc();
    $res-&gt;close();
    printf("Slave returns id = '%s'\n", $row['id']);
}
$mysqli-&gt;close();
?&gt;

    </pre><p>
            The above example will output something similar to:
          </p><pre class="screen">

Slave returns id = '1'

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.connectionpooling"></a>7.4.3 Connection state</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        The plugin changes the semantics of a PHP MySQL connection
        handle. A new connection handle represents a connection pool,
        instead of a single MySQL client-server network connection. The
        connection pool consists of a master connection, and optionally
        any number of slave connections.
      </p><p>
        Every connection from the connection pool has its own state. For
        example, SQL user variables, temporary tables and transactions
        are part of the state. For a complete list of items that belong
        to the state of a connection, see the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.pooling" title="7.5.2 Connection pooling and switching">connection pooling
        and switching</a> concepts documentation. If the plugin
        decides to switch connections for load balancing, the
        application could be given a connection which has a different
        state. Applications must be made aware of this.
      </p><p>
</p>
<div class="example">
<a name="idm139660446142496"></a><p class="title"><b>Example 7.8 Plugin config with one slave and one master</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.27",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660446140288"></a><p class="title"><b>Example 7.9 Pitfall: connection state and SQL user variables</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Connection 1, connection bound SQL user variable, no SELECT thus run on master */
if (!$mysqli-&gt;query("SET @myrole='master'")) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}

/* Connection 2, run on slave because SELECT */
if (!($res = $mysqli-&gt;query("SELECT @myrole AS _role"))) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
} else {
    $row = $res-&gt;fetch_assoc();
    $res-&gt;close();
    printf("@myrole = '%s'\n", $row['_role']);
}
$mysqli-&gt;close();
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

@myrole = ''

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The example opens a load balanced connection and executes two
        statements. The first statement <code class="literal">SET
        @myrole='master'</code> does not begin with the
        string <code class="literal">SELECT</code>. Therefore the plugin does not
        recognize it as a read-only query which shall be run on a slave.
        The plugin runs the statement on the connection to the master.
        The statement sets a SQL user variable which is bound to the
        master connection. The state of the master connection has been
        changed.
      </p><p>
        The next statement is <code class="literal">SELECT @myrole AS
        _role</code>. The plugin does recognize it as a read-only
        query and sends it to the slave. The statement is run on a
        connection to the slave. This second connection does not have
        any SQL user variables bound to it. It has a different state
        than the first connection to the master. The requested SQL user
        variable is not set. The example script prints <code class="literal">@myrole
        = ''</code>.
      </p><p>
        It is the responsibility of the application developer to take
        care of the connection state. The plugin does not monitor all
        connection state changing activities. Monitoring all possible
        cases would be a very CPU intensive task, if it could be done at
        all.
      </p><p>
        The pitfalls can easily be worked around using SQL hints.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.sqlhints"></a>7.4.4 SQL Hints</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        SQL hints can force a query to choose a specific server from the
        connection pool. It gives the plugin a hint to use a designated
        server, which can solve issues caused by connection switches and
        connection state.
      </p><p>
        SQL hints are standard compliant SQL comments. Because SQL
        comments are supposed to be ignored by SQL processing systems,
        they do not interfere with other programs such as the MySQL
        Server, the MySQL Proxy, or a firewall.
      </p><p>
        Three SQL hints are supported by the plugin: The
        <code class="constant">MYSQLND_MS_MASTER_SWITCH</code> hint makes the
        plugin run a statement on the master,
        <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code> enforces the use of
        the slave, and <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code>
        will run a statement on the same server that was used for the
        previous statement.
      </p><p>
        The plugin scans the beginning of a statement for the existence
        of an SQL hint. SQL hints are only recognized if they appear at
        the beginning of the statement.
      </p><p>
</p>
<div class="example">
<a name="idm139660446123712"></a><p class="title"><b>Example 7.10 Plugin config with one slave and one master</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.27",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660446121504"></a><p class="title"><b>Example 7.11 SQL hints to prevent connection switches</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (mysqli_connect_errno()) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Connection 1, connection bound SQL user variable, no SELECT thus run on master */
if (!$mysqli-&gt;query("SET @myrole='master'")) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}

/* Connection 1, run on master because of SQL hint */
if (!($res = $mysqli-&gt;query(sprintf("/*%s*/SELECT @myrole AS _role", MYSQLND_MS_LAST_USED_SWITCH)))) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
} else {
    $row = $res-&gt;fetch_assoc();
    $res-&gt;close();
    printf("@myrole = '%s'\n", $row['_role']);
}
$mysqli-&gt;close();
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

@myrole = 'master'

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        In the above example, using
        <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code> prevents
        session switching from the master to a slave when running the
        <code class="literal">SELECT</code> statement.
      </p><p>
        SQL hints can also be used to run <code class="literal">SELECT</code>
        statements on the MySQL master server. This may be desired if
        the MySQL slave servers are typically behind the master, but you
        need current data from the cluster.
      </p><p>
        In version 1.2.0 the concept of a service level has been
        introduced to address cases when current data is required. Using
        a service level requires less attention and removes the need of
        using SQL hints for this use case. Please, find more information
        below in the service level and consistency section.
      </p><p>
</p>
<div class="example">
<a name="idm139660446113232"></a><p class="title"><b>Example 7.12 Fighting replication lag</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Force use of master, master has always fresh and current data */
if (!$mysqli-&gt;query(sprintf("/*%s*/SELECT critical_data FROM important_table", MYSQLND_MS_MASTER_SWITCH))) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        A use case may include the creation of tables on a slave. If an
        SQL hint is not given, then the plugin will send
        <code class="literal">CREATE</code> and <code class="literal">INSERT</code>
        statements to the master. Use the SQL hint
        <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code> if you want to run
        any such statement on a slave, for example, to build temporary
        reporting tables.
      </p><p>
</p>
<div class="example">
<a name="idm139660446108144"></a><p class="title"><b>Example 7.13 Table creation on a slave</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Force use of slave */
if (!$mysqli-&gt;query(sprintf("/*%s*/CREATE TABLE slave_reporting(id INT)", MYSQLND_MS_SLAVE_SWITCH))) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}
/* Continue using this particular slave connection */
if (!$mysqli-&gt;query(sprintf("/*%s*/INSERT INTO slave_reporting(id) VALUES (1), (2), (3)", MYSQLND_MS_LAST_USED_SWITCH))) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}
/* Don't use MYSQLND_MS_SLAVE_SWITCH which would allow switching to another slave! */
if ($res = $mysqli-&gt;query(sprintf("/*%s*/SELECT COUNT(*) AS _num FROM slave_reporting", MYSQLND_MS_LAST_USED_SWITCH))) {
    $row = $res-&gt;fetch_assoc();
    $res-&gt;close();
    printf("There are %d rows in the table 'slave_reporting'", $row['_num']);
} else {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}
$mysqli-&gt;close();
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The SQL hint <code class="constant">MYSQLND_MS_LAST_USED</code> forbids
        switching a connection, and forces use of the previously used
        connection.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.transactions"></a>7.4.5 Local transactions</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        The current version of the plugin is not transaction safe by
        default, because it is not aware of running transactions in all
        cases. SQL transactions are units of work to be run on a single
        server. The plugin does not always know when the unit of work
        starts and when it ends. Therefore, the plugin may decide to
        switch connections in the middle of a transaction.
      </p><p>
        No kind of MySQL load balancer can detect transaction boundaries
        without any kind of hint from the application.
      </p><p>
        You can either use SQL hints to work around this limitation.
        Alternatively, you can activate transaction API call monitoring.
        In the latter case you must use API calls only to control
        transactions, see below.
      </p><p>
</p>
<div class="example">
<a name="idm139660446099280"></a><p class="title"><b>Example 7.14 Plugin config with one slave and one master</b></p>
<div class="example-contents">
<pre class="programlisting">

[myapp]
{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.27",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660446097152"></a><p class="title"><b>Example 7.15 Using SQL hints for transactions</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Not a SELECT, will use master */
if (!$mysqli-&gt;query("START TRANSACTION")) {
    /* Please use better error handling in your code */
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Prevent connection switch! */
if (!$mysqli-&gt;query(sprintf("/*%s*/INSERT INTO test(id) VALUES (1)", MYSQLND_MS_LAST_USED_SWITCH))) {
    /* Please do proper ROLLBACK in your code, don't just die */
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
if ($res = $mysqli-&gt;query(sprintf("/*%s*/SELECT COUNT(*) AS _num FROM test", MYSQLND_MS_LAST_USED_SWITCH))) {
    $row = $res-&gt;fetch_assoc();
    $res-&gt;close();
    if ($row['_num'] &gt; 1000) {
        if (!$mysqli-&gt;query(sprintf("/*%s*/INSERT INTO events(task) VALUES ('cleanup')", MYSQLND_MS_LAST_USED_SWITCH))) {
            die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
        }
    }
} else {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
if (!$mysqli-&gt;query(sprintf("/*%s*/UPDATE log SET last_update = NOW()", MYSQLND_MS_LAST_USED_SWITCH))) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
if (!$mysqli-&gt;query(sprintf("/*%s*/COMMIT", MYSQLND_MS_LAST_USED_SWITCH))) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

$mysqli-&gt;close();
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Starting with PHP 5.4.0, the <code class="literal">mysqlnd</code> library
        allows the plugin to monitor the status of the
        <code class="literal">autocommit</code> mode, if the mode is set by API
        calls instead of using SQL statements such as <code class="literal">SET
        AUTOCOMMIT=0</code>. This makes it possible for the plugin to
        become transaction aware. In this case, you do not need to use
        SQL hints.
      </p><p>
        If using PHP 5.4.0 or newer, API calls that enable
        <code class="literal">autocommit</code> mode, and when setting the plugin
        configuration option
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">trx_stickiness=master</a>,
        the plugin can automatically disable load balancing and
        connection switches for SQL transactions. In this configuration,
        the plugin stops load balancing if <code class="literal">autocommit</code>
        is disabled and directs all statements to the master. This
        prevents connection switches in the middle of a transaction.
        Once <code class="literal">autocommit</code> is re-enabled, the plugin
        starts to load balance statements again.
      </p><p>
        API based transaction boundary detection has been improved with
        PHP 5.5.0 and <code class="literal">PECL/mysqlnd_ms</code> 1.5.0 to cover
        not only calls to
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.autocommit" title="3.9.2 mysqli::autocommit, mysqli_autocommit"><code class="function">mysqli_autocommit</code></a>
        but also
        <a class="ulink" href="http://www.php.net/mysqli_begin" target="_top"><code class="function">mysqli_begin</code></a>,
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.commit" title="3.9.9 mysqli::commit, mysqli_commit"><code class="function">mysqli_commit</code></a>
        and
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.rollback" title="3.9.47 mysqli::rollback, mysqli_rollback"><code class="function">mysqli_rollback</code></a>.
      </p><p>
</p>
<div class="example">
<a name="idm139660446079136"></a><p class="title"><b>Example 7.16 Transaction aware load balancing: trx_stickiness setting</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        },
        "trx_stickiness": "master"
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660446076880"></a><p class="title"><b>Example 7.17 Transaction aware</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Disable autocommit, plugin will run all statements on the master */
$mysqli-&gt;autocommit(false);

if (!$mysqli-&gt;query("INSERT INTO test(id) VALUES (1)")) {
    /* Please do proper ROLLBACK in your code, don't just die */
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
if ($res = $mysqli-&gt;query("SELECT COUNT(*) AS _num FROM test")) {
    $row = $res-&gt;fetch_assoc();
    $res-&gt;close();
    if ($row['_num'] &gt; 1000) {
        if (!$mysqli-&gt;query("INSERT INTO events(task) VALUES ('cleanup')")) {
            die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
        }
    }
} else {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
if (!$mysqli-&gt;query("UPDATE log SET last_update = NOW()")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
if (!$mysqli-&gt;commit()) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Plugin assumes that the transaction has ended and starts load balancing again */
$mysqli-&gt;autocommit(true);
$mysqli-&gt;close();
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          The plugin configuration option
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">trx_stickiness=master</a>
          requires PHP 5.4.0 or newer.
</p>
</div>
<p>
        Please note the restrictions outlined in the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transaction" title="7.5.3 Local transaction handling">transaction
        handling</a> concepts section.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.xa_transactions"></a>7.4.6 XA/Distributed Transactions</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          XA related functions have been introduced in PECL mysqlnd_ms
          version 1.6.0-alpha.
</p>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title">
Early adaptors wanted
</div>
<p>
          The feature is currently under development. There may be
          issues and/or feature limitations. Do not use in production
          environments, although early lab tests indicate reasonable
          quality.
        </p><p>
          Please, contact the development team if you are interested in
          this feature. We are looking for real life feedback to
          complement the feature.
</p>
</div>
<p>
        XA transactions are a standardized method for executing
        transactions across multiple resources. Those resources can be
        databases or other transactional systems. The MySQL server
        supports XA SQL statements which allows users to carry out a
        distributed SQL transaction that spawns multiple database
        servers or any kind as long as they support the SQL statements
        too. In such a scenario it is in the responsibility of the user
        to coordinate the participating servers.
      </p><p>
        <code class="literal">PECL/mysqlnd_ms</code> can act as a transaction
        coordinator for a global (distributed, XA) transaction carried
        out on MySQL servers only. As a transaction coordinator, the
        plugin tracks all servers involved in a global transaction and
        transparently issues appropriate SQL statements on the
        participants. The global transactions are controlled with
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin" title="7.8.11 mysqlnd_ms_xa_begin"><code class="function">mysqlnd_ms_xa_begin</code></a>,
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit" title="7.8.12 mysqlnd_ms_xa_commit"><code class="function">mysqlnd_ms_xa_commit</code></a>
        and
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-rollback" title="7.8.14 mysqlnd_ms_xa_rollback"><code class="function">mysqlnd_ms_xa_rollback</code></a>.
        SQL details are mostly hidden from the application as is the
        need to track and coordinate participants.
      </p><p>
</p>
<div class="example">
<a name="idm139660446057520"></a><p class="title"><b>Example 7.18 General pattern for XA transactions</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* start a global transaction */
$gtrid_id = "12345";
if (!mysqlnd_ms_xa_begin($mysqli, $gtrid_id)) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* run queries as usual: XA BEGIN will be injected upon running a query */
if (!$mysqli-&gt;query("INSERT INTO orders(order_id, item) VALUES (1, 'christmas tree, 1.8m')")) {
    /* Either INSERT failed or the injected XA BEGIN failed */
    if ('XA' == substr($mysqli-&gt;sqlstate, 0, 2)) {
        printf("Global transaction/XA related failure, [%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
    } else {
        printf("INSERT failed, [%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
    }
    /* rollback global transaction */
    mysqlnd_ms_xa_rollback($mysqli, $xid);
    die("Stopping.");
}

/* continue carrying out queries on other servers, e.g. other shards */

/* commit the global transaction */
if (!mysqlnd_ms_xa_commit($mysqli, $xa_id)) {
    printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Unlike with local transactions, which are carried out on a
        single server, XA transactions have an identifier (xid)
        associated with them. The XA transaction identifier is composed
        of a global transaction identifier (gtrid), a branch qualifier
        (bqual) a format identifier (formatID). Only the global
        transaction identifier can and must be given when calling any of
        the plugins XA functions.
      </p><p>
        Once a global transaction has been started, the plugin begins
        tracking servers until the global transaction ends. When a
        server is picked for query execution, the plugin injects the SQL
        statement <code class="literal">XA BEGIN</code> prior to executing the
        actual SQL statement on the server. <code class="literal">XA BEGIN</code>
        makes the server participate in the global transaction. If the
        injected SQL statement fails, the plugin will report the issue
        in reply to the query execution function that was used. In the
        above example, <code class="literal">$mysqli-&gt;query("INSERT INTO
        orders(order_id, item) VALUES (1, 'christmas tree,
        1.8m')")</code> would indicate such an error. You
        may want to check the errors SQL state code to determine whether
        the actual query (here: <code class="literal">INSERT</code>) has failed or
        the error is related to the global transaction. It is up to you
        to ignore the failure to start the global transaction on a
        server and continue execution without having the server
        participate in the global transaction.
      </p><p>
</p>
<div class="example">
<a name="idm139660446048768"></a><p class="title"><b>Example 7.19 Local and global transactions are mutually exclusive</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* start a local transaction */
if (!$mysqli-&gt;begin_transaction()) {
    die(sprintf("[%d/%s] %s\n", $mysqli-&gt;errno, $mysqli-&gt;sqlstate, $mysqli-&gt;error));
}

/* cannot start global transaction now - must end local transaction first */
$gtrid_id = "12345";
if (!mysqlnd_ms_xa_begin($mysqli, $gtrid_id)) {
    die(sprintf("[%d/%s] %s\n", $mysqli-&gt;errno, $mysqli-&gt;sqlstate, $mysqli-&gt;error));
}
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">


Warning: mysqlnd_ms_xa_begin(): (mysqlnd_ms) Some work is done outside global transaction. You must end the active local transaction first in ... on line ...
[1400/XAE09] (mysqlnd_ms) Some work is done outside global transaction. You must end the active local transaction first

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        A global transaction cannot be started when a local transaction
        is active. The plugin tries to detect this situation as early as
        possible, that is when
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin" title="7.8.11 mysqlnd_ms_xa_begin"><code class="function">mysqlnd_ms_xa_begin</code></a>
        is called. If using API calls only to control transactions, the
        plugin will know that a local transaction is open and return an
        error for
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin" title="7.8.11 mysqlnd_ms_xa_begin"><code class="function">mysqlnd_ms_xa_begin</code></a>.
        However, note the plugins
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transaction" title="7.5.3 Local transaction handling">limitations on
        detecting transaction boundaries.</a>. In the worst case, if
        using direct SQL for local transactions
        (<code class="literal">BEGIN</code>, <code class="literal">COMMIT</code>, ...), it
        may happen that an error is delayed until some SQL is executed
        on a server.
      </p><p>
        To end a global transaction invoke
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit" title="7.8.12 mysqlnd_ms_xa_commit"><code class="function">mysqlnd_ms_xa_commit</code></a>
        or
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-rollback" title="7.8.14 mysqlnd_ms_xa_rollback"><code class="function">mysqlnd_ms_xa_rollback</code></a>.
        When a global transaction is ended all participants must be
        informed of the end. Therefore, PECL/mysqlnd_ms transparently
        issues appropriate XA related SQL statements on some or all of
        them. Any failure during this phase will cause an implicit
        rollback. The XA related API is intentionally kept simple here.
        A more complex API that gave more control would bare few, if
        any, advantages over a user implementation that issues all lower
        level XA SQL statements itself.
      </p><p>
        XA transactions use the two-phase commit protocol. The two-phase
        commit protocol is a blocking protocol. There are cases when no
        progress can be made, not even when using timeouts. Transaction
        coordinators should survive their own failure, be able to detect
        blockades and break ties. <code class="literal">PECL/mysqlnd_ms</code>
        takes the role of a transaction coordinator and can be
        configured to survive its own crash to avoid issues with blocked
        MySQL servers. Therefore, the plugin can and should be
        configured to use a persistent and crash-safe state to allow
        garbage collection of unfinished, aborted global transactions. A
        global transaction can be aborted in an open state if either the
        plugin fails (crashes) or a connection from the plugin to a
        global transaction participant fails.
      </p><p>
</p>
<div class="example">
<a name="idm139660446032688"></a><p class="title"><b>Example 7.20 Transaction coordinator state store</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "xa": {
            "state_store": {
                "participant_localhost_ip": "192.168.2.12",
                "mysql": {
                    "host": "192.168.2.13",
                    "user": "root",
                    "password": "",
                    "db": "test",
                    "port": "3312",
                    "socket": null
                }
            }
        },
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.14",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Currently, <code class="literal">PECL/mysqlnd_ms</code> supports only
        using MySQL database tables as a state store. The SQL
        definitions of the tables are given in the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.xa">plugin
        configuration section.</a> Please, make sure to use a
        transactional and crash-safe storage engine for the tables, such
        as InnoDB. InnoDB is the default table engine in recent versions
        of the MySQL server. Make also sure the database server itself
        is highly available.
      </p><p>
        If a state store has been configured, the plugin can perform a
        garbage collection. During garbage collection it may be
        necessary to connect to a participant of a failed global
        transaction. Thus, the state store holds a list of participants
        and, among others, their host names. If the garbage collection
        is run on another host but the one that has written a
        participant entry with the host name
        <code class="literal">localhost</code>, then <code class="literal">localhost</code>
        resolves to different machines. There are two solutions to the
        problem. Either you do not configure any servers with the host
        name <code class="literal">localhost</code> but configure an IP address
        (and port) or, you hint the garbage collection. In the above
        example, <code class="literal">localhost</code> is used for
        <code class="literal">master_0</code>, hence it may not resolve to the
        correct host during garbage collection. However,
        <code class="literal">participant_localhost_ip</code> is also set to hint
        the garbage collection that <code class="literal">localhost</code> stands
        for the IP <code class="literal">192.168.2.12</code>.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.qos-consistency"></a>7.4.7 Service level and consistency</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          Service levels have been introduced in PECL mysqlnd_ms version
          1.2.0-alpha.
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
          is available with PHP 5.4.0 or newer.
</p>
</div>
<p>
        Different types of MySQL cluster solutions offer different
        service and data consistency levels to their users. An
        asynchronous MySQL replication cluster offers eventual
        consistency by default. A read executed on an asynchronous slave
        may return current, stale or no data at all, depending on
        whether the slave has replayed all changesets from the master or
        not.
      </p><p>
        Applications using an MySQL replication cluster need to be
        designed to work correctly with eventual consistent data. In
        some cases, however, stale data is not acceptable. In those
        cases only certain slaves or even only master accesses are
        allowed to achieve the required quality of service from the
        cluster.
      </p><p>
        As of PECL mysqlnd_ms 1.2.0 the plugin is capable of selecting
        MySQL replication nodes automatically that deliver session
        consistency or strong consistency. Session consistency means
        that one client can read its writes. Other clients may or may
        not see the clients' write. Strong consistency means that
        all clients will see all writes from the client.
      </p><p>
</p>
<div class="example">
<a name="idm139660446012720"></a><p class="title"><b>Example 7.21 Session consistency: read your writes</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660446010576"></a><p class="title"><b>Example 7.22 Requesting session consistency</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* read-write splitting: master used */
if (!$mysqli-&gt;query("INSERT INTO orders(order_id, item) VALUES (1, 'christmas tree, 1.8m')")) {
    /* Please use better error handling in your code */
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Request session consistency: read your writes */
if (!mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_SESSION)) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Plugin picks a node which has the changes, here: master */
if (!$res = $mysqli-&gt;query("SELECT item FROM orders WHERE order_id = 1")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

var_dump($res-&gt;fetch_assoc());

/* Back to eventual consistency: stale data allowed */
if (!mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL)) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Plugin picks any slave, stale data is allowed */
if (!$res = $mysqli-&gt;query("SELECT item, price FROM specials")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Service levels can be set in the plugins configuration file and
        at runtime using
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
        In the example the function is used to enforce session
        consistency (read your writes) for all future statements until
        further notice. The <code class="literal">SELECT</code> statement on the
        <code class="literal">orders</code> table is run on the master to ensure
        the previous write can be seen by the client. Read-write
        splitting logic has been adapted to fulfill the service level.
      </p><p>
        After the application has read its changes from the
        <code class="literal">orders</code> table it returns to the default
        service level, which is eventual consistency. Eventual
        consistency puts no restrictions on choosing a node for
        statement execution. Thus, the <code class="literal">SELECT</code>
        statement on the <code class="literal">specials</code> table is executed
        on a slave.
      </p><p>
        The new functionality supersedes the use of SQL hints and the
        <code class="literal">master_on_write</code> configuration option. In many
        cases
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
        is easier to use, more powerful improves portability.
      </p><p>
</p>
<div class="example">
<a name="idm139660445998240"></a><p class="title"><b>Example 7.23 Maximum age/slave lag</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        },
        "failover" : "master"
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445996032"></a><p class="title"><b>Example 7.24 Limiting slave lag</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Read from slaves lagging no more than four seconds */
$ret = mysqlnd_ms_set_qos(
    $mysqli,
    MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL,
    MYSQLND_MS_QOS_OPTION_AGE,
    4
);

if (!$ret) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Plugin picks any slave, which may or may not have the changes */
if (!$res = $mysqli-&gt;query("SELECT item, price FROM daytrade")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Back to default: use of all slaves and masters permitted */
if (!mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL)) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The eventual consistency service level can be used with an
        optional parameter to set a maximum slave lag for choosing
        slaves. If set, the plugin checks <code class="literal">SHOW SLAVE
        STATUS</code> for all configured slaves. In case of the
        example, only slaves for which
        <code class="literal">Slave_IO_Running=Yes</code>,
        <code class="literal">Slave_SQL_Running=Yes</code> and
        <code class="literal">Seconds_Behind_Master &lt;= 4</code> is true are
        considered for executing the statement <code class="literal">SELECT item,
        price FROM daytrade</code>.
      </p><p>
        Checking <code class="literal">SHOW SLAVE STATUS</code> is done
        transparently from an applications perspective. Errors, if any,
        are reported as warnings. No error will be set on the connection
        handle. Even if all <code class="literal">SHOW SLAVE STATUS</code> SQL
        statements executed by the plugin fail, the execution of the
        users statement is not stopped, given that master fail over is
        enabled. Thus, no application changes are required.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Expensive and slow operation
</div>
<p>
          Checking <code class="literal">SHOW SLAVE STATUS</code> for all slaves
          adds overhead to the application. It is an expensive and slow
          background operation. Try to minimize the use of it.
          Unfortunately, a MySQL replication cluster does not give
          clients the possibility to request a list of candidates from a
          central instance. Thus, a more efficient way of checking the
          slaves lag is not available.
        </p><p>
          Please, note the limitations and properties of <code class="literal">SHOW
          SLAVE STATUS</code> as explained in the MySQL reference
          manual.
</p>
</div>
<p>
        To prevent mysqlnd_ms from emitting a warning if no slaves can
        be found that lag no more than the defined number of seconds
        behind the master, it is necessary to enable master fail over in
        the plugins configuration file. If no slaves can be found and
        fail over is turned on, the plugin picks a master for executing
        the statement.
      </p><p>
        If no slave can be found and fail over is turned off, the plugin
        emits a warning, it does not execute the statement and it sets
        an error on the connection.
      </p><p>
</p>
<div class="example">
<a name="idm139660445981744"></a><p class="title"><b>Example 7.25 Fail over not set</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445979568"></a><p class="title"><b>Example 7.26 No slave within time limit</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Read from slaves lagging no more than four seconds */
$ret = mysqlnd_ms_set_qos(
    $mysqli,
    MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL,
    MYSQLND_MS_QOS_OPTION_AGE,
    4
);

if (!$ret) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Plugin picks any slave, which may or may not have the changes */
if (!$res = $mysqli-&gt;query("SELECT item, price FROM daytrade")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}


/* Back to default: use of all slaves and masters permitted */
if (!mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL)) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

PHP Warning:  mysqli::query(): (mysqlnd_ms) Couldn't find the appropriate slave connection. 0 slaves to choose from. Something is wrong in %s on line %d
PHP Warning:  mysqli::query(): (mysqlnd_ms) No connection selected by the last filter in %s on line %d
[2000] (mysqlnd_ms) No connection selected by the last filter

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.gtid"></a>7.4.8 Global transaction IDs</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          A client-side global transaction ID injection has been
          introduced in mysqlnd_ms version 1.2.0-alpha. The feature is
          not required for synchronous clusters, such as MySQL Cluster.
          Use it with asynchronous clusters such as classical MySQL
          replication.
        </p><p>
          As of MySQL 5.6.5-m8 release candidate the MySQL server
          features built-in global transaction identifiers. The MySQL
          built-in global transaction ID feature is supported by
          <code class="literal">PECL/mysqlnd_ms</code> 1.3.0-alpha or later.
          However, the final feature set found in MySQL 5.6 production
          releases to date is not sufficient to support the ideas
          discussed below in all cases. Please, see also the
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">concepts
          section</a>.
</p>
</div>
<p>
        <code class="literal">PECL/mysqlnd_ms</code> can either use its own global
        transaction ID emulation or the global transaction ID feature
        built-in to MySQL 5.6.5-m8 or later. From a developer
        perspective the client-side and server-side approach offer the
        same features with regards to service levels provided by
        PECL/mysqlnd_ms. Their differences are discussed in the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">concepts
        section</a>.
      </p><p>
        The quickstart first demonstrates the use of the client-side
        global transaction ID emulation built-in to
        <code class="literal">PECL/mysqlnd_ms</code> before its show how to use
        the server-side counterpart. The order ensures that the
        underlying idea is discussed first.
      </p><p>
        <span class="emphasis"><em>Idea and client-side emulation</em></span>
      </p><p>
        In its most basic form a global transaction ID (GTID) is a
        counter in a table on the master. The counter is incremented
        whenever a transaction is committed on the master. Slaves
        replicate the table. The counter serves two purposes. In case of
        a master failure, it helps the database administrator to
        identify the most recent slave for promoting it to the new
        master. The most recent slave is the one with the highest
        counter value. Applications can use the global transaction ID to
        search for slaves which have replicated a certain write
        (identified by a global transaction ID) already.
      </p><p>
        <code class="literal">PECL/mysqlnd_ms</code> can inject SQL for every
        committed transaction to increment a GTID counter. The so
        created GTID is accessible by the application to identify an
        applications write operation. This enables the plugin to deliver
        session consistency (read your writes) service level by not only
        querying masters but also slaves which have replicated the
        change already. Read load is taken away from the master.
      </p><p>
        Client-side global transaction ID emulation has some
        limitations. Please, read the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">concepts section</a>
        carefully to fully understand the principles and ideas behind
        it, before using in production environments. The background
        knowledge is not required to continue with the quickstart.
      </p><p>
        First, create a counter table on your master server and insert a
        record into it. The plugin does not assist creating the table.
        Database administrators must make sure it exists. Depending on
        the error reporting mode, the plugin will silently ignore the
        lack of the table or bail out.
      </p><p>
</p>
<div class="example">
<a name="idm139660445959392"></a><p class="title"><b>Example 7.27 Create counter table on master</b></p>
<div class="example-contents">
<pre class="programlisting">

CREATE TABLE `trx` (
  `trx_id` int(11) DEFAULT NULL,
  `last_update` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=latin1
INSERT INTO `trx`(`trx_id`) VALUES (1);

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        In the plugins configuration file set the SQL to update the
        global transaction ID table using <code class="literal">on_commit</code>
        from the <code class="literal">global_transaction_id_injection</code>
        section. Make sure the table name used for the
        <code class="literal">UPDATE</code> statement is fully qualified. In the
        example, <code class="literal">test.trx</code> is used to refer to table
        <code class="literal">trx</code> in the schema (database)
        <code class="literal">test</code>. Use the table that was created in the
        previous step. It is important to set the fully qualified table
        name because the connection on which the injection is done may
        use a different default database. Make sure the user that opens
        the connection is allowed to execute the
        <code class="literal">UPDATE</code>.
      </p><p>
        Enable reporting of errors that may occur when mysqlnd_ms does
        global transaction ID injection.
      </p><p>
</p>
<div class="example">
<a name="idm139660445950832"></a><p class="title"><b>Example 7.28 Plugin config: SQL for client-side GTID injection</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        },
        "global_transaction_id_injection":{
            "on_commit":"UPDATE test.trx SET trx_id = trx_id + 1",
            "report_error":true
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445948464"></a><p class="title"><b>Example 7.29 Transparent global transaction ID injection</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* auto commit mode, transaction on master, GTID must be incremented */
if (!$mysqli-&gt;query("DROP TABLE IF EXISTS test")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* auto commit mode, transaction on master, GTID must be incremented */
if (!$mysqli-&gt;query("CREATE TABLE test(id INT)")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* auto commit mode, transaction on master, GTID must be incremented */
if (!$mysqli-&gt;query("INSERT INTO test(id) VALUES (1)")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* auto commit mode, read on slave, no increment */
if (!($res = $mysqli-&gt;query("SELECT id FROM test"))) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

var_dump($res-&gt;fetch_assoc());
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

array(1) {
  ["id"]=&gt;
  string(1) "1"
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The example runs three statements in auto commit mode on the
        master, causing three transactions on the master. For every such
        statement, the plugin will inject the configured
        <code class="literal">UPDATE</code> transparently before executing the
        users SQL statement. When the script ends the global transaction
        ID counter on the master has been incremented by three.
      </p><p>
        The fourth SQL statement executed in the example, a
        <code class="literal">SELECT</code>, does not trigger an increment. Only
        transactions (writes) executed on a master shall increment the
        GTID counter.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
SQL for global transaction ID: efficient solution wanted!</div>
<p>
          The SQL used for the client-side global transaction ID
          emulation is inefficient. It is optimized for clearity not for
          performance. Do not use it for production environments.
          Please, help finding an efficient solution for inclusion in
          the manual. We appreciate your input.
</p>
</div>
<p>
</p>
<div class="example">
<a name="idm139660445939568"></a><p class="title"><b>Example 7.30 Plugin config: SQL for fetching GTID</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        },
        "global_transaction_id_injection":{
            "on_commit":"UPDATE test.trx SET trx_id = trx_id + 1",
            "fetch_last_gtid" : "SELECT MAX(trx_id) FROM test.trx",
            "report_error":true
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445937152"></a><p class="title"><b>Example 7.31 Obtaining GTID after injection</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* auto commit mode, transaction on master, GTID must be incremented */
if (!$mysqli-&gt;query("DROP TABLE IF EXISTS test")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

printf("GTID after transaction %s\n", mysqlnd_ms_get_last_gtid($mysqli));

/* auto commit mode, transaction on master, GTID must be incremented */
if (!$mysqli-&gt;query("CREATE TABLE test(id INT)")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

printf("GTID after transaction %s\n", mysqlnd_ms_get_last_gtid($mysqli));
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

GTID after transaction 7
GTID after transaction 8

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Applications can ask PECL mysqlnd_ms for a global transaction ID
        which belongs to the last write operation performed by the
        application. The function
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>
        returns the GTID obtained when executing the SQL statement from
        the <code class="literal">fetch_last_gtid</code> entry of the
        <code class="literal">global_transaction_id_injection</code> section from
        the plugins configuration file. The function may be called after
        the GTID has been incremented.
      </p><p>
        Applications are adviced not to run the SQL statement themselves
        as this bares the risk of accidently causing an implicit GTID
        increment. Also, if the function is used, it is easy to migrate
        an application from one SQL statement for fetching a transaction
        ID to another, for example, if any MySQL server ever features
        built-in global transaction ID support.
      </p><p>
        The quickstart shows a SQL statement which will return a GTID
        equal or greater to that created for the previous statement. It
        is exactly the GTID created for the previous statement if no
        other clients have incremented the GTID in the time span between
        the statement execution and the <code class="literal">SELECT</code> to
        fetch the GTID. Otherwise, it is greater.
      </p><p>
</p>
<div class="example">
<a name="idm139660445926624"></a><p class="title"><b>Example 7.32 Plugin config: Checking for a certain GTID</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        },
        "global_transaction_id_injection":{
            "on_commit":"UPDATE test.trx SET trx_id = trx_id + 1",
            "fetch_last_gtid" : "SELECT MAX(trx_id) FROM test.trx",
            "check_for_gtid" : "SELECT trx_id FROM test.trx WHERE trx_id &gt;= #GTID",
            "report_error":true
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445923680"></a><p class="title"><b>Example 7.33 Session consistency service level and GTID combined</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* auto commit mode, transaction on master, GTID must be incremented */
if (   !$mysqli-&gt;query("DROP TABLE IF EXISTS test")
    || !$mysqli-&gt;query("CREATE TABLE test(id INT)")
    || !$mysqli-&gt;query("INSERT INTO test(id) VALUES (1)")
) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* GTID as an identifier for the last write */
$gtid = mysqlnd_ms_get_last_gtid($mysqli);

/* Session consistency (read your writes): try to read from slaves not only master */
if (false == mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_SESSION, MYSQLND_MS_QOS_OPTION_GTID, $gtid)) {
    die(sprintf("[006] [%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Either run on master or a slave which has replicated the INSERT */
if (!($res = $mysqli-&gt;query("SELECT id FROM test"))) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

var_dump($res-&gt;fetch_assoc());
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        A GTID returned from
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>
        can be used as an option for the session consistency service
        level. Session consistency delivers read your writes. Session
        consistency can be requested by calling
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
        In the example, the plugin will execute the
        <code class="literal">SELECT</code> statement either on the master or on a
        slave which has replicated the previous
        <code class="literal">INSERT</code> already.
      </p><p>
        PECL mysqlnd_ms will transparently check every configured slave
        if it has replicated the <code class="literal">INSERT</code> by checking
        the slaves GTID table. The check is done running the SQL set
        with the <code class="literal">check_for_gtid</code> option from the
        <code class="literal">global_transaction_id_injection</code> section of
        the plugins configuration file. Please note, that this is a slow
        and expensive procedure. Applications should try to use it
        sparsely and only if read load on the master becomes to high
        otherwise.
      </p><p>
        <span class="emphasis"><em>Use of the server-side global transaction ID
        feature</em></span>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Insufficient server support in MySQL 5.6
</div>
<p>
          The plugin has been developed against a pre-production version
          of MySQL 5.6. It turns out that all released production
          versions of MySQL 5.6 do not provide clients with enough
          information to enforce session consistency based on GTIDs.
          Please, read the
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">concepts
          section</a> for details.
</p>
</div>
<p>
        Starting with MySQL 5.6.5-m8 the MySQL Replication system
        features server-side global transaction IDs. Transaction
        identifiers are automatically generated and maintained by the
        server. Users do not need to take care of maintaining them.
        There is no need to setup any tables in advance, or for setting
        <code class="literal">on_commit</code>. A client-side emulation is no
        longer needed.
      </p><p>
        Clients can continue to use global transaction identifier to
        achieve session consistency when reading from MySQL Replication
        slaves in some cases but not all! The algorithm works as
        described above. Different SQL statements must be configured for
        <code class="literal">fetch_last_gtid</code> and
        <code class="literal">check_for_gtid</code>. The statements are given
        below. Please note, MySQL 5.6.5-m8 is a development version.
        Details of the server implementation may change in the future
        and require adoption of the SQL statements shown.
      </p><p>
        Using the following configuration any of the above described
        functionality can be used together with the server-side global
        transaction ID feature.
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>
        and
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
        continue to work as described above. The only difference is that
        the server does not use a simple sequence number but a string
        containing of a server identifier and a sequence number. Thus,
        users cannot easily derive an order from GTIDs returned by
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>.
      </p><p>
</p>
<div class="example">
<a name="idm139660445900128"></a><p class="title"><b>Example 7.34 Plugin config: using MySQL 5.6.5-m8 built-in GTID feature</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        },
        "global_transaction_id_injection":{
            "fetch_last_gtid" : "SELECT @@GLOBAL.GTID_DONE AS trx_id FROM DUAL",
            "check_for_gtid" : "SELECT GTID_SUBSET('#GTID', @@GLOBAL.GTID_DONE) AS trx_id FROM DUAL",
            "report_error":true
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.cache"></a>7.4.9 Cache integration</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement, dependencies and status
</div>
<p>
          Please, find more about version requirements, extension load
          order dependencies and the current status in the
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.concept_cache" title="7.5.12 Cache integration">concepts
          section</a>!
</p>
</div>
<p>
        Databases clusters can deliver different levels of consistency.
        As of <code class="literal">PECL/mysqlnd_ms</code> 1.2.0 it is possible to
        advice the plugin to consider only cluster nodes that can
        deliver the consistency level requested. For example, if using
        asynchronous MySQL Replication with its cluster-wide eventual
        consistency, it is possible to request session consistency (read
        your writes) at any time using
        <a class="ulink" href="http://www.php.net/mysqlnd_ms_set_quos" target="_top"><code class="function">mysqlnd_ms_set_quos</code></a>.
        Please, see also the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.qos-consistency" title="7.4.7 Service level and consistency">service
        level and consistency</a> introduction.
      </p><p>
</p>
<div class="example">
<a name="idm139660445889040"></a><p class="title"><b>Example 7.35 Recap: quality of service to request read your writes</b></p>
<div class="example-contents">
<pre class="programlisting">
/* Request session consistency: read your writes */
if (!mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_SESSION))
  die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Assuming PECL/mysqlnd has been explicitly told to deliver no
        consistency level higher than eventual consistency, it is
        possible to replace a database node read access with a
        client-side cache using time-to-live (TTL) as its invalidation
        strategy. Both the database node and the cache may or may not
        serve current data as this is what eventual consistency defines.
      </p><p>
        Replacing a database node read access with a local cache access
        can improve overall performance and lower the database load. If
        the cache entry is every reused by other clients than the one
        creating the cache entry, a database access is saved and thus
        database load is lowered. Furthermore, system performance can
        become better if computation and delivery of a database query is
        slower than a local cache access.
      </p><p>
</p>
<div class="example">
<a name="idm139660445885200"></a><p class="title"><b>Example 7.36 Plugin config: no special entries for caching</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "127.0.0.1",
                "port": "3306"
            }
        },
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445882992"></a><p class="title"><b>Example 7.37 Caching a slave request</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

if (   !$mysqli-&gt;query("DROP TABLE IF EXISTS test")
    || !$mysqli-&gt;query("CREATE TABLE test(id INT)")
    || !$mysqli-&gt;query("INSERT INTO test(id) VALUES (1)")
) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Explicitly allow eventual consistency and caching (TTL &lt;= 60 seconds) */
if (false == mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL, MYSQLND_MS_QOS_OPTION_CACHE, 60)) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* To make this example work, we must wait for a slave to catch up. Brute force style. */
$attempts = 0;
do {
    /* check if slave has the table */
    if ($res = $mysqli-&gt;query("SELECT id FROM test")) {
        break;
    } else if ($mysqli-&gt;errno) {
        die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
    }
    /* wait for slave to catch up */
    usleep(200000);
} while ($attempts++ &lt; 10);

/* Query has been run on a slave, result is in the cache */
assert($res);
var_dump($res-&gt;fetch_assoc());

/* Served from cache */
$res = $mysqli-&gt;query("SELECT id FROM test");
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The example shows how to use the cache feature. First, you have
        to set the quality of service to eventual consistency and
        explicitly allow for caching. This is done by calling
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
        Then, the result set of every read-only statement is cached for
        upto that many seconds as allowed with
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
      </p><p>
        The actual TTL is lower or equal to the value set with
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
        The value passed to the function sets the maximum age (seconds)
        of the data delivered. To calculate the actual TTL value the
        replication lag on a slave is checked and subtracted from the
        given value. If, for example, the maximum age is set to 60
        seconds and the slave reports a lag of 10 seconds the resulting
        TTL is 50 seconds. The TTL is calculated individually for every
        cached query.
      </p><p>
</p>
<div class="example">
<a name="idm139660445873216"></a><p class="title"><b>Example 7.38 Read your writes and caching combined</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

if (   !$mysqli-&gt;query("DROP TABLE IF EXISTS test")
    || !$mysqli-&gt;query("CREATE TABLE test(id INT)")
    || !$mysqli-&gt;query("INSERT INTO test(id) VALUES (1)")
) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Explicitly allow eventual consistency and caching (TTL &lt;= 60 seconds) */
if (false == mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL, MYSQLND_MS_QOS_OPTION_CACHE, 60)) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* To make this example work, we must wait for a slave to catch up. Brute force style. */
$attempts = 0;
do {
    /* check if slave has the table */
    if ($res = $mysqli-&gt;query("SELECT id FROM test")) {
        break;
    } else if ($mysqli-&gt;errno) {
        die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
    }
    /* wait for slave to catch up */
    usleep(200000);
} while ($attempts++ &lt; 10);

assert($res);

/* Query has been run on a slave, result is in the cache */
var_dump($res-&gt;fetch_assoc());

/* Served from cache */
if (!($res = $mysqli-&gt;query("SELECT id FROM test"))) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
var_dump($res-&gt;fetch_assoc());

/* Update on master */
if (!$mysqli-&gt;query("UPDATE test SET id = 2")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Read your writes */
if (false == mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_SESSION)) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Fetch latest data */
if (!($res = $mysqli-&gt;query("SELECT id FROM test"))) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
var_dump($res-&gt;fetch_assoc());
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The quality of service can be changed at any time to avoid
        further cache usage. If needed, you can switch to read your
        writes (session consistency). In that case, the cache will not
        be used and fresh data is read.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.failover"></a>7.4.10 Failover</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        By default, the plugin does not attempt to fail over if
        connecting to a host fails. This prevents pitfalls related to
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.connectionpooling" title="7.4.3 Connection state">connection
        state</a>. It is recommended to manually handle connection
        errors in a way similar to a failed transaction. You should
        catch the error, rebuild the connection state and rerun your
        query as shown below.
      </p><p>
        If connection state is no issue to you, you can alternatively
        enable automatic and silent failover. Depending on the
        configuration, the automatic and silent failover will either
        attempt to fail over to the master before issuing and error or,
        try to connect to other slaves, given the query allowes for it,
        before attempting to connect to a master. Because
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.failover" title="7.5.6 Failover">automatic
        failover</a> is not fool-proof, it is not discussed in the
        quickstart. Instead, details are given in the concepts section
        below.
      </p><p>
</p>
<div class="example">
<a name="idm139660445862112"></a><p class="title"><b>Example 7.39 Manual failover, automatic optional</b></p>
<div class="example-contents">
<pre class="programlisting">

  {
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "simulate_slave_failure",
                "port": "0"
            },
            "slave_1": {
                "host": "127.0.0.1",
                "port": 3311
            }
        },
       "filters": { "roundrobin": [] }
    }
 }

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445859280"></a><p class="title"><b>Example 7.40 Manual failover</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

$sql = "SELECT 1 FROM DUAL";

/* error handling as it should be done regardless of the plugin */
if (!($res = $link-&gt;query($sql))) {
    /* plugin specific: check for connection error */
    switch ($link-&gt;errno) {
    case 2002:
    case 2003:
    case 2005:
        printf("Connection error - trying next slave!\n");
        /* load balancer will pick next slave */
        $res = $link-&gt;query($sql);
        break;
    default:
        /* no connection error, failover is unlikely to help */
        die(sprintf("SQL error: [%d] %s", $link-&gt;errno, $link-&gt;error));
        break;
    }
}
if ($res) {
    var_dump($res-&gt;fetch_assoc());
}
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.partitioning"></a>7.4.11 Partitioning and Sharding</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        Database clustering is done for various reasons. Clusters can
        improve availability, fault tolerance, and increase performance
        by applying a divide and conquer approach as work is distributed
        over many machines. Clustering is sometimes combined with
        partitioning and sharding to further break up a large complex
        task into smaller, more manageable units.
      </p><p>
        The mysqlnd_ms plugin aims to support a wide variety of MySQL
        database clusters. Some flavors of MySQL database clusters have
        built-in methods for partitioning and sharding, which could be
        transparent to use. The plugin supports the two most common
        approaches: MySQL Replication table filtering, and Sharding
        (application based partitioning).
      </p><p>
        MySQL Replication supports partitioning as filters that allow
        you to create slaves that replicate all or specific databases of
        the master, or tables. It is then in the responsibility of the
        application to choose a slave according to the filter rules. You
        can either use the mysqlnd_ms
        <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-node-groups">node_groups</a></code>
        filter to manually support this, or use the experimental table
        filter.
      </p><p>
        Manual partitioning or sharding is supported through the node
        grouping filter, and SQL hints as of 1.5.0. The node_groups
        filter lets you assign a symbolic name to a group of master and
        slave servers. In the example, the master
        <code class="literal">master_0</code> and <code class="literal">slave_0</code> form
        a group with the name <code class="literal">Partition_A</code>. It is
        entirely up to you to decide what makes up a group. For example,
        you may use node groups for sharding, and use the group names to
        address shards like <code class="literal">Shard_A_Range_0_100</code>.
      </p><p>
</p>
<div class="example">
<a name="idm139660445845504"></a><p class="title"><b>Example 7.41 Cluster node groups</b></p>
<div class="example-contents">
<pre class="programlisting">

 {
  "myapp": {
       "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "simulate_slave_failure",
                "port": "0"
            },
            "slave_1": {
                "host": "127.0.0.1",
                "port": 3311
            }
        },
        "filters": {
            "node_groups": {
                "Partition_A" : {
                    "master": ["master_0"],
                    "slave": ["slave_0"]
                }
            },
           "roundrobin": []
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445842976"></a><p class="title"><b>Example 7.42 Manual partitioning using SQL hints</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
function select($mysqli, $msg, $hint = '')
{
    /* Note: weak test, two connections to two servers may have the same thread id */
    $sql = sprintf("SELECT CONNECTION_ID() AS _thread, '%s' AS _hint FROM DUAL", $msg);
    if ($hint) {
        $sql = $hint . $sql;
    }
    if (!($res = $mysqli-&gt;query($sql))) {
        printf("[%d] %s", $mysqli-&gt;errno, $mysqli-&gt;error);
        return false;
    }
    $row =  $res-&gt;fetch_assoc();
    printf("%d - %s - %s\n", $row['_thread'], $row['_hint'], $sql);
    return true;
}

$mysqli = new mysqli("myapp", "user", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* All slaves allowed */
select($mysqli, "slave_0");
select($mysqli, "slave_1");

/* only servers of node group "Partition_A" allowed */
select($mysqli, "slave_1", "/*Partition_A*/");
select($mysqli, "slave_1", "/*Partition_A*/");
?&gt;

    </pre><pre class="screen">

6804 - slave_0 - SELECT CONNECTION_ID() AS _thread, 'slave1' AS _hint FROM DUAL
2442 - slave_1 - SELECT CONNECTION_ID() AS _thread, 'slave2' AS _hint FROM DUAL
6804 - slave_0 - /*Partition_A*/SELECT CONNECTION_ID() AS _thread, 'slave1' AS _hint FROM DUAL
6804 - slave_0 - /*Partition_A*/SELECT CONNECTION_ID() AS _thread, 'slave1' AS _hint FROM DUAL

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        By default, the plugin will use all configured master and slave
        servers for query execution. But if a query begins with a SQL
        hint like <code class="literal">/*node_group*/</code>, the plugin will
        only consider the servers listed in the
        <code class="literal">node_group</code> for query execution. Thus,
        <code class="literal">SELECT</code> queries prefixed with
        <code class="literal">/*Partition_A*/</code> will only be executed on
        <code class="literal">slave_0</code>.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.quickstart.mysql_fabric"></a>7.4.12 MySQL Fabric</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement and status
</div>
<p>
          Work on supporting MySQL Fabric started in version 1.6.
          Please, consider the support to be of pre-alpha quality. The
          manual may not list all features or feature limitations. This
          is work in progress.
        </p><p>
          Sharding is the only use case supported by the plugin to date.
</p>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title">
MySQL Fabric concepts
</div>
<p>
          Please, check the MySQL reference manual for more information
          about MySQL Fabric and how to set it up. The PHP manual
          assumes that you are familiar with the basic concepts and
          ideas of MySQL Fabric.
</p>
</div>
<p>
        MySQL Fabric is a system for managing farms of MySQL servers to
        achive High Availability and optionally support sharding.
        Technically, it is a middleware to manage and monitor MySQL
        servers.
      </p><p>
        Clients query MySQL Fabric to obtain lists of MySQL servers,
        their state and their roles. For example, clients can request a
        list of slaves for a MySQL Replication group and whether they
        are ready to handle SQL requests. Another example is a cluster
        of sharded MySQL servers where the client seeks to know which
        shard to query for a given table and shard key. If configured to
        use Fabric, the plugin uses XML RCP over HTTP to obtain the list
        at runtime from a MySQL Fabric host. The XML remote procedure
        call itself is done in the background and transparent from a
        developers point of view.
      </p><p>
        Instead of listing MySQL servers directly in the plugins
        configuration file it contains a list of one or more MySQL
        Fabric hosts
      </p><p>
</p>
<div class="example">
<a name="idm139660445825296"></a><p class="title"><b>Example 7.43 Plugin config: Fabric hosts instead of MySQL servers</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "fabric": {
            "hosts": [
                {
                    "host" : "127.0.0.1",
                    "port" : 8080
                }
            ]
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Users utilize the new functions
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-shard" title="7.8.3 mysqlnd_ms_fabric_select_shard"><code class="function">mysqlnd_ms_fabric_select_shard</code></a>
        and
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-global" title="7.8.2 mysqlnd_ms_fabric_select_global"><code class="function">mysqlnd_ms_fabric_select_global</code></a>
        to switch to the set of servers responsible for a given shard
        key. Then, the plugin picks an appropriate server for running
        queries on. When doing so, the plugin takes care of additional
        load balancing rules set.
      </p><p>
        The below example assumes that MySQL Fabric has been setup to
        shard the table <code class="literal">test.fabrictest</code> using the
        <code class="literal">id</code> column of the table as a shard key.
      </p><p>
</p>
<div class="example">
<a name="idm139660445817824"></a><p class="title"><b>Example 7.44 Manual partitioning using SQL hints</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "user", "password", "database");
if (!$mysqli) {
    /* Of course, your error handling is nicer... */
    die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));
}

/* Create a global table - a table available on all shards */
mysqlnd_ms_fabric_select_global($mysqli, "test.fabrictest");
if (!$mysqli-&gt;query("CREATE TABLE test.fabrictest(id INT NOT NULL PRIMARY KEY)")) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Switch connection to appropriate shard and insert record */
mysqlnd_ms_fabric_select_shard($mysqli, "test.fabrictest", 10);
if (!($res = $mysqli-&gt;query("INSERT INTO fabrictest(id) VALUES (10)"))) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}

/* Try to read newly inserted record */
mysqlnd_ms_fabric_select_shard($mysqli, "test.fabrictest", 10);
if (!($res = $mysqli-&gt;query("SELECT id FROM test WHERE id = 10"))) {
    die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
}
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The example creates the sharded table, inserts a record and
        reads the record thereafter. All SQL data definition language
        (DDL) operations on a sharded table must be applied to the so
        called global server group. Prior to creating or altering a
        sharded table,
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-global" title="7.8.2 mysqlnd_ms_fabric_select_global"><code class="function">mysqlnd_ms_fabric_select_global</code></a>
        is called to switch the given connection to the corresponding
        servers of the global group. Data manipulation (DML) SQL
        statements must be sent to the shards directly. The
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-shard" title="7.8.3 mysqlnd_ms_fabric_select_shard">
        <code class="function">mysqlnd_ms_fabric_select_shard</code></a>
        switches a connection to shards handling a certain shard key.
</p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-mysqlnd-ms.concepts"></a>7.5 Concepts</h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.architecture">7.5.1 Architecture</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.pooling">7.5.2 Connection pooling and switching</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transaction">7.5.3 Local transaction handling</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.errorhandling">7.5.4 Error handling</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transient_errors">7.5.5 Transient errors</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.failover">7.5.6 Failover</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.loadbalancing">7.5.7 Load balancing</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.rwsplit">7.5.8 Read-write splitting</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.filter">7.5.9 Filter</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.qos-consistency">7.5.10 Service level and consistency</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid">7.5.11 Global transaction IDs</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.concept_cache">7.5.12 Cache integration</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.supportedclusters">7.5.13 Supported clusters</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.concept_xa_trx">7.5.14 XA/Distributed transactions</a></span></dt></dl>
</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
    </p><p>
      This explains the architecture and related concepts for this
      plugin, and describes the impact that MySQL replication and this
      plugin have on developmental tasks while using a database cluster.
      Reading and understanding these concepts is required, in order to
      use this plugin with success.
</p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.architecture"></a>7.5.1 Architecture</h3>
</div>
</div>
</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        The mysqlnd replication and load balancing plugin is implemented
        as a PHP extension. It is written in C and operates under the
        hood of PHP. During the startup of the PHP interpreter, in the
        module init phase of the PHP engine, it gets registered as a
        <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> plugin to
        replace selected mysqlnd C methods.
      </p><p>
        At PHP runtime, it inspects queries sent from mysqlnd (PHP) to
        the MySQL server. If a query is recognized as read-only, it will
        be sent to one of the configured slave servers. Statements are
        considered read-only if they either start with
        <code class="literal">SELECT</code>, the SQL hint
        <code class="literal">/*ms=slave*/</code> or a slave had been chosen for
        running the previous query, and the query started with the SQL
        hint <code class="literal">/*ms=last_used*/</code>. In all other cases,
        the query will be sent to the MySQL replication master server.
      </p><p>
        For better portability, applications should use the
        <code class="constant">MYSQLND_MS_MASTER_SWITCH</code>,
        <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code>, and
        <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code>
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.constants" title="7.7 Predefined Constants">predefined
        mysqlnd_ms constants</a>, instead of their literal values,
        such as <code class="literal">/*ms=slave*/</code>.
      </p><p>
        The plugin handles the opening and closing of database
        connections to both master and slave servers. From an
        application point of view, there continues to be only one
        connection handle. However, internally, this one public
        connection handle represents a pool of network connections that
        are managed by the plugin. The plugin proxies queries to the
        master server, and to the slaves using multiple connections.
      </p><p>
        Database connections have a state consisting of, for example,
        transaction status, transaction settings, character set
        settings, and temporary tables. The plugin will try to maintain
        the same state among all internal connections, whenever this can
        be done in an automatic and transparent way. In cases where it
        is not easily possible to maintain state among all connections,
        such as when using <code class="literal">BEGIN TRANSACTION</code>, the
        plugin leaves it to the user to handle.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.pooling"></a>7.5.2 Connection pooling and switching</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        The replication and load balancing plugin changes the semantics
        of a PHP MySQL connection handle. The existing API of the PHP
        MySQL extensions
        (<a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
        <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a>, and
        <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>) are not
        changed in a way that functions are added or removed. But their
        behavior changes when using the plugin. Existing applications do
        not need to be adapted to a new API, but they may need to be
        modified because of the behavior changes.
      </p><p>
        The plugin breaks the one-by-one relationship between a
        <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
        <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a>, and
        <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a> connection
        handle and a MySQL network connection. And a
        <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
        <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a>, and
        <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a> connection
        handle represents a local pool of connections to the configured
        MySQL replication master and MySQL replication slave servers.
        The plugin redirects queries to the master and slave servers. At
        some point in time one and the same PHP connection handle may
        point to the MySQL master server. Later on, it may point to one
        of the slave servers or still the master. Manipulating and
        replacing the network connection referenced by a PHP MySQL
        connection handle is not a transparent operation.
      </p><p>
        Every MySQL connection has a state. The state of the connections
        in the connection pool of the plugin can differ. Whenever the
        plugin switches from one wire connection to another, the current
        state of the user connection may change. The applications must
        be aware of this.
      </p><p>
        The following list shows what the connection state consists of.
        The list may not be complete.
      </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
       Transaction status
      </li><li class="listitem">
       Temporary tables
      </li><li class="listitem">
       Table locks
      </li><li class="listitem">
      Session system variables and session user variables
     </li><li class="listitem">
      The current database set using <code class="literal">USE</code> and other state chaining SQL commands
     </li><li class="listitem">
       Prepared statements
      </li><li class="listitem"><code class="literal">HANDLER</code> variables
      </li><li class="listitem">
       Locks acquired with <code class="literal">GET_LOCK()</code>

</li></ul>
</div>
<p>
      </p><p>
        Connection switches happen right before queries are executed.
        The plugin does not switch the current connection until the next
        statement is executed.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Replication issues
</div>
<p>
          See also the MySQL reference manual chapter about
          <a class="ulink" href="http://dev.mysql.com/doc/mysql/en/replication.html" target="_top">replication
          features</a> and related issues. Some restrictions may not
          be related to the PHP plugin, but are properties of the MySQL
          replication system.
</p>
</div>
<p>
        Broadcasted messages
      </p><p>
        The plugins philosophy is to align the state of connections in
        the pool only if the state is under full control of the plugin,
        or if it is necessary for security reasons. Just a few actions
        that change the state of the connection fall into this category.
      </p><p>
        The following is a list of connection client library calls that
        change state, and are broadcasted to all open connections in the
        connection pool.
      </p><p>
        If any of the listed calls below are to be executed, the plugin
        loops over all open master and slave connections. The loop
        continues until all servers have been contacted, and the loop
        does not break if a server indicates a failure. If possible, the
        failure will propagate to the called user API function, which
        may be detected depending on which underlying library function
        was triggered.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Library call</th><th scope="col">Notes</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">change_user()</code></td><td>Called by the
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.change-user" title="3.9.4 mysqli::change_user, mysqli_change_user"><code class="function">mysqli_change_user</code></a>
                user API call. Also triggered upon reuse of a persistent
                <code class="literal">mysqli</code> connection.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">select_db</code></td><td>Called by the following user API calls:
                <a class="link" href="apis-php-mysql.html#apis-php-function.mysql-select-db" title="5.5.43 mysql_select_db"><code class="function">mysql_select_db</code></a>,
                <a class="link" href="apis-php-mysql.html#apis-php-function.mysql-list-tables" title="5.5.35 mysql_list_tables"><code class="function">mysql_list_tables</code></a>,
                <a class="link" href="apis-php-mysql.html#apis-php-function.mysql-db-query" title="5.5.8 mysql_db_query"><code class="function">mysql_db_query</code></a>,
                <a class="link" href="apis-php-mysql.html#apis-php-function.mysql-list-fields" title="5.5.33 mysql_list_fields"><code class="function">mysql_list_fields</code></a>,
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.select-db" title="3.9.50 mysqli::select_db, mysqli_select_db"><code class="function">mysqli_select_db</code></a>.
                Note, that SQL <code class="literal">USE</code> is not monitored.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">set_charset()</code></td><td>Called by the following user API calls:
                <a class="link" href="apis-php-mysql.html#apis-php-function.mysql-set-charset" title="5.5.44 mysql_set_charset"><code class="function">mysql_set_charset</code></a>.
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.set-charset" title="3.9.52 mysqli::set_charset, mysqli_set_charset"><code class="function">mysqli_set_charset</code></a>.
                Note, that SQL <code class="literal">SET NAMES</code> is not
                monitored.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">set_server_option()</code></td><td>Called by the following user API calls:
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.multi-query" title="3.9.34 mysqli::multi_query, mysqli_multi_query"><code class="function">mysqli_multi_query</code></a>,
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.real-query" title="3.9.43 mysqli::real_query, mysqli_real_query"><code class="function">mysqli_real_query</code></a>,
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.query" title="3.9.40 mysqli::query, mysqli_query"><code class="function">mysqli_query</code></a>,
                <a class="link" href="apis-php-mysql.html#apis-php-function.mysql-query" title="5.5.40 mysql_query"><code class="function">mysql_query</code></a>.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">set_client_option()</code></td><td>Called by the following user API calls:
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.options" title="3.9.36 mysqli::options, mysqli_options"><code class="function">mysqli_options</code></a>,
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.ssl-set" title="3.9.56 mysqli::ssl_set, mysqli_ssl_set"><code class="function">mysqli_ssl_set</code></a>,
                <a class="link" href="apis-php-mysqli.html#apis-php-function.mysqli-connect" title="3.15.4 mysqli_connect"><code class="function">mysqli_connect</code></a>,
                <a class="link" href="apis-php-mysql.html#apis-php-function.mysql-connect" title="5.5.4 mysql_connect"><code class="function">mysql_connect</code></a>,
                <a class="link" href="apis-php-mysql.html#apis-php-function.mysql-pconnect" title="5.5.38 mysql_pconnect"><code class="function">mysql_pconnect</code></a>.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">set_autocommit()</code></td><td>Called by the following user API calls:
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.autocommit" title="3.9.2 mysqli::autocommit, mysqli_autocommit"><code class="function">mysqli_autocommit</code></a>,
                <code class="literal">PDO::setAttribute(PDO::ATTR_AUTOCOMMIT)</code>.</td><td>Since 1.0.0. PHP &gt;= 5.4.0.</td></tr><tr><td scope="row"><code class="literal">ssl_set()</code></td><td>Called by the following user API calls:
<a class="link" href="apis-php-mysqli.html#apis-php-mysqli.ssl-set" title="3.9.56 mysqli::ssl_set, mysqli_ssl_set"><code class="function">mysqli_ssl_set</code></a>.</td><td>Since 1.1.0.</td></tr></tbody></table>
</div>
<p>
        Broadcasting and lazy connections
      </p><p>
        The plugin does not proxy or <span class="quote">“<span class="quote">remember</span>”</span> all
        settings to apply them on connections opened in the future. This
        is important to remember, if using
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
        connections</a>. Lazy connections are connections which are
        not opened before the client sends the first connection. Use of
        lazy connections is the default plugin action.
      </p><p>
        The following connection library calls each changed state, and
        their execution is recorded for later use when lazy connections
        are opened. This helps ensure that the connection state of all
        connections in the connection pool are comparable.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Library call</th><th scope="col">Notes</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">change_user()</code></td><td>User, password and database recorded for future use.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">select_db</code></td><td>Database recorded for future use.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">set_charset()</code></td><td>Calls <code class="literal">set_client_option(MYSQL_SET_CHARSET_NAME,
                charset)</code> on lazy connection to ensure
                <code class="literal">charset</code> will be used upon opening the
                lazy connection.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">set_autocommit()</code></td><td>Adds <code class="literal">SET AUTOCOMMIT=0|1</code> to the list of init commands
                of a lazy connection using
                <code class="literal">set_client_option(MYSQL_INIT_COMMAND, "SET
AUTOCOMMIT=...%quot;)</code>.</td><td>Since 1.1.0. PHP &gt;= 5.4.0.</td></tr></tbody></table>
</div>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title">
Connection state
</div>
<p>
          The connection state is not only changed by API calls. Thus,
          even if PECL mysqlnd_ms monitors all API calls, the
          application must still be aware. Ultimately, it is the
          applications responsibility to maintain the connection state,
          if needed.
</p>
</div>
<p>
        Charsets and string escaping
      </p><p>
        Due to the use of lazy connections, which are a default, it can
        happen that an application tries to escape a string for use
        within SQL statements before a connection has been established.
        In this case string escaping is not possible. The string escape
        function does not know what charset to use before a connection
        has been established.
      </p><p>
        To overcome the problem a new configuration setting
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.server-charset"><code class="literal">server_charset</code></a>
        has been introduced in version 1.4.0.
      </p><p>
        Attention has to be paid on escaping strings with a certain
        charset but using the result on a connection that uses a
        different charset. Please note, that PECL/mysqlnd_ms manipulates
        connections and one application level connection represents a
        pool of multiple connections that all may have different default
        charsets. It is recommended to configure the servers involved to
        use the same default charsets. The configuration setting
        <code class="literal">server_charset</code> does help with this situation
        as well. If using <code class="literal">server_charset</code>, the plugin
        will set the given charset on all newly opened connections.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.transaction"></a>7.5.3 Local transaction handling</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        Transaction handling is fundamentally changed. An SQL
        transaction is a unit of work that is run on one database
        server. The unit of work consists of one or more SQL statements.
      </p><p>
        By default the plugin is not aware of SQL transactions. The
        plugin may switch connections for load balancing at any point in
        time. Connection switches may happen in the middle of a
        transaction. This is against the nature of an SQL transaction.
        By default, the plugin is not transaction safe.
      </p><p>
        Any kind of MySQL load balancer must be hinted about the begin
        and end of a transaction. Hinting can either be done implicitly
        by monitoring API calls or using SQL hints. Both options are
        supported by the plugin, depending on your PHP version. API
        monitoring requires PHP 5.4.0 or newer. The plugin, like any
        other MySQL load balancer, cannot detect transaction boundaries
        based on the MySQL Client Server Protocol. Thus, entirely
        transparent transaction aware load balancing is not possible.
        The least intrusive option is API monitoring, which requires
        little to no application changes, depending on your application.
      </p><p>
        Please, find examples of using SQL hints or the API monitoring
        in the <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart" title="7.4 Quickstart and Examples">examples
        section</a>. The details behind the API monitoring, which
        makes the plugin transaction aware, are described below.
      </p><p>
        Beginning with PHP 5.4.0, the
        <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> library allows
        this plugin to subclass the library C API call
        <code class="literal">set_autocommit()</code>, to detect the status of
        <code class="literal">autocommit</code> mode.
      </p><p>
        The PHP MySQL extensions either issue a query (such as
        <code class="literal">SET AUTOCOMMIT=0|1</code>), or use the mysqlnd
        library call <code class="literal">set_autocommit()</code> to control the
        <code class="literal">autocommit</code> setting. If an extension makes use
        of <code class="literal">set_autocommit()</code>, the plugin can be made
        transaction aware. Transaction awareness cannot be achieved if
        using SQL to set the autocommit mode. The library function
        <code class="literal">set_autocommit()</code> is called by the
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.autocommit" title="3.9.2 mysqli::autocommit, mysqli_autocommit"><code class="function">mysqli_autocommit</code></a>
        and <code class="literal">PDO::setAttribute(PDO::ATTR_AUTOCOMMIT)</code>
        user API calls.
      </p><p>
        The plugin configuration option
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">trx_stickiness=master</a>
        can be used to make the plugin transactional aware. In this
        mode, the plugin stops load balancing if autocommit becomes
        disabled, and directs all statements to the master until
        autocommit gets enabled.
      </p><p>
        An application that does not want to set SQL hints for
        transactions but wants to use the transparent API monitoring to
        avoid application changes must make sure that the autocommit
        settings is changed exclusively through the listed API calls.
      </p><p>
        API based transaction boundary detection has been improved with
        PHP 5.5.0 and PECL/mysqlnd_ms 1.5.0 to cover not only calls to
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.autocommit" title="3.9.2 mysqli::autocommit, mysqli_autocommit"><code class="function">mysqli_autocommit</code></a>
        but also
        <a class="ulink" href="http://www.php.net/mysqli_begin" target="_top"><code class="function">mysqli_begin</code></a>,
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.commit" title="3.9.9 mysqli::commit, mysqli_commit"><code class="function">mysqli_commit</code></a>
        and
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.rollback" title="3.9.47 mysqli::rollback, mysqli_rollback"><code class="function">mysqli_rollback</code></a>.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.errorhandling"></a>7.5.4 Error handling</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        Applications using PECL/mysqlnd_ms should implement proper error
        handling for all user API calls. And because the plugin changes
        the semantics of a connection handle, API calls may return
        unexpected errors. If using the plugin on a connection handle
        that no longer represents an individual network connection, but
        a connection pool, an error code and error message will be set
        on the connection handle whenever an error occurs on any of the
        network connections behind.
      </p><p>
        If using lazy connections, which is the default, connections are
        not opened until they are needed for query execution. Therefore,
        an API call for a statement execution may return a connection
        error. In the example below, an error is provoked when trying to
        run a statement on a slave. Opening a slave connection fails
        because the plugin configuration file lists an invalid host name
        for the slave.
      </p><p>
</p>
<div class="example">
<a name="idm139660445662880"></a><p class="title"><b>Example 7.45 Provoking a connection error</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "invalid_host_name",
            }
        },
        "lazy_connections": 1
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The explicit activation of lazy connections is for demonstration
        purpose only.
      </p><p>
</p>
<div class="example">
<a name="idm139660445660208"></a><p class="title"><b>Example 7.46 Connection error on query execution</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (mysqli_connect_errno())
  /* Of course, your error handling is nicer... */
  die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));

/* Connection 1, connection bound SQL user variable, no SELECT thus run on master */
if (!$mysqli-&gt;query("SET @myrole='master'")) {
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}

/* Connection 2, run on slave because SELECT, provoke connection error */
if (!($res = $mysqli-&gt;query("SELECT @myrole AS _role"))) {
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
} else {
 $row = $res-&gt;fetch_assoc();
 $res-&gt;close();
 printf("@myrole = '%s'\n", $row['_role']);
}
$mysqli-&gt;close();
?&gt;

    </pre><p>
            The above example will output something similar to:
          </p><pre class="screen">

PHP Warning:  mysqli::query(): php_network_getaddresses: getaddrinfo failed: Name or service not known in %s on line %d
PHP Warning:  mysqli::query(): [2002] php_network_getaddresses: getaddrinfo failed: Name or service not known (trying to connect via tcp://invalid_host_name:3306) in %s on line %d
[2002] php_network_getaddresses: getaddrinfo failed: Name or service not known

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Applications are expected to handle possible connection errors
        by implementing proper error handling.
      </p><p>
        Depending on the use case, applications may want to handle
        connection errors differently from other errors. Typical
        connection errors are <code class="literal">2002 (CR_CONNECTION_ERROR) -
        Can't connect to local MySQL server through socket
        '%s' (%d)</code>, <code class="literal">2003
        (CR_CONN_HOST_ERROR) - Can't connect to MySQL server on
        '%s' (%d)</code> and <code class="literal">2005
        (CR_UNKNOWN_HOST) - Unknown MySQL server host '%s'
        (%d)</code>. For example, the application may test for the
        error codes and manually perform a fail over. The plugins
        philosophy is not to offer automatic fail over, beyond master
        fail over, because fail over is not a transparent operation.
      </p><p>
</p>
<div class="example">
<a name="idm139660445651648"></a><p class="title"><b>Example 7.47 Provoking a connection error</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "invalid_host_name"
            },
            "slave_1": {
                "host": "192.168.78.136"
            }
        },
        "lazy_connections": 1,
        "filters": {
            "roundrobin": [

            ]
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Explicitly activating lazy connections is done for demonstration
        purposes, as is round robin load balancing as opposed to the
        default <code class="literal">random once</code> type.
      </p><p>
</p>
<div class="example">
<a name="idm139660445648064"></a><p class="title"><b>Example 7.48 Most basic failover</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (mysqli_connect_errno())
  /* Of course, your error handling is nicer... */
  die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));

/* Connection 1, connection bound SQL user variable, no SELECT thus run on master */
if (!$mysqli-&gt;query("SET @myrole='master'")) {
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}

/* Connection 2, first slave */
$res = $mysqli-&gt;query("SELECT VERSION() AS _version");
/* Hackish manual fail over */
if (2002 == $mysqli-&gt;errno || 2003 == $mysqli-&gt;errno || 2004 == $mysqli-&gt;errno) {
  /* Connection 3, first slave connection failed, trying next slave */
  $res = $mysqli-&gt;query("SELECT VERSION() AS _version");
}

if (!$res) {
  printf("ERROR, [%d] '%s'\n", $mysqli-&gt;errno, $mysqli-&gt;error);
} else {
 /* Error messages are taken from connection 3, thus no error */
 printf("SUCCESS, [%d] '%s'\n", $mysqli-&gt;errno, $mysqli-&gt;error);
 $row = $res-&gt;fetch_assoc();
 $res-&gt;close();
 printf("version = %s\n", $row['_version']);
}
$mysqli-&gt;close();
?&gt;

    </pre><p>
            The above example will output something similar to:
          </p><pre class="screen">

[1045] Access denied for user 'username'@'localhost' (using password: YES)
PHP Warning:  mysqli::query(): php_network_getaddresses: getaddrinfo failed: Name or service not known in %s on line %d
PHP Warning:  mysqli::query(): [2002] php_network_getaddresses: getaddrinfo failed: Name or service not known (trying to connect via tcp://invalid_host_name:3306) in %s on line %d
SUCCESS, [0] ''
version = 5.6.2-m5-log

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        In some cases, it may not be easily possible to retrieve all
        errors that occur on all network connections through a
        connection handle. For example, let's assume a connection
        handle represents a pool of three open connections. One
        connection to a master and two connections to the slaves. The
        application changes the current database using the user API call
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.select-db" title="3.9.50 mysqli::select_db, mysqli_select_db"><code class="function">mysqli_select_db</code></a>,
        which then calls the mysqlnd library function to change the
        schemata. mysqlnd_ms monitors the function, and tries to change
        the current database on all connections to harmonize their
        state. Now, assume the master succeeds in changing the database,
        and both slaves fail. Upon the initial error from the first
        slave, the plugin will set an appropriate error on the
        connection handle. The same is done when the second slave fails
        to change the database. The error message from the first slave
        is lost.
      </p><p>
        Such cases can be debugged by either checking for errors of the
        type <code class="literal">E_WARNING</code> (see above) or, if no other
        option, investigation of the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.debugging" title="7.6.4.5 Debugging and Tracing">mysqlnd_ms debug
        and trace log</a>.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.transient_errors"></a>7.5.5 Transient errors</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        Some distributed database clusters make use of transient errors.
        A transient error is a temporary error that is likely to
        disappear soon. By definition it is safe for a client to ignore
        a transient error and retry the failed operation on the same
        database server. The retry is free of side effects. Clients are
        not forced to abort their work or to fail over to another
        database server immediately. They may enter a retry loop before
        to wait for the error to disappear before giving up on the
        database server. Transient errors can be seen, for example, when
        using MySQL Cluster. But they are not bound to any specific
        clustering solution per se.
      </p><p>
        <code class="literal">PECL/mysqlnd_ms</code> can perform an automatic
        retry loop in case of a transient error. This increases
        distribution transparency and thus makes it easier to migrate an
        application running on a single database server to run on a
        cluster of database servers without having to change the source
        of the application.
      </p><p>
        The automatic retry loop will repeat the requested operation up
        to a user configurable number of times and pause between the
        attempts for a configurable amount of time. If the error
        disappears during the loop, the application will never see it.
        If not, the error is forwarded to the application for handling.
      </p><p>
        In the example below a duplicate key error is provoked to make
        the plugin retry the failing query two times before the error is
        passed to the application. Between the two attempts the plugin
        sleeps for 100 milliseconds.
      </p><p>
</p>
<div class="example">
<a name="idm139660445631680"></a><p class="title"><b>Example 7.49 Provoking a transient error</b></p>
<div class="example-contents">
<pre class="programlisting">

mysqlnd_ms.enable=1
mysqlnd_ms.collect_statistics=1

    </pre><pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
       },
       "transient_error": {
          "mysql_error_codes": [
            1062
          ],
          "max_retries": 2,
          "usleep_retry": 100
       }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445628640"></a><p class="title"><b>Example 7.50 Transient error retry loop</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
if (mysqli_connect_errno())
  /* Of course, your error handling is nicer... */
  die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));

if (!$mysqli-&gt;query("DROP TABLE IF EXISTS test") ||
    !$mysqli-&gt;query("CREATE TABLE test(id INT PRIMARY KEY)") ||
    !$mysqli-&gt;query("INSERT INTO test(id) VALUES (1))")) {
  printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}

/* Retry loop is completely transparent. Checking statistics is
 the only way to know about implicit retries */
$stats = mysqlnd_ms_get_stats();
printf("Transient error retries before error: %d\n", $stats['transient_error_retries']);

/* Provoking duplicate key error to see statistics change */
if (!$mysqli-&gt;query("INSERT INTO test(id) VALUES (1))")) {
  printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
}

$stats = mysqlnd_ms_get_stats();
printf("Transient error retries after error: %d\n", $stats['transient_error_retries']);

$mysqli-&gt;close();
?&gt;

    </pre><p>
            The above example will output something similar to:
          </p><pre class="screen">

Transient error retries before error: 0
[1062] Duplicate entry '1' for key 'PRIMARY'
Transient error retries before error: 2

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        Because the execution of the retry loop is transparent from a
        users point of view, the example checks the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats">statistics</a>
        provided by the plugin to learn about it.
      </p><p>
        As the example shows, the plugin can be instructed to consider
        any error transient regardless of the database servers error
        semantics. The only error that a stock MySQL server considers
        temporary has the error code <code class="constant">1297</code>. When
        configuring other error codes but <code class="constant">1297</code> make
        sure your configuration reflects the semantics of your clusters
        error codes.
      </p><p>
        The following mysqlnd C API calls are monitored by the plugin to
        check for transient errors: <code class="literal">query()</code>,
        <code class="literal">change_user()</code>,
        <code class="literal">select_db()</code>,
        <code class="literal">set_charset()</code>,
        <code class="literal">set_server_option()</code>
        <code class="literal">prepare()</code>, <code class="literal">execute()</code>,
        <code class="literal">set_autocommit()</code>,
        <code class="literal">tx_begin()</code>, <code class="literal">tx_commit()</code>,
        <code class="literal">tx_rollback()</code>,
        <code class="literal">tx_commit_or_rollback()</code>. The corresponding
        user API calls have similar names.
      </p><p>
        The maximum time the plugin may sleep during the retry loop
        depends on the function in question. The a retry loop for
        <code class="literal">query()</code>, <code class="literal">prepare()</code> or
        <code class="literal">execute()</code> will sleep for up to
        <code class="literal">max_retries * usleep_retry</code> milliseconds.
      </p><p>
        However, functions that
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.pooling" title="7.5.2 Connection pooling and switching">control connection
        state</a> are dispatched to all connections. The retry loop
        settings are applied to every connection on which the command is
        to be run. Thus, such a function may interrupt program execution
        for longer than a function that is run on one server only. For
        example, <code class="literal">set_autocommit()</code> is dispatched to
        connections and may sleep up to <code class="literal">(max_retries *
        usleep_retry) * number_of_open_connections)</code>
        milliseconds. Please, keep this in mind when setting long sleep
        times and large retry numbers. Using the default settings of
        <code class="literal">max_retries=1</code>,
        <code class="literal">usleep_retry=100</code> and
        <code class="literal">lazy_connections=1</code> it is unlikely that you
        will ever see a delay of more than 1 second.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.failover"></a>7.5.6 Failover</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        By default, connection failover handling is left to the user.
        The application is responsible for checking return values of the
        database functions it calls and reacting to possible errors. If,
        for example, the plugin recognizes a query as a read-only query
        to be sent to the slave servers, and the slave server selected
        by the plugin is not available, the plugin will raise an error
        after not executing the statement.
      </p><p>
        <span class="emphasis"><em>Default: manual failover</em></span>
      </p><p>
        It is up to the application to handle the error and, if
        required, re-issue the query to trigger the selection of another
        slave server for statement execution. The plugin will make no
        attempts to failover automatically, because the plugin cannot
        ensure that an automatic failover will not change the state of
        the connection. For example, the application may have issued a
        query which depends on SQL user variables which are bound to a
        specific connection. Such a query might return incorrect results
        if the plugin would switch the connection implicitly as part of
        automatic failover. To ensure correct results, the application
        must take care of the failover, and rebuild the required
        connection state. Therefore, by default, no automatic failover
        is performed by the plugin.
      </p><p>
        A user that does not change the connection state after opening a
        connection may activate automatic failover. Please note, that
        automatic failover logic is limited to connection attempts.
        Automatic failover is not used for already established
        connections. There is no way to instruct the plugin to attempt
        failover on a connection that has been connected to MySQL
        already in the past.
      </p><p>
        <span class="emphasis"><em>Automatic failover</em></span>
      </p><p>
        The failover policy is configured in the plugins configuration
        file, by using the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.failover">failover</a>
        configuration directive.
      </p><p>
        Automatic and silent failover can be enabled through the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.failover">failover</a>
        configuration directive. Automatic failover can either be
        configured to try exactly one master after a slave failure or,
        alternatively, loop over slaves and masters before returning an
        error to the user. The number of connection attempts can be
        limited and failed hosts can be excluded from future load
        balancing attempts. Limiting the number of retries and
        remembering failed hosts are considered experimental features,
        albeit being reasonable stable. Syntax and semantics may change
        in future versions.
      </p><p>
        Please note, since version 1.5.0 automatic failover is disabled
        for the duration of a transaction if transaction stickiness is
        enabled and transaction boundaries have been detected. The
        plugin will not switch connections for the duration of a
        transaction. It will also not perform automatic and silent
        failover. Instead an error will be thrown. It is then left to
        the user to handle the failure of the transaction. Please check,
        the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness"><code class="literal">trx_stickiness</code></a>
        documentation how to do this.
      </p><p>
        A basic manual failover example is provided within the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.errorhandling" title="7.5.4 Error handling">error
        handling</a> section.
      </p><p>
        <span class="emphasis"><em>Standby servers</em></span>
      </p><p>
        Using
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-random">weighted
        load balancing</a>, introduced in PECL/mysqlnd 1.4.0, it is
        possible to configure standby servers that are sparsely used
        during normal operations. A standby server that is primarily
        used as a worst-case standby failover target can be assigned a
        very low weight/priority in relation to all other servers. As
        long as all servers are up and running the majority of the
        workload is assigned to the servers which have hight weight
        values. Few requests will be directed to the standby system
        which has a very low weight value.
      </p><p>
        Upon failure of the servers with a high priority, you can still
        failover to the standby, which has been given a low load
        balancing priority by assigning a low weight to it. Failover can
        be some manually or automatically. If done automatically, you
        may want to combine it with the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.failover"><code class="literal">remember_failed</code></a>
        option.
      </p><p>
        At this point, it is not possible to instruct the load balancer
        to direct no requests at all to a standby. This may not be much
        of a limitation given that the highest weight you can assign to
        a server is 65535. Given two slaves, of which one shall act as a
        standby and has been assigned a weight of 1, the standby will
        have to handle far less than one percent of the overall
        workload.
      </p><p>
        <span class="emphasis"><em>Failover and primary copy</em></span>
      </p><p>
        Please note, if using a primary copy cluster, such as MySQL
        Replication, it is difficult to do connection failover in case
        of a master failure. At any time there is only one master in the
        cluster for a given dataset. The master is a single point of
        failure. If the master fails, clients have no target to fail
        over write requests. In case of a master outage the database
        administrator must take care of the situation and update the
        client configurations, if need be.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.loadbalancing"></a>7.5.7 Load balancing</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        Four load balancing strategies are supported to distribute
        statements over the configured MySQL slave servers:
      </p><p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
              random
            </span></dt><dd><p>
                Chooses a random server whenever a statement is
                executed.
              </p></dd><dt><span class="term">
              random once (default)
            </span></dt><dd><p>
                Chooses a random server after the first statement is
                executed, and uses the decision for the rest of the PHP
                request.
              </p><p>
                It is the default, and the lowest impact on the
                connection state.
              </p></dd><dt><span class="term">
              round robin
            </span></dt><dd><p>
                Iterates over the list of configured servers.
              </p></dd><dt><span class="term">
              user-defined via callback
            </span></dt><dd><p>
                Is used to implement any other strategy.
</p></dd></dl>
</div>
<p>
      </p><p>
        The load balancing policy is configured in the plugins
        configuration file using the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-random">random</a>,
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-roundrobin">roundrobin</a>,
        and
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-user">user</a>
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.filter" title="7.5.9 Filter">filters</a>.
      </p><p>
        Servers can be prioritized assigning a weight. A server that has
        been given a weight of two will get twice as many requests as a
        server that has been given the default weight of one.
        Prioritization can be handy in heterogenous environments. For
        example, you may want to assign more requests to a powerful
        machine than to a less powerful. Or, you may have configured
        servers that are close or far from the client, thus expose
        different latencies.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.rwsplit"></a>7.5.8 Read-write splitting</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        The plugin executes read-only statements on the configured MySQL
        slaves, and all other queries on the MySQL master. Statements
        are considered read-only if they either start with
        <code class="literal">SELECT</code>, the SQL hint
        <code class="literal">/*ms=slave*/</code>, or if a slave had been chosen
        for running the previous query and the query starts with the SQL
        hint <code class="literal">/*ms=last_used*/</code>. In all other cases,
        the query will be sent to the MySQL replication master server.
        It is recommended to use the constants
        <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code>,
        <code class="constant">MYSQLND_MS_MASTER_SWITCH</code> and
        <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code> instead of
        <code class="literal">/*ms=slave*/</code>. See also the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.constants" title="7.7 Predefined Constants">list of mysqlnd_ms
        constants</a>.
      </p><p>
        SQL hints are a special kind of standard compliant SQL comments.
        The plugin does check every statement for certain SQL hints. The
        SQL hints are described within the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.constants" title="7.7 Predefined Constants">mysqlnd_ms
        constants</a> documentation, constants that are exported by
        the extension. Other systems involved with the statement
        processing, such as the MySQL server, SQL firewalls, and SQL
        proxies, are unaffected by the SQL hints, because those systems
        are designed to ignore SQL comments.
      </p><p>
        The built-in read-write splitter can be replaced by a
        user-defined filter, see also the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-user">user
        filter</a> documentation.
      </p><p>
        A user-defined read-write splitter can request the built-in
        logic to send a statement to a specific location, by invoking
        <a class="ulink" href="http://www.php.net/mysqlnd_ms_is_select" target="_top"><code class="function">mysqlnd_ms_is_select</code></a>.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          The built-in read-write splitter is not aware of
          multi-statements. Multi-statements are seen as one statement.
          The splitter will check the beginning of the statement to
          decide where to run the statement. If, for example, a
          multi-statement begins with <code class="literal">SELECT 1 FROM DUAL;
          INSERT INTO test(id) VALUES (1); ...</code> the plugin will
          run it on a slave although the statement is not read-only.
</p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.filter"></a>7.5.9 Filter</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          Filters exist as of mysqlnd_ms version 1.1.0-beta.
</p>
</div>
<p>
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json" title="7.6.4 Plugin configuration file (&gt;=1.1.x)">filters</a>.
        PHP applications that implement a MySQL replication cluster must
        first identify a group of servers in the cluster which could
        execute a statement before the statement is executed by one of
        the candidates. In other words: a defined list of servers must
        be filtered until only one server is available.
      </p><p>
        The process of filtering may include using one or more filters,
        and filters can be chained. And they are executed in the order
        they are defined in the plugins configuration file.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Explanation: comparing filter chaining to pipes
</div>
<p>
          The concept of chained filters can be compared to using pipes
          to connect command line utilities on an operating system
          command shell. For example, an input stream is passed to a
          processor, filtered, and then transferred to be output. Then,
          the output is passed as input to the next command, which is
          connected to the previous using the pipe operator.
</p>
</div>
<p>
        Available filters:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Load balancing filters:
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filters">random</a> and
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filters">roundrobin</a>.
     </li><li class="listitem">
      Selection filter:
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filters">user</a>,
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filters">user_multi</a>,
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filters">quality_of_service</a>.
</li></ul>
</div>
<p>
      </p><p>
        The <code class="literal">random</code> filter implements the
        'random' and 'random once' load balancing
        policies. The 'round robin' load balancing can be
        configured through the <code class="literal">roundrobin</code> filter.
        Setting a 'user defined callback' for server selection
        is possible with the <code class="literal">user</code> filter. The
        <code class="literal">quality_of_service</code> filter finds cluster nodes
        capable of delivering a certain service, for example,
        read-your-writes or, not lagging more seconds behind the master
        than allowed.
      </p><p>
        Filters can accept parameters to change their behavior. The
        <code class="literal">random</code> filter accepts an optional
        <code class="literal">sticky</code> parameter. If set to true, the filter
        changes load balancing from random to random once. Random picks
        a random server every time a statement is to be executed. Random
        once picks a random server when the first statement is to be
        executed and uses the same server for the rest of the PHP
        request.
      </p><p>
        One of the biggest strength of the filter concept is the
        possibility to chain filters. This strength does not become
        immediately visible because the <code class="literal">random</code>,
        <code class="literal">roundrobin</code> and <code class="literal">user</code>
        filters are supposed to output no more than one server. If a
        filter reduces the list of candidates for running a statement to
        only one server, it makes little sense to use that one server as
        input for another filter for further reduction of the list of
        candidates.
      </p><p>
        An example filter sequence that will fail:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Statement to be executed: <code class="literal">SELECT 1 FROM DUAL</code>. Passed to all filters.
     </li><li class="listitem">
      All configured nodes are passed as input to the first filter.
      Master nodes: <code class="literal">master_0</code>.
      Slave nodes:<code class="literal">slave_0</code>, <code class="literal">slave_1</code>

            </li><li class="listitem">
      Filter: <code class="literal">random</code>, argument <code class="literal">sticky=1</code>.
      Picks a random slave once to be used for the rest of the PHP request.
      Output: <code class="literal">slave_0</code>.
     </li><li class="listitem">
      Output of <code class="literal">slave_0</code> and the statement to be executed
      is passed as input to the next filter. Here: <code class="literal">roundrobin</code>,
      server list passed to filter is: <code class="literal">slave_0</code>.
     </li><li class="listitem">
      Filter: <code class="literal">roundrobin</code>. Server list consists of
      one server only, round robin will always return the same server.
</li></ul>
</div>
<p>

        If trying to use such a filter sequence, the plugin may emit a
        warning like <code class="literal">(mysqlnd_ms) Error while creating filter
        '%s' . Non-multi filter '%s' already
        created. Stopping in %s on line %d</code>. Furthermore, an
        appropriate error on the connection handle may be set.
      </p><p>
        A second type of filter exists: multi filter. A multi filter
        emits zero, one or multiple servers after processing. The
        <code class="literal">quality_of_service</code> filter is an example. If
        the service quality requested sets an upper limit for the slave
        lag and more than one slave is lagging behind less than the
        allowed number of seconds, the filter returns more than one
        cluster node. A multi filter must be followed by other to
        further reduce the list of candidates for statement execution
        until a candidate is found.
      </p><p>
        A filter sequence with the <code class="literal">quality_of_service</code>
        multi filter followed by a load balancing filter.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Statement to be executed: <code class="literal">SELECT sum(price) FROM orders WHERE order_id = 1</code>.
      Passed to all filters.
     </li><li class="listitem">
      All configured nodes are passed as input to the first filter.
      Master nodes: <code class="literal">master_0</code>.
      Slave nodes: <code class="literal">slave_0</code>, <code class="literal">slave_1</code>,
      <code class="literal">slave_2</code>, <code class="literal">slave_3</code>

            </li><li class="listitem">
      Filter: <code class="literal">quality_of_service</code>, rule set: session_consistency (read-your-writes)
      Output: <code class="literal">master_0</code>

            </li><li class="listitem">
      Output of <code class="literal">master_0</code>
      and the statement to be executed
      is passed as input to the next filter, which is <code class="literal">roundrobin</code>.
     </li><li class="listitem">
      Filter: <code class="literal">roundrobin</code>. Server list consists of
      one server. Round robin selects <code class="literal">master_0</code>.
</li></ul>
</div>
<p>
      </p><p>
        A filter sequence must not end with a multi filter. If trying to
        use a filter sequence which ends with a multi filter the plugin
        may emit a warning like <code class="literal">(mysqlnd_ms) Error in
        configuration. Last filter is multi filter. Needs to be
        non-multi one. Stopping in %s on line %d</code>. Furthermore,
        an appropriate error on the connection handle may be set.
      </p><p>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Speculation towards the future: MySQL replication filtering
</div>
<p>
            In future versions, there may be additional multi filters.
            For example, there may be a <code class="literal">table</code> filter
            to support MySQL replication filtering. This would allow you
            to define rules for which database or table is to be
            replicated to which node of a replication cluster. Assume
            your replication cluster consists of four slaves
            (<code class="literal">slave_0</code>, <code class="literal">slave_1</code>,
            <code class="literal">slave_2</code>, <code class="literal">slave_3</code>) two
            of which replicate a database named <code class="literal">sales</code>
            (<code class="literal">slave_0</code>, <code class="literal">slave_1</code>). If
            the application queries the database
            <code class="literal">slaves</code>, the hypothetical
            <code class="literal">table</code> filter reduces the list of possible
            servers to <code class="literal">slave_0</code> and
            <code class="literal">slave_1</code>. Because the output and list of
            candidates consists of more than one server, it is necessary
            and possible to add additional filters to the candidate
            list, for example, using a load balancing filter to identify
            a server for statement execution.
</p>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.qos-consistency"></a>7.5.10 Service level and consistency</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          Service levels have been introduced in mysqlnd_ms version
          1.2.0-alpha.
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
          requires PHP 5.4.0 or newer.
</p>
</div>
<p>
        The plugin can be used with different kinds of MySQL database
        clusters. Different clusters can deliver different levels of
        service to applications. The service levels can be grouped by
        the data consistency levels that can be achieved. The plugin
        knows about:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">eventual consistency</li><li class="listitem">session consistency</li><li class="listitem">strong consistency</li></ul>
</div>
<p>
      </p><p>
        Depending how a cluster is used it may be possible to achieve
        higher service levels than the default one. For example, a read
        from an asynchronous MySQL replication slave is eventual
        consistent. Thus, one may say the default consistency level of a
        MySQL replication cluster is eventual consistency. However, if
        the master only is used by a client for reading and writing
        during a session, session consistency (read your writes) is
        given. PECL mysqlnd 1.2.0 abstracts the details of choosing an
        appropriate node for any of the above service levels from the
        user.
      </p><p>
        Service levels can be set through the qualify-of-service filter
        in the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json" title="7.6.4 Plugin configuration file (&gt;=1.1.x)">plugins
        configuration file</a> and at runtime using the function
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
      </p><p>
        The plugin defines the different service levels as follows.
      </p><p>
        Eventual consistency is the default service provided by an
        asynchronous cluster, such as classical MySQL replication. A
        read operation executed on an arbitrary node may or may not
        return stale data. The applications view of the data is eventual
        consistent.
      </p><p>
        Session consistency is given if a client can always read its own
        writes. An asynchronous MySQL replication cluster can deliver
        session consistency if clients always use the master after the
        first write or never query a slave which has not yet replicated
        the clients write operation.
      </p><p>
        The plugins understanding of strong consistency is that all
        clients always see the committed writes of all other clients.
        This is the default when using MySQL Cluster or any other
        cluster offering synchronous data distribution.
      </p><p>
        <span class="emphasis"><em>Service level parameters</em></span>
      </p><p>
        Eventual consistency and session consistency service level
        accept parameters.
      </p><p>
        Eventual consistency is the service provided by classical MySQL
        replication. By default, all nodes qualify for read requests. An
        optional <code class="literal">age</code> parameter can be given to filter
        out nodes which lag more than a certain number of seconds behind
        the master. The plugin is using <code class="literal">SHOW SLAVE
        STATUS</code> to measure the lag. Please, see the MySQL
        reference manual to learn about accuracy and reliability of the
        <code class="literal">SHOW SLAVE STATUS</code> command.
      </p><p>
        Session consistency (read your writes) accepts an optional
        <code class="literal">GTID</code> parameter to consider reading not only
        from the master but also from slaves which already have
        replicated a certain write described by its transaction
        identifier. This way, when using asynchronous MySQL replication,
        read requests may be load balanced over slaves while still
        ensuring session consistency.
      </p><p>
        The latter requires the use of
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">client-side global
        transaction id injection</a>.
      </p><p>
        <span class="emphasis"><em>Advantages of the new approach</em></span>
      </p><p>
        The new approach supersedes the use of SQL hints and the
        configuration option <code class="literal">master_on_write</code> in some
        respects. If an application running on top of an asynchronous
        MySQL replication cluster cannot accept stale data for certain
        reads, it is easier to tell the plugin to choose appropriate
        nodes than prefixing all read statements in question with the
        SQL hint to enforce the use of the master. Furthermore, the
        plugin may be able to use selected slaves for reading.
      </p><p>
        The <code class="literal">master_on_write</code> configuration option
        makes the plugin use the master after the first write (session
        consistency, read your writes). In some cases, session
        consistency may not be needed for the rest of the session but
        only for some, few read operations. Thus,
        <code class="literal">master_on_write</code> may result in more read load
        on the master than necessary. In those cases it is better to
        request a higher than default service level only for those reads
        that actually need it. Once the reads are done, the application
        can return to default service level. Switching between service
        levels is only possible using
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
      </p><p>
        <span class="emphasis"><em>Performance considerations</em></span>
      </p><p>
        A MySQL replication cluster cannot tell clients which slaves are
        capable of delivering which level of service. Thus, in some
        cases, clients need to query the slaves to check their status.
        PECL mysqlnd_ms transparently runs the necessary SQL in the
        background. However, this is an expensive and slow operation.
        SQL statements are run if eventual consistency is combined with
        an age (slave lag) limit and if session consistency is combined
        with a global transaction ID.
      </p><p>
        If eventual consistency is combined with an maximum age (slave
        lag), the plugin selects candidates for statement execution and
        load balancing for each statement as follows. If the statement
        is a write all masters are considered as candidates. Slaves are
        not checked and not considered as candidates. If the statement
        is a read, the plugin transparently executes <code class="literal">SHOW SLAVE
        STATUS</code> on every slaves connection. It will loop over
        all connections, send the statement and then start checking for
        results. Usually, this is slightly faster than a loop over all
        connections in which for every connection a query is send and
        the plugin waits for its results. A slave is considered a
        candidate if <code class="literal">SHOW SLAVE STATUS</code> reports
        <code class="literal">Slave_IO_Running=Yes</code>,
        <code class="literal">Slave_SQL_Running=Yes</code> and
        <code class="literal">Seconds_Behind_Master</code> is less or equal than
        the allowed maximum age. In case of an SQL error, the plugin
        emits a warning but does not set an error on the connection. The
        error is not set to make it possible to use the plugin as a
        drop-in.
      </p><p>
        If session consistency is combined with a global transaction ID,
        the plugin executes the SQL statement set with the
        <code class="literal">fetch_last_gtid</code> entry of the
        <code class="literal">global_transaction_id_injection</code> section from
        the plugins configuration file. Further details are identical to
        those described above.
      </p><p>
        In version 1.2.0 no additional optimizations are done for
        executing background queries. Future versions may contain
        optimizations, depending on user demand.
      </p><p>
        If no parameters and options are set, no SQL is needed. In that
        case, the plugin consider all nodes of the type shown below.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">eventual consistency, no further options set: all masters, all slaves</li><li class="listitem">session consistency, no further options set: all masters</li><li class="listitem">strong consistency (no options allowed): all masters</li></ul>
</div>
<p>
      </p><p>
        <span class="emphasis"><em>Throttling</em></span>
      </p><p>
        The quality of service filter can be combined with
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">Global transaction
        IDs</a> to throttle clients. Throttling does reduce the write
        load on the master by slowing down clients. If session
        consistency is requested and global transactions identifier are
        used to check the status of a slave, the check can be done in
        two ways. By default a slave is checked and skipped immediately
        if it does not match the criteria for session consistency.
        Alternatively, the plugin can wait for a slave to catch up to
        the master until session consistency is possible. To enable the
        throttling, you have to set
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.gtid">wait_for_gtid_timeout</a>
        configuration option.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.gtid"></a>7.5.11 Global transaction IDs</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          Client side global transaction ID injection exists as of
          mysqlnd_ms version 1.2.0-alpha. Transaction boundaries are
          detected by monitoring API calls. This is possible as of PHP
          5.4.0. Please, see also
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transaction" title="7.5.3 Local transaction handling">Transaction
          handling</a>.
        </p><p>
          As of MySQL 5.6.5-m8 the MySQL server features built-in global
          transaction identifiers. The MySQL built-in global transaction
          ID feature is supported by <code class="literal">PECL/mysqlnd_ms</code>
          1.3.0-alpha or later. Neither are client-side transaction
          boundary monitoring nor any setup activities required if using
          the server feature.
        </p><p>
          Please note, all MySQL 5.6 production versions do not provide
          clients with enough information to use GTIDs for enforcing
          session consistency. In the worst case, the plugin will choose
          the master only.
</p>
</div>
<p>
        <span class="emphasis"><em>Idea and client-side emulation</em></span>
      </p><p>
        <code class="literal">PECL/mysqlnd_ms</code> can do client-side
        transparent global transaction ID injection. In its most basic
        form, a global transaction identifier is a counter which is
        incremented for every transaction executed on the master. The
        counter is held in a table on the master. Slaves replicate the
        counter table.
      </p><p>
        In case of a master failure a database administrator can easily
        identify the most recent slave for promoting it as a new master.
        The most recent slave has the highest transaction identifier.
      </p><p>
        Application developers can ask the plugin for the global
        transaction identifier (GTID) for their last successful write
        operation. The plugin will return an identifier that refers to
        an transaction no older than that of the clients last write
        operation. Then, the GTID can be passed as a parameter to the
        quality of service (QoS) filter as an option for session
        consistency. Session consistency ensures read your writes. The
        filter ensures that all reads are either directed to a master or
        a slave which has replicated the write referenced by the GTID.
      </p><p>
        <span class="emphasis"><em>When injection is done</em></span>
      </p><p>
        The plugin transparently maintains the GTID table on the master.
        In autocommit mode the plugin injects an
        <code class="literal">UPDATE</code> statement before executing the users
        statement for every master use. In manual transaction mode, the
        injection is done before the application calls
        <code class="literal">commit()</code> to close a transaction. The
        configuration option <code class="literal">report_error</code> of the GTID
        section in the plugins configuration file is used to control
        whether a failed injection shall abort the current operation or
        be ignored silently (default).
      </p><p>
        Please note, the PHP version requirements for
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transaction" title="7.5.3 Local transaction handling">transaction
        boundary monitoring</a> and their limits.
      </p><p>
        <span class="emphasis"><em>Limitations</em></span>
      </p><p>
        Client-side global transaction ID injection has shortcomings.
        The potential issues are not specific to
        <code class="literal">PECL/mysqlnd_ms</code> but are rather of general
        nature.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Global transaction ID tables must be deployed on all masters and replicas.
     </li><li class="listitem">
      The GTID can have holes. Only PHP clients using the plugin will
      maintain the table. Other clients will not.
     </li><li class="listitem">
      Client-side transaction boundary detection is based on API calls only.
     </li><li class="listitem">
      Client-side transaction boundary detection does not take implicit
      commit into account. Some MySQL SQL statements cause an implicit
      commit and cannot be rolled back.
</li></ul>
</div>
<p>
      </p><p>
        <span class="emphasis"><em>Using server-side global transaction
        identifier</em></span>
      </p><p>
        Starting with <code class="literal">PECL/mysqlnd_ms</code> 1.3.0-alpha the
        MySQL 5.6.5-m8 or newer built-in global transaction identifier
        feature is supported. Use of the server feature lifts all of the
        above listed limitations. Please, see the MySQL Reference Manual
        for limitations and preconditions for using server built-in
        global transaction identifiers.
      </p><p>
        Whether to use the client-side emulation or the server built-in
        functionality is a question not directly related to the plugin,
        thus it is not discussed in depth. There are no plans to remove
        the client-side emulation and you can continue to use it, if the
        server-side solution is no option. This may be the case in
        heterogenous environments with old MySQL server or, if any of
        the server-side solution limitations is not acceptable.
      </p><p>
        From an applications perspective there is hardly a difference in
        using one or the other approach. The following properties
        differ.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
      Client-side emulation, as shown in the manual, is using an easy to compare sequence number
      for global transactions. Multi-master is not handled to keep the manual examples easy.
     </p><p class="simpara">
      Server-side built-in feature is using a combination of a server identifier
      and a sequence number as a global transaction identifier. Comparison cannot
      use numeric algebra. Instead a SQL function must be used. Please,
      see the MySQL Reference Manual for details.
     </p><p class="simpara">
      Server-side built-in feature of MySQL 5.6 cannot be used to ensure session consistency
      under all circumstances. Do not use it for the quality-of-service feature. Here is a simple
      example why it will not give reliable results. There are more edge cases that cannot
      be covered with limited functionality exported by the server. Currently, clients can
      ask a MySQL replication master for a list of all executed global transaction IDs only.
      If a slave is configured not to replicate all transactions, for example, because replication
      filters are set, then the slave will never show the same set of executed global transaction
      IDs. Albeit the slave may have replicated a clients writes and it may be a candidate
      for a consistent read, it will never be considered by the plugin. Upon write the plugin
      learns from the master that the servers complete transaction history consists of GTID=1..3.
      There is no way for the plugin to ask for the GTID of the write transaction itself, say GTID=3.
      Assume that a slave does not replicate the transactions GTID=1..2 but only GTID=3 because of
      a replication feature. Then, the slaves transaction history is GTID=3. However, the plugin tries
      to find a node which has a transaction history of GITD=1...3. Albeit the slave has replicated
      the clients write and session consistency may be achieved when reading from the slave, it
      will not be considered by the plugin. This is not a fault of the plugin implementation but
      a feature gap on the server side. Please note, this is a trivial case to illustrate the
      issue there are other issues. In sum you are asked not to attempt  using MySQL 5.6 built-in GTIDs
      for enforcing session consistency. Sooner or later the load balancing will stop working properly
      and the plugin will direct all session consistency requests to the master.
     </p></li><li class="listitem">
      Plugin global transaction ID statistics are only available with client-side
      emulation because they monitor the emulation.
</li></ul>
</div>
<p>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Global transaction identifiers in distributed systems
</div>
<p>
          Global transaction identifiers can serve multiple purposes in
          the context of distributed systems, such as a database
          cluster. Global transaction identifiers can be used for, for
          example, system wide identification of transactions, global
          ordering of transactions, heartbeat mechanism and for checking
          the replication status of replicas.
          <code class="literal">PECL/mysqlnd_ms</code>, a clientside driver based
          software, does focus on using GTIDs for tasks that can be
          handled at the client, such as checking the replication status
          of replicas for asynchronous replication setups.
</p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.concept_cache"></a>7.5.12 Cache integration</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          The feature requires use of <code class="literal">PECL/mysqlnd_ms</code>
          1.3.0-beta or later, and <code class="literal">PECL/mysqlnd_qc</code>
          1.1.0-alpha or newer. <code class="literal">PECL/mysqlnd_ms</code> must
          be compiled to support the feature. PHP 5.4.0 or newer is
          required.
</p>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title">
Setup: extension load order
</div>
<p>
          <code class="literal">PECL/mysqlnd_ms</code> must be loaded before
          <code class="literal">PECL/mysqlnd_qc</code>, when using shared
          extensions.
</p>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title">
Feature stability
</div>
<p>
          The cache integration is of beta quality.
</p>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title">
Suitable MySQL clusters
</div>
<p>
          The feature is targeted for use with MySQL Replication
          (primary copy). Currently, no other kinds of MySQL clusters
          are supported. Users of such cluster must control
          PECL/mysqlnd_qc manually if they are interested in client-side
          query caching.
</p>
</div>
<p>
        Support for MySQL replication clusters (asynchronous primary
        copy) is the main focus of <code class="literal">PECL/mysqlnd_ms</code>.
        The slaves of a MySQL replication cluster may or may not reflect
        the latest updates from the master. Slaves are asynchronous and
        can lag behind the master. A read from a slave is eventual
        consistent from a cluster-wide perspective.
      </p><p>
        The same level of consistency is offered by a local cache using
        time-to-live (TTL) invalidation strategy. Current data or stale
        data may be served. Eventually, data searched for in the cache
        is not available and the source of the cache needs to be
        accessed.
      </p><p>
        Given that both a MySQL Replication slave (asynchronous
        secondary) and a local TTL-driven cache deliver the same level
        of service it is possible to transparently replace a remote
        database access with a local cache access to gain better
        possibility.
      </p><p>
        As of <code class="literal">PECL/mysqlnd_ms</code> 1.3.0-beta the plugin
        is capable of transparently controlling
        <code class="literal">PECL/mysqlnd_ms</code> 1.1.0-alpha or newer to cache
        a read-only query if explicitly allowed by setting an
        appropriate quality of service through
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
        P lease, see the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.cache" title="7.4.9 Cache integration">quickstart</a>
        for a code example. Both plugins must be installed,
        <code class="literal">PECL/mysqlnd_ms</code> must be compiled to support
        the cache feature and PHP 5.4.0 or newer has to be used.
      </p><p>
        Applications have full control of cache usage and can request
        fresh data at any time, if need be. The cache usage can be
        enabled and disabled time during the execution of a script. The
        cache will be used if
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
        sets the quality of service to eventual consistency and enables
        cache usage. Cache usage is disabled by requesting higher
        consistency levels, for example, session consistency (read your
        writes). Once the quality of service has been relaxed to
        eventual consistency the cache can be used again.
      </p><p>
        If caching is enabled for a read-only statement,
        <code class="literal">PECL/mysqlnd_ms</code> may inject
        <a class="link" href="apis-php-mysqlnd-qc.html#apis-php-mysqlnd-qc.quickstart.caching" title="8.4.3 Caching queries">SQL hints
        to control caching</a> by PECL/mysqlnd_qc. It may modify the
        SQL statement it got from the application. Subsequent SQL
        processors are supposed to ignore the SQL hints. A SQL hint is a
        SQL comment. Comments must not be ignored, for example, by the
        database server.
      </p><p>
        The TTL of a cache entry is computed on a per statement basis.
        Applications set an maximum age for the data they want to
        retrieve using
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
        The age sets an approximate upper limit of how many seconds the
        data returned may lag behind the master.
      </p><p>
        The following logic is used to compute the actual TTL if caching
        is enabled. The logic takes the estimated slave lag into account
        for choosing a TTL. If, for example, there are two slaves
        lagging 5 and 10 seconds behind and the maximum age allowed is
        60 seconds, the TTL is set to 50 seconds. Please note, the age
        setting is no more than an estimated guess.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Check whether the statement is read-only. If not, don't cache.
     </li><li class="listitem">
      If caching is enabled, check the slave lag of all configured slaves.
      Establish slave connections if none exist so far and lazy connections are
      used.
     </li><li class="listitem">
      Send <code class="literal">SHOW SLAVE STATUS</code> to all slaves. Do not wait
      for the first slave to reply before sending to the second slave. Clients
      often wait long for replies, thus we send out all requests in a burst before
      fetching in a second stage.
     </li><li class="listitem">
      Loop over all slaves. For every slave wait for its reply. Do not start
      checking another slave before the currently waited for slave has replied.
      Check for <code class="literal">Slave_IO_Running=Yes</code> and <code class="literal">Slave_SQL_Running=Yes</code>.
      If both conditions hold true, fetch the value of <code class="literal">Seconds_Behind_Master</code>.
      In case of any errors or if conditions fail, set an error on the slave connection.
      Skip any such slave connection for the rest of connection filtering.
     </li><li class="listitem">
      Search for the maximum value of <code class="literal">Seconds_Behind_Master</code> from
      all slaves that passed the previous conditions. Subtract the value from
      the maximum age provided by the user with <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
      Use the result as a TTL.
     </li><li class="listitem">
      The filtering may sort out all slaves. If so, the maximum age is used as
      TTL, because the maximum lag found equals zero. It is perfectly valid to
      sort out all slaves. In the following it is up to subsequent filter
      to decide what to do. The built-in load balancing filter will pick the
      master.
     </li><li class="listitem">
      Inject the appropriate SQL hints to enable caching by <code class="literal">PECL/mysqlnd_qc</code>.
     </li><li class="listitem">
      Proceed with the connection filtering, e.g. apply load balancing rules to
      pick a slave.
     </li><li class="listitem"><code class="literal">PECL/mysqlnd_qc</code> is loaded after
      <code class="literal">PECL/mysqlnd_ms</code> by PHP. Thus, it will see
      all query modifications of <code class="literal">PECL/mysqlnd_ms</code> and cache
      the query if instructed to do so.
</li></ul>
</div>
<p>
      </p><p>
        The algorithm may seem expensive. <code class="literal">SHOW SLAVE
        STATUS</code> is a very fast operation. Given a sufficient
        number of requests and cache hits per second the cost of
        checking the slaves lag can easily outweigh the costs of the
        cache decision.
      </p><p>
        Suggestions on a better algorithm are always welcome.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.supportedclusters"></a>7.5.13 Supported clusters</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        Any application using any kind of MySQL cluster is faced with
        the same tasks:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Identify nodes capable of executing a given statement with
      the required service level
     </li><li class="listitem">
       Load balance requests within the list of candidates
     </li><li class="listitem">
       Automatic fail over within candidates, if needed
</li></ul>
</div>
<p>
      </p><p>
        The plugin is optimized for fulfilling these tasks in the
        context of a classical asynchronous MySQL replication cluster
        consisting of a single master and many slaves (primary copy).
        When using classical, asynchronous MySQL replication all of the
        above listed tasks need to be mastered at the client side.
      </p><p>
        Other types of MySQL cluster may have lower requirements on the
        application side. For example, if all nodes in the cluster can
        answer read and write requests, no read-write splitting needs to
        be done (multi-master, update-all). If all nodes in the cluster
        are synchronous, they automatically provide the highest possible
        quality of service which makes choosing a node easier. In this
        case, the plugin may serve the application after some
        reconfiguration to disable certain features, such as built-in
        read-write splitting.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Documentation focus
</div>
<p>
          The documentation focusses describing the use of the plugin
          with classical asynchronous MySQL replication clusters
          (primary copy). Support for this kind of cluster has been the
          original development goal. Use of other clusters is briefly
          described below. Please note, that this is still work in
          progress.
</p>
</div>
<p>
        <span class="emphasis"><em>Primary copy (MySQL Replication)</em></span>
      </p><p>
        This is the primary use case of the plugin. Follow the hints
        given in the descriptions of each feature.
      </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Configure one master and one or more slaves.
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.server-list-syntax">Server configuration details</a>
      are given in the setup section.
     </li><li class="listitem">
      Use random load balancing policy together with the
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-random">sticky</a> flag.
     </li><li class="listitem">
      If you do not plan to use the
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.qos-consistency" title="7.4.7 Service level and consistency">service level</a> API calls,
      add the <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.master-on-write">master on write</a>
      flag.
     </li><li class="listitem">
      Please, make yourself aware of the properties of automatic failover before
      adding a <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.failover">failover</a> directive.
     </li><li class="listitem">
       Consider the use of <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">trx_stickiness</a>
       to execute transactions on the primary only. Please, read carefully how it works
       before you rely on it.
</li></ul>
</div>
<p>
      </p><p>
</p>
<div class="example">
<a name="idm139660445335216"></a><p class="title"><b>Example 7.51 Enabling the plugin (php.ini)</b></p>
<div class="example-contents">
<pre class="programlisting">

mysqlnd_ms.enable=1
mysqlnd_ms.config_file=/path/to/mysqlnd_ms_plugin.ini

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445333264"></a><p class="title"><b>Example 7.52 Basic plugin configuration (mysqlnd_ms_plugin.ini) for MySQL Replication</b></p>
<div class="example-contents">
<pre class="programlisting">

{
  "myapp": {
    "master": {
      "master_1": {
        "host": "localhost",
        "socket": "\/tmp\/mysql57.sock"
      }
    },
    "slave": {
      "slave_0": {
        "host": "127.0.0.1",
        "port": 3308
      },
      "slave_1": {
        "host": "192.168.2.28",
        "port": 3306
      }
    },
    "filters": {
      "random": {
        "sticky": "1"
      }
    }
  }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        <span class="emphasis"><em>Primary copy with multi primaries (MMM - MySQL Multi
        Master)</em></span>
      </p><p>
        MySQL Replication allows you to create cluster topologies with
        multiple masters (primaries). Write-write conflicts are not
        handled by the replication system. This is no update anywhere
        setup. Thus, data must be partitioned manually and clients must
        redirected in accordance to the partitioning rules. The
        recommended setup is equal to the sharding setup below.
      </p><p>
        <span class="emphasis"><em>Manual sharding, possibly combined with primary copy
        and multiple primaries</em></span>
      </p><p>
        Use SQL hints and the node group filter for clusters that use
        data partitioning but leave query redirection to the client. The
        example configuration shows a multi master setup with two
        shards.
      </p><p>
</p>
<div class="example">
<a name="idm139660445327856"></a><p class="title"><b>Example 7.53 Multiple primaries - multi master (php.ini)</b></p>
<div class="example-contents">
<pre class="programlisting">

mysqlnd_ms.enable=1
mysqlnd_ms.config_file=/path/to/mysqlnd_ms_plugin.ini
mysqlnd_ms.multi_master=1

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445325920"></a><p class="title"><b>Example 7.54 Primary copy with multiple primaries and paritioning</b></p>
<div class="example-contents">
<pre class="programlisting">

{
  "myapp": {
    "master": {
      "master_1": {
        "host": "localhost",
        "socket": "\/tmp\/mysql57.sock"
      }
      "master_2": {
        "host": "192.168.2.27",
        "socket": "3306"
      }
    },
    "slave": {
      "slave_1": {
        "host": "127.0.0.1",
        "port": 3308
      },
      "slave_2": {
        "host": "192.168.2.28",
        "port": 3306
      }
    },
    "filters": {
      "node_groups": {
        "Partition_A" : {
          "master": ["master_1"],
          "slave": ["slave_1"]
        },
        "Partition_B" : {
          "master": ["master_2"],
          "slave": ["slave_2"]
        }
      },
      "roundrobin": []
    }
  }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        The plugin can also be used with a loose collection of unrelated
        shards. For such a cluster, configure masters only and disable
        read write splitting. The nodes of such a cluster are called
        masters in the plugin configuration as they accept both reads
        and writes for their partition.
      </p><p>
        <span class="emphasis"><em>Using synchronous update everywhere clusters such as
        MySQL Cluster</em></span>
      </p><p>
        MySQL Cluster is a synchronous cluster solution. All cluster
        nodes accept read and write requests. In the context of the
        plugin, all nodes shall be considered as masters.
      </p><p>
        Use the load balancing and fail over features only.
      </p><p>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Disable the plugins <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.rwsplit" title="7.5.8 Read-write splitting">built-in read-write splitting</a>.
     </li><li class="listitem">
      Configure masters only.
     </li><li class="listitem">
      Consider random once load balancing strategy, which is the plugins default.
      If random once is used, only masters are configured and no SQL hints are used
      to force using a certain node, no connection switches will happen for the
      duration of a web request. Thus, no special handling is required
      for transactions. The plugin will pick one master at the beginning of the
      PHP script and use it until the script terminates.
     </li><li class="listitem">
      Do not set the quality of service. All nodes have all the data. This
      automatically gives you the highest possible service quality (strong consistency).
     </li><li class="listitem">
      Do not enable client-side global transaction injection. It is neither
      required to help with server-side fail over nor to assist the quality of service
      filter choosing an appropriate node.
</li></ul>
</div>
<p>
      </p><p>
        Disabling built-in read-write splitting.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Set
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration" title="7.6.3 Runtime Configuration"><code class="literal">mysqlnd_ms.disable_rw_split=1</code></a>

            </li><li class="listitem">
      Do not use <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.rwsplit" title="7.5.8 Read-write splitting">SQL hints</a>
      to enforce the use of slaves
</li></ul>
</div>
<p>
      </p><p>
        Configure masters only.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Set
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration" title="7.6.3 Runtime Configuration"><code class="literal">mysqlnd_ms.multi_master=1</code>.</a>

            </li><li class="listitem">Do not configure any slaves.</li><li class="listitem"><p class="simpara">
      Set
      <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json" title="7.6.4 Plugin configuration file (&gt;=1.1.x)">failover=loop_before_master</a></code>
      in the plugins configuration file to avoid warnings about the empty slave list
      and to make the failover logic loop over all configured masters before emitting an error.
     </p><p class="simpara">
      Please, note the warnings about automatic failover given in the previous sections.
</p></li></ul>
</div>
<p>
      </p><p>
</p>
<div class="example">
<a name="idm139660445302384"></a><p class="title"><b>Example 7.55 Multiple primaries - multi master (php.ini)</b></p>
<div class="example-contents">
<pre class="programlisting">

mysqlnd_ms.enable=1
mysqlnd_ms.config_file=/path/to/mysqlnd_ms_plugin.ini
mysqlnd_ms.multi_master=1
mysqlnd_ms.disable_rw_split=1

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
</p>
<div class="example">
<a name="idm139660445300352"></a><p class="title"><b>Example 7.56 Synchronous update anywhere cluster</b></p>
<div class="example-contents">
<pre class="programlisting">


  "myapp": {
    "master": {
      "master_1": {
        "host": "localhost",
        "socket": "\/tmp\/mysql57.sock"
      },
      "master_2": {
        "host": "192.168.2.28",
        "port": 3306
      }
    },
    "slave": {
    },
    "filters": {
      "roundrobin": {
      }
    },
    "failover": {
      "strategy": "loop_before_master",
      "remember_failed": true
    }
  }
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        If running an update everywhere cluster that has no built-in
        partitioning to avoid hot spots and high collision rates,
        consider using the node groups filter to keep updates on a
        frequently accessed table on one of the nodes. This may help to
        reduce collision rates and thus improve performance.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.concept_xa_trx"></a>7.5.14 XA/Distributed transactions</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Version requirement
</div>
<p>
          XA related functions have been introduced in
          <code class="literal">PECL/mysqlnd_ms</code> version 1.6.0-alpha.
</p>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title">
Early adaptors wanted
</div>
<p>
          The feature is currently under development. There may be
          issues and/or feature limitations. Do not use in production
          environments, although early lab tests indicate reasonable
          quality.
        </p><p>
          Please, contact the development team if you are interested in
          this feature. We are looking for real life feedback to
          complement the feature.
        </p><p>
          Below is a list of some feature restrictions.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                The feature is not yet compatible with the MySQL Fabric
                support . This limitation is soon to be lifted.
              </p><p>
                XA transaction identifier are currently restricted to
                numbers. This limitation will be lifted upon request, it
                is a simplification used during the initial
                implementation.
</p></li></ul>
</div>
<p>
</p>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title">
MySQL server restrictions
</div>
<p>
          The XA support by the MySQL server has some restrictions. Most
          noteably, the servers binary log may lack changes made by XA
          transactions in case of certain errors. Please, see the MySQL
          manual for details.
</p>
</div>
<p>
        XA/Distributed transactions can spawn multiple MySQL servers.
        Thus, they may seem like a perfect tool for sharded MySQL
        clusters, for example, clusters managed with MySQL Fabric.
        <code class="literal">PECL/mysqlnd_ms</code> hides most of the SQL
        commands to control XA transactions and performs automatic
        administrative tasks in cases of errors, to provide the user
        with a comprehensive API. Users should setup the plugin
        carefully and be well aware of server restrictions prior to
        using the feature.
      </p><p>
</p>
<div class="example">
<a name="idm139660445285232"></a><p class="title"><b>Example 7.57 General pattern for XA transactions</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");

/* BEGIN */
mysqlnd_ms_xa_begin($mysqli, 1 /* xa id */);

/* run queries on various servers */
$mysqli-&gt;query("UPDATE some_table SET col_a = 1");
...

/* COMMIT */
mysqlnd_ms_xa_commit($link, 1);
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        XA transactions use the two-phase commit protocol. The two-phase
        commit protocol is a blocking protocol. During the first phase
        participating servers begin a transaction and the client carries
        out its work. This phase is followed by a second voting phase.
        During voting, the servers first make a firm promise that they
        are ready to commit the work even in case of their possible
        unexpected failure. Should a server crash in this phase, it will
        still recall the aborted transaction after recover and wait for
        the client to decide on whether it shall be committed or rolled
        back.
      </p><p>
        Should a client that has initiated a global transaction crash
        after all the participating servers gave their promise to be
        ready to commit, then the servers must wait for a decision. The
        servers are not allowed to unilaterally decide on the
        transaction.
      </p><p>
        A client crash or disconnect from a participant, a server crash
        or server error during the fist phase of the protocol is
        uncritical. In most cases, the server will forget about the XA
        transaction and its work is rolled back. Additionally, the
        plugin tries to reach out to as many participants as it can to
        instruct the server to roll back the work immediately. It is not
        possible to disable this implicit rollback carried out by
        <code class="literal">PECL/mysqlnd_ms</code> in case of errors during the
        first phase of the protocol. This design decision has been made
        to keep the implementation simple.
      </p><p>
        An error during the second phase of the commit protocol can
        develop into a more severe situation. The servers will not
        forget about prepared but unfinished transactions in all cases.
        The plugin will not attempt to solve these cases immediately but
        waits for optional background garbage collection to ensure
        progress of the commit protocol. It is assumed that a solution
        will take significant time as it may include waiting for a
        participating server to recover from a crash. This time span may
        be longer than a developer and end user expects when trying to
        commit a global transaction with
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit" title="7.8.12 mysqlnd_ms_xa_commit"><code class="function">mysqlnd_ms_xa_commit</code></a>.
        Thus, the function returns with the unfinished global
        transaction still requiring attention. Please, be warned that at
        this point, it is not yet clear whether the global transaction
        will be committed or rolled back later on.
      </p><p>
        Errors during the second phase can be ignored, handled by
        yourself or solved by the build-int garbage collection logic.
        Ignoring them is not recommended as you may experience
        unfinished global transactions on your servers that block
        resources virtually indefinitely. Handling the errors requires
        knowing the participants, checking their state and issuing
        appropriate SQL commands on them. There are no user API calls to
        expose this very information. You will have to configure a state
        store and make the plugin record its actions in it to receive
        the desired facts.
      </p><p>
        Please, see the
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.xa_transactions" title="7.4.6 XA/Distributed Transactions">quickstart</a>
        and related
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.xa.state-store">plugin
        configuration file settings</a> for an example how to
        configure a state. In addition to configuring a state store, you
        have to setup some SQL tables. The table definitions are given
        in the description of the plugin configuration settings.
      </p><p>
        Setting up and configuring a state store is also a precondition
        for using the built-in garbage collection for XA transactions
        that fail during the second commit phase. Recording information
        about ongoing XA transactions is an unavoidable extra task. The
        extra task consists of updating the state store after each and
        every operation that changes the state of the global transaction
        itself (started, committed, rolled back, errors and aborts), the
        addition of participants (host, optionally user and password
        required to connect) and any changes to a participants state.
        Please note, depending on configuration and your security
        policies, these recordings may be considered sensitive. It is
        therefore recommended to restrict access to the state store.
        Unless the state store itself becomes overloaded, writing the
        state information may contribute noteworthy to the runtime but
        should overall be only a minor factor.
      </p><p>
        It is possible that the effort it takes to implement your own
        routines for handling XA transactions that failed during the
        second commit phase exceeds the benefits of using the XA feature
        of <code class="literal">PECL/mysqlnd_ms</code> in the first place. Thus,
        the manual focussed on using the built-on garbage collection
        only.
      </p><p>
        Garbage collection can be triggered manually or automatically in
        the background. You may want to call
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-gc" title="7.8.13 mysqlnd_ms_xa_gc"><code class="function">mysqlnd_ms_xa_gc</code></a>
        immediately after a commit failure to attempt to solve any
        failed but still open global transactions as soon as possible.
        You may also decide to disable the automatic background garbage
        collection, implement your own rule set for invoking the
        built-in garbage collection and trigger it when desired.
      </p><p>
        By default the plugin will start the garbage collection with a
        certain probability in the extensions internal
        <code class="literal">RSHUTDOWN</code> method. The request shutdown is
        called after your script finished. Whether the garbage
        collection will be triggered is determined by computing a random
        value between <code class="literal">1...1000</code> and comparing it with
        the configuration setting
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.xa.gc"><code class="literal">probability</code></a>
        (default: 5). If the setting is greater or equal to the random
        value, the garbage collection will be triggered.
      </p><p>
        Once started, the garbage collection acts upon up to
        <code class="literal">max_transactions_per_run</code> (default: 100)
        global transactions recorded. Records include successfully
        finished but also unfinished XA transactions. Records for
        successful transactions are removed and unfinished transactions
        are attempted to be solved. There are no statistics that help
        you finding the right balance between keeping garbage collection
        runs short by limiting the number of transactions considered per
        run and preventing the garbage collection to fall behind,
        resulting in many records.
      </p><p>
        For each failed XA transaction the garbage collection makes
        <code class="literal">max_retries</code> (default: 5) attempts to finish
        it. After that <code class="literal">PECL/mysqlnd_ms</code> gives up.
        There are two possible reasons for this. Either a participating
        server crashed and has not become accessible again within
        <code class="literal">max_retries</code> invocations of the garbage
        collection, or there is a situation that the built-in garbage
        collection cannot cope with. Likely, the latter would be
        considered a bug. However, you can manually force more garbage
        collection runs calling
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-gc" title="7.8.13 mysqlnd_ms_xa_gc"><code class="function">mysqlnd_ms_xa_gc</code></a>
        with the appropriate parameter set. Should even those function
        runs fail to solve the situation, then the problem must be
        solved by an operator.
      </p><p>
        The function
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>
        provides some statistics on how many XA transactions have been
        started, committed, failed or rolled back.
</p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-mysqlnd-ms.setup"></a>7.6 Installing/Configuring</h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.requirements">7.6.1 Requirements</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.installation">7.6.2 Installation</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration">7.6.3 Runtime Configuration</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json">7.6.4 Plugin configuration file (&gt;=1.1.x)</a></span></dt></dl>
</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
</p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.requirements"></a>7.6.1 Requirements</h3>
</div>
</div>
</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        <code class="literal">PHP 5.3.6</code> or newer. Some advanced
        functionality requires <code class="literal">PHP 5.4.0</code> or newer.
      </p><p>
        The <code class="literal">mysqlnd_ms</code> replication and load balancing
        plugin supports all PHP applications and all available PHP MySQL
        extensions (<a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
        <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a>,
        <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>). The PHP
        MySQL extension must be configured to use
        <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> in order to be
        able to use the <code class="literal">mysqlnd_ms</code> plugin for
        <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a>.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.installation"></a>7.6.2 Installation</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        This <a class="ulink" href="http://pecl.php.net/" target="_top">PECL</a> extension is
        not bundled with PHP.
      </p><p>
        Information for installing this PECL extension may be found in
        the manual chapter titled
        <a class="ulink" href="http://www.php.net/install.pecl" target="_top">Installation of
        PECL extensions</a>. Additional information such as new
        releases, downloads, source files, maintainer information, and a
        CHANGELOG, can be located here:
        <a class="ulink" href="http://pecl.php.net/package/mysqlnd_ms" target="_top">http://pecl.php.net/package/mysqlnd_ms</a>
      </p><p>
        A <acronym class="acronym">DLL</acronym> for this <acronym class="acronym">PECL</acronym>
        extension is currently unavailable. See also the
        <a class="ulink" href="http://www.php.net/install.windows.building" target="_top">building
        on Windows</a> section.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.configuration"></a>7.6.3 Runtime Configuration</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
The behaviour of these functions is affected by settings in <code class="filename">php.ini</code>.
</p><p>
</p>
<div class="table">
<a name="idm139660445231024"></a><p class="title"><b>Table 7.1 Mysqlnd_ms Configure Options</b></p>
<div class="table-contents">
<table class="table" summary="Mysqlnd_ms Configure Options" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th scope="col">Name</th><th scope="col">Default</th><th scope="col">Changeable</th><th scope="col">Changelog</th></tr></thead><tbody><tr><td scope="row"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.enable">mysqlnd_ms.enable</a></td><td>0</td><td>PHP_INI_SYSTEM</td><td> </td></tr><tr><td scope="row"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.force-config-usage">mysqlnd_ms.force_config_usage</a></td><td>0</td><td>PHP_INI_SYSTEM</td><td> </td></tr><tr><td scope="row"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.ini-file">mysqlnd_ms.ini_file</a></td><td>""</td><td>PHP_INI_SYSTEM</td><td> </td></tr><tr><td scope="row"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.config-file">mysqlnd_ms.config_file</a></td><td>""</td><td>PHP_INI_SYSTEM</td><td> </td></tr><tr><td scope="row"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.collect-statistics">mysqlnd_ms.collect_statistics</a></td><td>0</td><td>PHP_INI_SYSTEM</td><td> </td></tr><tr><td scope="row"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.multi-master">mysqlnd_ms.multi_master</a></td><td>0</td><td>PHP_INI_SYSTEM</td><td> </td></tr><tr><td scope="row"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.disable-rw-split">mysqlnd_ms.disable_rw_split</a></td><td>0</td><td>PHP_INI_SYSTEM</td><td> </td></tr></tbody></table>
</div>

</div>
<p><br class="table-break">
      </p><p>
        Here's a short explanation of the configuration directives.
      </p><p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><a name="apis-php-ini.mysqlnd-ms.enable"></a><span class="term">
              <em class="parameter"><code>mysqlnd_ms.enable</code></em>
              <span class="type">integer</span>
            </span></dt><dd><p>
                Enables or disables the plugin. If disabled, the
                extension will not plug into
                <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> to proxy
                internal <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a>
                C API calls.
              </p></dd><dt><a name="apis-php-ini.mysqlnd-ms.force-config-usage"></a><span class="term">
              <em class="parameter"><code>mysqlnd_ms.force_config_usage</code></em>
              <span class="type">integer</span>
            </span></dt><dd><p>
                If enabled, the plugin checks if the host (server)
                parameters value of any MySQL connection attempt,
                matches a section name from the plugin configuration
                file. If not, the connection attempt is blocked.
              </p><p>
                This setting is not only useful to restrict PHP to
                certain servers but also to debug configuration file
                problems. The configuration file validity is checked at
                two different stages. The first check is performed when
                PHP begins to handle a web request. At this point the
                plugin reads and decodes the configuration file. Errors
                thrown at this early stage in an extensions life cycle
                may not be shown properly to the user. Thus, the plugin
                buffers the errors, if any, and additionally displays
                them when establishing a connection to MySQL. By default
                a buffered startup error will emit an error of type
                <code class="literal">E_WARNING</code>. If
                <code class="literal">force_config_usage</code> is set, the error
                type used is <code class="literal">E_RECOVERABLE_ERROR</code>.
              </p><p>
                Please, see also
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.debug_config">configuration
                file debugging notes</a>.
              </p></dd><dt><a name="apis-php-ini.mysqlnd-ms.ini-file"></a><span class="term">
              <em class="parameter"><code>mysqlnd_ms.ini_file</code></em>
              <span class="type">string</span>
            </span></dt><dd><p>
                Plugin specific configuration file. This setting has
                been renamed to
                <code class="literal">mysqlnd_ms.config_file</code> in version
                1.4.0.
              </p></dd><dt><a name="apis-php-ini.mysqlnd-ms.config-file"></a><span class="term">
              <em class="parameter"><code>mysqlnd_ms.config_file</code></em>
              <span class="type">string</span>
            </span></dt><dd><p>
                Plugin specific configuration file. This setting
                superseeds <code class="literal">mysqlnd_ms.ini_file</code> since
                1.4.0.
              </p></dd><dt><a name="apis-php-ini.mysqlnd-ms.collect-statistics"></a><span class="term">
              <em class="parameter"><code>mysqlnd_ms.collect_statistics</code></em>
              <span class="type">integer</span>
            </span></dt><dd><p>
                Enables or disables the collection of statistics. The
                collection of statistics is disabled by default for
                performance reasons. Statistics are returned by the
                function
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>.
              </p></dd><dt><a name="apis-php-ini.mysqlnd-ms.multi-master"></a><span class="term">
              <em class="parameter"><code>mysqlnd_ms.multi_master</code></em>
              <span class="type">integer</span>
            </span></dt><dd><p>
                Enables or disables support of MySQL multi master
                replication setups. Please, see also
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.supportedclusters" title="7.5.13 Supported clusters">supported
                clusters</a>.
              </p></dd><dt><a name="apis-php-ini.mysqlnd-ms.disable-rw-split"></a><span class="term">
              <em class="parameter"><code>mysqlnd_ms.disable_rw_split</code></em>
              <span class="type">integer</span>
            </span></dt><dd><p>
                Enables or disables built-in read write splitting.
              </p><p>
                Controls whether load balancing and lazy connection
                functionality can be used independently of read write
                splitting. If read write splitting is disabled, only
                servers from the master list will be used for statement
                execution. All configured slave servers will be ignored.
              </p><p>
                The SQL hint <code class="literal">MYSQLND_MS_USE_SLAVE</code>
                will not be recognized. If found, the statement will be
                redirected to a master.
              </p><p>
                Disabling read write splitting impacts the return value
                of
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-query-is-select" title="7.8.8 mysqlnd_ms_query_is_select"><code class="function">mysqlnd_ms_query_is_select</code></a>.
                The function will no longer propose query execution on
                slave servers.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Multiple master servers
</div>
<p>
                  Setting <code class="literal">mysqlnd_ms.multi_master=1</code>
                  allows the plugin to use multiple master servers,
                  instead of only the first master server of the master
                  list.
                </p><p>
                  Please, see also
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.supportedclusters" title="7.5.13 Supported clusters">supported
                  clusters</a>.
</p>
</div>
</dd></dl>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.plugin-ini-json"></a>7.6.4 Plugin configuration file (&gt;=1.1.x)</h3>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json-introduction">7.6.4.1 Introduction</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json-reference">7.6.4.2 Configuration Directives</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-v1">7.6.4.3 Plugin configuration file (&lt;= 1.0.x)</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.testing">7.6.4.4 Testing</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.debugging">7.6.4.5 Debugging and Tracing</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.monitoring">7.6.4.6 Monitoring</a></span></dt></dl>
</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        The following documentation applies to PECL/mysqlnd_ms &gt;=
        1.1.0-beta. It is not valid for prior versions. For
        documentation covering earlier versions, see the configuration
        documentation for
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-v1" title="7.6.4.3 Plugin configuration file (&lt;= 1.0.x)">mysqlnd_ms
        1.0.x and below</a>.
</p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="apis-php-mysqlnd-ms.plugin-ini-json-introduction"></a>7.6.4.1 Introduction</h4>
</div>
</div>
</div>
<p>
          <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
          Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Changelog: Feature was added in PECL/mysqlnd_ms 1.1.0-beta
</div>
<p>
            The below description applies to PECL/mysqlnd_ms &gt;=
            1.1.0-beta. It is not valid for prior versions.
</p>
</div>
<p>
          The plugin uses its own configuration file. The configuration
          file holds information about the MySQL replication master
          server, the MySQL replication slave servers, the server pick
          (load balancing) policy, the failover strategy, and the use of
          lazy connections.
        </p><p>
          The plugin loads its configuration file at the beginning of a
          web request. It is then cached in memory and used for the
          duration of the web request. This way, there is no need to
          restart PHP after deploying the configuration file.
          Configuration file changes will become active almost
          instantly.
        </p><p>
          The PHP configuration directive
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.config-file"><code class="literal">mysqlnd_ms.config_file</code></a>
          is used to set the plugins configuration file. Please note,
          that the PHP configuration directive may not be evaluated for
          every web request. Therefore, changing the plugins
          configuration file name or location may require a PHP restart.
          However, no restart is required to read changes if an already
          existing plugin configuration file is updated.
        </p><p>
          Using and parsing <acronym class="acronym">JSON</acronym> is efficient, and
          using <acronym class="acronym">JSON</acronym> makes it easier to express
          hierarchical data structures than the standard
          <code class="filename">php.ini</code> format.
        </p><p>
</p>
<div class="example">
<a name="idm139660445150048"></a><p class="title"><b>Example 7.58 Converting a PHP array (hash) into JSON format</b></p>
<div class="example-contents">
<p>
              Or alternatively, a developer may be more familiar with
              the PHP <span class="type">array</span> syntax, and prefer it. This
              example demonstrates how a developer might convert a PHP
              array to <acronym class="acronym">JSON</acronym>.
            </p><pre class="programlisting">

&lt;?php
$config = array(
  "myapp" =&gt; array(
    "master" =&gt; array(
      "master_0" =&gt; array(
        "host"   =&gt; "localhost",
        "socket" =&gt; "/tmp/mysql.sock",
      ),
    ),
    "slave" =&gt; array(),
  ),
);

file_put_contents("mysqlnd_ms.ini", json_encode($config, JSON_PRETTY_PRINT));
printf("mysqlnd_ms.ini file created...\n");
printf("Dumping file contents...\n");
printf("%s\n", str_repeat("-", 80));
echo file_get_contents("mysqlnd_ms.ini");
printf("\n%s\n", str_repeat("-", 80));
?&gt;

    </pre><p>
              The above example will output:
            </p><pre class="screen">

mysqlnd_ms.ini file created...
Dumping file contents...
--------------------------------------------------------------------------------
{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": [

        ]
    }
}
--------------------------------------------------------------------------------

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          A plugin configuration file consists of one or more sections.
          Sections are represented by the top-level object properties of
          the object encoded in the <acronym class="acronym">JSON</acronym> file.
          Sections could also be called <span class="emphasis"><em>configuration
          names</em></span>.
        </p><p>
          Applications reference sections by their name. Applications
          use section names as the host (server) parameter to the
          various connect methods of the
          <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
          <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> and
          <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
          extensions. Upon connect, the
          <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> plugin
          compares the hostname with all of the section names from the
          plugin configuration file. If the hostname and section name
          match, then the plugin will load the settings for that
          section.
        </p><p><a name="apis-php-mysqlnd-ms.plugin-ini-json.using-section"></a>
</p>
<div class="example">
<a name="idm139660445137376"></a><p class="title"><b>Example 7.59 Using section names example</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.27"
            },
            "slave_1": {
                "host": "192.168.2.27",
                "port": 3306
            }
        }
    },
    "localhost": {
        "master": [
            {
                "host": "localhost",
                "socket": "\/path\/to\/mysql.sock"
            }
        ],
        "slave": [
            {
                "host": "192.168.3.24",
                "port": "3305"
            },
            {
                "host": "192.168.3.65",
                "port": "3309"
            }
        ]
    }
}

    </pre><pre class="programlisting">

&lt;?php
/* All of the following connections will be load balanced */
$mysqli = new mysqli("myapp", "username", "password", "database");
$pdo = new PDO('mysql:host=myapp;dbname=database', 'username', 'password');
$mysql = mysql_connect("myapp", "username", "password");

$mysqli = new mysqli("localhost", "username", "password", "database");
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          Section names are strings. It is valid to use a section name
          such as <code class="literal">192.168.2.1</code>,
          <code class="literal">127.0.0.1</code> or <code class="literal">localhost</code>.
          If, for example, an application connects to
          <code class="literal">localhost</code> and a plugin configuration
          section <code class="literal">localhost</code> exists, the semantics of
          the connect operation are changed. The application will no
          longer only use the MySQL server running on the host
          <code class="literal">localhost</code>, but the plugin will start to
          load balance MySQL queries following the rules from the
          <code class="literal">localhost</code> configuration section. This way
          you can load balance queries from an application without
          changing the applications source code. Please keep in mind,
          that such a configuration may not contribute to overall
          readability of your applications source code. Using section
          names that can be mixed up with host names should be seen as a
          last resort.
        </p><p><a name="apis-php-mysqlnd-ms.plugin-ini-json.server-list-syntax"></a>
          Each configuration section contains, at a minimum, a list of
          master servers and a list of slave servers. The master list is
          configured with the keyword <code class="literal">master</code>, while
          the slave list is configured with the <code class="literal">slave</code>
          keyword. Failing to provide a slave list will result in a
          fatal <code class="constant">E_ERROR</code> level error, although a
          slave list may be empty. It is possible to allow no slaves.
          However, this is only recommended with synchronous clusters,
          please see also
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.supportedclusters" title="7.5.13 Supported clusters">supported
          clusters</a>. The main part of the documentation focusses
          on the use of asynchronous MySQL replication clusters.
        </p><p>
          The master and slave server lists can be optionally indexed by
          symbolic names for the servers they describe. Alternatively,
          an array of descriptions for slave and master servers may be
          used.
        </p><p>
</p>
<div class="example">
<a name="idm139660445122240"></a><p class="title"><b>Example 7.60 List of anonymous slaves</b></p>
<div class="example-contents">
<pre class="programlisting">

"slave": [
    {
        "host": "192.168.3.24",
        "port": "3305"
    },
    {
        "host": "192.168.3.65",
        "port": "3309"
    }
]

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          An anonymous server list is encoded by the <code class="literal">JSON
          array</code> type. Optionally, symbolic names may be used
          for indexing the slave or master servers of a server list, and
          done so using the <code class="literal">JSON object</code> type.
        </p><p>
</p>
<div class="example">
<a name="idm139660445118256"></a><p class="title"><b>Example 7.61 Master list using symbolic names</b></p>
<div class="example-contents">
<pre class="programlisting">

"master": {
    "master_0": {
        "host": "localhost"
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          It is recommended to index the server lists with symbolic
          server names. The alias names will be shown in error messages.
        </p><p>
          The order of servers is preserved and taken into account by
          mysqlnd_ms. If, for example, you configure round robin load
          balancing strategy, the first <code class="literal">SELECT</code>
          statement will be executed on the slave that appears first in
          the slave server list.
        </p><p>
          A configured server can be described with the
          <code class="literal">host</code>, <code class="literal">port</code>,
          <code class="literal">socket</code>, <code class="literal">db</code>,
          <code class="literal">user</code>, <code class="literal">password</code> and
          <code class="literal">connect_flags</code>. It is mandatory to set the
          database server host using the <code class="literal">host</code>
          keyword. All other settings are optional.
        </p><p>
</p>
<div class="example">
<a name="idm139660445108176"></a><p class="title"><b>Example 7.62 Keywords to configure a server</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "db_server_host",
                "port": "db_server_port",
                "socket": "db_server_socket",
                "db": "database_resp_schema",
                "user": "user",
                "password": "password",
                "connect_flags": 0
            }
        },
        "slave": {
            "slave_0": {
                "host": "db_server_host",
                "port": "db_server_port",
                "socket": "db_server_socket"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          If a setting is omitted, the plugin will use the value
          provided by the user API call used to open a connection.
          Please, see the
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.using-section">using
          section names example</a> above.
        </p><p>
          The configuration file format has been changed in version
          1.1.0-beta to allow for chained filters. Filters are
          responsible for filtering the configured list of servers to
          identify a server for execution of a given statement. Filters
          are configured with the <code class="literal">filter</code> keyword.
          Filters are executed by mysqlnd_ms in the order of their
          appearance. Defining filters is optional. A configuration
          section in the plugins configuration file does not need to
          have a <code class="literal">filters</code> entry.
        </p><p>
          Filters replace the
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config.pick"><code class="literal">pick[]</code></a>
          setting from prior versions. The new <code class="literal">random</code>
          and <code class="literal">roundrobin</code> provide the same
          functionality.
        </p><p>
</p>
<div class="example">
<a name="idm139660445098336"></a><p class="title"><b>Example 7.63 New <code class="literal">roundrobin</code> filter, old functionality</b></p>
<div class="example-contents">
<pre class="programlisting">

   {
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            },
            "slave_1": {
                "host": "192.168.78.137",
                "port": "3306"
            }
        },
        "filters": {
            "roundrobin": [

            ]
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          The function
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>
          has been removed. Setting a callback is now done with the
          <code class="literal">user</code> filter. Some filters accept
          parameters. The <code class="literal">user</code> filter requires and
          accepts a mandatory <code class="literal">callback</code> parameter to
          set the callback previously set through the function
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>.

</p>
<div class="example">
<a name="idm139660445090016"></a><p class="title"><b>Example 7.64 The <code class="literal">user</code> filter replaces
<a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a></b></p>
<div class="example-contents">
<pre class="programlisting">

"filters": {
    "user": {
        "callback": "pick_server"
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p><a name="apis-php-mysqlnd-ms.plugin-ini-json.debug_config"></a>
          The validity of the configuration file is checked both when
          reading the configuration file and later when establishing a
          connection. The configuration file is read during PHP request
          startup. At this early stage a PHP extension may not display
          error messages properly. In the worst case, no error is shown
          and a connection attempt fails without an adequate error
          message. This problem has been cured in version 1.5.0.
        </p><p>
</p>
<div class="example">
<a name="idm139660445084800"></a><p class="title"><b>Example 7.65 Common error message in case of configuration file issues (upto version
1.5.0)</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
?&gt;

    </pre><p>
              The above example will output:
            </p><pre class="screen">

Warning: mysqli::mysqli(): (mysqlnd_ms) (mysqlnd_ms) Failed to parse config file [s1.json]. Please, verify the JSON in Command line code

Warning: mysqli::mysqli(): (HY000/2002): php_network_getaddresses: getaddrinfo failed: Name or service not known in Command line code on line 1

Warning: mysqli::query(): Couldn't fetch mysqli in Command line code on line 1

Fatal error: Call to a member function fetch_assoc() on a non-object in Command line code on line 1

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          Since version 1.5.0 startup errors are additionally buffered
          and emitted when a connection attempt is made. Use the
          configuration directive
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.force-config-usage"><code class="literal">mysqlnd_ms.force_config_usage</code></a>
          to set the error type used to display buffered errors. By
          default an error of type <code class="literal">E_WARNING</code> will be
          emitted.
        </p><p>
</p>
<div class="example">
<a name="idm139660445078384"></a><p class="title"><b>Example 7.66 Improved configuration file validation since 1.5.0</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
?&gt;

    </pre><p>
              The above example will output:
            </p><pre class="screen">

Warning: mysqli::mysqli(): (mysqlnd_ms) (mysqlnd_ms) Failed to parse config file [s1.json]. Please, verify the JSON in Command line code on line 1

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          It can be useful to set
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.force-config-usage"><code class="literal">mysqlnd_ms.force_config_usage
          = 1</code></a> when debugging potential configuration
          file errors. This will not only turn the type of buffered
          startup errors into <code class="literal">E_RECOVERABLE_ERROR</code> but
          also help detecting misspelled section names.
        </p><p>
</p>
<div class="example">
<a name="idm139660445072432"></a><p class="title"><b>Example 7.67 Possibly more precise error due to
<code class="literal">mysqlnd_ms.force_config_usage=1</code></b></p>
<div class="example-contents">
<pre class="programlisting">

mysqlnd_ms.force_config_usage=1

    </pre><pre class="programlisting">

&lt;?php
$mysqli = new mysqli("invalid_section", "username", "password", "database");
?&gt;

    </pre><p>
              The above example will output:
            </p><pre class="screen">

Warning: mysqli::mysqli(): (mysqlnd_ms) Exclusive usage of configuration enforced but did not find the correct INI file section (invalid_section) in Command line code on line 1 line 1

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="apis-php-mysqlnd-ms.plugin-ini-json-reference"></a>7.6.4.2 Configuration Directives</h4>

</div>

</div>

</div>
<p>
          <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
          Documentation Group.</a>
        </p><p>
          Here is a short explanation of the configuration directives
          that can be used.
        </p><p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.master"></a><span class="term">
                <em class="parameter"><code>master</code></em> <span class="type">array or
                object</span>
              </span></dt><dd><p>
                  List of MySQL replication master servers. The list of
                  either of the <code class="literal">JSON type array</code> to
                  declare an anonymous list of servers or of the
                  <code class="literal">JSON type object</code>. Please, see
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.server-list-syntax">above</a>
                  for examples.
                </p><p>
                  Setting at least one master server is mandatory. The
                  plugin will issue an error of type
                  <code class="literal">E_ERROR</code> if the user has failed to
                  provide a master server list for a configuration
                  section. The fatal error may read
                  <code class="literal">(mysqlnd_ms) Section [master] doesn't
                  exist for host [name_of_a_config_section] in %s on
                  line %d</code>.
                </p><p>
                  A server is described with the
                  <code class="literal">host</code>, <code class="literal">port</code>,
                  <code class="literal">socket</code>, <code class="literal">db</code>,
                  <code class="literal">user</code>, <code class="literal">password</code>
                  and <code class="literal">connect_flags</code>. It is mandatory
                  to provide at a value for <code class="literal">host</code>. If
                  any of the other values is not given, it will be taken
                  from the user API connect call, please, see also:
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.plugin-ini-json.using-section">using
                  section names example</a>.
                </p><p><a name="apis-php-mysqlnd-ms.plugin-ini-json.server-config-keywords"></a>
                  Table of server configuration keywords.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">host</code></td><td><p>
                            Database server host. This is a mandatory
                            setting. Failing to provide, will cause an
                            error of type
                            <code class="literal">E_RECOVERABLE_ERROR</code> when
                            the plugin tries to connect to the server.
                            The error message may read
                            <code class="literal">(mysqlnd_ms) Cannot find [host] in
                            [%s] section in config in %s on line
                            %d</code>.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">port</code></td><td><p>
                            Database server TCP/IP port.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">socket</code></td><td><p>
                            Database server Unix domain socket.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">db</code></td><td><p>
                            Database (schemata).
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">user</code></td><td><p>
                            MySQL database user.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">password</code></td><td><p>
                            MySQL database user password.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">connect_flags</code></td><td><p>
                            Connection flags.
</p></td><td>Since 1.1.0.</td></tr></tbody></table>
</div>
<p>
                  The plugin supports using only one master server. An
                  experimental setting exists to enable multi-master
                  support. The details are not documented. The setting
                  is meant for development only.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.slave"></a><span class="term">
                <em class="parameter"><code>slave</code></em> <span class="type">array or
                object</span>
              </span></dt><dd><p>
                  List of one or more MySQL replication slave servers.
                  The syntax is identical to setting master servers,
                  please, see
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.master"><code class="literal">master</code></a>
                  above for details.
                </p><p>
                  The plugin supports using one or more slave servers.
                </p><p>
                  Setting a list of slave servers is mandatory. The
                  plugin will report an error of the type
                  <code class="literal">E_ERROR</code> if <code class="literal">slave</code>
                  is not given for a configuration section. The fatal
                  error message may read <code class="literal">(mysqlnd_ms) Section
                  [slave] doesn't exist for host [%s] in %s on line
                  %d</code>. Note, that it is valid to use an empty
                  slave server list. The error has been introduced to
                  prevent accidently setting no slaves by forgetting
                  about the <code class="literal">slave</code> setting. A
                  master-only setup is still possible using an empty
                  slave server list.
                </p><p>
                  If an empty slave list is configured and an attempt is
                  made to execute a statement on a slave the plugin may
                  emit a warning like <code class="literal">mysqlnd_ms) Couldn't
                  find the appropriate slave connection. 0 slaves to
                  choose from.</code> upon statement execution. It is
                  possible that another warning follows such as
                  <code class="literal">(mysqlnd_ms) No connection selected by the
                  last filter</code>.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.gtid"></a><span class="term">
                <em class="parameter"><code>global_transaction_id_injection</code></em>
                <span class="type">array or object</span>
              </span></dt><dd><p>
                  Global transaction identifier configuration related to
                  both the use of the server built-in global transaction
                  ID feature and the client-side emulation.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">fetch_last_gtid</code></td><td><p>
                            SQL statement for accessing the latest
                            global transaction identifier. The SQL
                            statement is run if the plugin needs to know
                            the most recent global transaction
                            identifier. This can be the case, for
                            example, when checking MySQL Replication
                            slave status. Also used with
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>.
                          </p></td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">check_for_gtid</code></td><td><p>
                            SQL statement for checking if a replica has
                            replicated all transactions up to and
                            including ones searched for. The SQL
                            statement is run when searching for replicas
                            which can offer a higher level of
                            consistency than eventual consistency. The
                            statement must contain a placeholder
                            <code class="literal">#GTID</code> which is to be
                            replaced with the global transaction
                            identifier searched for by the plugin.
                            Please, check the
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.gtid" title="7.4.8 Global transaction IDs">quickstart</a>
                            for examples.
                          </p></td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">report_errors</code></td><td><p>
                            Whether to emit an error of type warning if
                            an issue occurs while executing any of the
                            configured SQL statements.
                          </p></td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">on_commit</code></td><td><p>
                            Client-side global transaction ID emulation
                            only. SQL statement to run when a
                            transaction finished to update the global
                            transaction identifier sequence number on
                            the master. Please, see the
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.gtid" title="7.4.8 Global transaction IDs">quickstart</a>
                            for examples.
                          </p></td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">wait_for_gtid_timeout</code></td><td><p>
                            Instructs the plugin to wait up to
                            <code class="literal">wait_for_gtid_timeout</code>
                            seconds for a slave to catch up when
                            searching for slaves that can deliver
                            session consistency. The setting limits the
                            time spend for polling the slave status. If
                            polling the status takes very long, the
                            total clock time spend waiting may exceed
                            <code class="literal">wait_for_gtid_timeout</code>.
                            The plugin calls <code class="literal">sleep(1)</code>
                            to sleep one second between each two polls.
                          </p>



                          <p>
                            The setting can be used both with the
                            plugins client-side emulation and the
                            server-side global transaction identifier
                            feature of MySQL 5.6.
                          </p>



                          <p>
                            Waiting for a slave to replicate a certain
                            GTID needed for session consistency also
                            means throttling the client. By throttling
                            the client the write load on the master is
                            reduced indirectly. A primary copy based
                            replication system, such as MySQL
                            Replication, is given more time to reach a
                            consistent state. This can be desired, for
                            example, to increase the number of data
                            copies for high availability considerations
                            or to prevent the master from being
                            overloaded.
</p></td><td>Since 1.4.0.</td></tr></tbody></table>
</div>
</dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.fabric"></a><span class="term">
                <em class="parameter"><code>fabric</code></em> <span class="type">object</span>
              </span></dt><dd><p>
                  MySQL Fabric related settings. If the plugin is used
                  together with MySQL Fabric, then the plugins
                  configuration file no longer contains lists of MySQL
                  servers. Instead, the plugin will ask MySQL Fabric
                  which list of servers to use to perform a certain
                  task.
                </p><p>
                  A minimum plugin configuration for use with MySQL
                  Fabric contains a list of one or more MySQL Fabric
                  hosts that the plugin can query. If more than one
                  MySQL Fabric host is configured, the plugin will use a
                  roundrobin strategy to choose among them. Other
                  strategies are currently not available.
                </p><p>
</p>
<div class="example">
<a name="idm139660444978336"></a><p class="title"><b>Example 7.68 Minimum pluging configuration for use with MySQL Fabric</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "fabric": {
            "hosts": [
                {
                    "host" : "127.0.0.1",
                    "port" : 8080
                }
            ]
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Each MySQL Fabric host is described using a JSON
                  object with the following members.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">host</code></td><td><p>
                            Host name of the MySQL Fabric host.
                          </p></td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">port</code></td><td><p>
                            The TCP/IP port on which the MySQL Fabric
                            host listens for remote procedure calls sent
                            by clients such as the plugin.
</p></td><td>Since 1.6.0.</td></tr></tbody></table>
</div>
<p>
                  The plugin is using PHP streams to communicate with
                  MySQL Fabric through XML RPC over HTTP. By default no
                  timeouts are set for the network communication. Thus,
                  the plugin defaults to PHP stream default timeouts.
                  Those defaults are out of control of the plugin
                  itself.
                </p><p>
                  An optional timeout value can be set to overrule the
                  PHP streams default timeout setting. Setting the
                  timeout in the plugins configuration file has the same
                  effect as setting a timeout for a PHP user space HTTP
                  connection established through PHP streams.
                </p><p>
                  The plugins Fabric timeout value unit is seconds. The
                  allowed value range is from 0 to 65535. The setting
                  exists since version 1.6.
                </p><p>
</p>
<div class="example">
<a name="idm139660444963264"></a><p class="title"><b>Example 7.69 Optional timeout for communication with Fabric</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "fabric": {
            "hosts": [
                {
                    "host" : "127.0.0.1",
                    "port" : 8080
                }
            ],
            "timeout": 2
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">Transaction
                  stickiness</a> and MySQL Fabric logic can collide.
                  The stickiness option disables switching between
                  servers for the duration of a transaction. When using
                  Fabric and sharding the user may (erroneously) start a
                  local transaction on one share and then attempt to
                  switch to a different shard using either
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-shard" title="7.8.3 mysqlnd_ms_fabric_select_shard"><code class="function">mysqlnd_ms_fabric_select_shard</code></a>
                  or
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-global" title="7.8.2 mysqlnd_ms_fabric_select_global"><code class="function">mysqlnd_ms_fabric_select_global</code></a>.
                  In this case, the plugin will not reject the request
                  to switch servers in the middle of a transaction but
                  allow the user to switch to another server regardless
                  of the transaction stickiness setting used. It is
                  clearly a user error to write such code.
                </p><p>
                  If transaction stickiness is enabled and you would
                  like to get an error of type warning when calling
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-shard" title="7.8.3 mysqlnd_ms_fabric_select_shard"><code class="function">mysqlnd_ms_fabric_select_shard</code></a>
                  or
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-global" title="7.8.2 mysqlnd_ms_fabric_select_global"><code class="function">mysqlnd_ms_fabric_select_global</code></a>,
                  set the boolean flag
                  <code class="literal">trx_warn_server_list_changes</code>.
                </p><p>
</p>
<div class="example">
<a name="idm139660444952384"></a><p class="title"><b>Example 7.70 Warnings about the violation of transaction boundaries</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "fabric": {
            "hosts": [
                {
                    "host" : "127.0.0.1",
                    "port" : 8080
                }
            ],
            "trx_warn_serverlist_changes": 1
        },
        "trx_stickiness": "on"
    }
}

        </pre><pre class="programlisting">

&lt;?php
$link = new mysqli("myapp", "root", "", "test");
/*
  For the demo the call may fail.
  Failed or not we get into the state
  needed for the example.
*/
@mysqlnd_ms_fabric_select_global($link, 1);
$link-&gt;begin_transaction();
@$link-&gt;query("DROP TABLE IF EXISTS test");
/*
  Switching servers/shards is a mistake due to open
  local transaction!
*/
mysqlnd_ms_select_global($link, 1);
?&gt;

         </pre><p>
                      The above example will output:
                    </p><pre class="screen">

PHP Warning: mysqlnd_ms_fabric_select_global(): (mysqlnd_ms) Fabric server exchange in the middle of a transaction in %s on line %d

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Please, consider the feature experimental. Changes to
                  syntax and semantics may happen.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.filters"></a><span class="term">
                <em class="parameter"><code>filters</code></em> <span class="type">object</span>
              </span></dt><dd><p>
                  List of filters. A filter is responsible to filter the
                  list of available servers for executing a given
                  statement. Filters can be chained. The
                  <code class="literal">random</code> and
                  <code class="literal">roundrobin</code> filter replace the
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config.pick"><code class="literal">pick[]</code></a>
                  directive used in prior version to select a load
                  balancing policy. The <code class="literal">user</code> filter
                  replaces the
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>
                  function.
                </p><p>
                  Filters may accept parameters to refine their actions.
                </p><p>
                  If no load balancing policy is set, the plugin will
                  default to <code class="literal">random_once</code>. The
                  <code class="literal">random_once</code> policy picks a random
                  slave server when running the first read-only
                  statement. The slave server will be used for all
                  read-only statements until the PHP script execution
                  ends. No load balancing policy is set and thus,
                  defaulting takes place, if neither the
                  <code class="literal">random</code> nor the
                  <code class="literal">roundrobin</code> are part of a
                  configuration section.
                </p><p>
                  If a filter chain is configured so that a filter which
                  output no more than once server is used as input for a
                  filter which should be given more than one server as
                  input, the plugin may emit a warning upon opening a
                  connection. The warning may read:
                  <code class="literal">(mysqlnd_ms) Error while creating filter
                  '%s' . Non-multi filter '%s'
                  already created. Stopping in %s on line %d</code>.
                  Furthermore, an error of the error code
                  <code class="literal">2000</code>, the sql state
                  <code class="literal">HY000</code> and an error message similar
                  to the warning may be set on the connection handle.
                </p><p>
</p>
<div class="example">
<a name="idm139660444931424"></a><p class="title"><b>Example 7.71 Invalid filter sequence</b></p>
<div class="example-contents">
<pre class="programlisting">

       {
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "filters": [
            "roundrobin",
            "random"
        ]
    }
}

         </pre><pre class="programlisting">

&lt;?php
$link = new mysqli("myapp", "root", "", "test");
printf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error());
$link-&gt;query("SELECT 1 FROM DUAL");
?&gt;

         </pre><p>
                      The above example will output:
                    </p><pre class="screen">

PHP Warning:  mysqli::mysqli(): (HY000/2000): (mysqlnd_ms) Error while creating filter 'random' . Non-multi filter 'roundrobin' already created. Stopping in filter_warning.php on line 1
[2000] (mysqlnd_ms) Error while creating filter 'random' . Non-multi filter 'roundrobin' already created. Stopping
PHP Warning:  mysqli::query(): Couldn't fetch mysqli in filter_warning.php on line 3

</pre>
</div>

</div>
<p><br class="example-break">
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-random"></a><span class="term">
                Filter: <em class="parameter"><code>random</code></em>
                <span class="type">object</span>
              </span></dt><dd><p>
                  The <code class="literal">random</code> filter features the
                  random and random once load balancing policies, set
                  through the
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config.pick"><code class="literal">pick[]</code></a>
                  directive in older versions.
                </p><p>
                  The random policy will pick a random server whenever a
                  read-only statement is to be executed. The random once
                  strategy picks a random slave server once and
                  continues using the slave for the rest of the PHP web
                  request. Random once is a default, if load balancing
                  is not configured through a filter.
                </p><p>
                  If the <code class="literal">random</code> filter is not given
                  any arguments, it stands for random load balancing
                  policy.
                </p><p>
</p>
<div class="example">
<a name="idm139660444919136"></a><p class="title"><b>Example 7.72 Random load balancing with <code class="literal">random</code> filter</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            },
            "slave_1": {
                "host": "192.168.78.137",
                "port": "3306"
            }
        },
        "filters": [
            "random"
        ]
    }
}


</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Optionally, the <code class="literal">sticky</code> argument can
                  be passed to the filter. If the parameter
                  <code class="literal">sticky</code> is set to the string
                  <code class="literal">1</code>, the filter follows the random
                  once load balancing strategy.
                </p><p>
</p>
<div class="example">
<a name="idm139660444913408"></a><p class="title"><b>Example 7.73 Random once load balancing with <code class="literal">random</code> filter</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "filters": {
        "random": {
            "sticky": "1"
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Both the <code class="literal">random</code> and
                  <code class="literal">roundrobin</code> filters support setting
                  a priority, a weight for a server, since
                  PECL/mysqlnd_ms 1.4.0. If the
                  <code class="literal">weight</code> argument is passed to the
                  filter, it must assign a weight for all servers.
                  Servers must be given an alias name in the
                  <code class="literal">slave</code> respectively
                  <code class="literal">master</code> server lists. The alias must
                  be used to reference servers for assigning a priority
                  with <code class="literal">weight</code>.
                </p><p>
</p>
<div class="example">
<a name="idm139660444905552"></a><p class="title"><b>Example 7.74 Referencing error</b></p>
<div class="example-contents">
<pre class="screen">

[E_RECOVERABLE_ERROR] mysqli_real_connect(): (mysqlnd_ms) Unknown server 'slave3' in 'random' filter configuration. Stopping in %s on line %d

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Using a wrong alias name with
                  <code class="literal">weight</code> may result in an error
                  similar to the shown above.
                </p><p>
                  If <code class="literal">weight</code> is omitted, the default
                  weight of all servers is one.
                </p><p>
</p>
<div class="example">
<a name="idm139660444901072"></a><p class="title"><b>Example 7.75 Assigning a <code class="literal">weight</code> for load balancing</b></p>
<div class="example-contents">
<pre class="programlisting">

{
   "myapp": {
       "master": {
           "master1":{
               "host":"localhost",
               "socket":"\/var\/run\/mysql\/mysql.sock"
           }
       },
       "slave": {
           "slave1": {
               "host":"192.168.2.28",
               "port":3306
           },
           "slave2": {
               "host":"192.168.2.29",
               "port":3306
           },
           "slave3": {
               "host":"192.0.43.10",
               "port":3306
           },
       },
       "filters": {
           "random": {
               "weights": {
                   "slave1":8,
                   "slave2":4,
                   "slave3":1,
                   "master1":1
               }
           }
       }
   }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  At the average a server assigned a weight of two will
                  be selected twice as often as a server assigned a
                  weight of one. Different weights can be assigned to
                  reflect differently sized machines, to prefer
                  co-located slaves which have a low network latency or,
                  to configure a standby failover server. In the latter
                  case, you may want to assign the standby server a very
                  low weight in relation to the other servers. For
                  example, given the configuration above
                  <code class="literal">slave3</code> will get only some eight
                  percent of the requests in the average. As long as
                  <code class="literal">slave1</code> and
                  <code class="literal">slave2</code> are running, it will be used
                  sparsely, similar to a standby failover server. Upon
                  failure of <code class="literal">slave1</code> and
                  <code class="literal">slave2</code>, the usage of
                  <code class="literal">slave3</code> increases. Please, check the
                  notes on failover before using
                  <code class="literal">weight</code> this way.
                </p><p>
                  Valid weight values range from 1 to 65535.
                </p><p>
                  Unknown arguments are ignored by the filter. No
                  warning or error is given.
                </p><p>
                  The filter expects one or more servers as input.
                  Outputs one server. A filter sequence such as
                  <code class="literal">random</code>,
                  <code class="literal">roundrobin</code> may cause a warning and
                  an error message to be set on the connection handle
                  when executing a statement.
                </p><p>
                  List of filter arguments.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">sticky</code></td><td><p>
                            Enables or disabled random once load
                            balancing policy. See above.
                          </p></td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">weight</code></td><td><p>
                            Assigns a load balancing weight/priority to
                            a server. Please, see above for a
                            description.
</p></td><td>Since 1.4.0.</td></tr></tbody></table>
</div>
</dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-roundrobin"></a><span class="term">
                Filter: <em class="parameter"><code>roundrobin</code></em>
                <span class="type">object</span>
              </span></dt><dd><p>
                  If using the <code class="literal">roundrobin</code> filter, the
                  plugin iterates over the list of configured slave
                  servers to pick a server for statement execution. If
                  the plugin reaches the end of the list, it wraps
                  around to the beginning of the list and picks the
                  first configured slave server.
                </p><p>
</p>
<div class="example">
<a name="idm139660444872992"></a><p class="title"><b>Example 7.76 <code class="literal">roundrobin</code> filter</b></p>
<div class="example-contents">
<pre class="programlisting">

       {
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "filters": [
            "roundrobin"
        ]
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Expects one or more servers as input. Outputs one
                  server. A filter sequence such as
                  <code class="literal">roundrobin</code>,
                  <code class="literal">random</code> may cause a warning and an
                  error message to be set on the connection handle when
                  executing a statement.
                </p><p>
                  List of filter arguments.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">weight</code></td><td><p>
                            Assigns a load balancing weight/priority to
                            a server. Please, find a description
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-random">above</a>.
</p></td><td>Since 1.4.0.</td></tr></tbody></table>
</div>
</dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-user"></a><span class="term">
                Filter: <em class="parameter"><code>user</code></em> <span class="type">object</span>
              </span></dt><dd><p>
                  The <code class="literal">user</code> replaces
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>
                  function, which was removed in 1.1.0-beta. The filter
                  sets a callback for user-defined read/write splitting
                  and server selection.
                </p><p>
                  The plugins built-in read/write query split mechanism
                  decisions can be overwritten in two ways. The easiest
                  way is to prepend a query string with the SQL hints
                  <code class="constant">MYSQLND_MS_MASTER_SWITCH</code>,
                  <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code> or
                  <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code>.
                  Using SQL hints one can control, for example, whether
                  a query shall be send to the MySQL replication master
                  server or one of the slave servers. By help of SQL
                  hints it is not possible to pick a certain slave
                  server for query execution.
                </p><p>
                  Full control on server selection can be gained using a
                  callback function. Use of a callback is recommended to
                  expert users only because the callback has to cover
                  all cases otherwise handled by the plugin.
                </p><p>
                  The plugin will invoke the callback function for
                  selecting a server from the lists of configured master
                  and slave servers. The callback function inspects the
                  query to run and picks a server for query execution by
                  returning the hosts URI, as found in the master and
                  slave list.
                </p><p>
                  If the lazy connections are enabled and the callback
                  chooses a slave server for which no connection has
                  been established so far and establishing the
                  connection to the slave fails, the plugin will return
                  an error upon the next action on the failed
                  connection, for example, when running a query. It is
                  the responsibility of the application developer to
                  handle the error. For example, the application can
                  re-run the query to trigger a new server selection and
                  callback invocation. If so, the callback must make
                  sure to select a different slave, or check slave
                  availability, before returning to the plugin to
                  prevent an endless loop.
                </p><p>
</p>
<div class="example">
<a name="idm139660444848144"></a><p class="title"><b>Example 7.77 Setting a callback</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "filters": {
            "user": {
                "callback": "pick_server"
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  The callback is supposed to return a host to run the
                  query on. The host URI is to be taken from the master
                  and slave connection lists passed to the callback
                  function. If callback returns a value neither found in
                  the master nor in the slave connection lists the
                  plugin will emit an error of the type
                  <code class="literal">E_RECOVERABLE_ERROR</code> The error may
                  read like <code class="literal"> (mysqlnd_ms) User filter callback
                  has returned an unknown server. The server
                  'server that is not in master or slave list'
                  can neither be found in the master list nor in the
                  slave list</code>. If the application catches the
                  error to ignore it, follow up errors may be set on the
                  connection handle, for example, <code class="literal">(mysqlnd_ms)
                  No connection selected by the last filter</code>
                  with the error code <code class="literal">2000</code> and the
                  sqlstate <code class="literal">HY000</code>. Furthermore a
                  warning may be emitted.
                </p><p>
                  Referencing a non-existing function as a callback will
                  result in any error of the type
                  <code class="literal">E_RECOVERABLE_ERROR</code> whenever the
                  plugin tries to callback function. The error message
                  may reads like: <code class="literal">(mysqlnd_ms) Specified
                  callback (pick_server) is not a valid
                  callback</code>. If the application catches the
                  error to ignore it, follow up errors may be set on the
                  connection handle, for example, <code class="literal">(mysqlnd_ms)
                  Specified callback (pick_server) is not a valid
                  callback</code> with the error code
                  <code class="literal">2000</code> and the sqlstate
                  <code class="literal">HY000</code>. Furthermore a warning may be
                  emitted.
                </p><p>
                  The following parameters are passed from the plugin to
                  the callback.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Parameter</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">connected_host</code></td><td><p>
                            URI of the currently connected database
                            server.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">query</code></td><td><p>
                            Query string of the statement for which a
                            server needs to be picked.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">masters</code></td><td><p>
                            List of master servers to choose from. Note,
                            that the list of master servers may not be
                            identical to the list of configured master
                            servers if the filter is not the first in
                            the filter chain. Previously run filters may
                            have reduced the master list already.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">slaves</code></td><td><p>
                            List of slave servers to choose from. Note,
                            that the list of master servers may not be
                            identical to the list of configured master
                            servers if the filter is not the first in
                            the filter chain. Previously run filters may
                            have reduced the master list already.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">last_used_connection</code></td><td><p>
                            URI of the server of the connection used to
                            execute the previous statement on.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">in_transaction</code></td><td><p>
                            Boolean flag indicating whether the
                            statement is part of an open transaction. If
                            autocommit mode is turned off, this will be
                            set to <code class="constant">TRUE</code>. Otherwise
                            it is set to <code class="constant">FALSE</code>.
                          </p>



                          <p>
                            Transaction detection is based on monitoring
                            the mysqlnd library call
                            <code class="literal">set_autocommit</code>.
                            Monitoring is not possible before PHP 5.4.0.
                            Please, see
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.pooling" title="7.5.2 Connection pooling and switching">connection
                            pooling and switching</a> concepts
                            discussion for further details.
</p></td><td>Since 1.1.0.</td></tr></tbody></table>
</div>
<p>
</p>
<div class="example">
<a name="idm139660444811328"></a><p class="title"><b>Example 7.78 Using a callback</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.27",
                "port": "3306"
            },
            "slave_1": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "filters": {
            "user": {
                "callback": "pick_server"
            }
        }
    }
}

         </pre><pre class="programlisting">

&lt;?php
function pick_server($connected, $query, $masters, $slaves, $last_used_connection, $in_transaction)
{
 static $slave_idx = 0;
 static $num_slaves = NULL;
 if (is_null($num_slaves))
  $num_slaves = count($slaves);

 /* default: fallback to the plugins build-in logic */
 $ret = NULL;

 printf("User has connected to '%s'...\n", $connected);
 printf("... deciding where to run '%s'\n", $query);

 $where = mysqlnd_ms_query_is_select($query);
 switch ($where)
 {
  case MYSQLND_MS_QUERY_USE_MASTER:
   printf("... using master\n");
   $ret = $masters[0];
   break;
  case MYSQLND_MS_QUERY_USE_SLAVE:
   /* SELECT or SQL hint for using slave */
   if (stristr($query, "FROM table_on_slave_a_only"))
   {
    /* a table which is only on the first configured slave  */
    printf("... access to table available only on slave A detected\n");
    $ret = $slaves[0];
   }
   else
   {
    /* round robin */
    printf("... some read-only query for a slave\n");
    $ret = $slaves[$slave_idx++ % $num_slaves];
   }
   break;
  case MYSQLND_MS_QUERY_LAST_USED:
   printf("... using last used server\n");
   $ret = $last_used_connection;
   break;
 }

 printf("... ret = '%s'\n", $ret);
 return $ret;
}

$mysqli = new mysqli("myapp", "root", "", "test");

if (!($res = $mysqli-&gt;query("SELECT 1 FROM DUAL")))
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
else
 $res-&gt;close();

if (!($res = $mysqli-&gt;query("SELECT 2 FROM DUAL")))
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
else
 $res-&gt;close();


if (!($res = $mysqli-&gt;query("SELECT * FROM table_on_slave_a_only")))
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
else
 $res-&gt;close();

$mysqli-&gt;close();
?&gt;

         </pre><p>
                      The above example will output:
                    </p><pre class="screen">

User has connected to 'myapp'...
... deciding where to run 'SELECT 1 FROM DUAL'
... some read-only query for a slave
... ret = 'tcp://192.168.2.27:3306'
User has connected to 'myapp'...
... deciding where to run 'SELECT 2 FROM DUAL'
... some read-only query for a slave
... ret = 'tcp://192.168.78.136:3306'
User has connected to 'myapp'...
... deciding where to run 'SELECT * FROM table_on_slave_a_only'
... access to table available only on slave A detected
... ret = 'tcp://192.168.2.27:3306'

</pre>
</div>

</div>
<p><br class="example-break">
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-user-multi"></a><span class="term">
                Filter: <em class="parameter"><code>user_multi</code></em>
                <span class="type">object</span>
              </span></dt><dd><p>
                  The <code class="literal">user_multi</code> differs from the
                  <code class="literal">user</code> only in one aspect. Otherwise,
                  their syntax is identical. The <code class="literal">user</code>
                  filter must pick and return exactly one node for
                  statement execution. A filter chain usually ends with
                  a filter that emits only one node. The filter chain
                  shall reduce the list of candidates for statement
                  execution down to one. This, only one node left, is
                  the case after the <code class="literal">user</code> filter has
                  been run.
                </p><p>
                  The <code class="literal">user_multi</code> filter is a multi
                  filter. It returns a list of slave and a list of
                  master servers. This list needs further filtering to
                  identify exactly one node for statement execution. A
                  multi filter is typically placed at the top of the
                  filter chain. The
                  <code class="literal">quality_of_service</code> filter is
                  another example of a multi filter.
                </p><p>
                  The return value of the callback set for
                  <code class="literal">user_multi</code> must be an array with
                  two elements. The first element holds a list of
                  selected master servers. The second element contains a
                  list of selected slave servers. The lists shall
                  contain the keys of the slave and master servers as
                  found in the slave and master lists passed to the
                  callback. The below example returns random master and
                  slave lists extracted from the functions input.
                </p><p>
</p>
<div class="example">
<a name="idm139660444792816"></a><p class="title"><b>Example 7.79 Returning random masters and slaves</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
function pick_server($connected, $query, $masters, $slaves, $last_used_connection, $in_transaction)
{
  $picked_masters = array()
  foreach ($masters as $key =&gt; $value) {
    if (mt_rand(0, 2) &gt; 1)
      $picked_masters[] = $key;
  }
  $picked_slaves = array()
  foreach ($slaves as $key =&gt; $value) {
    if (mt_rand(0, 2) &gt; 1)
      $picked_slaves[] = $key;
  }
  return array($picked_masters, $picked_slaves);
}
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  The plugin will issue an error of type
                  <code class="literal">E_RECOVERABLE</code> if the callback fails
                  to return a server list. The error may read
                  <code class="literal">(mysqlnd_ms) User multi filter callback has
                  not returned a list of servers to use. The callback
                  must return an array in %s on line %d</code>. In
                  case the server list is not empty but has invalid
                  servers key/ids in it, an error of type
                  <code class="literal">E_RECOVERABLE</code> will the thrown with
                  an error message like <code class="literal">(mysqlnd_ms) User multi
                  filter callback has returned an invalid list of
                  servers to use. Server id is negative in %s on line
                  %d</code>, or similar.
                </p><p>
                  Whether an error is emitted in case of an empty slave
                  or master list depends on the configuration. If an
                  empty master list is returned for a write operation,
                  it is likely that the plugin will emit a warning that
                  may read <code class="literal">(mysqlnd_ms) Couldn't find the
                  appropriate master connection. 0 masters to choose
                  from. Something is wrong in %s on line %d</code>.
                  Typically a follow up error of type
                  <code class="literal">E_ERROR</code> will happen. In case of a
                  read operation and an empty slave list the behavior
                  depends on the fail over configuration. If fail over
                  to master is enabled, no error should appear. If fail
                  over to master is deactivated the plugin will emit a
                  warning that may read <code class="literal">(mysqlnd_ms)
                  Couldn't find the appropriate slave connection. 0
                  slaves to choose from. Something is wrong in %s on
                  line %d</code>.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-node-groups"></a><span class="term">
                Filter: <em class="parameter"><code>node_groups</code></em>
                <span class="type">object</span>
              </span></dt><dd><p>
                  The <code class="literal">node_groups</code> filter lets you
                  group cluster nodes and query selected groups, for
                  example, to support data partitioning. Data
                  partitioning can be required for manual sharding,
                  primary copy based clusters running multiple masters,
                  or to avoid hot spots in update everywhere clusters
                  that have no built-in partitioning. The filter is a
                  multi filter which returns zero, one or multiple of
                  its input servers. Thus, it must be followed by other
                  filters to reduce the number of candidates down to one
                  for statement execution.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">user defined node group name</code></td><td><p>
                            One or more node groups must be defined. A
                            node group can have an arbitrary user
                            defined name. The name is used in
                            combination with a SQL hint to restrict
                            query execution to the nodes listed for the
                            node group. To run a query on any of the
                            servers of a node group, the query must
                            begin with the SQL hint <code class="literal">/*user
                            defined node group name*/</code>. Please
                            note, no white space is allowed around
                            <code class="literal">user defined node group
                            name</code>. Because <code class="literal">user
                            defined node group name</code> is used
                            as-is as part of a SQL hint, you should
                            choose the name that is compliant with the
                            SQL language.
                          </p>



                          <p>
                            Each node group entry must contain a list of
                            <code class="literal">master</code> servers.
                            Additional <code class="literal">slave</code> servers
                            are allowed. Failing to provide a list of
                            <code class="literal">master</code> for a node group
                            <code class="literal">name_of_group</code> may cause
                            an error of type
                            <code class="constant">E_RECOVERABLE_ERROR</code>
                            like <code class="literal">(mysqlnd_ms) No masters
                            configured in node group
                            'name_of_group' for
                            'node_groups' filter</code>.
                          </p>



                          <p>
                            The list of master and slave servers must
                            reference corresponding entries in the
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.master">global
                            master</a> respectively
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.slave">slave</a>
                            server list. Referencing an unknown server
                            in either of the both server lists may cause
                            an <code class="constant">E_RECOVERABLE_ERROR</code>
                            error like <code class="literal">(mysqlnd_ms) Unknown
                            master 'server_alias_name'
                            (section 'name_of_group') in
                            'node_groups' filter
                            configuration</code>.
                          </p>



                          <p>
</p>
<div class="example">
<a name="idm139660444758096"></a><p class="title"><b>Example 7.80 Manual partitioning</b></p>
<div class="example-contents">
<pre class="programlisting">

 {
  "myapp": {
       "master": {
            "master_0": {
                "host": "localhost",
                "socket": "\/tmp\/mysql.sock"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.28",
                "port": 3306
            },
            "slave_1": {
                "host": "127.0.0.1",
                "port": 3311
            }
        },
        "filters": {
            "node_groups": {
                "Partition_A" : {
                    "master": ["master_0"],
                    "slave": ["slave_0"]
                }
            },
           "roundrobin": []
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                          </p>



                          <p>
                            Please note, if a filter chain generates an
                            empty slave list and the PHP configuration
                            directive
                            <code class="literal">mysqlnd_ms.multi_master=0</code>
                            is used, the plugin may emit a warning.
</p></td><td>Since 1.5.0.</td></tr></tbody></table>
</div>
</dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-qos"></a><span class="term">
                Filter: <em class="parameter"><code>quality_of_service</code></em>
                <span class="type">object</span>
              </span></dt><dd><p>
                  The <code class="literal">quality_of_service</code> identifies
                  cluster nodes capable of delivering a certain quality
                  of service. It is a multi filter which returns zero,
                  one or multiple of its input servers. Thus, it must be
                  followed by other filters to reduce the number of
                  candidates down to one for statement execution.
                </p><p>
                  The <code class="literal">quality_of_service</code> filter has
                  been introduced in 1.2.0-alpha. In the 1.2 series the
                  filters focus is on the consistency aspect of service
                  quality. Different types of clusters offer different
                  default data consistencies. For example, an
                  asynchronous MySQL replication slave offers eventual
                  consistency. The slave may not be able to deliver
                  requested data because it has not replicated the
                  write, it may serve stale database because its lagging
                  behind or it may serve current information. Often,
                  this is acceptable. In some cases higher consistency
                  levels are needed for the application to work correct.
                  In those cases, the
                  <code class="literal">quality_of_service</code> can filter out
                  cluster nodes which cannot deliver the necessary
                  quality of service.
                </p><p>
                  The <code class="literal">quality_of_service</code> filter can
                  be replaced or created at runtime. A successful call
                  to
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
                  removes all existing <code class="literal">qos</code> filter
                  entries from the filter list and installs a new one at
                  the very beginning. All settings that can be made
                  through
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
                  can also be in the plugins configuration file.
                  However, use of the function is by far the most common
                  use case. Instead of setting session consistency and
                  strong consistency service levels in the plugins
                  configuration file it is recommended to define only
                  masters and no slaves. Both service levels will force
                  the use of masters only. Using an empty slave list
                  shortens the configuration file, thus improving
                  readability. The only service level for which there is
                  a case of defining in the plugins configuration file
                  is the combination of eventual consistency and maximum
                  slave lag.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">eventual_consistency</code></td><td><p>
                            Request eventual consistency. Allows the use
                            of all master and slave servers. Data
                            returned may or may not be current.
                          </p>



                          <p>
                            Eventual consistency accepts an optional
                            <code class="literal">age</code> parameter. If
                            <code class="literal">age</code> is given the plugin
                            considers only slaves for reading for which
                            MySQL replication reports a slave lag less
                            or equal to <code class="literal">age</code>. The
                            replication lag is measure using
                            <code class="literal">SHOW SLAVE STATUS</code>. If the
                            plugin fails to fetch the replication lag,
                            the slave tested is skipped. Implementation
                            details and tips are given in the
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.qos-consistency" title="7.5.10 Service level and consistency">quality
                            of service concepts section</a>.
                          </p>



                          <p>
                            Please note, if a filter chain generates an
                            empty slave list and the PHP configuration
                            directive
                            <code class="literal">mysqlnd_ms.multi_master=0</code>
                            is used, the plugin may emit a warning.
                          </p>



                          <p>
</p>
<div class="example">
<a name="idm139660444727008"></a><p class="title"><b>Example 7.81 Global limit on slave lag</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.2.27",
                "port": "3306"
            },
            "slave_1": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "filters": {
            "quality_of_service": {
                "eventual_consistency": {
                    "age":123
                }
            }
        }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                          </p></td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">session_consistency</code></td><td><p>
                            Request session consistency (read your
                            writes). Allows use of all masters and all
                            slaves which are in sync with the master. If
                            no further parameters are given slaves are
                            filtered out as there is no reliable way to
                            test if a slave has caught up to the master
                            or is lagging behind. Please note, if a
                            filter chain generates an empty slave list
                            and the PHP configuration directive
                            <code class="literal">mysqlnd_ms.multi_master=0</code>
                            is used, the plugin may emit a warning.
                          </p>



                          <p>
                            Session consistency temporarily requested
                            using
                            <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
                            is a valuable alternative to using
                            <code class="literal">master_on_write</code>.
                            <code class="literal">master_on_write</code> is likely
                            to send more statements to the master than
                            needed. The application may be able to
                            continue operation at a lower consistency
                            level after it has done some critical reads.
                          </p></td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">strong_consistency</code></td><td><p>
                            Request strong consistency. Only masters
                            will be used.
</p></td><td>Since 1.2.0.</td></tr></tbody></table>
</div>
</dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.failover"></a><span class="term">
                <em class="parameter"><code>failover</code></em> Up to and including
                1.3.x: <span class="type">string</span>. Since 1.4.0:
                <span class="type">object</span>.
              </span></dt><dd><p>
                  Failover policy. Supported policies:
                  <code class="literal">disabled</code> (default),
                  <code class="literal">master</code>,
                  <code class="literal">loop_before_master</code> (Since 1.4.0).
                </p><p>
                  If no failover policy is set, the plugin will not do
                  any automatic failover
                  (<code class="literal">failover=disabled</code>). Whenever the
                  plugin fails to connect a server it will emit a
                  warning and set the connections error code and
                  message. Thereafter it is up to the application to
                  handle the error and, for example, resent the last
                  statement to trigger the selection of another server.
                </p><p>
                  Please note, the automatic failover logic is applied
                  when opening connections only. Once a connection has
                  been opened no automatic attempts are made to reopen
                  it in case of an error. If, for example, the server a
                  connection is connected to is shut down and the user
                  attempts to run a statement on the connection, no
                  automatic failover will be tried. Instead, an error
                  will be reported.
                </p><p>
                  If using <code class="literal">failover=master</code> the plugin
                  will implicitly failover to a master, if available.
                  Please check the concepts documentation to learn about
                  potential pitfalls and risks of using
                  <code class="literal">failover=master</code>.
                </p><p>
</p>
<div class="example">
<a name="idm139660444702528"></a><p class="title"><b>Example 7.82 Optional master failover when failing to connect to slave
(PECL/mysqlnd_ms &lt; 1.4.0)</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "failover": "master"
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Since PECL/mysqlnd_ms 1.4.0 the failover configuration
                  keyword refers to an object.
                </p><p>
</p>
<div class="example">
<a name="idm139660444699632"></a><p class="title"><b>Example 7.83 New syntax since 1.4.0</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "failover": {"strategy": "master" }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">strategy</code></td><td><p>
                            Failover policy. Possible values:
                            <code class="literal">disabled</code> (default),
                            <code class="literal">master</code>,
                            <code class="literal">loop_before_master</code>
                          </p>



                          <p>
                            A value of <code class="literal">disabled</code>
                            disables automatic failover.
                          </p>



                          <p>
                            Setting <code class="literal">master</code> instructs
                            the plugin to try to connect to a master in
                            case of a slave connection error. If the
                            master connection attempt fails, the plugin
                            exists the failover loop and returns an
                            error to the user.
                          </p>



                          <p>
                            If using
                            <code class="literal">loop_before_master</code> and a
                            slave request is made, the plugin tries to
                            connect to other slaves before failing over
                            to a master. If multiple master are given
                            and multi master is enabled, the plugin also
                            loops over the list of masters and attempts
                            to connect before returning an error to the
                            user.
                          </p></td><td>Since 1.4.0.</td></tr><tr><td scope="row"><code class="literal">remember_failed</code></td><td><p>
                            Remember failures for the duration of a web
                            request. Default: <code class="literal">false</code>.
                          </p>



                          <p>
                            If set to <code class="literal">true</code> the plugin
                            will remember failed hosts and skip the
                            hosts in all future load balancing made for
                            the duration of the current web request.
                          </p></td><td>Since 1.4.0. The feature is only available together with the
                          <code class="literal">random</code> and
                          <code class="literal">roundrobin</code> load balancing
                          filter. Use of the setting is recommended.</td></tr><tr><td scope="row"><code class="literal">max_retries</code></td><td><p>
                            Maximum number of connection attempts before
                            skipping host. Default: <code class="literal">0</code>
                            (no limit).
                          </p>



                          <p>
                            The setting is used to prevent hosts from
                            being dropped of the host list upon the
                            first failure. If set to <code class="literal">n &gt;
                            0</code>, the plugin will keep the node
                            in the node list even after a failed
                            connection attempt. The node will not be
                            removed immediately from the slave
                            respectively master lists after the first
                            connection failure but instead be tried to
                            connect to up to <code class="literal">n</code> times
                            in future load balancing rounds before being
                            removed.
                          </p></td><td>Since 1.4.0. The feature is only available together with the
                          <code class="literal">random</code> and
                          <code class="literal">roundrobin</code> load balancing
filter.</td></tr></tbody></table>
</div>
<p>
                  Setting <code class="literal">failover</code> to any other value
                  but <code class="literal">disabled</code>,
                  <code class="literal">master</code> or
                  <code class="literal">loop_before_master</code> will not emit
                  any warning or error.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections"></a><span class="term">
                <em class="parameter"><code>lazy_connections</code></em>
                <span class="type">bool</span>
              </span></dt><dd><p>
                  Controls the use of lazy connections. Lazy connections
                  are connections which are not opened before the client
                  sends the first connection. Lazy connections are a
                  default.
                </p><p>
                  It is strongly recommended to use lazy connections.
                  Lazy connections help to keep the number of open
                  connections low. If you disable lazy connections and,
                  for example, configure one MySQL replication master
                  server and two MySQL replication slaves, the plugin
                  will open three connections upon the first call to a
                  connect function although the application might use
                  the master connection only.
                </p><p>
                  Lazy connections bare a risk if you make heavy use of
                  actions which change the state of a connection. The
                  plugin does not dispatch all state changing actions to
                  all connections from the connection pool. The few
                  dispatched actions are applied to already opened
                  connections only. Lazy connections opened in the
                  future are not affected. Only some settings are
                  "remembered" and applied when lazy
                  connections are opened.
                </p><p>
</p>
<div class="example">
<a name="idm139660444660944"></a><p class="title"><b>Example 7.84 Disabling lazy connection</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "lazy_connections": 0
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Please, see also <code class="literal">server_charset</code> to
                  overcome potential problems with string escaping and
                  servers using different default charsets.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.server-charset"></a><span class="term">
                <em class="parameter"><code>server_charset</code></em>
                <span class="type">string</span>
              </span></dt><dd><p>
                  The setting has been introduced in 1.4.0. It is
                  recommended to set it if using lazy connections.
                </p><p>
                  The <code class="literal">server_charset</code> setting serves
                  two purposes. It acts as a fallback charset to be used
                  for string escaping done before a connection has been
                  established and it helps to avoid escaping pitfalls in
                  heterogeneous environments which servers using
                  different default charsets.
                </p><p>
                  String escaping takes a connections charset into
                  account. String escaping is not possible before a
                  connection has been opened and the connections charset
                  is known. The use of lazy connections delays the
                  actual opening of connections until a statement is
                  send.
                </p><p>
                  An application using lazy connections may attempt to
                  escape a string before sending a statement. In fact,
                  this should be a common case as the statement string
                  may contain the string that is to be escaped. However,
                  due to the lazy connection feature no connection has
                  been opened yet and escaping fails. The plugin may
                  report an error of the type
                  <code class="literal">E_WARNING</code> and a message like
                  <code class="literal">(mysqlnd_ms) string escaping doesn't
                  work without established connection. Possible solution
                  is to add server_charset to your
                  configuration</code> to inform you of the pitfall.
                </p><p>
                  Setting <code class="literal">server_charset</code> makes the
                  plugin use the given charset for string escaping done
                  on lazy connection handles before establishing a
                  network connection to MySQL. Furthermore, the plugin
                  will enforce the use of the charset when the
                  connection is established.
                </p><p>
                  Enforcing the use of the configured charset used for
                  escaping is done to prevent tapping into the pitfall
                  of using a different charset for escaping than used
                  later for the connection. This has the additional
                  benefit of removing the need to align the charset
                  configuration of all servers used. No matter what the
                  default charset on any of the servers is, the plugin
                  will set the configured one as a default.
                </p><p>
                  The plugin does not stop the user from changing the
                  charset at any time using the
                  <a class="ulink" href="http://www.php.net/set_charset" target="_top"><code class="function">set_charset</code></a>
                  call or corresponding SQL statements. Please, note
                  that the use of SQL is not recommended as it cannot be
                  monitored by the plugin. The user can, for example,
                  change the charset on a lazy connection handle after
                  escaping a string and before the actual connection is
                  opened. The charset set by the user will be used for
                  any subsequent escaping before the connection is
                  established. The connection will be established using
                  the configured charset, no matter what the server
                  charset is or what the user has set before. Once a
                  connection has been opened,
                  <code class="literal">set_charset</code> is of no meaning
                  anymore.
                </p><p>
</p>
<div class="example">
<a name="idm139660444643440"></a><p class="title"><b>Example 7.85 String escaping on a lazy connection handle</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "lazy_connections": 1,
        "server_charset" : "utf8"
    }
}

        </pre><pre class="programlisting">

&lt;?php
$mysqli = new mysqli("myapp", "username", "password", "database");
$mysqli-&gt;real_escape("this will be escaped using the server_charset setting - utf8");
$mysqli-&gt;set_charset("latin1");
$mysqli-&gt;real_escape("this will be escaped using latin1");
/* server_charset implicitly set - utf8 connection */
$mysqli-&gt;query("SELECT 'This connection will be set to server_charset upon establishing' AS _msg FROM DUAL");
/* latin1 used from now on */
$mysqli-&gt;set_charset("latin1");
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.master-on-write"></a><span class="term">
                <em class="parameter"><code>master_on_write</code></em> <span class="type">bool</span>
              </span></dt><dd><p>
                  If set, the plugin will use the master server only
                  after the first statement has been executed on the
                  master. Applications can still send statements to the
                  slaves using SQL hints to overrule the automatic
                  decision.
                </p><p>
                  The setting may help with replication lag. If an
                  application runs an <code class="literal">INSERT</code> the
                  plugin will, by default, use the master to execute all
                  following statements, including
                  <code class="literal">SELECT</code> statements. This helps to
                  avoid problems with reads from slaves which have not
                  replicated the <code class="literal">INSERT</code> yet.
                </p><p>
</p>
<div class="example">
<a name="idm139660444632928"></a><p class="title"><b>Example 7.86 Master on write for consistent reads</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "master_on_write": 1
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Please, note the <code class="literal">quality_of_service</code>
                  filter introduced in version 1.2.0-alpha. It gives
                  finer control, for example, for achieving
                  read-your-writes and, it offers additional
                  functionality introducing
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.qos-consistency" title="7.5.10 Service level and consistency">service
                  levels</a>.
                </p><p>
                  All
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">transaction
                  stickiness</a> settings, including
                  <code class="literal">trx_stickiness=on</code>, are overruled by
                  <code class="literal">master_on_write=1</code>.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness"></a><span class="term">
                <em class="parameter"><code>trx_stickiness</code></em>
                <span class="type">string</span>
              </span></dt><dd><p>
                  Transaction stickiness policy. Supported policies:
                  <code class="literal">disabled</code> (default),
                  <code class="literal">master</code>.
                </p><p>
                  The setting requires 5.4.0 or newer. If used with PHP
                  older than 5.4.0, the plugin will emit a warning like
                  <code class="literal">(mysqlnd_ms) trx_stickiness strategy is not
                  supported before PHP 5.3.99</code>.
                </p><p>
                  If no transaction stickiness policy is set or, if
                  setting <code class="literal">trx_stickiness=disabled</code>,
                  the plugin is not transaction aware. Thus, the plugin
                  may load balance connections and switch connections in
                  the middle of a transaction. The plugin is not
                  transaction safe. SQL hints must be used avoid
                  connection switches during a transaction.
                </p><p>
                  As of PHP 5.4.0 the mysqlnd library allows the plugin
                  to monitor the <code class="literal">autocommit</code> mode set
                  by calls to the libraries
                  <code class="literal">set_autocommit()</code> function. If
                  setting <code class="literal">set_stickiness=master</code> and
                  <code class="literal">autocommit</code> gets disabled by a PHP
                  MySQL extension invoking the
                  <code class="literal">mysqlnd</code> library internal function
                  call <code class="literal">set_autocommit()</code>, the plugin
                  is made aware of the begin of a transaction. Then, the
                  plugin stops load balancing and directs all statements
                  to the master server until
                  <code class="literal">autocommit</code> is enabled. Thus, no SQL
                  hints are required.
                </p><p>
                  An example of a PHP MySQL API function calling the
                  <code class="literal">mysqlnd</code> library internal function
                  call <code class="literal">set_autocommit()</code> is
                  <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.autocommit" title="3.9.2 mysqli::autocommit, mysqli_autocommit"><code class="function">mysqli_autocommit</code></a>.
                </p><p>
                  Although setting
                  <code class="literal">trx_stickiness=master</code>, the plugin
                  cannot be made aware of <code class="literal">autocommit</code>
                  mode changes caused by SQL statements such as
                  <code class="literal">SET AUTOCOMMIT=0</code> or
                  <code class="literal">BEGIN</code>.
                </p><p>
                  As of PHP 5.5.0, the mysqlnd library features
                  additional C API calls to control transactions. The
                  level of control matches the one offered by SQL
                  statements. The <code class="literal">mysqli</code> API has been
                  modified to use these calls. Since version 1.5.0,
                  PECL/mysqlnd_ms can monitor not only
                  <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.autocommit" title="3.9.2 mysqli::autocommit, mysqli_autocommit"><code class="function">mysqli_autocommit</code></a>,
                  but also
                  <a class="ulink" href="http://www.php.net/mysqli_begin" target="_top"><code class="function">mysqli_begin</code></a>,
                  <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.commit" title="3.9.9 mysqli::commit, mysqli_commit"><code class="function">mysqli_commit</code></a>
                  and
                  <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.rollback" title="3.9.47 mysqli::rollback, mysqli_rollback"><code class="function">mysqli_rollback</code></a>
                  to detect transaction boundaries and stop load
                  balancing for the duration of a transaction.
                </p><p>
</p>
<div class="example">
<a name="idm139660444598672"></a><p class="title"><b>Example 7.87 Using master to execute transactions</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
        },
        "trx_stickiness": "master"
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  Since version 1.5.0 automatic and silent failover is
                  disabled for the duration of a transaction. If the
                  boundaries of a transaction have been properly
                  detected, transaction stickiness is enabled and a
                  server fails, the plugin will not attempt to fail over
                  to the next server, if any, regardless of the failover
                  policy configured. The user must handle the error
                  manually. Depending on the configuration, the plugin
                  may emit an error of type <code class="literal">E_WARNING</code>
                  reading like <code class="literal">(mysqlnd_ms) Automatic failover
                  is not permitted in the middle of a
                  transaction</code>. This error may then be
                  overwritten by follow up errors such as
                  <code class="literal">(mysqlnd_ms) No connection selected by the
                  last filter</code>. Those errors will be generated
                  by the failing query function.
                </p><p>
</p>
<div class="example">
<a name="idm139660444593024"></a><p class="title"><b>Example 7.88 No automatic failover, error handling pitfall</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
/* assumption: automatic failover configured */
$mysqli = new mysqli("myapp", "username", "password", "database");

/* sets plugin internal state in_trx = 1 */
$mysqli-&gt;autocommit(false);

/* assumption: server fails */
if (!($res = $mysqli-&gt;query("SELECT 'Assume this query fails' AS _msg FROM DUAL"))) {
 /* handle failure of transaction, plugin internal state is still in_trx = 1 */
 printf("[%d] %s", $mysqli-&gt;errno, $mysqli-&gt;error);
 /*
  If using autocommit() based transaction detection it is a
  MUST to call autocommit(true). Otherwise the plugin assumes
  the current transaction continues and connection
  changes remain forbidden.
 */
 $mysqli-&gt;autocommit(true);
 /* Likewise, you'll want to start a new transaction */
 $mysqli-&gt;autocommit(false);
}
/* latin1 used from now on */
$mysqli-&gt;set_charset("latin1");
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
                </p><p>
                  If a server fails in the middle of a transaction the
                  plugin continues to refuse to switch connections until
                  the current transaction has been finished. Recall that
                  the plugin monitors API calls to detect transaction
                  boundaries. Thus, you have to, for example, enable
                  auto commit mode to end the current transaction before
                  the plugin continues load balancing and switches the
                  server. Likewise, you will want to start a new
                  transaction immediately thereafter and disable auto
                  commit mode again.
                </p><p>
                  Not handling failed queries and not ending a failed
                  transaction using API calls may cause all following
                  commands emit errors such as <code class="literal">Commands out of
                  sync; you can't run this command now</code>.
                  Thus, it is important to handle all errors.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.transient_error"></a><span class="term">
                <em class="parameter"><code>transient_error</code></em>
                <span class="type">object</span>
              </span></dt><dd><p>
                  The setting has been introduced in 1.6.0.
                </p><p>
                  A database cluster node may reply a transient error to
                  a client. The client can then repeat the operation on
                  the same node, fail over to a different node or abort
                  the operation. Per definition is it safe for a client
                  to retry the same operation on the same node before
                  giving up.
                </p><p>
                  <code class="literal">PECL/mysqlnd_ms</code> can perform the
                  retry loop on behalf of the application. By
                  configuring <code class="literal">transient_error</code> the
                  plugin can be instructed to repeat operations failing
                  with a certain error code for a certain maximum number
                  of times with a pause between the retries. If the
                  transient error disappears during loop execution, it
                  is hidden from the application. Otherwise, the error
                  is forwarded to the application by the end of the
                  loop.
                </p><p>
</p>
<div class="example">
<a name="idm139660444581072"></a><p class="title"><b>Example 7.89 Retry loop for transient errors</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master_0": {
                "host": "localhost"
            }
        },
        "slave": {
            "slave_0": {
                "host": "192.168.78.136",
                "port": "3306"
            }
       },
       "transient_error": {
          "mysql_error_codes": [
            1297
          ],
          "max_retries": 2,
          "usleep_retry": 100
       }
    }
}

</pre>
</div>

</div>
<p><br class="example-break">
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Keyword</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">mysql_error_codes</code></td><td><p>
                            List of transient error codes. You may add
                            any MySQL error code to the list. It is
                            possible to consider any error as transient
                            not only <code class="literal">1297</code>
                            (<code class="literal">HY000 (ER_GET_TEMPORARY_ERRMSG),
                            Message: Got temporary error %d
                            '%s' from %s</code>). Before
                            adding other codes but
                            <code class="literal">1297</code> to the list, make
                            sure your cluster supports a new attempt
                            without impacting the state of your
                            application.
                          </p></td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">max_retries</code></td><td><p>
                            How often to retry an operation which fails
                            with a transient error before forwarding the
                            failure to the user.
                          </p>



                          <p>
                            Default: <code class="literal">1</code>
                          </p></td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">usleep_retry</code></td><td><p>
                            Milliseconds to sleep between transient
                            error retries. The value is passed to the C
                            function
                            <a class="ulink" href="http://www.php.net/usleep" target="_top"><code class="function">usleep</code></a>,
                            hence the name.
                          </p>



                          <p>
                            Default: <code class="literal">100</code>
</p></td><td>Since 1.6.0.</td></tr></tbody></table>
</div>
</dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.xa"></a><span class="term">
                <em class="parameter"><code>xa</code></em> <span class="type">object</span>
              </span></dt><dd><p>
                  The setting has been introduced in 1.6.0.
                </p><p>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Experimental
</div>
<p>
                      The feature is currently under development. There
                      may be issues and/or feature limitations. Do not
                      use in production environments.
</p>
</div>
<p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
                      state_store
</span></dt><dd>
<div class="variablelist">
<a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.xa.state-store"></a><dl class="variablelist"><dt><span class="term">
                            record_participant_credentials
                          </span></dt><dd><p>
                              Whether to store the username and password
                              of a global transaction participant in the
                              participants table. If disabled, the
                              garbage collection will use the default
                              username and password when connecting to
                              the participants. Unless you are using a
                              different username and password for each
                              of your MySQL servers, you can use the
                              default and avoid storing the sensible
                              information in state store.
                            </p><p>
                              Please note, username and password are
                              stored in clear text when using the MySQL
                              state store, which is the only one
                              available. It is in your responsibility to
                              protect this sensible information.
                            </p><p>
                              Default: <code class="literal">false</code>
                            </p></dd><dt><span class="term">
                            participant_localhost_ip
                          </span></dt><dd><p>
                              During XA garbage collection the plugin
                              may find a participant server for which
                              the host <code class="literal">localhost</code> has
                              been recorded. If the garbage collection
                              takes place on another host but the host
                              that has written the participant record to
                              the state store, the host name
                              <code class="literal">localhost</code> now resolves
                              to a different host. Therefore, when
                              recording a participant servers host name
                              in the state store, a value of
                              <code class="literal">localhost</code> must be
                              replaced with the actual IP address of
                              <code class="literal">localhost</code>.
                            </p><p>
                              Setting
                              <code class="literal">participant_localhost_ip</code>
                              should be considered only if using
                              <code class="literal">localhost</code> cannot be
                              avoided. From a garbage collection point
                              of view only, it is preferrable not to
                              configure any socket connection but to
                              provide an IP address and port for a node.
                            </p></dd><dt><span class="term">
                            mysql
                          </span></dt><dd><p>
                              The MySQL state store is the only state
                              store available.
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
                                  global_trx_table
                                </span></dt><dd><p>
                                    Name of the MySQL table used to
                                    store the state of an ongoing or
                                    aborted global transaction. Use the
                                    below SQL statement to create the
                                    table. Make sure to edit the table
                                    name to match your configuration.
                                  </p><p>
                                    Default:
                                    <code class="literal">mysqlnd_ms_xa_trx</code>
                                  </p><p>
</p>
<div class="example">
<a name="idm139660444535856"></a><p class="title"><b>Example 7.90 SQL definition for the MySQL state store transaction table</b></p>
<div class="example-contents">
<pre class="programlisting">

CREATE TABLE mysqlnd_ms_xa_trx (
  store_trx_id int(11) NOT NULL AUTO_INCREMENT,
  gtrid int(11) NOT NULL,
  format_id int(10) unsigned NOT NULL DEFAULT '1',
  state enum('XA_NON_EXISTING','XA_ACTIVE','XA_IDLE','XA_PREPARED','XA_COMMIT','XA_ROLLBACK') NOT NULL DEFAULT 'XA_NON_EXISTING',
  intend enum('XA_NON_EXISTING','XA_ACTIVE','XA_IDLE','XA_PREPARED','XA_COMMIT','XA_ROLLBACK') DEFAULT 'XA_NON_EXISTING',
  finished enum('NO','SUCCESS','FAILURE') NOT NULL DEFAULT 'NO',
  modified timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  started datetime DEFAULT NULL,
  timeout datetime DEFAULT NULL,
  PRIMARY KEY (store_trx_id),
  KEY idx_xa_id (gtrid,format_id,finished),
  KEY idx_state (state)
) ENGINE=InnoDB

</pre>
</div>

</div>
<p><br class="example-break">
                                  </p></dd><dt><span class="term">
                                  participant_table
                                </span></dt><dd><p>
                                    Name of the MySQL table used to
                                    store participants of an ongoing or
                                    aborted global transaction. Use the
                                    below SQL statement to create the
                                    table. Make sure to edit the table
                                    name to match your configuration.
                                  </p><p>
                                    Storing credentials can be enabled
                                    and disabled using
                                    <code class="literal">record_participant_credentials</code>
                                  </p><p>
                                    Default:
                                    <code class="literal">mysqlnd_ms_xa_participants</code>
</p>
<div class="example">
<a name="idm139660444528656"></a><p class="title"><b>Example 7.91 SQL definition for the MySQL state store transaction table</b></p>
<div class="example-contents">
<pre class="programlisting">

CREATE TABLE mysqlnd_ms_xa_participants (
  fk_store_trx_id int(11) NOT NULL,
  bqual varbinary(64) NOT NULL DEFAULT '',
  participant_id int(10) unsigned NOT NULL AUTO_INCREMENT,
  server_uuid varchar(127) DEFAULT NULL,
  scheme varchar(1024) NOT NULL,
  host varchar(127) DEFAULT NULL,
  port smallint(5) unsigned DEFAULT NULL,
  socket varchar(127) DEFAULT NULL,
  user varchar(127) DEFAULT NULL,
  password varchar(127) DEFAULT NULL,
  state enum('XA_NON_EXISTING','XA_ACTIVE','XA_IDLE','XA_PREPARED','XA_COMMIT','XA_ROLLBACK')
   NOT NULL DEFAULT 'XA_NON_EXISTING',
  health enum('OK','GC_DONE','CLIENT ERROR','SERVER ERROR') NOT NULL DEFAULT 'OK',
  connection_id int(10) unsigned DEFAULT NULL,
  client_errno smallint(5) unsigned DEFAULT NULL,
  client_error varchar(1024) DEFAULT NULL,
  modified timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (participant_id),
  KEY idx_xa_bqual (bqual),
  KEY idx_store_trx (fk_store_trx_id),
  CONSTRAINT mysqlnd_ms_xa_participants_ibfk_1 FOREIGN KEY (fk_store_trx_id)
    REFERENCES mysqlnd_ms_xa_trx (store_trx_id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB

</pre>
</div>

</div>
<br class="example-break"></dd><dt><span class="term">
                                  garbage_collection_table
                                </span></dt><dd><p>
                                    Name of the MySQL table used to
                                    track and synchronize garbage
                                    collection runs. Use the below SQL
                                    statement to create the table. Make
                                    sure to edit the table name to match
                                    your configuration.
                                  </p><p>
                                    Default:
                                    <code class="literal">mysqlnd_ms_xa_gc</code>
</p>
<div class="example">
<a name="idm139660444522704"></a><p class="title"><b>Example 7.92 SQL definition for the MySQL state store garbage collection table</b></p>
<div class="example-contents">
<pre class="programlisting">

CREATE TABLE mysqlnd_ms_xa_gc (
  gc_id int(10) unsigned NOT NULL AUTO_INCREMENT,
  gtrid int(11) NOT NULL,
  format_id int(10) unsigned NOT NULL DEFAULT '1',
  fk_store_trx_id int(11) DEFAULT NULL,
  modified timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  attempts smallint(5) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (gc_id),
  KEY idx_store_trx (gtrid,format_id,fk_store_trx_id)
) ENGINE=InnoDB

</pre>
</div>

</div>
<br class="example-break"></dd><dt><span class="term">
                                  host
                                </span></dt><dd><p>
                                    Host name of the MySQL server.
                                  </p></dd><dt><span class="term">
                                  user
                                </span></dt><dd><p>
                                    Name of the user used to connect to
                                    the MySQL server.
                                  </p></dd><dt><span class="term">
                                  password
                                </span></dt><dd><p>
                                    Password for the MySQL server user.
                                  </p></dd><dt><span class="term">
                                  db
                                </span></dt><dd><p>
                                    Database that holds the garbage
                                    collection tables. Please note, you
                                    have to create the garbage
                                    collection tables prior to using the
                                    plugin. The tables will not be
                                    created implicitly during runtime
                                    but garbage collection will fail if
                                    the tables to not exist.
                                  </p></dd><dt><span class="term">
                                  port
                                </span></dt><dd><p>
                                    Port of the MySQL server.
                                  </p></dd><dt><span class="term">
                                  socket
                                </span></dt><dd><p>
                                    Unix domain socket of the MySQL
                                    server. Please note, if you have
                                    multiple PHP servers each of them
                                    will try to carry out garbage
                                    collection and need to be able to
                                    connect to the state store. In this
                                    case, you may prefer configuring an
                                    IP address and a port for the MySQL
                                    state store server to ensure all PHP
                                    servers can reach it.
</p></dd></dl>
</div>
</dd></dl>
</div>
</dd><dt><span class="term">
                      rollback_on_close
                    </span></dt><dd><p>
                        Whether to automatically rollback an open global
                        transaction when a connection is closed. If
                        enabled, it mimics the default behaviour of
                        local transactions. Should a client disconnect,
                        the server rolls back any open and unfinished
                        transactions.
                      </p><p>
                        Default: <code class="literal">true</code>
                      </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config-v2.xa.gc"></a><span class="term">
                      garbage_collection
</span></dt><dd>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
                            max_retries
                          </span></dt><dd><p>
                              Maximum number of garbage collection runs
                              before giving up. Allowed values are from
                              <code class="literal">0</code> to
                              <code class="literal">100</code>. A setting of
                              <code class="literal">0</code> means no limit,
                              unless the state store enforces a limit.
                              Should the state store enforce a limit, it
                              can be supposed to be significantly higher
                              than <code class="literal">100</code>. Available
                              since 1.6.0.
                            </p><p>
                              Please note, it is important to end failed
                              XA transactions within reasonable time to
                              make participating servers free resources
                              bound to the transaction. The built-in
                              garbage collection is not expected to fail
                              for a long period as long as crashed
                              servers become available again quickly.
                              Still, a situation may arise where a human
                              is required to act because the built-in
                              garbage collection stopped or failed. In
                              this case, you may first want to check if
                              the transaction still cannot be fixed by
                              forcing
                              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-gc" title="7.8.13 mysqlnd_ms_xa_gc"><code class="function">mysqlnd_ms_xa_gc</code></a>
                              to ignore the setting, prior to handling
                              it manually.
                            </p><p>
                              Default: <code class="literal">5</code>
                            </p></dd><dt><span class="term">
                            probability
                          </span></dt><dd><p>
                              Garbage collection probability. Allowed
                              values are from <code class="literal">0</code> to
                              <code class="literal">1000</code>. A setting of
                              <code class="literal">0</code> disables automatic
                              background garbage collection. Despite a
                              setting of <code class="literal">0</code> it is
                              still possible to trigger garbage
                              collection by calling
                              <a class="ulink" href="http://www.php.net/mysqlnd_ms_gc" target="_top"><code class="function">mysqlnd_ms_gc</code></a>.
                              Available since 1.6.0.
                            </p><p>
                              The automatic garbage collection of
                              stalled XA transaction is only available
                              if a state store have been configured. The
                              state store is responsible to keep track
                              of XA transactions. Based on its
                              recordings it can find blocked XA
                              transactions where the client has crashed,
                              connect to the participants and rollback
                              the unfinished transactions.
                            </p><p>
                              The garbage collection is triggered as
                              part of PHP's request shutdown
                              procedure at the end of a web request.
                              That is after your PHP script has finished
                              working. Do decide whether to run the
                              garbage collection a random value between
                              <code class="literal">0</code> and
                              <code class="literal">1000</code> is computed. If
                              the <code class="literal">probability</code> value
                              is higher or equal to the random value,
                              the state stores garbage collection
                              routines are invoked.
                            </p><p>
                              Default: <code class="literal">5</code>
                            </p></dd><dt><span class="term">
                            max_transactions_per_run
                          </span></dt><dd><p>
                              Maximum number of unfinished XA
                              transactions considered by the garbage
                              collection during one run. Allowed values
                              are from <code class="literal">1</code> to
                              <code class="literal">32768</code>. Available since
                              1.6.0.
                            </p><p>
                              Cleaning up an unfinished XA transaction
                              takes considerable amounts of time and
                              resources. The garbage collection routine
                              may have to connect to several
                              participants of a failed global
                              transaction to issue the SQL commands for
                              rolling back the unfinished tranaction.
                            </p><p>
                              Default: <code class="literal">100</code>
</p></dd></dl>
</div>
</dd></dl>
</div>
</dd></dl>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="apis-php-mysqlnd-ms.plugin-ini-v1"></a>7.6.4.3 Plugin configuration file (&lt;= 1.0.x)</h4>

</div>

</div>

</div>
<p>
          <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
          Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
            The below description applies to PECL/mysqlnd_ms &lt;
            1.1.0-beta. It is not valid for later versions.
</p>
</div>
<p>
          The plugin is using its own configuration file. The
          configuration file holds information on the MySQL replication
          master server, the MySQL replication slave servers, the server
          pick (load balancing) policy, the failover strategy and the
          use of lazy connections.
        </p><p>
          The PHP configuration directive
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.ini-file"><code class="literal">mysqlnd_ms.ini_file</code></a>
          is used to set the plugins configuration file.
        </p><p>
          The configuration file mimics standard the
          <code class="literal">php.ini</code> format. It consists of one or more
          sections. Every section defines its own unit of settings.
          There is no global section for setting defaults.
        </p><p>
          Applications reference sections by their name. Applications
          use section names as the host (server) parameter to the
          various connect methods of the
          <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
          <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> and
          <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
          extensions. Upon connect the
          <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> plugin
          compares the hostname with all section names from the plugin
          configuration file. If hostname and section name match, the
          plugin will load the sections settings.
        </p><p>
</p>
<div class="example">
<a name="idm139660444463392"></a><p class="title"><b>Example 7.93 Using section names example</b></p>
<div class="example-contents">
<pre class="programlisting">

[myapp]
master[] = localhost
slave[] = 192.168.2.27
slave[] = 192.168.2.28:3306
[localhost]
master[] = localhost:/tmp/mysql/mysql.sock
slave[] = 192.168.3.24:3305
slave[] = 192.168.3.65:3309

    </pre><pre class="programlisting">

&lt;?php
/* All of the following connections will be load balanced */
$mysqli = new mysqli("myapp", "username", "password", "database");
$pdo = new PDO('mysql:host=myapp;dbname=database', 'username', 'password');
$mysql = mysql_connect("myapp", "username", "password");

$mysqli = new mysqli("localhost", "username", "password", "database");
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          Section names are strings. It is valid to use a section name
          such as <code class="literal">192.168.2.1</code>,
          <code class="literal">127.0.0.1</code> or <code class="literal">localhost</code>.
          If, for example, an application connects to
          <code class="literal">localhost</code> and a plugin configuration
          section <code class="literal">[localhost]</code> exists, the semantics
          of the connect operation are changed. The application will no
          longer only use the MySQL server running on the host
          <code class="literal">localhost</code> but the plugin will start to load
          balance MySQL queries following the rules from the
          <code class="literal">[localhost]</code> configuration section. This way
          you can load balance queries from an application without
          changing the applications source code.
        </p><p>
          The <code class="literal">master[]</code>, <code class="literal">slave[]</code>
          and <code class="literal">pick[]</code> configuration directives use a
          list-like syntax. Configuration directives supporting
          list-like syntax may appear multiple times in a configuration
          section. The plugin maintains the order in which entries
          appear when interpreting them. For example, the below example
          shows two <code class="literal">slave[]</code> configuration directives
          in the configuration section <code class="literal">[myapp]</code>. If
          doing round-robin load balancing for read-only queries, the
          plugin will send the first read-only query to the MySQL server
          <code class="literal">mysql_slave_1</code> because it is the first in
          the list. The second read-only query will be send to the MySQL
          server <code class="literal">mysql_slave_2</code> because it is the
          second in the list. Configuration directives supporting
          list-like syntax result are ordered from top to bottom in
          accordance to their appearance within a configuration section.
        </p><p>
</p>
<div class="example">
<a name="idm139660444447712"></a><p class="title"><b>Example 7.94 List-like syntax</b></p>
<div class="example-contents">
<pre class="programlisting">

[myapp]
master[] = mysql_master_server
slave[] = mysql_slave_1
slave[] = mysql_slave_2

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          Here is a short explanation of the configuration directives
          that can be used.
        </p><p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config.master"></a><span class="term">
                <em class="parameter"><code>master[]</code></em> <span class="type">string</span>
              </span></dt><dd><p>
                  URI of a MySQL replication master server. The URI
                  follows the syntax
                  <code class="literal">hostname[:port|unix_domain_socket]</code>.
                </p><p>
                  The plugin supports using only one master server.
                </p><p>
                  Setting a master server is mandatory. The plugin will
                  report a warning upon connect if the user has failed
                  to provide a master server for a configuration
                  section. The warning may read <code class="literal">(mysqlnd_ms)
                  Cannot find master section in config</code>.
                  Furthermore the plugin may set an error code for the
                  connection handle such as <code class="literal">HY000/2000
                  (CR_UNKNOWN_ERROR)</code>. The corresponding error
                  message depends on your language settings.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config.slave"></a><span class="term">
                <em class="parameter"><code>slave[]</code></em> <span class="type">string</span>
              </span></dt><dd><p>
                  URI of one or more MySQL replication slave servers.
                  The URI follows the syntax
                  <code class="literal">hostname[:port|unix_domain_socket]</code>.
                </p><p>
                  The plugin supports using one or more slave servers.
                </p><p>
                  Setting a slave server is mandatory. The plugin will
                  report a warning upon connect if the user has failed
                  to provide at least one slave server for a
                  configuration section. The warning may read
                  <code class="literal">(mysqlnd_ms) Cannot find slaves section in
                  config</code>. Furthermore the plugin may set an
                  error code for the connection handle such as
                  <code class="literal">HY000/2000 (CR_UNKNOWN_ERROR)</code>. The
                  corresponding error message depends on your language
                  settings.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config.pick"></a><span class="term">
                <em class="parameter"><code>pick[]</code></em> <span class="type">string</span>
              </span></dt><dd><p>
                  Load balancing (server picking) policy. Supported
                  policies: <code class="literal">random</code>,
                  <code class="literal">random_once</code> (default),
                  <code class="literal">roundrobin</code>,
                  <code class="literal">user</code>.
                </p><p>
                  If no load balancing policy is set, the plugin will
                  default to <code class="literal">random_once</code>. The
                  <code class="literal">random_once</code> policy picks a random
                  slave server when running the first read-only
                  statement. The slave server will be used for all
                  read-only statements until the PHP script execution
                  ends.
                </p><p>
                  The <code class="literal">random</code> policy will pick a
                  random server whenever a read-only statement is to be
                  executed.
                </p><p>
                  If using <code class="literal">roundrobin</code> the plugin
                  iterates over the list of configured slave servers to
                  pick a server for statement execution. If the plugin
                  reaches the end of the list, it wraps around to the
                  beginning of the list and picks the first configured
                  slave server.
                </p><p>
                  Setting more than one load balancing policy for a
                  configuration section makes only sense in conjunction
                  with <code class="literal">user</code> and
                  <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>.
                  If the user defined callback fails to pick a server,
                  the plugin falls back to the second configured load
                  balancing policy.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config.failover"></a><span class="term">
                <em class="parameter"><code>failover</code></em> <span class="type">string</span>
              </span></dt><dd><p>
                  Failover policy. Supported policies:
                  <code class="literal">disabled</code> (default),
                  <code class="literal">master</code>.
                </p><p>
                  If no failover policy is set, the plugin will not do
                  any automatic failover
                  (<code class="literal">failover=disabled</code>). Whenever the
                  plugin fails to connect a server it will emit a
                  warning and set the connections error code and
                  message. Thereafter it is up to the application to
                  handle the error and, for example, resent the last
                  statement to trigger the selection of another server.
                </p><p>
                  If using <code class="literal">failover=master</code> the plugin
                  will implicitly failover to a slave, if available.
                  Please check the concepts documentation to learn about
                  potential pitfalls and risks of using
                  <code class="literal">failover=master</code>.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config.lazy-connections"></a><span class="term">
                <em class="parameter"><code>lazy_connections</code></em>
                <span class="type">bool</span>
              </span></dt><dd><p>
                  Controls the use of lazy connections. Lazy connections
                  are connections which are not opened before the client
                  sends the first connection.
                </p><p>
                  It is strongly recommended to use lazy connections.
                  Lazy connections help to keep the number of open
                  connections low. If you disable lazy connections and,
                  for example, configure one MySQL replication master
                  server and two MySQL replication slaves, the plugin
                  will open three connections upon the first call to a
                  connect function although the application might use
                  the master connection only.
                </p><p>
                  Lazy connections bare a risk if you make heavy use of
                  actions which change the state of a connection. The
                  plugin does not dispatch all state changing actions to
                  all connections from the connection pool. The few
                  dispatched actions are applied to already opened
                  connections only. Lazy connections opened in the
                  future are not affected. If, for example, the
                  connection character set is changed using a PHP MySQL
                  API call, the plugin will change the character set of
                  all currently opened connection. It will not remember
                  the character set change to apply it on lazy
                  connections opened in the future. As a result the
                  internal connection pool would hold connections using
                  different character sets. This is not desired.
                  Remember that character sets are taken into account
                  for escaping.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config.master-on-write"></a><span class="term">
                <em class="parameter"><code>master_on_write</code></em> <span class="type">bool</span>
              </span></dt><dd><p>
                  If set, the plugin will use the master server only
                  after the first statement has been executed on the
                  master. Applications can still send statements to the
                  slaves using SQL hints to overrule the automatic
                  decision.
                </p><p>
                  The setting may help with replication lag. If an
                  application runs an <code class="literal">INSERT</code> the
                  plugin will, by default, use the master to execute all
                  following statements, including
                  <code class="literal">SELECT</code> statements. This helps to
                  avoid problems with reads from slaves which have not
                  replicated the <code class="literal">INSERT</code> yet.
                </p></dd><dt><a name="apis-php-ini.mysqlnd-ms-plugin-config.trx-stickiness"></a><span class="term">
                <em class="parameter"><code>trx_stickiness</code></em>
                <span class="type">string</span>
              </span></dt><dd><p>
                  Transaction stickiness policy. Supported policies:
                  <code class="literal">disabled</code> (default),
                  <code class="literal">master</code>.
                </p><p>
                  Experimental feature.
                </p><p>
                  The setting requires 5.4.0 or newer. If used with PHP
                  older than 5.4.0, the plugin will emit a warning like
                  <code class="literal">(mysqlnd_ms) trx_stickiness strategy is not
                  supported before PHP 5.3.99</code>.
                </p><p>
                  If no transaction stickiness policy is set or, if
                  setting <code class="literal">trx_stickiness=disabled</code>,
                  the plugin is not transaction aware. Thus, the plugin
                  may load balance connections and switch connections in
                  the middle of a transaction. The plugin is not
                  transaction safe. SQL hints must be used avoid
                  connection switches during a transaction.
                </p><p>
                  As of PHP 5.4.0 the mysqlnd library allows the plugin
                  to monitor the <code class="literal">autocommit</code> mode set
                  by calls to the libraries
                  <code class="literal">trx_autocommit()</code> function. If
                  setting <code class="literal">trx_stickiness=master</code> and
                  <code class="literal">autocommit</code> gets disabled by a PHP
                  MySQL extension invoking the
                  <code class="literal">mysqlnd</code> library internal function
                  call <code class="literal">trx_autocommit()</code>, the plugin
                  is made aware of the begin of a transaction. Then, the
                  plugin stops load balancing and directs all statements
                  to the master server until
                  <code class="literal">autocommit</code> is enabled. Thus, no SQL
                  hints are required.
                </p><p>
                  An example of a PHP MySQL API function calling the
                  <code class="literal">mysqlnd</code> library internal function
                  call <code class="literal">trx_autocommit()</code> is
                  <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.autocommit" title="3.9.2 mysqli::autocommit, mysqli_autocommit"><code class="function">mysqli_autocommit</code></a>.
                </p><p>
                  Although setting
                  <code class="literal">trx_stickiness=master</code>, the plugin
                  cannot be made aware of <code class="literal">autocommit</code>
                  mode changes caused by SQL statements such as
                  <code class="literal">SET AUTOCOMMIT=0</code>.
</p></dd></dl>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="apis-php-mysqlnd-ms.testing"></a>7.6.4.4 Testing</h4>

</div>

</div>

</div>
<p>
          <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
          Documentation Group.</a>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
            The section applies to mysqlnd_ms 1.1.0 or newer, not the
            1.0 series.
</p>
</div>
<p>
          The PECL/mysqlnd_ms test suite is in the
          <code class="filename">tests/</code> directory of the source
          distribution. The test suite consists of standard phpt tests,
          which are described on the PHP Quality Assurance Teams
          website.
        </p><p>
          Running the tests requires setting up one to four MySQL
          servers. Some tests don't connect to MySQL at all. Others
          require one server for testing. Some require two distinct
          servers. In some cases two servers are used to emulate a
          replication setup. In other cases a master and a slave of an
          existing MySQL replication setup are required for testing. The
          tests will try to detect how many servers and what kind of
          servers are given. If the required servers are not found, the
          test will be skipped automatically.
        </p><p>
          Before running the tests, edit
          <code class="filename">tests/config.inc</code> to configure the MySQL
          servers to be used for testing.
        </p><p>
          The most basic configuration is as follows.

</p><pre class="programlisting">

 putenv("MYSQL_TEST_HOST=localhost");
 putenv("MYSQL_TEST_PORT=3306");
 putenv("MYSQL_TEST_USER=root");
 putenv("MYSQL_TEST_PASSWD=");
 putenv("MYSQL_TEST_DB=test");
 putenv("MYSQL_TEST_ENGINE=MyISAM");
 putenv("MYSQL_TEST_SOCKET=");

 putenv("MYSQL_TEST_SKIP_CONNECT_FAILURE=1");
 putenv("MYSQL_TEST_CONNECT_FLAGS=0");
 putenv("MYSQL_TEST_EXPERIMENTAL=0");

 /* replication cluster emulation */
 putenv("MYSQL_TEST_EMULATED_MASTER_HOST=". getenv("MYSQL_TEST_HOST"));
 putenv("MYSQL_TEST_EMULATED_SLAVE_HOST=". getenv("MYSQL_TEST_HOST"));

 /* real replication cluster */
 putenv("MYSQL_TEST_MASTER_HOST=". getenv("MYSQL_TEST_EMULATED_MASTER_HOST"));
 putenv("MYSQL_TEST_SLAVE_HOST=". getenv("MYSQL_TEST_EMULATED_SLAVE_HOST"));

     </pre><p>
        </p><p>
          <code class="literal">MYSQL_TEST_HOST</code>,
          <code class="literal">MYSQL_TEST_PORT</code> and
          <code class="literal">MYSQL_TEST_SOCKET</code> define the hostname,
          TCP/IP port and Unix domain socket of the default database
          server. <code class="literal">MYSQL_TEST_USER</code> and
          <code class="literal">MYSQL_TEST_PASSWD</code> contain the user and
          password needed to connect to the database/schema configured
          with <code class="literal">MYSQL_TEST_DB</code>. All configured servers
          must have the same database user configured to give access to
          the test database.
        </p><p>
          Using <code class="literal">host</code>, <code class="literal">host:port</code> or
          <code class="literal">host:/path/to/socket</code> syntax one can set an
          alternate host, host and port or host and socket for any of
          the servers.

</p><pre class="programlisting">

putenv("MYSQL_TEST_SLAVE_HOST=192.168.78.136:3307"));
putenv("MYSQL_TEST_MASTER_HOST=myserver_hostname:/path/to/socket"));

     </pre><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="apis-php-mysqlnd-ms.debugging"></a>7.6.4.5 Debugging and Tracing</h4>

</div>

</div>

</div>
<p>
          <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
          Documentation Group.</a>
        </p><p>
          The mysqlnd debug log can be used to debug and trace the
          actitivities of PECL/mysqlnd_ms. As a mysqlnd PECL/mysqlnd_ms
          adds trace information to the mysqlnd library debug file.
          Please, see the
          <a class="link" href="apis-php-mysqlnd.html#apis-php-ini.mysqlnd.debug"><code class="literal">mysqlnd.debug</code></a>
          PHP configuration directive documentation for a detailed
          description on how to configure the debug log.
        </p><p>
          Configuration setting example to activate the debug log:

</p><pre class="programlisting">

mysqlnd.debug=d:t:x:O,/tmp/mysqlnd.trace

  </pre><p>

</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
              This feature is only available with a debug build of PHP.
              Works on Microsoft Windows if using a debug build of PHP
              and PHP was built using Microsoft Visual C version 9 and
              above.
</p>
</div>
<p>
        </p><p>
          The debug log shows mysqlnd library and PECL/mysqlnd_ms plugin
          function calls, similar to a trace log. Mysqlnd library calls
          are usually prefixed with <code class="literal">mysqlnd_</code>.
          PECL/mysqlnd internal calls begin with
          <code class="literal">mysqlnd_ms</code>.
        </p><p>
          Example excerpt from the debug log (connect):

</p><pre class="programlisting">

[...]
&gt;mysqlnd_connect
| info : host=myapp user=root db=test port=3306 flags=131072
| &gt;mysqlnd_ms::connect
| | &gt;mysqlnd_ms_config_json_section_exists
| | | info : section=[myapp] len=[5]
| | | &gt;mysqlnd_ms_config_json_sub_section_exists
| | | | info : section=[myapp] len=[5]
| | | | info : ret=1
| | | &lt;mysqlnd_ms_config_json_sub_section_exists
| | | info : ret=1
| | &lt;mysqlnd_ms_config_json_section_exists
[...]

   </pre><p>
        </p><p>
          The debug log is not only useful for plugin developers but
          also to find the cause of user errors. For example, if your
          application does not do proper error handling and fails to
          record error messages, checking the debug and trace log may
          help finding the cause. Use of the debug log to debug
          application issues should be considered only if no other
          option is available. Writing the debug log to disk is a slow
          operation and may have negative impact on the application
          performance.
        </p><p>
          Example excerpt from the debug log (connection failure):

</p><pre class="programlisting">

[...]
| | | | | | | info : adding error [Access denied for user 'root'@'localhost' (using password: YES)] to the list
| | | | | | | info : PACKET_FREE(0)
| | | | | | | info : PACKET_FREE(0x7f3ef6323f50)
| | | | | | | info : PACKET_FREE(0x7f3ef6324080)
| | | | | | &lt;mysqlnd_auth_handshake
| | | | | | info : switch_to_auth_protocol=n/a
| | | | | | info : conn-&gt;error_info.error_no = 1045
| | | | | &lt;mysqlnd_connect_run_authentication
| | | | | info : PACKET_FREE(0x7f3ef63236d8)
| | | | | &gt;mysqlnd_conn::free_contents
| | | | | | &gt;mysqlnd_net::free_contents
| | | | | | &lt;mysqlnd_net::free_contents
| | | | | | info : Freeing memory of members
| | | | | | info : scheme=unix:///tmp/mysql.sock
| | | | | | &gt;mysqlnd_error_list_pdtor
| | | | | | &lt;mysqlnd_error_list_pdtor
| | | | | &lt;mysqlnd_conn::free_contents
| | | | &lt;mysqlnd_conn::connect
[...]

   </pre><p>
        </p><p>
          The trace log can also be used to verify correct behaviour of
          PECL/mysqlnd_ms itself, for example, to check which server has
          been selected for query execution and why.
        </p><p>
          Example excerpt from the debug log (plugin decision):

</p><pre class="programlisting">

[...]
&gt;mysqlnd_ms::query
| info : query=DROP TABLE IF EXISTS test
| &gt;_mysqlnd_plugin_get_plugin_connection_data
| | info : plugin_id=5
| &lt;_mysqlnd_plugin_get_plugin_connection_data
| &gt;mysqlnd_ms_pick_server_ex
| | info : conn_data=0x7fb6a7d3e5a0 *conn_data=0x7fb6a7d410d0
| | &gt;mysqlnd_ms_select_servers_all
| | &lt;mysqlnd_ms_select_servers_all
| | &gt;mysqlnd_ms_choose_connection_rr
| | | &gt;mysqlnd_ms_query_is_select
[...]
| | | &lt;mysqlnd_ms_query_is_select
[...]
| | | info : Init the master context
| | | info : list(0x7fb6a7d3f598) has 1
| | | info : Using master connection
| | | &gt;mysqlnd_ms_advanced_connect
| | | | &gt;mysqlnd_conn::connect
| | | | | info : host=localhost user=root db=test port=3306 flags=131072 persistent=0 state=0

   </pre><p>
        </p><p>
          In this case the statement <code class="literal">DROP TABLE IF EXISTS
          test</code> has been executed. Note that the statement
          string is shown in the log file. You may want to take measures
          to restrict access to the log for security considerations.
        </p><p>
          The statement has been load balanced using round robin policy,
          as you can easily guess from the functions name
          <code class="literal">&gt;mysqlnd_ms_choose_connection_rr</code>. It has
          been sent to a master server running on
          <code class="literal">host=localhost user=root db=test port=3306
          flags=131072 persistent=0 state=0</code>.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="apis-php-mysqlnd-ms.monitoring"></a>7.6.4.6 Monitoring</h4>

</div>

</div>

</div>
<p>
          <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
          Documentation Group.</a>
        </p><p>
          Plugin activity can be monitored using the mysqlnd trace log,
          mysqlnd statistics, mysqlnd_ms plugin statistics and external
          PHP debugging tools. Use of the trace log should be limited to
          debugging. It is recommended to use the plugins statistics for
          monitoring.
        </p><p>
          Writing a trace log is a slow operation. If using an external
          PHP debugging tool, please refer to the vendors manual about
          its performance impact and the type of information collected.
          In many cases, external debugging tools will provide call
          stacks. Often, a call stack or a trace log is more difficult
          to interpret than the statistics provided by the plugin.
        </p><p>
          Plugin statistics tell how often which kind of cluster node
          has been used (slave or master), why the node was used, if
          lazy connections have been used and if global transaction ID
          injection has been performed. The monitoring information
          provided enables user to verify plugin decisions and to plan
          their cluster resources based on usage pattern. The function
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>
          is used to access the statistics. Please, see the functions
          description for a list of available statistics.
        </p><p>
          Statistics are collected on a per PHP process basis. Their
          scope is a PHP process. Depending on the PHP deployment model
          a process may serve one or multiple web requests. If using CGI
          model, a PHP process serves one web request. If using FastCGI
          or pre-fork web server models, a PHP process usually serves
          multiple web requests. The same is the case with a threaded
          web server. Please, note that threads running in parallel can
          update the statistics in parallel. Thus, if using a threaded
          PHP deployment model, statistics can be changed by more than
          one script at a time. A script cannot rely on the fact that it
          sees only its own changes to statistics.
        </p><p>
</p>
<div class="example">
<a name="idm139660444331264"></a><p class="title"><b>Example 7.95 Verify plugin activity in a non-threaded deployment model</b></p>
<div class="example-contents">
<pre class="programlisting">

mysqlnd_ms.enable=1
mysqlnd_ms.collect_statistics=1

    </pre><pre class="programlisting">

&lt;?php
/* Load balanced following "myapp" section rules from the plugins config file (not shown) */
$mysqli = new mysqli("myapp", "username", "password", "database");
if (mysqli_connect_errno())
  /* Of course, your error handling is nicer... */
  die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));

$stats_before = mysqlnd_ms_get_stats();
if ($res = $mysqli-&gt;query("SELECT 'Read request' FROM DUAL")) {
  var_dump($res-&gt;fetch_all());
}
$stats_after = mysqlnd_ms_get_stats();
if ($stats_after['use_slave'] &lt;= $stats_before['use_slave']) {
  echo "According to the statistics the read request has not been run on a slave!";
}
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
        </p><p>
          Statistics are aggregated for all plugin activities and all
          connections handled by the plugin. It is not possible to tell
          how much a certain connection handle has contributed to the
          overall statistics.
        </p><p>
          Utilizing PHPs
          <a class="ulink" href="http://www.php.net/register_shutdown_function" target="_top"><code class="function">register_shutdown_function</code></a>
          function or the <code class="literal">auto_append_file</code> PHP
          configuration directive it is easily possible to dump
          statistics into, for example, a log file when a script
          finishes. Instead of using a log file it is also possible to
          send the statistics to an external monitoring tool for
          recording and display.
        </p><p>
</p>
<div class="example">
<a name="idm139660444324608"></a><p class="title"><b>Example 7.96 Recording statistics during shutdown</b></p>
<div class="example-contents">
<pre class="programlisting">

mysqlnd_ms.enable=1
mysqlnd_ms.collect_statistics=1
error_log=/tmp/php_errors.log

    </pre><pre class="programlisting">

&lt;?php
function check_stats() {
  $msg = str_repeat("-", 80) . "\n";
  $msg .= var_export(mysqlnd_ms_get_stats(), true) . "\n";
  $msg .= str_repeat("-", 80) . "\n";
  error_log($msg);
}
register_shutdown_function("check_stats");
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-mysqlnd-ms.constants"></a>7.7 Predefined Constants</h2>

</div>

</div>

</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
    </p><p>
The constants below are defined by this extension, and
will only be available when the extension has either
been compiled into PHP or dynamically loaded at runtime.
</p><p>
      <span class="emphasis"><em>SQL hint related</em></span>
    </p><p>
</p>
<div class="example">
<a name="idm139660444317392"></a><p class="title"><b>Example 7.97 Example demonstrating the usage of mysqlnd_ms constants</b></p>
<div class="example-contents">
<p>
          The mysqlnd replication and load balancing plugin
          (<code class="literal">mysqlnd_ms</code>) performs read/write splitting.
          This directs write queries to a MySQL master server, and
          read-only queries to the MySQL slave servers. The plugin has a
          built-in read/write split logic. All queries which start with
          <code class="literal">SELECT</code> are considered read-only queries,
          which are then sent to a MySQL slave server that is listed in
          the plugin configuration file. All other queries are directed
          to the MySQL master server that is also specified in the
          plugin configuration file.
        </p><p>
          User supplied SQL hints can be used to overrule automatic
          read/write splitting, to gain full control on the process. SQL
          hints are standards compliant SQL comments. The plugin will
          scan the beginning of a query string for an SQL comment for
          certain commands, which then control query redirection. Other
          systems involved in the query processing are unaffected by the
          SQL hints because other systems will ignore the SQL comments.
        </p><p>
          The plugin supports three SQL hints to direct queries to
          either the MySQL slave servers, the MySQL master server, or
          the last used MySQL server. SQL hints must be placed at the
          beginning of a query to be recognized by the plugin.
        </p><p>
          For better portability, it is recommended to use the string
          constants <code class="constant">MYSQLND_MS_MASTER_SWITCH</code>,
          <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code> and
          <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code> instead of
          their literal values.
        </p><pre class="programlisting">

&lt;?php
/* Use constants for maximum portability */
$master_query = "/*" . MYSQLND_MS_MASTER_SWITCH . "*/SELECT id FROM test";

/* Valid but less portable: using literal instead of constant */
$slave_query = "/*ms=slave*/SHOW TABLES";

printf("master_query = '%s'\n", $master_query);
printf("slave_query = '%s'\n", $slave_query);
?&gt;

   </pre><p>
          The above examples will output:
        </p><pre class="screen">

master_query = /*ms=master*/SELECT id FROM test
slave_query = /*ms=slave*/SHOW TABLES

</pre>
</div>

</div>
<p><br class="example-break">
    </p><p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><a name="apis-php-constant.mysqlnd-ms-master-switch"></a><span class="term">
            <code class="constant">MYSQLND_MS_MASTER_SWITCH</code>
            (<span class="type">string</span>)
          </span></dt><dd>
      SQL hint used to send a query to the MySQL replication master server.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-slave-switch"></a><span class="term">
            <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code>
            (<span class="type">string</span>)
          </span></dt><dd>
      SQL hint used to send a query to one of the MySQL replication slave servers.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-last-used-switch"></a><span class="term">
            <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code>
            (<span class="type">string</span>)
          </span></dt><dd>
      SQL hint used to send a query to the last used MySQL server. The last
      used MySQL server can either be a master or a slave server in a
      MySQL replication setup.
</dd></dl>
</div>
<p>
    </p><p>
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-query-is-select" title="7.8.8 mysqlnd_ms_query_is_select"><code class="function">mysqlnd_ms_query_is_select</code></a>
      related
    </p><p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><a name="apis-php-constant.mysqlnd-ms-query-use-master"></a><span class="term">
            <code class="constant">MYSQLND_MS_QUERY_USE_MASTER</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
     If <a class="ulink" href="http://www.php.net/mysqlnd_ms_is_select" target="_top"><code class="function">mysqlnd_ms_is_select</code></a> returns
     <code class="constant">MYSQLND_MS_QUERY_USE_MASTER</code> for a given query, the
     built-in read/write split mechanism recommends sending the query to
     a MySQL replication master server.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-query-use-slave"></a><span class="term">
            <code class="constant">MYSQLND_MS_QUERY_USE_SLAVE</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
      If <a class="ulink" href="http://www.php.net/mysqlnd_ms_is_select" target="_top"><code class="function">mysqlnd_ms_is_select</code></a> returns
      <code class="constant">MYSQLND_MS_QUERY_USE_SLAVE</code> for a given query, the
      built-in read/write split mechanism recommends sending the query to
      a MySQL replication slave server.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-query-use-last-used"></a><span class="term">
            <code class="constant">MYSQLND_MS_QUERY_USE_LAST_USED</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
      If <a class="ulink" href="http://www.php.net/mysqlnd_ms_is_select" target="_top"><code class="function">mysqlnd_ms_is_select</code></a> returns
      <code class="constant">MYSQLND_MS_QUERY_USE_LAST_USED</code> for a given query, the
      built-in read/write split mechanism recommends sending the query to
      the last used server.
</dd></dl>
</div>
<p>
    </p><p>
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>,
      quality of service filter and service level related
    </p><p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><a name="apis-php-constant.mysqlnd-ms-qos-consistency-eventual"></a><span class="term">
            <code class="constant">MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
      Use to request the service level eventual consistency from the
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>. Eventual consistency is the
      default quality of service when reading from an asynchronous MySQL
      replication slave. Data returned in this service level may or may not
      be stale, depending on whether the selected slaves happen to have replicated
      the latest changes from the MySQL replication master or not.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-qos-consistency-session"></a><span class="term">
            <code class="constant">MYSQLND_MS_QOS_CONSISTENCY_SESSION</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
      Use to request the service level session consistency from the
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>. Session consistency
      is defined as read your writes. The client is guaranteed to see his
      latest changes.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-qos-consistency-strong"></a><span class="term">
            <code class="constant">MYSQLND_MS_QOS_CONSISTENCY_STRONG</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
      Use to request the service level strong consistency from the
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>. Strong consistency
      is used to ensure all clients see each others changes.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-qos-option-gtid"></a><span class="term">
            <code class="constant">MYSQLND_MS_QOS_OPTION_GTID</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
      Used as a service level option with
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a> to parameterize session
      consistency.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-qos-option-age"></a><span class="term">
            <code class="constant">MYSQLND_MS_QOS_OPTION_AGE</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
      Used as a service level option with
      <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a> to parameterize eventual
      consistency.
</dd></dl>
</div>
<p>
    </p><p>
      <span class="emphasis"><em>Other</em></span>
    </p><p>
      The plugins version number can be obtained using
      <code class="constant">MYSQLND_MS_VERSION</code> or
      <code class="constant">MYSQLND_MS_VERSION_ID</code>.
      <code class="constant">MYSQLND_MS_VERSION</code> is the string
      representation of the numerical version number
      <code class="constant">MYSQLND_MS_VERSION_ID</code>, which is an integer
      such as 10000. Developers can calculate the version number as
      follows.
    </p><p>
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col">Version (part)</th><th scope="col">Example</th></tr></thead><tbody><tr><td scope="row">Major*10000</td><td>1*10000 = 10000</td></tr><tr><td scope="row">Minor*100</td><td>0*100 = 0</td></tr><tr><td scope="row">Patch</td><td>0 = 0</td></tr><tr><td scope="row">MYSQLND_MS_VERSION_ID</td><td>10000</td></tr></tbody></table>
</div>
<p>
    </p><p>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><a name="apis-php-constant.mysqlnd-ms-version"></a><span class="term">
            <code class="constant">MYSQLND_MS_VERSION</code>
            (<span class="type">string</span>)
          </span></dt><dd>
      Plugin version string, for example, <span class="quote">“<span class="quote">1.0.0-prototype</span>”</span>.
     </dd><dt><a name="apis-php-constant.mysqlnd-ms-version-id"></a><span class="term">
            <code class="constant">MYSQLND_MS_VERSION_ID</code>
            (<span class="type">integer</span>)
          </span></dt><dd>
      Plugin version number, for example, 10000.
</dd></dl>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-ref.mysqlnd-ms"></a>7.8 Mysqlnd_ms Functions</h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-dump-servers">7.8.1 <code class="literal">mysqlnd_ms_dump_servers</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-global">7.8.2 <code class="literal">mysqlnd_ms_fabric_select_global</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-shard">7.8.3 <code class="literal">mysqlnd_ms_fabric_select_shard</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid">7.8.4 <code class="literal">mysqlnd_ms_get_last_gtid</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-used-connection">7.8.5 <code class="literal">mysqlnd_ms_get_last_used_connection</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats">7.8.6 <code class="literal">mysqlnd_ms_get_stats</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-match-wild">7.8.7 <code class="literal">mysqlnd_ms_match_wild</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-query-is-select">7.8.8 <code class="literal">mysqlnd_ms_query_is_select</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos">7.8.9 <code class="literal">mysqlnd_ms_set_qos</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server">7.8.10 <code class="literal">mysqlnd_ms_set_user_pick_server</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin">7.8.11 <code class="literal">mysqlnd_ms_xa_begin</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit">7.8.12 <code class="literal">mysqlnd_ms_xa_commit</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-gc">7.8.13 <code class="literal">mysqlnd_ms_xa_gc</code></a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-rollback">7.8.14 <code class="literal">mysqlnd_ms_xa_rollback</code></a></span></dt></dl>
</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
</p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-dump-servers"></a>7.8.1 <code class="literal">mysqlnd_ms_dump_servers</code></h3>
</div>
</div>
</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_dump_servers</code>
          </p><p>
            Returns a list of currently configured servers
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">array </span><span class="methodname">mysqlnd_ms_dump_servers</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>);</code><p>
        Returns a list of currently configured servers.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A MySQL connection handle obtained from any of the connect
              functions of the
              <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
              <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> or
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
              extensions.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        <code class="constant">FALSE</code> on error. Otherwise, returns an array
        with two entries <code class="literal">masters</code> and
        <code class="literal">slaves</code> each of which contains an array
        listing all corresponding servers.
      </p><p>
        The function can be used to check and debug the list of servers
        currently used by the plugin. It is mostly useful when the list
        of servers changes at runtime, for example, when using MySQL
        Fabric.
      </p><p>
        <code class="literal">masters</code> and <code class="literal">slaves</code> server
        entries
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Key</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">name_from_config</code></td><td><p>
                  Server entry name from config, if appliciable. NULL if
                  no configuration name is available.
                </p></td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">hostname</code></td><td><p>
                  Host name of the server.
                </p></td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">user</code></td><td><p>
                  Database user used to authenticate against the server.
                </p></td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">port</code></td><td><p>
                  TCP/IP port of the server.
                </p></td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">socket</code></td><td><p>
                  Unix domain socket of the server.
</p></td><td>Since 1.6.0.</td></tr></tbody></table>
</div>
<p>
        <span class="bold"><strong>Notes</strong></span>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-dump-servers" title="7.8.1 mysqlnd_ms_dump_servers"><code class="function">mysqlnd_ms_dump_servers</code></a>
          requires PECL mysqlnd_ms &gt;&gt; 1.6.0.
</p>
</div>
<p>
        <span class="bold"><strong>Examples</strong></span>
      </p><p>
</p>
<div class="example">
<a name="idm139660444189504"></a><p class="title"><b>Example 7.98 <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-dump-servers" title="7.8.1 mysqlnd_ms_dump_servers"><code class="function">mysqlnd_ms_dump_servers</code></a>
example</b></p>
<div class="example-contents">
<pre class="programlisting">

{
    "myapp": {
        "master": {
            "master1": {
                "host":"master1_host",
                "port":"master1_port",
                "socket":"master1_socket",
                "db":"master1_db",
                "user":"master1_user",
                "password":"master1_pw"
            }
        },
        "slave": {
             "slave_0": {
                 "host":"slave0_host",
                 "port":"slave0_port",
                 "socket":"slave0_socket",
                 "db":"slave0_db",
                 "user":"slave0_user",
                 "password":"slave0_pw"
             },
             "slave_1": {
                 "host":"slave1_host"
             }
        }
    }
}

    </pre><pre class="programlisting">

&lt;?php
$link = mysqli_connect("myapp", "global_user", "global_pass", "global_db", 1234, "global_socket");
var_dump(mysqlnd_ms_dump_servers($link);
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

array(2) {
  ["masters"]=&gt;
  array(1) {
    [0]=&gt;
    array(5) {
      ["name_from_config"]=&gt;
      string(7) "master1"
      ["hostname"]=&gt;
      string(12) "master1_host"
      ["user"]=&gt;
      string(12) "master1_user"
      ["port"]=&gt;
      int(3306)
      ["socket"]=&gt;
      string(14) "master1_socket"
    }
  }
  ["slaves"]=&gt;
  array(2) {
    [0]=&gt;
    array(5) {
      ["name_from_config"]=&gt;
      string(7) "slave_0"
      ["hostname"]=&gt;
      string(11) "slave0_host"
      ["user"]=&gt;
      string(11) "slave0_user"
      ["port"]=&gt;
      int(3306)
      ["socket"]=&gt;
      string(13) "slave0_socket"
    }
    [1]=&gt;
    array(5) {
      ["name_from_config"]=&gt;
      string(7) "slave_1"
      ["hostname"]=&gt;
      string(11) "slave1_host"
      ["user"]=&gt;
      string(12) "gloabal_user"
      ["port"]=&gt;
      int(1234)
      ["socket"]=&gt;
      string(13) "global_socket"
    }
  }
}

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-fabric-select-global"></a>7.8.2 <code class="literal">mysqlnd_ms_fabric_select_global</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_fabric_select_global</code>
          </p><p>
            Switch to global sharding server for a given table
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
</p><code class="methodsynopsis"><span class="type">array </span><span class="methodname">mysqlnd_ms_fabric_select_global</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>,<br>                                      <span class="methodparam"><span class="type">mixed </span><span class="parameter">table_name</span></span>);</code>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Warning
</div>
<p>This function is
currently not documented; only its argument list is available.
</p>
</div>
<p>
        MySQL Fabric related.
      </p><p>
        Switch the connection to the nodes handling global sharding
        queries for the given table name.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A MySQL connection handle obtained from any of the connect
              functions of the
              <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
              <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> or
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
              extensions.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>table_name</code></em>
          </span></dt><dd><p>
              The table name to ask Fabric about.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        <code class="constant">FALSE</code> on error. Otherwise,
        <code class="constant">TRUE</code>
      </p><p>
        <span class="bold"><strong>Notes</strong></span>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-global" title="7.8.2 mysqlnd_ms_fabric_select_global"><code class="function">mysqlnd_ms_fabric_select_global</code></a>
          requires PECL mysqlnd_ms &gt;&gt; 1.6.0.
</p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-fabric-select-shard"></a>7.8.3 <code class="literal">mysqlnd_ms_fabric_select_shard</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_fabric_select_shard</code>
          </p><p>
            Switch to shard
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
</p><code class="methodsynopsis"><span class="type">array </span><span class="methodname">mysqlnd_ms_fabric_select_shard</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>,<br>                                     <span class="methodparam"><span class="type">mixed </span><span class="parameter">table_name</span></span>,<br>                                     <span class="methodparam"><span class="type">mixed </span><span class="parameter">shard_key</span></span>);</code>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Warning
</div>
<p>This function is
currently not documented; only its argument list is available.
</p>
</div>
<p>
        MySQL Fabric related.
      </p><p>
        Switch the connection to the shards responsible for the given
        table name and shard key.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A MySQL connection handle obtained from any of the connect
              functions of the
              <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
              <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> or
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
              extensions.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>table_name</code></em>
          </span></dt><dd><p>
              The table name to ask Fabric about.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>shard_key</code></em>
          </span></dt><dd><p>
              The shard key to ask Fabric about.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        <code class="constant">FALSE</code> on error. Otherwise,
        <code class="constant">TRUE</code>
      </p><p>
        <span class="bold"><strong>Notes</strong></span>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-shard" title="7.8.3 mysqlnd_ms_fabric_select_shard"><code class="function">mysqlnd_ms_fabric_select_shard</code></a>
          requires PECL mysqlnd_ms &gt;&gt; 1.6.0.
</p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-get-last-gtid"></a>7.8.4 <code class="literal">mysqlnd_ms_get_last_gtid</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_get_last_gtid</code>
          </p><p>
            Returns the latest global transaction ID
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">string </span><span class="methodname">mysqlnd_ms_get_last_gtid</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>);</code><p>
        Returns a global transaction identifier which belongs to a write
        operation no older than the last write performed by the client.
        It is not guaranteed that the global transaction identifier is
        identical to that one created for the last write transaction
        performed by the client.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A PECL/mysqlnd_ms connection handle to a MySQL server of
              the type
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>,
              <a class="link" href="apis-php-mysqli.html" title="Chapter 3 MySQL Improved Extension">mysqli</a>&gt; or
              <a class="link" href="apis-php-mysql.html" title="Chapter 5 Original MySQL API">ext/mysql</a>. The
              connection handle is obtained when opening a connection
              with a host name that matches a mysqlnd_ms configuration
              file entry using any of the above three MySQL driver
              extensions.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Returns a global transaction ID (GTID) on success. Otherwise,
        returns <code class="constant">FALSE</code>.
      </p><p>
        The function
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>
        returns the GTID obtained when executing the SQL statement from
        the <code class="literal">fetch_last_gtid</code> entry of the
        <code class="literal">global_transaction_id_injection</code> section from
        the plugins configuration file.
      </p><p>
        The function may be called after the GTID has been incremented.
      </p><p>
        <span class="bold"><strong>Notes</strong></span>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>
          requires PHP &gt;= 5.4.0 and PECL mysqlnd_ms &gt;= 1.2.0.
          Internally, it is using a <code class="literal">mysqlnd</code> library C
          functionality not available with PHP 5.3.
        </p><p>
          Please note, all MySQL 5.6 production versions do not provide
          clients with enough information to use GTIDs for enforcing
          session consistency. In the worst case, the plugin will choose
          the master only.
</p>
</div>
<p>
        <span class="bold"><strong>Examples</strong></span>
      </p><p>
</p>
<div class="example">
<a name="idm139660444094896"></a><p class="title"><b>Example 7.99 <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>
example</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
/* Open mysqlnd_ms connection using mysqli, PDO_MySQL or mysql extension */
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli)
  /* Of course, your error handling is nicer... */
  die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));

/* auto commit mode, transaction on master, GTID must be incremented */
if (!$mysqli-&gt;query("DROP TABLE IF EXISTS test"))
  die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));

printf("GTID after transaction %s\n", mysqlnd_ms_get_last_gtid($mysqli));

/* auto commit mode, transaction on master, GTID must be incremented */
if (!$mysqli-&gt;query("CREATE TABLE test(id INT)"))
  die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));

printf("GTID after transaction %s\n", mysqlnd_ms_get_last_gtid($mysqli));
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">Global Transaction IDs</a>

          </td></tr></table><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-get-last-used-connection"></a>7.8.5 <code class="literal">mysqlnd_ms_get_last_used_connection</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_get_last_used_connection</code>
          </p><p>
            Returns an array which describes the last used connection
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">array </span><span class="methodname">mysqlnd_ms_get_last_used_connection</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>);</code><p>
        Returns an array which describes the last used connection from
        the plugins connection pool currently pointed to by the user
        connection handle. If using the plugin, a user connection handle
        represents a pool of database connections. It is not possible to
        tell from the user connection handles properties to which
        database server from the pool the user connection handle points.
      </p><p>
        The function can be used to debug or monitor PECL mysqlnd_ms.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A MySQL connection handle obtained from any of the connect
              functions of the
              <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
              <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> or
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
              extensions.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        <code class="constant">FALSE</code> on error. Otherwise, an array which
        describes the connection used to execute the last statement on.
      </p><p>
        Array which describes the connection.
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Property</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">scheme</code></td><td>Connection scheme. Either <code class="literal">tcp://host:port</code> or
                <code class="literal">unix://host:socket</code>. If you want to
                distinguish connections from each other use a
                combination of <code class="literal">scheme</code> and
                <code class="literal">thread_id</code> as a unique key. Neither
                <code class="literal">scheme</code> nor
                <code class="literal">thread_id</code> alone are sufficient to
                distinguish two connections from each other. Two servers
                may assign the same <code class="literal">thread_id</code> to two
                different connections. Thus, connections in the pool may
                have the same <code class="literal">thread_id</code>. Also, do not
                rely on uniqueness of <code class="literal">scheme</code> in a
                pool. Your QA engineers may use the same MySQL server
                instance for two distinct logical roles and add it
                multiple times to the pool. This hack is used, for
                example, in the test suite.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">host</code></td><td>Database server host used with the connection. The host is only set with
                TCP/IP connections. It is empty with Unix domain or
                Windows named pipe connections,</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">host_info</code></td><td>A character string representing the server hostname and the connection
                type.</td><td>Since 1.1.2.</td></tr><tr><td scope="row"><code class="literal">port</code></td><td>Database server port used with the connection.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">socket_or_pipe</code></td><td>Unix domain socket or Windows named pipe used with the connection. The
                value is empty for TCP/IP connections.</td><td>Since 1.1.2.</td></tr><tr><td scope="row"><code class="literal">thread_id</code></td><td>Connection thread id.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">last_message</code></td><td>Info message obtained from the MySQL C API function mysql_info().
                Please, see
                <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.info" title="3.9.29 mysqli::$info, mysqli_info"><code class="function">mysqli_info</code></a>
for a description.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">errno</code></td><td>Error code.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">error</code></td><td>Error message.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">sqlstate</code></td><td>Error SQLstate code.</td><td>Since 1.1.0.</td></tr></tbody></table>
</div>
<p>
        <span class="bold"><strong>Notes</strong></span>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-used-connection" title="7.8.5 mysqlnd_ms_get_last_used_connection"><code class="function">mysqlnd_ms_get_last_used_connection</code></a>
          requires PHP &gt;= 5.4.0 and PECL mysqlnd_ms &gt;&gt; 1.1.0.
          Internally, it is using a <code class="literal">mysqlnd</code> library C
          call not available with PHP 5.3.
</p>
</div>
<p>
        <span class="bold"><strong>Examples</strong></span>
      </p><p>
        The example assumes that <code class="literal">myapp</code> refers to a
        plugin configuration file section and represents a connection
        pool.
      </p><p>
</p>
<div class="example">
<a name="idm139660444026080"></a><p class="title"><b>Example 7.100 <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-used-connection" title="7.8.5 mysqlnd_ms_get_last_used_connection"><code class="function">mysqlnd_ms_get_last_used_connection</code></a>
example</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
$link = new mysqli("myapp", "user", "password", "database");
$res = $link-&gt;query("SELECT 1 FROM DUAL");
var_dump(mysqlnd_ms_get_last_used_connection($link));
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

array(10) {
  ["scheme"]=&gt;
  string(22) "unix:///tmp/mysql.sock"
  ["host_info"]=&gt;
  string(25) "Localhost via UNIX socket"
  ["host"]=&gt;
  string(0) ""
  ["port"]=&gt;
  int(3306)
  ["socket_or_pipe"]=&gt;
  string(15) "/tmp/mysql.sock"
  ["thread_id"]=&gt;
  int(46253)
  ["last_message"]=&gt;
  string(0) ""
  ["errno"]=&gt;
  int(0)
  ["error"]=&gt;
  string(0) ""
  ["sqlstate"]=&gt;
  string(5) "00000"
}

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-get-stats"></a>7.8.6 <code class="literal">mysqlnd_ms_get_stats</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_get_stats</code>
          </p><p>
            Returns query distribution and connection statistics
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">array </span><span class="methodname">mysqlnd_ms_get_stats</span>();</code><p>
        Returns an array of statistics collected by the replication and
        load balancing plugin.
      </p><p>
        The PHP configuration setting
        <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.collect-statistics">mysqlnd_ms.collect_statistics</a></code>
        controls the collection of statistics. The collection of
        statistics is disabled by default for performance reasons.
      </p><p>
        The scope of the statistics is the <code class="literal">PHP</code>
        process. Depending on your deployment model a
        <code class="literal">PHP</code> process may handle one or multiple
        requests.
      </p><p>
        Statistics are aggregated for all connections and all storage
        handler. It is not possible to tell how much queries originating
        from <code class="literal">mysqli</code>, <code class="literal">PDO_MySQL</code> or
        <code class="literal">mysql</code> API calls have contributed to the
        aggregated data values.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
      </p><p>
        This function has no parameters.
      </p><p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Returns <code class="constant">NULL</code> if the PHP configuration
        directive
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.enable"><code class="literal">mysqlnd_ms.enable</code></a>
        has disabled the plugin. Otherwise, returns array of statistics.
      </p><p>
        Array of statistics
</p>
<div class="informaltable">
<table class="informaltable" summary="Unknown PHP API feature." border="1"><colgroup><col><col><col></colgroup><thead><tr><th scope="col">Statistic</th><th scope="col">Description</th><th scope="col">Version</th></tr></thead><tbody><tr><td scope="row"><code class="literal">use_slave</code></td><td><p>
                  The semantics of this statistic has changed between
                  1.0.1 - 1.1.0.
                </p>



                <p>
                  The meaning for version 1.0.1 is as follows. Number of
                  statements considered as read-only by the built-in
                  query analyzer. Neither statements which begin with a
                  SQL hint to force use of slave nor statements directed
                  to a slave by an user-defined callback are included.
                  The total number of statements sent to the slaves is
                  <code class="literal">use_slave</code> +
                  <code class="literal">use_slave_sql_hint</code> +
                  <code class="literal">use_slave_callback</code>.
                </p>



                <p>
                  PECL/mysqlnd_ms 1.1.0 introduces a new concept of
                  chained filters. The statistics is now set by the
                  internal load balancing filter. With version 1.1.0 the
                  load balancing filter is always the last in the filter
                  chain, if used. In future versions a load balancing
                  filter may be followed by other filters causing
                  another change in the meaning of the statistic. If, in
                  the future, a load balancing filter is followed by
                  another filter it is no longer guaranteed that the
                  statement, which increments
                  <code class="literal">use_slave</code>, will be executed on the
                  slaves.
                </p>



                <p>
                  The meaning for version 1.1.0 is as follows. Number of
                  statements sent to the slaves. Statements directed to
                  a slave by the user filter (an user-defined callback)
                  are not included. The latter are counted by
                  <code class="literal">use_slave_callback</code>.
                </p></td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">use_master</code></td><td><p>
                  The semantics of this statistic has changed between
                  1.0.1 - 1.1.0.
                </p>



                <p>
                  The meaning for version 1.0.1 is as follows. Number of
                  statements not considered as read-only by the built-in
                  query analyzer. Neither statements which begin with a
                  SQL hint to force use of master nor statements
                  directed to a master by an user-defined callback are
                  included. The total number of statements sent to the
                  master is <code class="literal">use_master</code> +
                  <code class="literal">use_master_sql_hint</code> +
                  <code class="literal">use_master_callback</code>.
                </p>



                <p>
                  PECL/mysqlnd_ms 1.1.0 introduces a new concept of
                  chained filters. The statictics is now set by the
                  internal load balancing filter. With version 1.1.0 the
                  load balancing filter is always the last in the filter
                  chain, if used. In future versions a load balancing
                  filter may be followed by other filters causing
                  another change in the meaning of the statistic. If, in
                  the future, a load balancing filter is followed by
                  another filter it is no longer guaranteed that the
                  statement, which increments
                  <code class="literal">use_master</code>, will be executed on the
                  slaves.
                </p>



                <p>
                  The meaning for version 1.1.0 is as follows. Number of
                  statements sent to the masters. Statements directed to
                  a master by the user filter (an user-defined callback)
                  are not included. The latter are counted by
                  <code class="literal">use_master_callback</code>.
                </p></td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">use_slave_guess</code></td><td>Number of statements the built-in query analyzer recommends sending to a
                slave because they contain no SQL hint to force use of a
                certain server. The recommendation may be overruled in
                the following. It is not guaranteed whether the
                statement will be executed on a slave or not. This is
                how often the internal <code class="literal">is_select</code>
                function has guessed that a slave shall be used. Please,
                see also the user space function
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-query-is-select" title="7.8.8 mysqlnd_ms_query_is_select"><code class="function">mysqlnd_ms_query_is_select</code></a>.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">use_master_guess</code></td><td>Number of statements the built-in query analyzer recommends sending to a
                master because they contain no SQL hint to force use of
                a certain server. The recommendation may be overruled in
                the following. It is not guaranteed whether the
                statement will be executed on a slave or not. This is
                how often the internal <code class="literal">is_select</code>
                function has guessed that a master shall be used.
                Please, see also the user space function
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-query-is-select" title="7.8.8 mysqlnd_ms_query_is_select"><code class="function">mysqlnd_ms_query_is_select</code></a>.</td><td>Since 1.1.0.</td></tr><tr><td scope="row"><code class="literal">use_slave_sql_hint</code></td><td>Number of statements sent to a slave because statement begins with the
                SQL hint to force use of slave.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">use_master_sql_hint</code></td><td>Number of statements sent to a master because statement begins with the
                SQL hint to force use of master.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">use_last_used_sql_hint</code></td><td>Number of statements sent to server which has run the previous
                statement, because statement begins with the SQL hint to
                force use of previously used server.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">use_slave_callback</code></td><td>Number of statements sent to a slave because an user-defined callback
                has chosen a slave server for statement execution.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">use_master_callback</code></td><td>Number of statements sent to a master because an user-defined callback
                has chosen a master server for statement execution.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">non_lazy_connections_slave_success</code></td><td>Number of successfully opened slave connections from configurations not
                using
                <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
                connections</a></code>. The total number of
                successfully opened slave connections is
                <code class="literal">non_lazy_connections_slave_success</code> +
                <code class="literal">lazy_connections_slave_success</code></td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">non_lazy_connections_slave_failure</code></td><td>Number of failed slave connection attempts from configurations not using
                <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
                connections</a></code>. The total number of failed
                slave connection attempts is
                <code class="literal">non_lazy_connections_slave_failure</code> +
                <code class="literal">lazy_connections_slave_failure</code></td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">non_lazy_connections_master_success</code></td><td>Number of successfully opened master connections from configurations not
                using
                <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
                connections</a></code>. The total number of
                successfully opened master connections is
                <code class="literal">non_lazy_connections_master_success</code> +
                <code class="literal">lazy_connections_master_success</code></td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">non_lazy_connections_master_failure</code></td><td>Number of failed master connection attempts from configurations not
                using
                <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
                connections</a></code>. The total number of failed
                master connection attempts is
                <code class="literal">non_lazy_connections_master_failure</code> +
                <code class="literal">lazy_connections_master_failure</code></td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">lazy_connections_slave_success</code></td><td>Number of successfully opened slave connections from configurations
                using
                <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
                connections</a></code>.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">lazy_connections_slave_failure</code></td><td>Number of failed slave connection attempts from configurations using
                <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
                connections</a></code>.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">lazy_connections_master_success</code></td><td>Number of successfully opened master connections from configurations
                using
                <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
                connections</a></code>.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">lazy_connections_master_failure</code></td><td>Number of failed master connection attempts from configurations using
                <code class="literal"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.lazy-connections">lazy
                connections</a></code>.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">trx_autocommit_on</code></td><td>Number of <code class="literal">autocommit</code> mode activations via API calls.
                This figure may be used to monitor activity related to
                the plugin configuration setting
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness"><code class="literal">trx_stickiness</code></a>.
                If, for example, you want to know if a certain API call
                invokes the <code class="literal">mysqlnd</code> library function
                <code class="literal">trx_autocommit()</code>, which is a
                requirement for
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness"><code class="literal">trx_stickiness</code></a>,
                you may call the user API function in question and check
                if the statistic has changed. The statistic is modified
                only by the plugins internal subclassed
                <code class="literal">trx_autocommit()</code> method.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">trx_autocommit_off</code></td><td>Number of <code class="literal">autocommit</code> mode deactivations via API
                calls.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">trx_master_forced</code></td><td>Number of statements redirected to the master while
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness"><code class="literal">trx_stickiness=master</code></a>
                and <code class="literal">autocommit</code> mode is disabled.</td><td>Since 1.0.0.</td></tr><tr><td scope="row"><code class="literal">gtid_autocommit_injections_success</code></td><td>Number of successful SQL injections in autocommit mode as part of the
                plugins client-side
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">global
                transaction id emulation</a>.</td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">gtid_autocommit_injections_failure</code></td><td>Number of failed SQL injections in autocommit mode as part of the
                plugins client-side
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">global
                transaction id emulation</a>.</td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">gtid_commit_injections_success</code></td><td>Number of successful SQL injections in commit mode as part of the
                plugins client-side
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">global
                transaction id emulation</a>.</td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">gtid_commit_injections_failure</code></td><td>Number of failed SQL injections in commit mode as part of the plugins
                client-side
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">global
                transaction id emulation</a>.</td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">gtid_implicit_commit_injections_success</code></td><td>Number of successful SQL injections when implicit commit is detected as
                part of the plugins client-side
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">global
                transaction id emulation</a>. Implicit commit
                happens, for example, when autocommit has been turned
                off, a query is executed and autocommit is enabled
                again. In that case, the statement will be committed by
                the server and SQL to maintain is injected before the
                autocommit is re-enabled. Another sequence causing an
                implicit commit is <code class="literal">begin()</code>,
                <code class="literal">query()</code>, <code class="literal">begin()</code>.
                The second call to <code class="literal">begin()</code> will
                implicitly commit the transaction started by the first
                call to <code class="literal">begin()</code>.
                <code class="literal">begin()</code> refers to internal library
                calls not actual PHP user API calls.</td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">gtid_implicit_commit_injections_failure</code></td><td>Number of failed SQL injections when implicit commit is detected as part
                of the plugins client-side
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.gtid" title="7.5.11 Global transaction IDs">global
                transaction id emulation</a>. Implicit commit
                happens, for example, when autocommit has been turned
                off, a query is executed and autocommit is enabled
                again. In that case, the statement will be committed by
                the server and SQL to maintain is injected before the
                autocommit is re-enabled.</td><td>Since 1.2.0.</td></tr><tr><td scope="row"><code class="literal">transient_error_retries</code></td><td>How often an operation has been retried when a transient error was
                detected. See also,
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.transient_error"><code class="literal">transient_error</code></a>
                plugin configuration file setting.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">fabric_sharding_lookup_servers_success</code></td><td>Number of successful <code class="literal">sharding.lookup_servers</code> remote
                procedure calls to MySQL Fabric. A call is considered
                successful if the plugin could reach MySQL Fabric and
                got any reply. The reply itself may or may not be
                understood by the plugin. Success refers to the network
                transport only. If the reply was not understood or
                indicates a valid error condition,
                <code class="literal">fabric_sharding_lookup_servers_xml_failure</code>
                gets incremented.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">fabric_sharding_lookup_servers_failure</code></td><td>Number of failed <code class="literal">sharding.lookup_servers</code> remote
                procedure calls to MySQL Fabric. A remote procedure call
                is considered failed if there was a network error in
                connecting to, writing to or reading from MySQL Fabric.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">fabric_sharding_lookup_servers_time_total</code></td><td>Time spent connecting to,writing to and reading from MySQL Fabrich
                during the <code class="literal">sharding.lookup_servers</code>
                remote procedure call. The value is aggregated for all
                calls. Time is measured in microseconds.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">fabric_sharding_lookup_servers_bytes_total</code></td><td>Total number of bytes received from MySQL Fabric in reply to
                <code class="literal">sharding.lookup_servers</code> calls.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">fabric_sharding_lookup_servers_xml_failure</code></td><td>How often a reply from MySQL Fabric to
                <code class="literal">sharding.lookup_servers</code> calls was not
                understood. Please note, the current experimental
                implementation does not distinguish between valid errors
                returned and malformed replies.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">xa_begin</code></td><td>How many XA/distributed transactions have been started using
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin" title="7.8.11 mysqlnd_ms_xa_begin"><code class="function">mysqlnd_ms_xa_begin</code></a>.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">xa_commit_success</code></td><td>How many XA/distributed transactions have been successfully committed
                using
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit" title="7.8.12 mysqlnd_ms_xa_commit"><code class="function">mysqlnd_ms_xa_commit</code></a>.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">xa_commit_failure</code></td><td>How many XA/distributed transactions failed to commit during
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit" title="7.8.12 mysqlnd_ms_xa_commit"><code class="function">mysqlnd_ms_xa_commit</code></a>.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">xa_rollback_success</code></td><td>How many XA/distributed transactions have been successfully rolled back
                using
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-rollback" title="7.8.14 mysqlnd_ms_xa_rollback"><code class="function">mysqlnd_ms_xa_rollback</code></a>.
                The figure does not include implict rollbacks performed
                as a result of
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit" title="7.8.12 mysqlnd_ms_xa_commit"><code class="function">mysqlnd_ms_xa_commit</code></a>
                failure.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">xa_rollback_failure</code></td><td>How many XA/distributed transactions could not be rolled back. This
                includes failures of
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-rollback" title="7.8.14 mysqlnd_ms_xa_rollback"><code class="function">mysqlnd_ms_xa_rollback</code></a>
                but also failured during rollback when closing a
                connection, if <code class="literal">rollback_on_close</code> is
                set. Please, see also
                <code class="literal">xa_rollback_on_close</code> below.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">xa_participants</code></td><td>Total number of participants in any XA transaction started with
                <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin" title="7.8.11 mysqlnd_ms_xa_begin"><code class="function">mysqlnd_ms_xa_begin</code></a>.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">xa_rollback_on_close</code></td><td>How many XA transactions have been rolled back implicitly when a
                connection was close and
                <code class="literal">rollback_on_close</code> is set. Depending
                on your coding policies, this may hint a flaw in your
                code as you may prefer to explicitly clean up resources.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">pool_masters_total</code></td><td>Number of master servers (connections) in the internal connection pool.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">pool_slaves_total</code></td><td>Number of slave servers (connections) in the internal connection pool.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">pool_masters_active</code></td><td>Number of master servers (connections) from the internal connection pool
                which are currently used for picking a connection.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">pool_slaves_active</code></td><td>Number of slave servers (connections) from the internal connection pool
                which are currently used for picking a connection.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">pool_updates</code></td><td>How often the active connection list has been replaced and a new set of
                master and slave servers had been installed.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">pool_master_reactivated</code></td><td>How often a master connection has been reused after being flushed from
                the active list.</td><td>Since 1.6.0.</td></tr><tr><td scope="row"><code class="literal">pool_slave_reactivated</code></td><td>How often a slave connection has been reused after being flushed from
the active list.</td><td>Since 1.6.0.</td></tr></tbody></table>
</div>
<p>
        <span class="bold"><strong>Examples</strong></span>
      </p><p>
</p>
<div class="example">
<a name="idm139660443825296"></a><p class="title"><b>Example 7.101 <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>
example</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
printf("mysqlnd_ms.enable = %d\n", ini_get("mysqlnd_ms.enable"));
printf("mysqlnd_ms.collect_statistics = %d\n", ini_get("mysqlnd_ms.collect_statistics"));
var_dump(mysqlnd_ms_get_stats());
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

mysqlnd_ms.enable = 1
mysqlnd_ms.collect_statistics = 1
array(26) {
  ["use_slave"]=&gt;
  string(1) "0"
  ["use_master"]=&gt;
  string(1) "0"
  ["use_slave_guess"]=&gt;
  string(1) "0"
  ["use_master_guess"]=&gt;
  string(1) "0"
  ["use_slave_sql_hint"]=&gt;
  string(1) "0"
  ["use_master_sql_hint"]=&gt;
  string(1) "0"
  ["use_last_used_sql_hint"]=&gt;
  string(1) "0"
  ["use_slave_callback"]=&gt;
  string(1) "0"
  ["use_master_callback"]=&gt;
  string(1) "0"
  ["non_lazy_connections_slave_success"]=&gt;
  string(1) "0"
  ["non_lazy_connections_slave_failure"]=&gt;
  string(1) "0"
  ["non_lazy_connections_master_success"]=&gt;
  string(1) "0"
  ["non_lazy_connections_master_failure"]=&gt;
  string(1) "0"
  ["lazy_connections_slave_success"]=&gt;
  string(1) "0"
  ["lazy_connections_slave_failure"]=&gt;
  string(1) "0"
  ["lazy_connections_master_success"]=&gt;
  string(1) "0"
  ["lazy_connections_master_failure"]=&gt;
  string(1) "0"
  ["trx_autocommit_on"]=&gt;
  string(1) "0"
  ["trx_autocommit_off"]=&gt;
  string(1) "0"
  ["trx_master_forced"]=&gt;
  string(1) "0"
  ["gtid_autocommit_injections_success"]=&gt;
  string(1) "0"
  ["gtid_autocommit_injections_failure"]=&gt;
  string(1) "0"
  ["gtid_commit_injections_success"]=&gt;
  string(1) "0"
  ["gtid_commit_injections_failure"]=&gt;
  string(1) "0"
  ["gtid_implicit_commit_injections_success"]=&gt;
  string(1) "0"
  ["gtid_implicit_commit_injections_failure"]=&gt;
  string(1) "0"
  ["transient_error_retries"]=&gt;
  string(1) "0"
}

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration" title="7.6.3 Runtime Configuration">Runtime configuration</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.collect-statistics">mysqlnd_ms.collect_statistics</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.enable">mysqlnd_ms.enable</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.monitoring" title="7.6.4.6 Monitoring">Monitoring</a>

          </td></tr></table><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-match-wild"></a>7.8.7 <code class="literal">mysqlnd_ms_match_wild</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_match_wild</code>
          </p><p>
            Finds whether a table name matches a wildcard pattern or not
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">bool </span><span class="methodname">mysqlnd_ms_match_wild</span>(<span class="methodparam"><span class="type">string </span><span class="parameter">table_name</span></span>,<br>                           <span class="methodparam"><span class="type">string </span><span class="parameter">wildcard</span></span>);</code><p>
        Finds whether a table name matches a wildcard pattern or not.
      </p><p>
        This function is not of much practical relevance with PECL
        mysqlnd_ms 1.1.0 because the plugin does not support MySQL
        replication table filtering yet.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>table_name</code></em>
          </span></dt><dd><p>
              The table name to check if it is matched by the wildcard.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>wildcard</code></em>
          </span></dt><dd><p>
              The wildcard pattern to check against the table name. The
              wildcard pattern supports the same placeholders as MySQL
              replication filters do.
            </p><p>
              MySQL replication filters can be configured by using the
              MySQL Server configuration options
              <code class="literal">--replicate-wild-do-table</code> and
              <code class="literal">--replicate-wild-do-db</code>. Please, consult
              the MySQL Reference Manual to learn more about this MySQL
              Server feature.
            </p><p>
              The supported placeholders are:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">%</code> - zero or more literals
        </li><li class="listitem"><code class="literal">_</code> - one literal
</li></ul>
</div>
<p>
            </p><p>
              Placeholders can be escaped using <code class="literal">\</code>.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Returns <code class="constant">TRUE</code> <code class="literal">table_name</code>
        is matched by <code class="literal">wildcard</code>. Otherwise, returns
        <code class="constant">FALSE</code>
      </p><p>
        <span class="bold"><strong>Examples</strong></span>
      </p><p>
</p>
<div class="example">
<a name="idm139660443782144"></a><p class="title"><b>Example 7.102 <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-match-wild" title="7.8.7 mysqlnd_ms_match_wild"><code class="function">mysqlnd_ms_match_wild</code></a>
example</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
var_dump(mysqlnd_ms_match_wild("schema_name.table_name", "schema%"));
var_dump(mysqlnd_ms_match_wild("abc", "_"));
var_dump(mysqlnd_ms_match_wild("table1", "table_"));
var_dump(mysqlnd_ms_match_wild("asia_customers", "%customers"));
var_dump(mysqlnd_ms_match_wild("funny%table","funny\%table"));
var_dump(mysqlnd_ms_match_wild("funnytable", "funny%table"));
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

bool(true)
bool(false)
bool(true)
bool(true)
bool(true)
bool(true)

</pre>
</div>

</div>
<p><br class="example-break">
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-query-is-select"></a>7.8.8 <code class="literal">mysqlnd_ms_query_is_select</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_query_is_select</code>
          </p><p>
            Find whether to send the query to the master, the slave or
            the last used MySQL server
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">int </span><span class="methodname">mysqlnd_ms_query_is_select</span>(<span class="methodparam"><span class="type">string </span><span class="parameter">query</span></span>);</code><p>
        Finds whether to send the query to the master, the slave or the
        last used MySQL server.
      </p><p>
        The plugins built-in read/write split mechanism will be used to
        analyze the query string to make a recommendation where to send
        the query. The built-in read/write split mechanism is very basic
        and simple. The plugin will recommend sending all queries to the
        MySQL replication master server but those which begin with
        <code class="literal">SELECT</code>, or begin with a SQL hint which
        enforces sending the query to a slave server. Due to the basic
        but fast algorithm the plugin may propose to run some read-only
        statements such as <code class="literal">SHOW TABLES</code> on the
        replication master.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>query</code></em>
          </span></dt><dd><p>
              Query string to test.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        A return value of
        <code class="constant">MYSQLND_MS_QUERY_USE_MASTER</code> indicates that
        the query should be send to the MySQL replication master server.
        The function returns a value of
        <code class="constant">MYSQLND_MS_QUERY_USE_SLAVE</code> if the query can
        be run on a slave because it is considered read-only. A value of
        <code class="constant">MYSQLND_MS_QUERY_USE_LAST_USED</code> is returned
        to recommend running the query on the last used server. This can
        either be a MySQL replication master server or a MySQL
        replication slave server.
      </p><p>
        If read write splitting has been disabled by setting
        <code class="literal">mysqlnd_ms.disable_rw_split</code>, the function
        will always return
        <code class="constant">MYSQLND_MS_QUERY_USE_MASTER</code> or
        <code class="constant">MYSQLND_MS_QUERY_USE_LAST_USED</code>.
      </p><p>
        <span class="bold"><strong>Examples</strong></span>
      </p><p>
</p>
<div class="example">
<a name="idm139660443754448"></a><p class="title"><b>Example 7.103 <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-query-is-select" title="7.8.8 mysqlnd_ms_query_is_select"><code class="function">mysqlnd_ms_query_is_select</code></a>
example</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
function is_select($query)
{
 switch (mysqlnd_ms_query_is_select($query))
 {
  case MYSQLND_MS_QUERY_USE_MASTER:
   printf("'%s' should be run on the master.\n", $query);
   break;
  case MYSQLND_MS_QUERY_USE_SLAVE:
   printf("'%s' should be run on a slave.\n", $query);
   break;
  case MYSQLND_MS_QUERY_USE_LAST_USED:
   printf("'%s' should be run on the server that has run the previous query\n", $query);
   break;
  default:
   printf("No suggestion where to run the '%s', fallback to master recommended\n", $query);
   break;
 }
}

is_select("INSERT INTO test(id) VALUES (1)");
is_select("SELECT 1 FROM DUAL");
is_select("/*" . MYSQLND_MS_LAST_USED_SWITCH . "*/SELECT 2 FROM DUAL");
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

INSERT INTO test(id) VALUES (1) should be run on the master.
SELECT 1 FROM DUAL should be run on a slave.
/*ms=last_used*/SELECT 2 FROM DUAL should be run on the server that has run the previous query

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.constants" title="7.7 Predefined Constants">Predefined Constants</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-user"><code class="literal">user</code></a> filter
    </td></tr></table><p>

        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration" title="7.6.3 Runtime Configuration">Runtime configuration</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.disable-rw-split">mysqlnd_ms.disable_rw_split</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.enable">mysqlnd_ms.enable</a>

          </td></tr></table><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-set-qos"></a>7.8.9 <code class="literal">mysqlnd_ms_set_qos</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_set_qos</code>
          </p><p>
            Sets the quality of service needed from the cluster
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">bool </span><span class="methodname">mysqlnd_ms_set_qos</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>,<br>                        <span class="methodparam"><span class="type">int </span><span class="parameter">service_level</span></span>,<br>                        <span class="methodparam"><span class="type">int </span><span class="parameter">service_level_option</span></span>,<br>                        <span class="methodparam"><span class="type">mixed </span><span class="parameter">option_value</span></span>);</code><p>
        Sets the quality of service needed from the cluster. A database
        cluster delivers a certain quality of service to the user
        depending on its architecture. A major aspect of the quality of
        service is the consistency level the cluster can offer. An
        asynchronous MySQL replication cluster defaults to eventual
        consistency for slave reads: a slave may serve stale data,
        current data, or it may have not the requested data at all,
        because it is not synchronous to the master. In a MySQL
        replication cluster, only master accesses can give strong
        consistency, which promises that all clients see each others
        changes.
      </p><p>
        PECL/mysqlnd_ms hides the complexity of choosing appropriate
        nodes to achieve a certain level of service from the cluster.
        The "Quality of Service" filter implements the
        necessary logic. The filter can either be configured in the
        plugins configuration file, or at runtime using
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
      </p><p>
        Similar results can be achieved with PECL mysqlnd_ms &lt; 1.2.0,
        if using SQL hints to force the use of a certain type of node or
        using the <code class="literal">master_on_write</code> plugin
        configuration option. The first requires more code and causes
        more work on the application side. The latter is less refined
        than using the quality of service filter. Settings made through
        the function call can be reversed, as shown in the example
        below. The example temporarily switches to a higher service
        level (session consistency, read your writes) and returns back
        to the clusters default after it has performed all operations
        that require the better service. This way, read load on the
        master can be minimized compared to using
        <code class="literal">master_on_write</code>, which would continue using
        the master after the first write.
      </p><p>
        Since 1.5.0 calls will fail when done in the middle of a
        transaction if
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">transaction
        stickiness</a> is enabled and transaction boundaries have
        been detected. properly.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A PECL/mysqlnd_ms connection handle to a MySQL server of
              the type
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>,
              <a class="link" href="apis-php-mysqli.html" title="Chapter 3 MySQL Improved Extension">mysqli</a> or
              <a class="link" href="apis-php-mysql.html" title="Chapter 5 Original MySQL API">ext/mysql</a> for which
              a service level is to be set. The connection handle is
              obtained when opening a connection with a host name that
              matches a mysqlnd_ms configuration file entry using any of
              the above three MySQL driver extensions.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>service_level</code></em>
          </span></dt><dd><p>
              The requested service level:
              <code class="constant">MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL</code>,
              <code class="constant">MYSQLND_MS_QOS_CONSISTENCY_SESSION</code> or
              <code class="constant">MYSQLND_MS_QOS_CONSISTENCY_STRONG</code>.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>service_level_option</code></em>
          </span></dt><dd><p>
              An option to parameterize the requested service level. The
              option can either be
              <code class="constant">MYSQLND_MS_QOS_OPTION_GTID</code> or
              <code class="constant">MYSQLND_MS_QOS_OPTION_AGE</code>.
            </p><p>
              The option <code class="constant">MYSQLND_MS_QOS_OPTION_GTID</code>
              can be used to refine the service level
              <code class="constant">MYSQLND_MS_QOS_CONSISTENCY_SESSION</code>.
              It must be combined with a fourth function parameter, the
              <em class="parameter"><code>option_value</code></em>. The
              <em class="parameter"><code>option_value</code></em> shall be a global
              transaction ID obtained from
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>.
              If set, the plugin considers both master servers and
              asynchronous slaves for session consistency (read your
              writes). Otherwise, only masters are used to achieve
              session consistency. A slave is considered up-to-date and
              checked if it has already replicated the global
              transaction ID from <em class="parameter"><code>option_value</code></em>.
              Please note, searching appropriate slaves is an expensive
              and slow operation. Use the feature sparsely, if the
              master cannot handle the read load alone.
            </p><p>
              The <code class="constant">MYSQLND_MS_QOS_OPTION_AGE</code> option
              can be combined with the
              <code class="constant">MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL</code>
              service level, to filter out asynchronous slaves that lag
              more seconds behind the master than
              <em class="parameter"><code>option_value</code></em>. If set, the plugin
              will only consider slaves for reading if <code class="literal">SHOW
              SLAVE STATUS</code> reports
              <code class="literal">Slave_IO_Running=Yes</code>,
              <code class="literal">Slave_SQL_Running=Yes</code> and
              <code class="literal">Seconds_Behind_Master &lt;=
              option_value</code>. Please note, searching appropriate
              slaves is an expensive and slow operation. Use the feature
              sparsely in version 1.2.0. Future versions may improve the
              algorithm used to identify candidates. Please, see the
              MySQL reference manual about the precision, accuracy and
              limitations of the MySQL administrative command
              <code class="literal">SHOW SLAVE STATUS</code>.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>option_value</code></em>
          </span></dt><dd><p>
              Parameter value for the service level option. See also the
              <em class="parameter"><code>service_level_option</code></em> parameter.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Returns <code class="constant">TRUE</code> if the connections service
        level has been switched to the requested. Otherwise, returns
        <code class="constant">FALSE</code>
      </p><p>
        <span class="bold"><strong>Notes</strong></span>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
          requires PHP &gt;= 5.4.0 and PECL mysqlnd_ms &gt;= 1.2.0.
          Internally, it is using a <code class="literal">mysqlnd</code> library C
          functionality not available with PHP 5.3.
        </p><p>
          Please note, all MySQL 5.6 production versions do not provide
          clients with enough information to use GTIDs for enforcing
          session consistency. In the worst case, the plugin will choose
          the master only.
</p>
</div>
<p>
        <span class="bold"><strong>Examples</strong></span>
      </p><p>
</p>
<div class="example">
<a name="idm139660443680592"></a><p class="title"><b>Example 7.104 <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
example</b></p>
<div class="example-contents">
<pre class="programlisting">

&lt;?php
/* Open mysqlnd_ms connection using mysqli, PDO_MySQL or mysql extension */
$mysqli = new mysqli("myapp", "username", "password", "database");
if (!$mysqli)
  /* Of course, your error handling is nicer... */
  die(sprintf("[%d] %s\n", mysqli_connect_errno(), mysqli_connect_error()));

/* Session consistency: read your writes */
$ret = mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_SESSION);
if (!$ret)
  die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));

/* Will use master and return fresh data, client can see his last write */
if (!$res = $mysqli-&gt;query("SELECT item, price FROM orders WHERE order_id = 1"))
  die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));

/* Back to default: use of all slaves and masters permitted, stale data can happen */
if (!mysqlnd_ms_set_qos($mysqli, MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL))
  die(sprintf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error));
?&gt;

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.qos-consistency" title="7.5.10 Service level and consistency">Service level and consistency concept</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.filter" title="7.5.9 Filter">Filter concept</a>

          </td></tr></table><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-set-user-pick-server"></a>7.8.10 <code class="literal">mysqlnd_ms_set_user_pick_server</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_set_user_pick_server</code>
          </p><p>
            Sets a callback for user-defined read/write splitting
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">bool </span><span class="methodname">mysqlnd_ms_set_user_pick_server</span>(<span class="methodparam"><span class="type">string </span><span class="parameter">function</span></span>);</code><p>
        Sets a callback for user-defined read/write splitting. The
        plugin will call the callback only if
        <code class="literal">pick[]=user</code> is the default rule for server
        picking in the relevant section of the plugins configuration
        file.
      </p><p>
        The plugins built-in read/write query split mechanism decisions
        can be overwritten in two ways. The easiest way is to prepend
        the query string with the SQL hints
        <code class="constant">MYSQLND_MS_MASTER_SWITCH</code>,
        <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code> or
        <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code>. Using SQL
        hints one can control, for example, whether a query shall be
        send to the MySQL replication master server or one of the slave
        servers. By help of SQL hints it is not possible to pick a
        certain slave server for query execution.
      </p><p>
        Full control on server selection can be gained using a callback
        function. Use of a callback is recommended to expert users only
        because the callback has to cover all cases otherwise handled by
        the plugin.
      </p><p>
        The plugin will invoke the callback function for selecting a
        server from the lists of configured master and slave servers.
        The callback function inspects the query to run and picks a
        server for query execution by returning the hosts URI, as found
        in the master and slave list.
      </p><p>
        If the lazy connections are enabled and the callback chooses a
        slave server for which no connection has been established so far
        and establishing the connection to the slave fails, the plugin
        will return an error upon the next action on the failed
        connection, for example, when running a query. It is the
        responsibility of the application developer to handle the error.
        For example, the application can re-run the query to trigger a
        new server selection and callback invocation. If so, the
        callback must make sure to select a different slave, or check
        slave availability, before returning to the plugin to prevent an
        endless loop.
      </p><p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>function</code></em>
          </span></dt><dd><p>
              The function to be called. Class methods may also be
              invoked statically using this function by passing
              <code class="literal">array($classname, $methodname)</code> to this
              parameter. Additionally class methods of an object
              instance may be called by passing
              <code class="literal">array($objectinstance, $methodname)</code> to
              this parameter.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Host to run the query on. The host URI is to be taken from the
        master and slave connection lists passed to the callback
        function. If callback returns a value neither found in the
        master nor in the slave connection lists the plugin will
        fallback to the second pick method configured via the
        <code class="literal">pick[]</code> setting in the plugin configuration
        file. If not second pick method is given, the plugin falls back
        to the build-in default pick method for server selection.
      </p><p>
        <span class="bold"><strong>Notes</strong></span>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>
          is available with PECL mysqlnd_ms &lt; 1.1.0. It has been
          replaced by the <code class="literal">user</code> filter. Please, check
          the <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-one" title="7.9.6 PECL/mysqlnd_ms 1.1 series">Change
          History</a> for upgrade notes.
</p>
</div>
<p>
        <span class="bold"><strong>Examples</strong></span>
      </p><p>
</p>
<div class="example">
<a name="idm139660443640256"></a><p class="title"><b>Example 7.105 <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>
example</b></p>
<div class="example-contents">
<pre class="programlisting">

[myapp]
master[] = localhost
slave[] = 192.168.2.27:3306
slave[] = 192.168.78.136:3306
pick[] = user

    </pre><pre class="programlisting">

&lt;?php

function pick_server($connected, $query, $master, $slaves, $last_used)
{
 static $slave_idx = 0;
 static $num_slaves = NULL;
 if (is_null($num_slaves))
  $num_slaves = count($slaves);

 /* default: fallback to the plugins build-in logic */
 $ret = NULL;

 printf("User has connected to '%s'...\n", $connected);
 printf("... deciding where to run '%s'\n", $query);

 $where = mysqlnd_ms_query_is_select($query);
 switch ($where)
 {
  case MYSQLND_MS_QUERY_USE_MASTER:
   printf("... using master\n");
   $ret = $master[0];
   break;
  case MYSQLND_MS_QUERY_USE_SLAVE:
   /* SELECT or SQL hint for using slave */
   if (stristr($query, "FROM table_on_slave_a_only"))
   {
    /* a table which is only on the first configured slave  */
    printf("... access to table available only on slave A detected\n");
    $ret = $slaves[0];
   }
   else
   {
    /* round robin */
    printf("... some read-only query for a slave\n");
    $ret = $slaves[$slave_idx++ % $num_slaves];
   }
   break;
  case MYSQLND_MS_QUERY_LAST_USED:
   printf("... using last used server\n");
   $ret = $last_used;
   break;
 }

 printf("... ret = '%s'\n", $ret);
 return $ret;
}

mysqlnd_ms_set_user_pick_server("pick_server");

$mysqli = new mysqli("myapp", "root", "root", "test");

if (!($res = $mysqli-&gt;query("SELECT 1 FROM DUAL")))
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
else
 $res-&gt;close();

if (!($res = $mysqli-&gt;query("SELECT 2 FROM DUAL")))
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
else
 $res-&gt;close();


if (!($res = $mysqli-&gt;query("SELECT * FROM table_on_slave_a_only")))
 printf("[%d] %s\n", $mysqli-&gt;errno, $mysqli-&gt;error);
else
 $res-&gt;close();

$mysqli-&gt;close();
?&gt;

    </pre><p>
            The above example will output:
          </p><pre class="screen">

User has connected to 'myapp'...
... deciding where to run 'SELECT 1 FROM DUAL'
... some read-only query for a slave
... ret = 'tcp://192.168.2.27:3306'
User has connected to 'myapp'...
... deciding where to run 'SELECT 2 FROM DUAL'
... some read-only query for a slave
... ret = 'tcp://192.168.78.136:3306'
User has connected to 'myapp'...
... deciding where to run 'SELECT * FROM table_on_slave_a_only'
... access to table available only on slave A detected
... ret = 'tcp://192.168.2.27:3306'

</pre>
</div>

</div>
<p><br class="example-break">
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-query-is-select" title="7.8.8 mysqlnd_ms_query_is_select"><code class="function">mysqlnd_ms_query_is_select</code></a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.filter" title="7.5.9 Filter">Filter concept</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.filter-user"><code class="literal">user</code></a> filter
    </td></tr></table><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-xa-begin"></a>7.8.11 <code class="literal">mysqlnd_ms_xa_begin</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_xa_begin</code>
          </p><p>
            Starts a distributed/XA transaction among MySQL servers
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">int </span><span class="methodname">mysqlnd_ms_xa_begin</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>,<br>                        <span class="methodparam"><span class="type">string </span><span class="parameter">gtrid</span></span>,<br>                        <span class="methodparam"><span class="type">int </span><span class="parameter">timeout</span></span>);</code><p>
        Starts a XA transaction among MySQL servers. PECL/mysqlnd_ms
        acts as a transaction coordinator the distributed transaction.
      </p><p>
        Once a global transaction has been started, the plugin injects
        appropriate <code class="literal">XA BEGIN</code> SQL statements on all
        MySQL servers used in the following. The global transaction is
        either ended by calling
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-commit" title="7.8.12 mysqlnd_ms_xa_commit"><code class="function">mysqlnd_ms_xa_commit</code></a>,
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-rollback" title="7.8.14 mysqlnd_ms_xa_rollback"><code class="function">mysqlnd_ms_xa_rollback</code></a>
        or by an implicit rollback in case of an error.
      </p><p>
        During a global transaction, the plugin tracks all server
        switches, for example, when switching from one MySQL shard to
        another MySQL shard. Immediately before a query is run on a
        server that has not been participating in the global transaction
        yet, <code class="literal">XA BEGIN</code> is executed on the server. From
        a users perspective the injection happens during a call to a
        query execution function such as
        <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.query" title="3.9.40 mysqli::query, mysqli_query"><code class="function">mysqli_query</code></a>.
        Should the injection fail an error is reported to the caller of
        the query execution function. The failing server does not become
        a participant in the global transaction. The user may retry
        executing a query on the server and hereby retry injecting
        <code class="literal">XA BEGIN</code>, abort the global transaction
        because not all required servers can participate, or ignore and
        continue the global without the failed server.
      </p><p>
        Reasons to fail executing <code class="literal">XA BEGIN</code> include
        but are not limited to a server being unreachable or the server
        having an open, concurrent XA transaction using the same xid.
      </p><p>
        Please note, global and local transactions are mutually
        exclusive. You cannot start a XA transaction when you have a
        local transaction open. The local transaction must be ended
        first. The plugin tries to detect this conflict as early as
        possible. It monitors API calls for controlling local
        transactions to learn about the current state. However, if using
        SQL statements for local transactions such as
        <code class="literal">BEGIN</code>, the plugin may not know the current
        state and the conflict is not detected before <code class="literal">XA
        BEGIN</code> is injected and executed.
      </p><p>
        The use of other XA resources but MySQL servers is not supported
        by the function. To carry out a global transaction among, for
        example, a MySQL server and another vendors database system, you
        should issue the systems SQL commands yourself.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Experimental
</div>
<p>
          The feature is currently under development. There may be
          issues and/or feature limitations. Do not use in production
          environments.
</p>
</div>
<p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A MySQL connection handle obtained from any of the connect
              functions of the
              <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
              <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> or
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
              extensions.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>gtrid</code></em>
          </span></dt><dd><p>
              Global transaction identifier (gtrid). The gtrid is a
              binary string up to 64 bytes long. Please note, depending
              on your character set settings, 64 characters may require
              more than 64 bytes to store.
            </p><p>
              In accordance with the MySQL SQL syntax, XA transactions
              use identifiers made of three parts. An xid consists of a
              global transaction identifier (gtrid), a branch qualifier
              (bqual) and a format identifier (formatID). Only the
              global transaction identifier can and needs to be set.
            </p><p>
              The branch qualifier and format identifier are set
              automatically. The details should be considered
              implementation dependent, which may change without prior
              notice. In version 1.6 the branch qualifier is consecutive
              number which is incremented whenever a participant joins
              the global transaction.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>timeout</code></em>
          </span></dt><dd><p>
              Timeout in seconds. The default value is 60 seconds.
            </p><p>
              The timeout is a hint to the garbage collection. If a
              transaction is recorded to take longer than expected, the
              garbage collection begins checking the transactions
              status.
            </p><p>
              Setting a low value may make the garbage collection check
              the progress too often. Please note, checking the status
              of a global transaction may involve connecting to all
              recorded participants and possibly issuing queries on the
              servers.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Returns <code class="constant">TRUE</code> if there is no open local or
        global transaction and a new global transaction can be started.
        Otherwise, returns <code class="constant">FALSE</code>
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.xa_transactions" title="7.4.6 XA/Distributed Transactions">Quickstart XA/Distributed transactions</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration" title="7.6.3 Runtime Configuration">Runtime configuration</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>

          </td></tr></table><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-xa-commit"></a>7.8.12 <code class="literal">mysqlnd_ms_xa_commit</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_xa_commit</code>
          </p><p>
            Commits a distributed/XA transaction among MySQL servers
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">int </span><span class="methodname">mysqlnd_ms_xa_commit</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>,<br>                         <span class="methodparam"><span class="type">string </span><span class="parameter">gtrid</span></span>);</code><p>
        Commits a global transaction among MySQL servers started by
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin" title="7.8.11 mysqlnd_ms_xa_begin"><code class="function">mysqlnd_ms_xa_begin</code></a>.
      </p><p>
        If any of the global transaction participants fails to commit an
        implicit rollback is performed. It may happen that not all cases
        can be handled during the rollback. For example, no attempts
        will be made to reconnect to a participant after the connection
        to the participant has been lost. Solving cases that cannot
        easily be rolled back is left to the garbage collection.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Experimental
</div>
<p>
          The feature is currently under development. There may be
          issues and/or feature limitations. Do not use in production
          environments.
</p>
</div>
<p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A MySQL connection handle obtained from any of the connect
              functions of the
              <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
              <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> or
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
              extensions.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>gtrid</code></em>
          </span></dt><dd><p>
              Global transaction identifier (gtrid).
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Returns <code class="constant">TRUE</code> if the global transaction has
        been committed. Otherwise, returns <code class="constant">FALSE</code>
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.xa_transactions" title="7.4.6 XA/Distributed Transactions">Quickstart XA/Distributed transactions</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration" title="7.6.3 Runtime Configuration">Runtime configuration</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>

          </td></tr></table><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-xa-gc"></a>7.8.13 <code class="literal">mysqlnd_ms_xa_gc</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_xa_gc</code>
          </p><p>
            Garbage collects unfinished XA transactions after severe
            errors
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">int </span><span class="methodname">mysqlnd_ms_xa_gc</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>,<br>                     <span class="methodparam"><span class="type">string </span><span class="parameter">gtrid</span></span>,<br>                     <span class="methodparam"><span class="type">boolean </span><span class="parameter">ignore_max_retries</span></span>);</code><p>
        Garbage collects unfinished XA transactions.
      </p><p>
        The XA protocol is a blocking protocol. There exist cases when
        servers participating in a global transaction cannot make
        progress when the transaction coordinator crashes or
        disconnects. In such a case, the MySQL servers keep waiting for
        instructions to finish the XA transaction in question. Because
        transactions occupy resources, transactions should always be
        terminated properly.
      </p><p>
        Garbage collection requires configuring a state store to track
        global transactions. Should a PHP client crash in the middle of
        a transaction and a new PHP client be started, then the built-in
        garbage collection can learn about the aborted global
        transaction and terminate it. If you do not configure a state
        store, the garbage collection cannot perform any cleanup tasks.
      </p><p>
        The state store should be crash-safe and be highly available to
        survive its own crash. Currently, only MySQL is supported as a
        state store.
      </p><p>
        Garbage collection can also be performed automatically in the
        background. See the plugin configuration directive
        <code class="literal">garbage_collection</code> for details.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Experimental
</div>
<p>
          The feature is currently under development. There may be
          issues and/or feature limitations. Do not use in production
          environments.
</p>
</div>
<p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A MySQL connection handle obtained from any of the connect
              functions of the
              <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
              <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> or
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
              extensions.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>gtrid</code></em>
          </span></dt><dd><p>
              Global transaction identifier (gtrid). If given, the
              garbage collection considers the transaction only.
              Otherwise, the state store is scanned for any unfinished
              transaction.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>ignore_max_retries</code></em>
          </span></dt><dd><p>
              Whether to ignore the plugin configuration
              <code class="literal">max_retries</code> setting. If garbage
              collection continuously fails and the
              <code class="literal">max_retries</code> limit is reached prior to
              finishing the failed global transaction, you can attempt
              further runs prior to investigating the cause and solving
              the issue manually by issuing appropriate SQL statements
              on the participants. Setting the parameter has the same
              effect as temporarily setting <code class="literal">max_retries =
              0</code>.
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Returns <code class="constant">TRUE</code> if garbage collection was
        successful. Otherwise, returns <code class="constant">FALSE</code>
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.xa_transactions" title="7.4.6 XA/Distributed Transactions">Quickstart XA/Distributed transactions</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration" title="7.6.3 Runtime Configuration">Runtime configuration</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.xa">State store configuration</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>

          </td></tr></table><p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-function.mysqlnd-ms-xa-rollback"></a>7.8.14 <code class="literal">mysqlnd_ms_xa_rollback</code></h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysqlnd_ms_xa_rollback</code>
          </p><p>
            Rolls back a distributed/XA transaction among MySQL servers
</p></li></ul>
</div>
<p>
        <span class="bold"><strong>Description</strong></span>
      </p><code class="methodsynopsis"><span class="type">int </span><span class="methodname">mysqlnd_ms_xa_rollback</span>(<span class="methodparam"><span class="type">mixed </span><span class="parameter">connection</span></span>,<br>                           <span class="methodparam"><span class="type">string </span><span class="parameter">gtrid</span></span>);</code><p>
        Rolls back a global transaction among MySQL servers started by
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-xa-begin" title="7.8.11 mysqlnd_ms_xa_begin"><code class="function">mysqlnd_ms_xa_begin</code></a>.
      </p><p>
        If any of the global transaction participants fails to rollback
        the situation is left to be solved by the garbage collection.
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Experimental
</div>
<p>
          The feature is currently under development. There may be
          issues and/or feature limitations. Do not use in production
          environments.
</p>
</div>
<p>
        <span class="bold"><strong>Parameters</strong></span>
</p>
<div class="variablelist">
<dl class="variablelist"><dt><span class="term">
            <em class="parameter"><code>connection</code></em>
          </span></dt><dd><p>
              A MySQL connection handle obtained from any of the connect
              functions of the
              <a class="link" href="apis-php-mysqli.html#apis-php-ref.mysqli" title="3.15 Aliases and deprecated Mysqli Functions">mysqli</a>,
              <a class="link" href="apis-php-mysql.html#apis-php-ref.mysql" title="5.5 MySQL Functions">mysql</a> or
              <a class="link" href="apis-php-pdo-mysql.html" title="Chapter 4 MySQL Functions (PDO_MYSQL)">PDO_MYSQL</a>
              extensions.
            </p></dd><dt><span class="term">
            <em class="parameter"><code>gtrid</code></em>
          </span></dt><dd><p>
              Global transaction identifier (gtrid).
</p></dd></dl>
</div>
<p>
        <span class="bold"><strong>Return Values</strong></span>
      </p><p>
        Returns <code class="constant">TRUE</code> if the global transaction has
        been rolled back. Otherwise, returns <code class="constant">FALSE</code>
      </p><p>
        <span class="bold"><strong>See Also</strong></span>
      </p><p>
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.xa_transactions" title="7.4.6 XA/Distributed Transactions">Quickstart XA/Distributed transactions</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.configuration" title="7.6.3 Runtime Configuration">Runtime configuration</a>

          </td></tr><tr><td><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>

          </td></tr></table><p>
</p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="apis-php-mysqlnd-ms.changes"></a>7.9 Change History</h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-six">7.9.1 PECL/mysqlnd_ms 1.6 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-five">7.9.2 PECL/mysqlnd_ms 1.5 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-four">7.9.3 PECL/mysqlnd_ms 1.4 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-three">7.9.4 PECL/mysqlnd_ms 1.3 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-two">7.9.5 PECL/mysqlnd_ms 1.2 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-one">7.9.6 PECL/mysqlnd_ms 1.1 series</a></span></dt><dt><span class="section"><a href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.changes-one-o">7.9.7 PECL/mysqlnd_ms 1.0 series</a></span></dt></dl>
</div>
<p>
      <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
      Documentation Group.</a>
    </p><p>
      This change history is a high level summary of selected changes
      that may impact applications and/or break backwards compatibility.
    </p><p>
      See also the <code class="filename">CHANGES</code> file in the source
      distribution for a complete list of changes.
</p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.changes-one-six"></a>7.9.1 PECL/mysqlnd_ms 1.6 series</h3>
</div>
</div>
</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        1.6.0-alpha

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: TBD
     </li><li class="listitem">
      Motto/theme: Maintenance and initial MySQL Fabric support
</li></ul>
</div>
<p>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          This is the current development series. All features are at an
          early stage. Changes may happen at any time without prior
          notice. Please, do not use this version in production
          environments.
        </p><p>
          The documentation may not reflect all changes yet.
</p>
</div>
<p>
        Bug fixes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Won't fix: #66616 R/W split fails: QOS with
              mysqlnd_get_last_gtid with built-in MySQL GTID
            </p><p>
              This is not a bug in the plugins implementation but a
              server side feature limitation not considered and
              documented before. MySQL 5.6 built-in GTIDs cannot be used
              to ensure session consistency when reading from slaves in
              all cases. In the worst case the plugin will not consider
              using the slaves and fallback to using the master. There
              will be no wrong results but no benefit from doing GTID
              checks either.
            </p></li><li class="listitem"><p>
              Fixed #66064 - Random once load balancer ignoring weights
            </p><p>
              Due to a config parsing bug random load balancing has
              ignored node weights if, and only if, the sticky flag was
              set (random once).
            </p></li><li class="listitem"><p>
              Fixed #65496 - Wrong check for slave delay
            </p><p>
              The quality of service filter has erroneously ignored
              slaves that lag for zero (0) seconds if a any maximum lag
              had been set. Although a slave was not lagging behind, it
              was excluded from the load balancing list if a maximum age
              was set by the QoS filter. This was due to using the wrong
              comparison operator in the source of the filter.
            </p></li><li class="listitem"><p>
              Fixed #65408 - Compile failure with
              -Werror=format-security
</p></li></ul>
</div>
<p>
      </p><p>
        Feature changes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Introduced an internal connection pool. When using Fabric
              and switching from shard group A to shard group B, we are
              replacing the entire list of masters and slaves. This
              troubles the connections state alignment logic and some
              filters. Some filters cache information on the master and
              slave lists. The new internal connection pool abstraction
              allows us to inform the filters of changes, hence they can
              update their caches.
            </p><p>
              Later on, the pool can also be used to reduce connection
              overhead. Assume you are switching from a shard group to
              another and back again. Whenever the switch is done, the
              pool's active server (and connection) lists are
              replaced. However, no longer used connections are not
              necessarily closed immediately but can be kept in the pool
              for later reuse.
            </p><p>
              Please note, the connection pool is internalat this point.
              There are some new statistics to monitor it. However, you
              cannot yet configure pool size of behaviour.
            </p></li><li class="listitem"><p>
              Added a basic distributed transaction abstraction. XA
              transactions can are supported ever since using standard
              SQL calls. This is inconvenient as XA participants must be
              managed manually. PECL/mysqlnd_ms introduces API calls to
              control XA transaction among MySQL servers. When using the
              new functions, PECL/mysqlnd_ms acts as a transaction
              coordinator. After starting a distributed transaction, the
              plugin tracks all servers involved until the transaction
              is ended and issues appropriate SQL statements on the XA
              participants.
            </p><p>
              This is useful, for example, when using Fabric and
              sharding. When using Fabric the actual shard servers
              involved in a business transaction may not be known in
              advance. Thus, manually controlling a transaction that
              spawns multiple shards becomes difficult. Please, be
              warned about
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.concept_xa_trx" title="7.5.14 XA/Distributed transactions">current
              limitations</a>.
            </p></li><li class="listitem"><p>
              Introduced automatic retry loop for
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transient_errors" title="7.5.5 Transient errors">transient
              errors</a> and
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats">corresponding
              statistic</a> to count the number of implicit retries.
              Some distributed database clusters use transient errors to
              hint a client to retry its operation in a bit. Most often,
              the client is then supposed to halt execution (sleep) for
              a short moment before retrying the desired operation.
              Immediately failing over to another node is not necessary
              in response to the error. Instead, a retry loop can be
              performed. Common situation when using MySQL Cluster.
            </p></li><li class="listitem"><p>
              Introduced automatic retry loop for
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.transient_errors" title="7.5.5 Transient errors">transient
              errors</a> and
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats">corresponding
              statistic</a> to count the number of implicit retries.
              Some distributed database clusters use transient errors to
              hint a client to retry its operation in a bit. Most often,
              the client is then supposed to halt execution (sleep) for
              a short moment before retrying the desired operation.
              Immediately failing over to another node is not necessary
              in response to the error. Instead, a retry loop can be
              performed. Common situation when using MySQL Cluster.
            </p></li><li class="listitem"><p>
              Introduced
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.quickstart.mysql_fabric" title="7.4.12 MySQL Fabric">most
              basic support</a> for the MySQL Fabric High
              Availability and sharding framework.
            </p><p>
              Please, consider this pre-alpha quality. Both the server
              side framework and the client side code is supposed to
              work flawless considering the MySQL Fabric quickstart
              examples only. However, testing has not been performed to
              the level of prior plugin alpha releases. Either sides are
              moving targets, API changes may happen at any time without
              prior warning.
            </p><p>
              As this is work in progress, the manual may not yet
              reflect allow feature limitations and known bugs.
            </p></li><li class="listitem"><p>
              New
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats">statistics</a>
              to monitor the Fabric XML RPC call
              <code class="literal">sharding.lookup_servers</code>:
              <code class="literal">fabric_sharding_lookup_servers_success</code>,
              <code class="literal">fabric_sharding_lookup_servers_failure</code>,
              <code class="literal">fabric_sharding_lookup_servers_time_total</code>,
              <code class="literal">fabric_sharding_lookup_servers_bytes_total</code>,
              <code class="literal">fabric_sharding_lookup_servers_xml_failure</code>.
            </p></li><li class="listitem"><p>
              New functions related to MySQL Fabric:
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-shard" title="7.8.3 mysqlnd_ms_fabric_select_shard"><code class="function">mysqlnd_ms_fabric_select_shard</code></a>,
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-fabric-select-global" title="7.8.2 mysqlnd_ms_fabric_select_global"><code class="function">mysqlnd_ms_fabric_select_global</code></a>,
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-dump-servers" title="7.8.1 mysqlnd_ms_dump_servers"><code class="function">mysqlnd_ms_dump_servers</code></a>.
</p></li></ul>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.changes-one-five"></a>7.9.2 PECL/mysqlnd_ms 1.5 series</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        1.5.1-stable

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 06/2013
     </li><li class="listitem">
      Motto/theme: Sharding support, improved transaction support
</li></ul>
</div>
<p>
</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title">
Note
</div>
<p>
          This is the current stable series. Use this version in
          production environments.
        </p><p>
          The documentation is complete.
</p>
</div>
<p>
        1.5.0-alpha

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 03/2013
     </li><li class="listitem">
      Motto/theme: Sharding support, improved transaction support
</li></ul>
</div>
<p>
      </p><p>
        Bug fixes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Fixed #60605 PHP segmentation fault when mysqlnd_ms is
              enabled.
            </p></li><li class="listitem"><p>
              Setting transaction stickiness disables all load
              balancing, including automatic failover, for the duration
              of a transaction. So far connection switches could have
              happened in the middle of a transaction in multi-master
              configurations and during automatic failover although
              transaction monitoring had detected transaction boundaries
              properly.
            </p></li><li class="listitem"><p>
              BC break and bug fix. SQL hints enforcing the use of a
              specific kind of server
              (<code class="constant">MYSQLND_MS_MASTER_SWITCH</code>,
              <code class="constant">MYSQLND_MS_SLAVE_SWITCH</code>,
              <code class="constant">MYSQLND_MS_LAST_USED_SWITCH</code>) are
              ignored for the duration of a transaction of transaction
              stickiness is enabled and transaction boundaries have been
              detected properly.
            </p><p>
              This is a change in behaviour. However, it is also a bug
              fix and a step to align behaviour. If, in previous
              versions, transaction stickiness, one of the above listed
              SQL hints and the quality of service filtering was
              combined it could happened that the SQL hints got ignored.
              In some case the SQL hints did work, in other cases they
              did not. The new behaviour is more consistent. SQL hints
              will always be ignore for the duration of a transaction,
              if
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">transaction
              stickiness</a> is enabled.
            </p><p>
              Please note, transaction boundary detection continues to
              be based on API call monitoring. SQL commands controlling
              transactions are not monitored.
            </p></li><li class="listitem"><p>
              BC break and bug fix. Calls to
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
              will fail when done in the middle of a transaction if
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">transaction
              stickiness</a> is enabled. Connection switches are not
              allowed for the duration of a transaction. Changing the
              quality of service likely results on a different set of
              servers qualifying for query execution, possibly making it
              necessary to switch connections. Thus, the call is not
              allowed in during an active transaction. The quality of
              server can, however, be changed in between transactions.
</p></li></ul>
</div>
<p>
      </p><p>
        Feature changes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Introduced the <code class="literal">node_group</code> filter. The
              filter lets you organize servers (master and slaves) into
              groups. Queries can be directed to a certain group of
              servers by prefixing the query statement with a SQL
              hint/comment that contains the groups configured name.
              Grouping can be used for partitioning and sharding, and
              also to optimize for local caching. In the case of
              sharding, a group name can be thought of like a shard key.
              All queries for a given shard key will be executed on the
              configured shard. Note: both the client and server must
              support sharding for sharding to function with mysqlnd_ms.
            </p></li><li class="listitem"><p>
              Extended configuration file validation during PHP startup
              (RINIT). An <code class="constant">E_WARNING</code> level error
              will be thrown if the configuration file can not be read
              (permissions), is empty, or the file (JSON) could not be
              parsed. Warnings may appear in log files, which depending
              on how PHP is configured.
            </p><p>
              Distributions that aim to provide a pre-configured setup,
              including a configuration file stub, are asked to put
              <code class="literal">{}</code> into the configuration file to
              prevent this warning about an invalid configuration file.
            </p><p>
              Further configuration file validation is done when parsing
              sections upon opening a connection. Please, note that
              there may still be situations when an invalid plugin
              configuration file does not lead to proper error messages
              but a failure to connect.
            </p></li><li class="listitem"><p>
              As of PHP 5.5.0, improved support for transaction
              boundaries detection was added for
              <code class="literal">mysqli</code>. The <code class="literal">mysqli</code>
              extension has been modified to use the new C API calls of
              the <code class="literal">mysqlnd</code> library to begin, commit,
              and rollback a transaction or savepoint. If
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">trx_stickiness</a>
              is used to enable transaction aware load balancing, the
              <a class="ulink" href="http://www.php.net/mysqli_begin" target="_top"><code class="function">mysqli_begin</code></a>,
              <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.commit" title="3.9.9 mysqli::commit, mysqli_commit"><code class="function">mysqli_commit</code></a>
              and
              <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.rollback" title="3.9.47 mysqli::rollback, mysqli_rollback"><code class="function">mysqli_rollback</code></a>
              functions will now be monitered by the plugin, to go along
              with the
              <a class="link" href="apis-php-mysqli.html#apis-php-mysqli.autocommit" title="3.9.2 mysqli::autocommit, mysqli_autocommit"><code class="function">mysqli_autocommit</code></a>
              function that was already supported. All SQL features to
              control transactions are also available through the
              improved <code class="literal">mysqli</code> transaction control
              related functions. This means that it is not required to
              issue SQL statements instead of using API calls.
              Applications using the appropriate API calls can be load
              balanced by PECL/mysqlnd_ms in a completely
              transaction-aware way.
            </p><p>
              Please note, <code class="literal">PDO_MySQL</code> has not been
              updated yet to utilize the new mysqlnd API calls. Thus,
              transaction boundary detection with
              <code class="literal">PDO_MySQL</code> continues to be limited to
              the monitoring by passing in
              <code class="constant">PDO::ATTR_AUTOCOMMIT</code> to
              <a class="ulink" href="http://www.php.net/PDO::setAttribute" target="_top"><code class="function">PDO::setAttribute</code></a>.
            </p></li><li class="listitem"><p>
              Introduced <code class="literal">trx_stickiness=on</code>. This
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">trx_stickiness</a>
              option differs from
              <code class="literal">trx_stickiness=master</code> as it tries to
              execute a read-only transaction on a slave, if quality of
              service (consistency level) allows the use of a slave.
              Read-only transactions were introduced in MySQL 5.6, and
              they offer performance gains.
            </p></li><li class="listitem"><p>
              Query cache support is considered beta if used with the
              <code class="literal">mysqli</code> API. It should work fine with
              primary copy based clusters. For all other APIs, this
              feature continues to be called experimental.
            </p></li><li class="listitem"><p>
              The code examples in the mysqlnd_ms source were updated.
</p></li></ul>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.changes-one-four"></a>7.9.3 PECL/mysqlnd_ms 1.4 series</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        1.4.2-stable

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 08/2012
     </li><li class="listitem">
      Motto/theme: Tweaking based on user feedback
</li></ul>
</div>
<p>
      </p><p>
        1.4.1-beta

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 08/2012
     </li><li class="listitem">
      Motto/theme: Tweaking based on user feedback
</li></ul>
</div>
<p>
      </p><p>
        Bug fixes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Fixed build with PHP 5.5
</p></li></ul>
</div>
<p>
      </p><p>
        1.4.0-alpha

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 07/2012
     </li><li class="listitem">
      Motto/theme: Tweaking based on user feedback
</li></ul>
</div>
<p>
      </p><p>
        Feature changes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              BC break: Renamed plugin configuration setting
              <code class="literal">ini_file</code> to
              <code class="literal">config_file</code>. In early versions the
              plugin configuration file used ini style. Back then the
              configuration setting was named accordingly. It has now
              been renamed to reflect the newer file format and to
              distinguish it from PHP's own ini file (configuration
              directives file).
            </p></li><li class="listitem"><p>
              Introduced new default charset setting
              <code class="literal">server_charset</code> to allow proper escaping
              before a connection is opened. This is most useful when
              using lazy connections, which are a default.
            </p></li><li class="listitem"><p>
              Introduced <code class="literal">wait_for_gtid_timeout</code>
              setting to throttle slave reads that need session
              consistency. If global transaction identifier are used and
              the service level is set to session consistency, the
              plugin tries to find up-to-date slaves. The slave status
              check is done by a SQL statement. If nothing else is set,
              the slave status is checked only one can the search for
              more up-to-date slaves continues immediately thereafter.
              Setting <code class="literal">wait_for_gtid_timeout</code> instructs
              the plugin to poll a slaves status for
              <code class="literal">wait_for_gtid_timeout</code> seconds if the
              first execution of the SQL statement has shown that the
              slave is not up-to-date yet. The poll will be done once
              per second. This way, the plugin will wait for slaves to
              catch up and throttle the client.
            </p></li><li class="listitem"><p>
              New failover strategy
              <code class="literal">loop_before_master</code>. By default the
              plugin does no failover. It is possible to enable
              automatic failover if a connection attempt fails. Upto
              version 1.3 only <code class="literal">master</code> strategy
              existed to failover to a master if a slave connection
              fails. <code class="literal">loop_before_master</code> is similar
              but tries all other slaves before attempting to connect to
              the master if a slave connection fails.
            </p><p>
              The number of attempts can be limited using the
              <code class="literal">max_retries</code> option. Failed hosts can be
              remembered and skipped in load balancing for the rest of
              the web request. <code class="literal">max_retries</code> and
              <code class="literal">remember_failed</code> are considered
              experimental although decent stability is given. Syntax
              and semantics may change in the future without prior
              notice.
</p></li></ul>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.changes-one-three"></a>7.9.4 PECL/mysqlnd_ms 1.3 series</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        1.3.2-stable

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 04/2012
     </li><li class="listitem">
      Motto/theme: see 1.3.0-alpha
</li></ul>
</div>
<p>
      </p><p>
        Bug fixes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Fixed problem with multi-master where although in a
              transaction the queries to the master weren't sticky
              and were spread all over the masters (RR). Still not
              sticky for Random. Random_once is not affected.
</p></li></ul>
</div>
<p>
      </p><p>
        1.3.1-beta

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 04/2012
     </li><li class="listitem">
      Motto/theme: see 1.3.0-alpha
</li></ul>
</div>
<p>
      </p><p>
        Bug fixes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Fixed problem with building together with QC.
</p></li></ul>
</div>
<p>
      </p><p>
        1.3.0-alpha

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 04/2012
     </li><li class="listitem">
      Motto/theme: Query caching through quality-of-service concept
</li></ul>
</div>
<p>
      </p><p>
        The 1.3 series aims to improve the performance of applications
        and the overall load of an asynchronous MySQL cluster, for
        example, a MySQL cluster using MySQL Replication. This is done
        by transparently replacing a slave access with a local cache
        access, if the application allows it by setting an appropriate
        quality of service flag. When using MySQL replication a slave
        can serve stale data. An application using MySQL replication
        must continue to work correctly with stale data. Given that the
        application is know to work correctly with stale data, the slave
        access can transparently be replace with a local cache access.
      </p><p>
        <a class="link" href="apis-php-mysqlnd-qc.html" title="Chapter 8 Mysqlnd query result cache plugin">PECL/mysqlnd_qc</a>
        serves as a cache backend. PECL/mysqlnd_qc supports use of
        various storage locations, among others main memory,
        <code class="literal">APC</code> and <code class="literal">MEMCACHE</code>.
      </p><p>
        Feature changes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Added cache option to quality-of-service (QoS) filter.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
          New configure option <code class="literal">enable-mysqlnd-ms-cache-support</code>

                  </li><li class="listitem">
          New constant <code class="literal">MYSQLND_MS_HAVE_CACHE_SUPPORT</code>.
         </li><li class="listitem">
          New constant <code class="literal">MYSQLND_MS_QOS_OPTION_CACHE</code> to be used
          with <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>.
</li></ul>
</div>
<p>
            </p></li><li class="listitem"><p>
              Support for built-in global transaction identifier feature
              of MySQL 5.6.5-m8 or newer.
</p></li></ul>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.changes-one-two"></a>7.9.5 PECL/mysqlnd_ms 1.2 series</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        1.2.1-beta

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 01/2012
     </li><li class="listitem">
      Motto/theme: see 1.2.0-alpha
</li></ul>
</div>
<p>
      </p><p>
        Minor test changes.
      </p><p>
        1.2.0-alpha

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 11/2011
     </li><li class="listitem">
      Motto/theme: Global Transaction ID injection and quality-of-service concept
</li></ul>
</div>
<p>
      </p><p>
        In version 1.2 the focus continues to be on supporting MySQL
        database clusters with asynchronous replication. The plugin
        tries to make using the cluster introducing a quality-of-service
        filter which applications can use to define what service quality
        they need from the cluster. Service levels provided are eventual
        consistency with optional maximum age/slave slag, session
        consistency and strong consistency.
      </p><p>
        Additionally the plugin can do client-side global transaction id
        injection to make manual master failover easier.
      </p><p>
        Feature changes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Introduced quality-of-service (QoS) filter. Service levels
              provided by QoS filter:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
          eventual consistency, optional option slave lag
         </li><li class="listitem">
          session consistency, optional option GTID
         </li><li class="listitem">
          strong consistency
</li></ul>
</div>
<p>
            </p></li><li class="listitem"><p>
              Added the
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
              function to set the required connection quality at
              runtime. The new constants related to
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-qos" title="7.8.9 mysqlnd_ms_set_qos"><code class="function">mysqlnd_ms_set_qos</code></a>
              are:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="constant">MYSQLND_MS_QOS_CONSISTENCY_STRONG</code>

                  </li><li class="listitem"><code class="constant">MYSQLND_MS_QOS_CONSISTENCY_SESSION</code>

                  </li><li class="listitem"><code class="constant">MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL</code>

                  </li><li class="listitem"><code class="constant">MYSQLND_MS_QOS_OPTION_GTID</code>

                  </li><li class="listitem"><code class="constant">MYSQLND_MS_QOS_OPTION_AGE</code>

</li></ul>
</div>
<p>
            </p></li><li class="listitem"><p>
              Added client-side global transaction id injection (GTID).
            </p></li><li class="listitem"><p>
              New statistics related to GTID:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">gtid_autocommit_injections_success</code>

                  </li><li class="listitem"><code class="literal">gtid_autocommit_injections_failure</code>

                  </li><li class="listitem"><code class="literal">gtid_commit_injections_success</code>

                  </li><li class="listitem"><code class="literal">gtid_commit_injections_failure</code>

                  </li><li class="listitem"><code class="literal">gtid_implicit_commit_injections_success</code>

                  </li><li class="listitem"><code class="literal">gtid_implicit_commit_injections_failure</code>

</li></ul>
</div>
<p>
            </p></li><li class="listitem"><p>
              Added
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-last-gtid" title="7.8.4 mysqlnd_ms_get_last_gtid"><code class="function">mysqlnd_ms_get_last_gtid</code></a>
              to fetch the last global transaction id.
            </p></li><li class="listitem"><p>
              Enabled support for multi master without slaves.
</p></li></ul>
</div>
<p>
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.changes-one-one"></a>7.9.6 PECL/mysqlnd_ms 1.1 series</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        1.1.0

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 09/2011
     </li><li class="listitem">
      Motto/theme: Cover replication basics with production quality
</li></ul>
</div>
<p>
      </p><p>
        The 1.1 and 1.0 series expose a similar feature set. Internally,
        the 1.1 series has been refactored to plan for future feature
        additions. A new configuration file format has been introduced,
        and limitations have been lifted. And the code quality and
        quality assurance has been improved.
      </p><p>
        Feature changes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              Added the (chainable)
              <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.filter" title="7.5.9 Filter">filter
              concept</a>:

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
          BC break:
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>
          has been removed. Thehttp://svn.php.net/viewvc/pecl/mysqlnd_ms/trunk/
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.filter" title="7.5.9 Filter"><code class="literal">user</code></a>
          filter has been introduced to replace it.
          The filter offers similar functionality, but see below for an
          explanation of the differences.
</li></ul>
</div>
<p>
            </p></li><li class="listitem">
      New powerful <acronym class="acronym">JSON</acronym> based configuration syntax.
     </li><li class="listitem"><a class="link" href="apis-php-mysqlnd-ms.html#apis-php-mysqlnd-ms.pooling" title="7.5.2 Connection pooling and switching">Lazy connections improved</a>:
      security relevant, and state changing commands are covered.
     </li><li class="listitem">
      Support for (native) prepared statements.
     </li><li class="listitem"><p>
              New statistics: <code class="literal">use_master_guess</code>,
              <code class="literal">use_slave_guess</code>.

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
          BC break: Semantics of statistics changed for
          <code class="literal">use_slave</code>, <code class="literal">use_master</code>.
          Future changes are likely. Please see,
          <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-get-stats" title="7.8.6 mysqlnd_ms_get_stats"><code class="function">mysqlnd_ms_get_stats</code></a>.
</li></ul>
</div>
<p>
            </p></li><li class="listitem">
      List of broadcasted messages extended by <code class="literal">ssl_set</code>.
     </li><li class="listitem">
      Library calls now monitored to remember settings for lazy connections:
      <code class="literal">change_user</code>, <code class="literal">select_db</code>,
      <code class="literal">set_charset</code>, <code class="literal">set_autocommit</code>.
     </li><li class="listitem">
      Introduced <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-ini.mysqlnd-ms.disable-rw-split"><code class="literal">mysqlnd_ms.disable_rw_split</code></a>.
      The configuration setting allows using the load balancing and lazy connection
      functionality independently of read write splitting.
</li></ul>
</div>
<p>
      </p><p>
        Bug fixes

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Fixed PECL #22724 - Server switching (mysqlnd_ms_query_is_select() case sensitive)
     </li><li class="listitem">
      Fixed PECL #22784 - Using mysql_connect and mysql_select_db did not work
     </li><li class="listitem">
      Fixed PECL #59982 - Unusable extension with --enable-mysqlnd-ms-table-filter.
      Use of the option is NOT supported. You must not used it. Added note to m4.
     </li><li class="listitem">
      Fixed Bug #60119 - host="localhost" lost in mysqlnd_ms_get_last_used_connection()
</li></ul>
</div>
<p>
      </p><p>
        The
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>
        function was removed, and replaced in favor of a new
        <code class="literal">user</code> filter. You can no longer set a callback
        function using
        <a class="link" href="apis-php-mysqlnd-ms.html#apis-php-function.mysqlnd-ms-set-user-pick-server" title="7.8.10 mysqlnd_ms_set_user_pick_server"><code class="function">mysqlnd_ms_set_user_pick_server</code></a>
        at runtime, but instead have to configure it in the plugins
        configuration file. The <code class="literal">user</code> filter will pass
        the same arguments to the callback as before. Therefore, you can
        continue to use the same procedural function as a
        callback.callback It is no longer possible to use static class
        methods, or class methods of an object instance, as a callback.
        Doing so will cause the function executing a statement handled
        by the plugin to emit an
        <code class="constant">E_RECOVERABLE_ERROR</code> level error, which
        might look like: "<code class="literal">(mysqlnd_ms) Specified callback
        (picker) is not a valid callback</code>." Note: this may
        halt your application.
</p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="apis-php-mysqlnd-ms.changes-one-o"></a>7.9.7 PECL/mysqlnd_ms 1.0 series</h3>

</div>

</div>

</div>
<p>
        <a class="link" href="apis-php-introduction.html#php-api-copyright">Copyright 1997-2014 the PHP
        Documentation Group.</a>
      </p><p>
        1.0.1-alpha

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 04/2011
     </li><li class="listitem">
      Motto/theme: bug fix release
</li></ul>
</div>
<p>
      </p><p>
        1.0.0-alpha

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 04/2011
     </li><li class="listitem">
      Motto/theme: Cover replication basics to test user feedback
</li></ul>
</div>
<p>
      </p><p>
        The first release of practical use. It features basic automatic
        read-write splitting, SQL hints to overrule automatic
        redirection, load balancing of slave requests, lazy connections,
        and optional, automatic use of the master after the first write.
      </p><p>
        The public feature set is close to that of the 1.1 release.
      </p><p>
        1.0.0-pre-alpha

</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      Release date: 09/2010
     </li><li class="listitem">
      Motto/theme: Proof of concept
</li></ul>
</div>
<p>
      </p><p>
        Initial check-in. Essentially a demo of the
        <a class="link" href="apis-php-mysqlnd.html" title="Chapter 6 MySQL Native Driver">mysqlnd</a> plugin API.
</p>
</div>

</div>

</div>
<div class="copyright-footer">

</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left"><a accesskey="p" href="apis-php-mysqlnd.html">Prev</a></td>
<td width="20%" align="center"><a accesskey="u" href="">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="apis-php-mysqlnd-qc.html">Next</a></td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 6 MySQL Native Driver</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top">Chapter 8 Mysqlnd query result cache plugin</td>
</tr>
</table>
</div>
</body>
</html>
