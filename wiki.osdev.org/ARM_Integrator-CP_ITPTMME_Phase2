<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>ARM Integrator-CP ITPTMME Phase2 - OSDev Wiki</title>
<script>document.documentElement.className="client-js";RLCONF={"wgBreakFrames":false,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"2face245d905847b98735aa6","wgCSPNonce":false,"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"ARM_Integrator-CP_ITPTMME_Phase2","wgTitle":"ARM Integrator-CP ITPTMME Phase2","wgCurRevisionId":28043,"wgRevisionId":28043,"wgArticleId":3503,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Pages using deprecated source tags","Articles Written in First Person","ARM"],"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgRelevantPageName":"ARM_Integrator-CP_ITPTMME_Phase2","wgRelevantArticleId":3503,"wgIsProbablyEditable":false,
"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgMFDisplayWikibaseDescriptions":{"search":false,"nearby":false,"watchlist":false,"tagline":false},"wgVisualEditor":{"pageLanguageCode":"en","pageLanguageDir":"ltr","pageVariantFallbacks":"en"},"wgVector2022PreviewPages":[],"wgMediaViewerOnClick":true,"wgMediaViewerEnabledByDefault":true,"wgEditSubmitButtonLabelPublish":false};RLSTATE={"site.styles":"ready","user.styles":"ready","user":"ready","user.options":"loading","ext.pygments":"ready","skins.vector.styles.legacy":"ready","ext.visualEditor.desktopArticleTarget.noscript":"ready","ext.DarkMode.styles":"ready"};RLPAGEMODULES=["site","mediawiki.page.ready","mediawiki.toc","skins.vector.legacy.js","ext.visualEditor.desktopArticleTarget.init","ext.visualEditor.targetLoader","ext.DarkMode","ext.moderation.notify","ext.moderation.ve","ext.moderation.ajaxhook","ext.moderation.notify.desktop"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.implement("user.options@12s5i",function($,jQuery,require,module){mw.user.tokens.set({"patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});});});</script>
<link rel="stylesheet" href="https://wiki.osdev.org/load.php?lang=en&amp;modules=ext.DarkMode.styles%7Cext.pygments%7Cext.visualEditor.desktopArticleTarget.noscript%7Cskins.vector.styles.legacy&amp;only=styles&amp;skin=vector"/>
<script async="" src="https://wiki.osdev.org/load.php?lang=en&amp;modules=startup&amp;only=scripts&amp;raw=1&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="https://wiki.osdev.org/load.php?lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.39.7"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="viewport" content="width=1000"/>
<link rel="icon" href="favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="OSDev Wiki (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="api.php?action=rsd"/>
<link rel="alternate" type="application/atom+xml" title="OSDev Wiki Atom feed" href="https://wiki.osdev.org/index.php?title=Special:RecentChanges&amp;feed=atom"/>
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-ARM_Integrator-CP_ITPTMME_Phase2 rootpage-ARM_Integrator-CP_ITPTMME_Phase2 skin-vector action-view skin-vector-legacy vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled"><div id="mw-page-base" class="noprint"></div>
<div id="mw-head-base" class="noprint"></div>
<div id="content" class="mw-body" role="main">
	<a id="top"></a>
	<div id="siteNotice"></div>
	<div class="mw-indicators">
	</div>
	<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">ARM Integrator-CP ITPTMME Phase2</span></h1>
	<div id="bodyContent" class="vector-body">
		<div id="siteSub" class="noprint">From OSDev Wiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="ARM_Integrator-CP_ITPTMME_Phase2#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="ARM_Integrator-CP_ITPTMME_Phase2#searchInput">Jump to search</a>
		<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr"><div class="mw-parser-output"><center>
<table style="border: 1px solid #cfcfbf; margin-top: 25px; margin-bottom: 25px; background-color: #f0f0ff; text-align: center;">
<tbody><tr>
<td>
<p>This page or section refers to its readers or editors using <i>I</i>, <i>my</i>, <i>we</i> or <i>us</i>. It should be <a rel="nofollow" class="external text" href="https://wiki.osdev.org/index.php?title=ARM_Integrator-CP_ITPTMME_Phase2&amp;action=edit">edited</a> to be in an encyclopedic tone.
</p>
</td></tr></tbody></table>
</center>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Processes_&amp;_Threads,_Exception_Handling,_And_System_Calls"><span class="tocnumber">1</span> <span class="toctext">Processes &amp; Threads, Exception Handling, And System Calls</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="ARM_Integrator-CP_ITPTMME_Phase2#New_Define_For_Timer_Support"><span class="tocnumber">1.1</span> <span class="toctext">New Define For Timer Support</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Basic_Linked_List_Utility_Functions"><span class="tocnumber">1.2</span> <span class="toctext">Basic Linked List Utility Functions</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Separate_Scheduler_Function"><span class="tocnumber">1.3</span> <span class="toctext">Separate Scheduler Function</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Added_Idle_Thread_And_Kernel_Thread"><span class="tocnumber">1.4</span> <span class="toctext">Added Idle Thread And Kernel Thread</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Creation_Of_Kernel_And_Idle_Thread"><span class="tocnumber">1.5</span> <span class="toctext">Creation Of Kernel And Idle Thread</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="ARM_Integrator-CP_ITPTMME_Phase2#New_Exception_Handlers"><span class="tocnumber">1.6</span> <span class="toctext">New Exception Handlers</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Added_memset"><span class="tocnumber">1.7</span> <span class="toctext">Added memset</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Changes_In_kelfload"><span class="tocnumber">1.8</span> <span class="toctext">Changes In kelfload</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Changed_To_Creation_Of_Process_From_Modules"><span class="tocnumber">1.9</span> <span class="toctext">Changed To Creation Of Process From Modules</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="ARM_Integrator-CP_ITPTMME_Phase2#SWI_Exception_Entry_And_Exit_Changed"><span class="tocnumber">1.10</span> <span class="toctext">SWI Exception Entry And Exit Changed</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Added_System_Call_Numbers"><span class="tocnumber">1.11</span> <span class="toctext">Added System Call Numbers</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="ARM_Integrator-CP_ITPTMME_Phase2#New_KPROCESS_And_Updated_KTHREAD"><span class="tocnumber">1.12</span> <span class="toctext">New KPROCESS And Updated KTHREAD</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Changes_To_KSTATE"><span class="tocnumber">1.13</span> <span class="toctext">Changes To KSTATE</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Second_Module_Added"><span class="tocnumber">1.14</span> <span class="toctext">Second Module Added</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="ARM_Integrator-CP_ITPTMME_Phase2#First_Module"><span class="tocnumber">1.15</span> <span class="toctext">First Module</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="ARM_Integrator-CP_ITPTMME_Phase2#Change_In_Timer_Initialization"><span class="tocnumber">1.16</span> <span class="toctext">Change In Timer Initialization</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span id="Processes_.26_Threads.2C_Exception_Handling.2C_And_System_Calls"></span><span class="mw-headline" id="Processes_&amp;_Threads,_Exception_Handling,_And_System_Calls">Processes &amp; Threads, Exception Handling, And System Calls</span></h2>
<p>In this phase we are going to improve our exception handling, rework out tasking system to support processes and threads (instead of tasks), and implement some basic system calls for demonstration.
</p><p>I make a few minor changes and one or two major changes. You can find the full source with:
</p>
<pre>    git clone http://kmcg3413.net/armthin.git
    git checkout origin/bPHASE1
</pre>
<p>This should give you the source with all the changes below. If you have been following along from the previous pages then you will only have to cover these simple changes. If you are new then I recommend you start from <a href="ARM_Integrator-CP_IRQTimerAndPIC" title="ARM Integrator-CP IRQTimerAndPIC">IRQ, Timer, And PIC</a>.
</p>
<h3><span class="mw-headline" id="New_Define_For_Timer_Support">New Define For Timer Support</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="cm">/* max number of ticks for a task */</span><span class="w"></span>
<span class="cp">#define KTASKTICKS 10000</span>
</pre></div>
<p>This sets the time in which threads are interrupted for a context switch. The lower the
higher the frequency or maximum time a thread can execute.
</p>
<h3><span class="mw-headline" id="Basic_Linked_List_Utility_Functions">Basic Linked List Utility Functions</span></h3>
<p>I like these functions because they can work with <i>any</i> data structure that has the fields
at the top. It can be cast to type <i>LL</i> and used that way.
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="w"> </span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_LL</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">_LL</span><span class="w">			</span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">_LL</span><span class="w">			</span><span class="o">*</span><span class="n">prev</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">LL</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ll_add</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">LL</span><span class="w">		</span><span class="o">*</span><span class="n">_i</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LL</span><span class="o">*</span><span class="p">)</span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">LL</span><span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_i</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ll_rem</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">LL</span><span class="w">			</span><span class="o">*</span><span class="n">_i</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LL</span><span class="o">*</span><span class="p">)</span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<h3><span class="mw-headline" id="Separate_Scheduler_Function">Separate Scheduler Function</span></h3>
<p>I have added support for sleeping threads, and a wake up flag. This is by no means a correct design, but rather just a demonstration of how you could put threads to sleep and wake them up. It also supports a timeout which allows a thread to not only wake up with an external signal but also after a specified amount of time.
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">ksched</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">KSTATE</span><span class="w">			</span><span class="o">*</span><span class="n">ks</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">KTHREAD</span><span class="w">			</span><span class="o">*</span><span class="n">kt</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w">			</span><span class="n">__lr</span><span class="p">,</span><span class="w"> </span><span class="n">__sp</span><span class="p">,</span><span class="w"> </span><span class="n">__spsr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uintptr</span><span class="w">			</span><span class="n">page</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">ks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">KSTATE</span><span class="o">*</span><span class="p">)</span><span class="n">KSTATEADDR</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* if valid process and thread then store */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="cm">/*</span>
<span class="cm">			1. store register on stack in thread struct</span>
<span class="cm">			2. access hidden registers and store in thread struct</span>
<span class="cm">		*/</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-1</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-2</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-3</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-4</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-5</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-6</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-7</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-8</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-9</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-10</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-11</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-12</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-13</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-14</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">cpsr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-15</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* switch to system mode get hidden registers then switch back */</span><span class="w"></span>
<span class="w">		</span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;mrs r0, cpsr </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			 mov r1, r0 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			 bic r0, r0, #0x1f </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			 orr r0, r0, #0x1f </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			 msr cpsr, r0 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			 mov&#160;%[sp], sp </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			 mov&#160;%[lr], lr </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			 msr cpsr, r1 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			 &quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">]</span><span class="s">&quot;=r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">__sp</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">lr</span><span class="p">]</span><span class="s">&quot;=r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">__lr</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__sp</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">lr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__lr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* initial start */</span><span class="w"></span>
<span class="w">		</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">procs</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">procs</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* get next thread */</span><span class="w"></span>
<span class="w">			</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="cm">/* if none get next process */</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* get next process */</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* if none get first process */</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">procs</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* get first thread */</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="cm">/* if current thread is sleeping and current thread equals last thread */</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KTHREAD_SLEEPING</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kt</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">PANIC</span><span class="p">(</span><span class="s">&quot;all-threads-sleeping&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="cm">/* only wakeup if it is sleeping */</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KTHREAD_SLEEPING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="c1">//kprintf(&quot;WOKE UP (timeout) %x\n&quot;, ks-&gt;cthread);</span>
<span class="w">				</span><span class="cm">/* wake up thread if passed timeout */</span><span class="w"></span>
<span class="w">				</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">KTHREAD_SLEEPING</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">			</span>
<span class="w">			</span><span class="cm">/* wakeup thread is set to be woken up */</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KTHREAD_WAKEUP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="c1">//kprintf(&quot;WOKE UP (signal) %x\n&quot;, ks-&gt;cthread);</span>
<span class="w">				</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">KTHREAD_WAKEUP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">KTHREAD_SLEEPING</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* run this thread */</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* thread is sleeping or not able to run */</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="cm">/* hopefully we got something or the system should deadlock */</span><span class="w"></span>
<span class="w">	</span><span class="n">kt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/*</span>
<span class="cm">		load registers</span>
<span class="cm">	*/</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r12</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r11</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r10</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r9</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r8</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r7</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r6</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-9</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r5</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r4</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r3</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r2</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-14</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">r0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-15</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">cpsr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* switch into system mode restore hidden registers then switch back */</span><span class="w"></span>
<span class="w">	</span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;mrs r0, cpsr </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		 mov r1, r0 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		 bic r0, r0, #0x1f </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		 orr r0, r0, #0x1f </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		 msr cpsr, r0 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		 mov sp,&#160;%[sp] </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		 mov lr,&#160;%[lr] </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		 msr cpsr, r1 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		 &quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">]</span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">lr</span><span class="p">]</span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">lr</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* set TLB table for user space (it can be zero for kernel) */</span><span class="w"></span>
<span class="w">	</span><span class="n">kvmm2_getphy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="p">)</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">.</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">page</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">arm4_tlbset1</span><span class="p">(</span><span class="n">page</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* </span>
<span class="cm">		Invalidate all unlocked entries...</span>
<span class="cm">		</span>
<span class="cm">		..according to the manual there may be a better way to invalidate,</span>
<span class="cm">		only some entries per process. But, for now this should work.</span>
<span class="cm">		</span>
<span class="cm">		If you do not do this then the TLB does not flush and old entries</span>
<span class="cm">		from the previous process will still be in the TLB cache.</span>
<span class="cm">	*/</span><span class="w"></span>
<span class="w">	</span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;mcr p15, #0, r0, c8, c7, #0&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="c1">//kprintf(&quot;SWITCH-TO thread:%x cpsr:%x fp:%x sp:%x pc:%x\n&quot;, kt, kt-&gt;cpsr, kt-&gt;r11, kt-&gt;sp, kt-&gt;pc);</span>
<span class="w">	</span>
<span class="w">	</span><span class="n">uint32</span><span class="w">			</span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">kvmm2_getphy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90000000</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="c1">//kprintf(&quot;NO STACK EXISTS??\n&quot;);</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="c1">//kprintf(&quot;writing to stack..%x\n&quot;, kt-&gt;sp);</span>
<span class="w">		</span><span class="c1">//((uint32*)kt-&gt;sp)[-1] = 0xbb;</span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kvmm2_getphy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">uint32</span><span class="w">			</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="c1">//kprintf(&quot;CODE PAGE&#160;:%x\n&quot;, p);</span>
<span class="w">		</span>
<span class="w">		</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint32</span><span class="o">*</span><span class="p">)(</span><span class="mh">0x80000000</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="c1">//((uint32*)KSTACKEXC)[-1] = 0x80000800;</span>
<span class="w">	</span>
<span class="w">		</span><span class="c1">//for (x = 0; x &lt; 1024; ++x) {</span>
<span class="w">		</span><span class="c1">//	p[x] = 0xeafffffe;</span>
<span class="w">		</span><span class="c1">//}</span>
<span class="w">	</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="c1">//kprintf(&quot;CODE PAGE????\n&quot;);</span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Here we have the basic save thread state and load thread state blocks. These possibly could be implemented in a much faster way, but I choose to avoid premature optimization for the sake of being straight forward. In the middle between the save and load state blocks you have the code to choose the next thread. In it's simplest form it simply grabs the next thread in the current process, and if no thread left it grabs the next process and the first thread. It continues this until it has a thread to run. In the form above it does the exact same except it checks if the thread is sleeping, then it checks the <i>timeout</i> (minimum time to sleep for) and if it is expired it sets the thread as awake and runs it. It also checks if any signal has been asserted to the thread and if so (and only if) then the thread is woken if it is sleeping. You might be wondering why I remove the wake signal (bit) only if the thread is sleeping. This has to do with my future design of the IPC for the system.
</p><p><br />
</p>
<h3><span class="mw-headline" id="Added_Idle_Thread_And_Kernel_Thread">Added Idle Thread And Kernel Thread</span></h3>
<p>I added an <i>idle</i> thread that does nothing but yield, and a kernel work thread. The idle thread keeps the scheduler with something to switch too when no other threads are running (supposed to be), but in reality in the current code it just switches to it and it yields. Needs some improvement, but it is simple for now.
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">ksleep</span><span class="p">(</span><span class="n">uint32</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w">			</span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;	mov r0,&#160;%[in] </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			swi #101 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			mov&#160;%[result], r0 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="p">]</span><span class="s">&quot;=r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* convert from ticks */</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">kthread</span><span class="p">(</span><span class="n">KTHREAD</span><span class="w"> </span><span class="o">*</span><span class="n">th</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w">			</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ksleep</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">kserdbg_putc</span><span class="p">(</span><span class="sc">&#39;$&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">kidle</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;swi #102&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">The</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="n">kidle</span><span class="err">&#39;&#39;</span><span class="w"> </span><span class="n">immediantly</span><span class="w"> </span><span class="n">yields</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">coded</span><span class="w"> </span><span class="n">differently</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">executes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="n">kidle</span><span class="err">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">decided</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">simple</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="w"></span>
</pre></div>
<h3><span class="mw-headline" id="Creation_Of_Kernel_And_Idle_Thread">Creation Of Kernel And Idle Thread</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="w">        </span><span class="p">....</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">....</span><span class="w"></span>
<span class="w">	</span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">KPROCESS</span><span class="o">*</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">KPROCESS</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="n">memset</span><span class="p">(</span><span class="n">process</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">KPROCESS</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="n">kvmm2_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">ll_add</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">procs</span><span class="p">,</span><span class="w"> </span><span class="n">process</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">KTHREAD</span><span class="o">*</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">KTHREAD</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="n">memset</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">KTHREAD</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="n">ll_add</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">th</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="p">)</span><span class="o">&amp;</span><span class="n">kthread</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">cpsr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x60000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ARM4_MODE_SYS</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* set stack */</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint32</span><span class="p">)</span><span class="n">th</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">KTHREAD</span><span class="o">*</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">KTHREAD</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="n">memset</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">KTHREAD</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="n">ll_add</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">th</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="p">)</span><span class="o">&amp;</span><span class="n">kidle</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KTHREAD_KIDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">cpsr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x60000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ARM4_MODE_SYS</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* set stack (dont need anything big for idle thread at the moment) */</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint32</span><span class="p">)</span><span class="n">th</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">idleth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">th</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">idleproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">....</span><span class="w"></span>
</pre></div>
<p>Here both the kernel thread and <i>idle</i> thread are created under the same process. You could have created a separate process if you like.
</p>
<h3><span class="mw-headline" id="New_Exception_Handlers">New Exception Handlers</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">k_exphandler</span><span class="p">(</span><span class="n">uint32</span><span class="w"> </span><span class="n">lr</span><span class="p">,</span><span class="w"> </span><span class="n">uint32</span><span class="w"> </span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w">			</span><span class="o">*</span><span class="n">t0mmio</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w">			</span><span class="o">*</span><span class="n">picmmio</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w">			</span><span class="n">swi</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">KSTATE</span><span class="w">			</span><span class="o">*</span><span class="n">ks</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w">				</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">KTHREAD</span><span class="w">			</span><span class="o">*</span><span class="n">kt</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uintptr</span><span class="w">			</span><span class="n">out</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w">			</span><span class="n">r0</span><span class="p">,</span><span class="w"> </span><span class="n">r1</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">KPROCESS</span><span class="w">		</span><span class="o">*</span><span class="n">proc</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">KTHREAD</span><span class="w">			</span><span class="o">*</span><span class="n">th</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">ks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">KSTATE</span><span class="o">*</span><span class="p">)</span><span class="n">KSTATEADDR</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span>
<span class="w">	</span><span class="c1">//kserdbg_putc(&#39;H&#39;);</span>
<span class="w">	</span><span class="c1">//kserdbg_putc(&#39;\n&#39;);</span>
<span class="w">	</span>
<span class="w">	</span><span class="cm">/*  clear interrupt in timer so it will lower its INT line</span>
<span class="cm">	</span>
<span class="cm">		if you do not clear it, an interrupt will</span>
<span class="cm">		be immediantly raised apon return from this</span>
<span class="cm">		interrupt</span>
<span class="cm">	*/</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ARM4_XRQ_IRQ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">picmmio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="mh">0x14000000</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="c1">//kprintf(&quot;picmmio[PIC_IRQ_STATUS]:%x\n&quot;, picmmio[PIC_IRQ_STATUS]);</span>
<span class="w">		</span><span class="cm">/*</span>
<span class="cm">			It is possible that other pins are activated so we just check</span>
<span class="cm">			this one bit.</span>
<span class="cm">			</span>
<span class="cm">			1 &lt;&lt; 4</span>
<span class="cm">		*/</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">picmmio</span><span class="p">[</span><span class="n">PIC_IRQ_STATUS</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">t0mmio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="mh">0x13000100</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">t0mmio</span><span class="p">[</span><span class="n">REG_INTCLR</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">			</span><span class="cm">/* according to the docs u can write any value */</span><span class="w"></span>
<span class="w">			</span>
<span class="w">			</span><span class="c1">//kprintf(&quot;t0mmio[REG_BGLOAD]:%x ks-&gt;ctime:%x\n&quot;, t0mmio[REG_BGLOAD], ks-&gt;ctime);</span>
<span class="w">			</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">t0mmio</span><span class="p">[</span><span class="n">REG_BGLOAD</span><span class="p">];</span><span class="w"></span>
<span class="w">			</span>
<span class="w">			</span><span class="n">ksched</span><span class="p">();</span><span class="w"></span>
<span class="w">			</span><span class="c1">//kprintf(&quot;time:%x\n&quot;, t0mmio[REG_VALUE]);</span>
<span class="w">			</span><span class="cm">/* go back through normal interrupt return process */</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="cm">/*</span>
<span class="cm">		Get SWI argument (index).</span>
<span class="cm">	*/</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ARM4_XRQ_SWINT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">swi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)((</span><span class="n">uintptr</span><span class="p">)</span><span class="n">lr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="c1">//kprintf(&quot;SWI thread:%x code:%x\n&quot;, ks-&gt;cthread, swi);</span>
<span class="w">		</span>
<span class="w">		</span><span class="c1">//((uint32*)KSTACKEXC)[-14] = R0;</span>
<span class="w">		</span><span class="c1">//((uint32*)KSTACKEXC)[-13] = R1;</span>
<span class="w">		</span>
<span class="w">		</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">swi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="nl">KSWI_WAKEUP</span><span class="p">:</span><span class="w"></span>
<span class="w">				</span><span class="cm">/* wake up thread function */</span><span class="w"></span>
<span class="w">				</span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-14</span><span class="p">];</span><span class="w"></span>
<span class="w">				</span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-13</span><span class="p">];</span><span class="w"></span>
<span class="w">				</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">procs</span><span class="p">;</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="p">)</span><span class="n">proc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">r0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">						</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">;</span><span class="w"> </span><span class="n">th</span><span class="p">;</span><span class="w"> </span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">th</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">							</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="p">)</span><span class="n">th</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">r1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">								</span><span class="cm">/* wake up thread */</span><span class="w"></span>
<span class="w">								</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">KTHREAD_WAKEUP</span><span class="p">;</span><span class="w"></span>
<span class="w">							</span><span class="p">}</span><span class="w"></span>
<span class="w">						</span><span class="p">}</span><span class="w"></span>
<span class="w">					</span><span class="p">}</span><span class="w"></span>
<span class="w">				</span><span class="p">}</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="nl">KSWI_GETTICKPERSECOND</span><span class="p">:</span><span class="w"></span>
<span class="w">				</span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-14</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">tpers</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="nl">KSWI_SLEEP</span><span class="p">:</span><span class="w"></span>
<span class="w">				</span><span class="cm">/* thread sleep function */</span><span class="w"></span>
<span class="w">				</span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="n">KSTACKEXC</span><span class="p">)[</span><span class="mi">-14</span><span class="p">];</span><span class="w"></span>
<span class="w">				</span>
<span class="w">				</span><span class="c1">//kprintf(&quot;SLEEPING thread:%x timeout:%x\n&quot;, ks-&gt;cthread, r0);</span>

<span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">					</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">KTHREAD_SLEEPING</span><span class="p">;</span><span class="w"></span>
<span class="w">					</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="p">}</span><span class="w"></span>
<span class="w">				</span><span class="n">ksched</span><span class="p">();</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="nl">KSWI_YEILD</span><span class="p">:</span><span class="w"></span>
<span class="w">				</span><span class="n">ksched</span><span class="p">();</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ARM4_XRQ_IRQ</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ARM4_XRQ_FIQ</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ARM4_XRQ_SWINT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="cm">/*</span>
<span class="cm">			Ensure, the exception return code is correctly handling LR with the</span>
<span class="cm">			correct offset. I am using the same return for everything except SWI, </span>
<span class="cm">			which requires that LR not be offset before return.</span>
<span class="cm">		*/</span><span class="w"></span>
<span class="w">		</span><span class="n">KTHREAD</span><span class="w">			</span><span class="o">*</span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;!EXCEPTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;type:%x cproc:%x cthread:%x lr:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="p">,</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">,</span><span class="w"> </span><span class="n">lr</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">ll_rem</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cproc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">cthread</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="n">ksched</span><span class="p">();</span><span class="w"></span>
<span class="w">		</span>
<span class="w">		</span><span class="n">kdumpthreadinfo</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>The biggest difference here is the addition of systems call and the termination of a thread when it has an exception. 
</p><p><br />
</p>
<h3><span class="mw-headline" id="Added_memset">Added memset</span></h3>
<p>I added a useful utility function <i>memset</i>.
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">memset</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">uint8</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">uintptr</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">uint8</span><span class="w">			</span><span class="o">*</span><span class="n">_p</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uintptr</span><span class="w">			</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint8</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sz</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">_p</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<h3><span class="mw-headline" id="Changes_In_kelfload">Changes In kelfload</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">kelfload</span><span class="p">(</span><span class="n">KPROCESS</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="n">uintptr</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">uintptr</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">ELF32_EHDR</span><span class="w">			</span><span class="o">*</span><span class="n">ehdr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">ELF32_SHDR</span><span class="w">			</span><span class="o">*</span><span class="n">shdr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w">				</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uintptr</span><span class="w">				</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">oldpage</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">KSTATE</span><span class="w">				</span><span class="o">*</span><span class="n">ks</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uint8</span><span class="w">				</span><span class="o">*</span><span class="n">fb</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">KTHREAD</span><span class="w">				</span><span class="o">*</span><span class="n">th</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;loading elf into memory space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">ks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">KSTATE</span><span class="o">*</span><span class="p">)</span><span class="n">KSTATEADDR</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span>
<span class="w">	</span><span class="n">ehdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ELF32_EHDR</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_machine</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EM_ARM</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;kelfload: not ARM machine!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_ident</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;kelfload: not ELF32 object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">.</span><span class="n">table</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">kvmm2_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">KTHREAD</span><span class="o">*</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">KTHREAD</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="n">memset</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">KTHREAD</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">ll_add</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">th</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">cpsr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x60000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ARM4_MODE_USER</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* set stack */</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x90001000</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* pass address of serial output as first argument */</span><span class="w"></span>
<span class="w">	</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xa0000000</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* map serial output mmio */</span><span class="w"></span>
<span class="w">	</span><span class="n">kvmm2_mapsingle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa0000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x16000000</span><span class="p">,</span><span class="w"> </span><span class="n">TLB_C_AP_FULLACCESS</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* map stack page (4K) */</span><span class="w"></span>
<span class="w">	</span><span class="n">kvmm2_allocregionat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90000000</span><span class="p">,</span><span class="w"> </span><span class="n">TLB_C_AP_FULLACCESS</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* map address space so we can work directly with it */</span><span class="w"></span>
<span class="w">	</span><span class="n">kvmm2_getphy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">.</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">page</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">oldpage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arm4_tlbget1</span><span class="p">();</span><span class="w"></span>
<span class="w">	</span><span class="n">arm4_tlbset1</span><span class="p">(</span><span class="n">page</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* flush the TLB */</span><span class="w"></span>
<span class="w">	</span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;mcr p15, #0, r0, c8, c7, #0&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="c1">// e_shoff - section table offset</span>
<span class="w">	</span><span class="c1">// e_shentsize - size of each section entry</span>
<span class="w">	</span><span class="c1">// e_shnum - count of entries in table</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_shnum</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">shdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ELF32_SHDR</span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_shoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_shentsize</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* load this into memory */</span><span class="w"></span>
<span class="w">			</span><span class="c1">// sh_offset - byte offset in module</span>
<span class="w">			</span><span class="c1">// sh_size - size of section in module </span>
<span class="w">			</span><span class="c1">// sh_addr - address to load at</span>
<span class="w">			</span><span class="n">kvmm2_allocregionat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">vmm</span><span class="p">,</span><span class="w"> </span><span class="n">kvmm2_rndup</span><span class="p">(</span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">),</span><span class="w"> </span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_addr</span><span class="p">,</span><span class="w"> </span><span class="n">TLB_C_AP_FULLACCESS</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint8</span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* copy */</span><span class="w"></span>
<span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="p">((</span><span class="n">uint8</span><span class="o">*</span><span class="p">)</span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_addr</span><span class="p">)[</span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fb</span><span class="p">[</span><span class="n">y</span><span class="p">];</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="cm">/* restore previous address space */</span><span class="w"></span>
<span class="w"> 	</span><span class="n">arm4_tlbset1</span><span class="p">(</span><span class="n">oldpage</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* flush the TLB */</span><span class="w"></span>
<span class="w">        </span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;mcr p15, #0, r0, c8, c7, #0&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Here we simple allocate memory for the sections and then copy them into memory. I switch address spaces and flush the TLB to make this easier to perform. It could be faster just to map the memory into kernel space and copy to it in certain situations, but I decided that this method was the simplest. 
</p>
<h3><span class="mw-headline" id="Changed_To_Creation_Of_Process_From_Modules">Changed To Creation Of Process From Modules</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="w">        </span><span class="p">....</span><span class="w"> </span>
<span class="w">	</span><span class="cp">#define KMODTYPE_ELFUSER			1</span>
<span class="w">	</span><span class="cm">/*</span>
<span class="cm">		create a task for any attached modules of the correct type</span>
<span class="cm">	*/</span><span class="w"></span>
<span class="w">	</span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;looking at attached modules</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kPkgGetFirstMod</span><span class="p">();</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kPkgGetNextMod</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;looking at module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">KMODTYPE_ELFUSER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* create new process */</span><span class="w"></span>
<span class="w">			</span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">KPROCESS</span><span class="o">*</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">KPROCESS</span><span class="p">));</span><span class="w"></span>
<span class="w">			</span><span class="n">memset</span><span class="p">(</span><span class="n">process</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">KPROCESS</span><span class="p">));</span><span class="w"></span>
<span class="w">			</span><span class="n">ll_add</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">procs</span><span class="p">,</span><span class="w"> </span><span class="n">process</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* will create thread in process */</span><span class="w"></span>
<span class="w">			</span><span class="n">kelfload</span><span class="p">(</span><span class="n">process</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uintptr</span><span class="p">)</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">.....</span><span class="w"></span>
</pre></div>
<p>I simply changed from creating of a task to the creation of a process, and <i>kelfload</i> was changed to create a thread of the passed process instead of a task.
</p>
<h3><span class="mw-headline" id="SWI_Exception_Entry_And_Exit_Changed">SWI Exception Entry And Exit Changed</span></h3>
<p>These were changed to push <i>SPSR</i> so it can be saved and restored easily from inside
our new <i>sched()</i> function.
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="cp">#define KEXP_TOPSWI \</span>
<span class="cp">	uint32			lr; \</span>
<span class="cp">	asm(&quot;mov sp,&#160;%[ps]&quot;&#160;:&#160;: [ps]&quot;i&quot; (KSTACKEXC)); \</span>
<span class="cp">	asm(&quot;push {lr}&quot;); \</span>
<span class="cp">	asm(&quot;push {r0,r1,r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12}&quot;); \</span>
<span class="cp">	asm(&quot;mrs r0, spsr&quot;); \</span>
<span class="cp">	asm(&quot;push {r0}&quot;); \</span>
<span class="cp">	asm(&quot;mov&#160;%[ps], lr&quot;&#160;: [ps]&quot;=r&quot; (lr));	</span>

<span class="cp">#define KEXP_BOTSWI \</span>
<span class="cp">	asm(&quot;pop {r0}&quot;); \</span>
<span class="cp">	asm(&quot;msr spsr, r0&quot;); \</span>
<span class="cp">	asm(&quot;pop {r0,r1,r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12}&quot;); \</span>
<span class="cp">	asm(&quot;LDM sp!, {pc}^&quot;)</span>
</pre></div>
<p>The <i>SWI</i> entry and exit assembly now saves everything the same way as the other exception handlers allowing the scheduler to be called to save the current thread and load the next meaning system calls can switch threads for <i>sleep</i> and <i>yield</i>.
</p>
<h3><span class="mw-headline" id="Added_System_Call_Numbers">Added System Call Numbers</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="cp">#define KSWI_WAKEUP				100</span>
<span class="cp">#define KSWI_SLEEP				101</span>
<span class="cp">#define KSWI_YEILD				102</span>
<span class="cp">#define KSWI_GETTICKPERSECOND	103</span>
</pre></div>
<h3><span class="mw-headline" id="New_KPROCESS_And_Updated_KTHREAD">New KPROCESS And Updated KTHREAD</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_KTHREAD</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">_KTHREAD</span><span class="w">		</span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">_KTHREAD</span><span class="w">		</span><span class="o">*</span><span class="n">prev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">uint64</span><span class="w">				</span><span class="n">timeout</span><span class="p">;</span><span class="w">			</span><span class="cm">/* when to wakeup */</span><span class="w"></span>
<span class="w">	</span><span class="n">uint8</span><span class="w">				</span><span class="n">flags</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w">				</span><span class="n">r0</span><span class="p">,</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="n">r3</span><span class="p">,</span><span class="w"> </span><span class="n">r4</span><span class="p">,</span><span class="w"> </span><span class="n">r5</span><span class="p">,</span><span class="w"> </span><span class="n">r6</span><span class="p">,</span><span class="w"> </span><span class="n">r7</span><span class="p">,</span><span class="w"> </span><span class="n">r8</span><span class="p">,</span><span class="w"> </span><span class="n">r9</span><span class="p">,</span><span class="w"> </span><span class="n">r10</span><span class="p">,</span><span class="w"> </span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="n">r12</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">lr</span><span class="p">,</span><span class="w"> </span><span class="n">cpsr</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">KTHREAD</span><span class="p">;</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_KPROCESS</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">_KPROCESS</span><span class="w">	</span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">_KPROCESS</span><span class="w">	</span><span class="o">*</span><span class="n">prev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">KVMMTABLE</span><span class="w">			</span><span class="n">vmm</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">KTHREAD</span><span class="w">				</span><span class="o">*</span><span class="n">threads</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">KPROCESS</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>The <i>KTHREAD</i> was updated with linked list fields added, <i>timeout</i>, and <i>flags</i>. The <i>KPROCESS</i> is new and was added to provide a process like structure to tasking. The <i>vmm</i> field was moved from the thread structure to the process structure since all threads share the same
address space.
</p>
<h3><span class="mw-headline" id="Changes_To_KSTATE">Changes To KSTATE</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_KSTATE</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">-</span><span class="w">	</span><span class="cm">/* process/thread support */</span><span class="w"></span>
<span class="o">-</span><span class="w">	</span><span class="n">KTHREAD</span><span class="w">			</span><span class="n">threads</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span><span class="w"></span>
<span class="o">-</span><span class="w">	</span><span class="n">uint8</span><span class="w">			</span><span class="n">threadndx</span><span class="p">;</span><span class="w">	</span>
<span class="o">-</span><span class="w">	</span><span class="n">uint8</span><span class="w">			</span><span class="n">iswitch</span><span class="p">;</span><span class="w"></span>
<span class="o">-</span><span class="w">	</span>
<span class="w"> 	</span><span class="cm">/* new process/thread support */</span><span class="w"></span>
<span class="o">+</span><span class="w">	</span><span class="n">KPROCESS</span><span class="w">		</span><span class="o">*</span><span class="n">procs</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">	</span><span class="n">KPROCESS</span><span class="w">		</span><span class="o">*</span><span class="n">cproc</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">	</span><span class="n">KTHREAD</span><span class="w">			</span><span class="o">*</span><span class="n">cthread</span><span class="p">;</span><span class="w"></span>
<span class="w"> 	</span>
<span class="w"> 	</span><span class="cm">/* physical and heap memory management */</span><span class="w"></span>
<span class="w"> 	</span><span class="n">KHEAPBM</span><span class="w">			</span><span class="n">hphy</span><span class="p">;</span><span class="w">			</span><span class="cm">/* kernel physical page heap */</span><span class="w"></span>
<span class="w"> 	</span><span class="n">KHEAPBM</span><span class="w">			</span><span class="n">hchk</span><span class="p">;</span><span class="w">			</span><span class="cm">/* data chunk heap */</span><span class="w"></span>
<span class="w"> 	</span>
<span class="o">+</span><span class="w">	</span><span class="cm">/* time management */</span><span class="w"></span>
<span class="o">+</span><span class="w"> 	</span><span class="n">uint64</span><span class="w">			</span><span class="n">ctime</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">	</span><span class="n">uint32</span><span class="w">			</span><span class="n">tpers</span><span class="p">;</span><span class="w">			</span><span class="cm">/* ticks per second */</span><span class="w"></span>
<span class="o">+</span><span class="w">	</span>
<span class="w"> 	</span><span class="cm">/* virtual memory management */</span><span class="w"></span>
<span class="w"> 	</span><span class="n">KVMMTABLE</span><span class="w">		</span><span class="n">vmm</span><span class="p">;</span><span class="w">			</span><span class="cm">/* kernel virtual memory map */</span><span class="w"></span>
<span class="w"> 	</span><span class="n">uint32</span><span class="w">			</span><span class="n">vmm_ucte</span><span class="p">;</span><span class="w">		</span><span class="cm">/* unused coarse table entries */</span><span class="w"></span>
</pre></div>
<p>The old thread/task structures removed and the new field added. A pointer to the first process entry (linked list) was added, and a pointer to the current process and thread.
</p>
<h3><span class="mw-headline" id="Second_Module_Added">Second Module Added</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">_start</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">smmio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w">		</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w">		</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">for</span><span class="p">(;;);</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0xfffff</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">smmio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<h3><span class="mw-headline" id="First_Module">First Module</span></h3>
<p>This module demonstrates going to sleep.
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getTicksPerSecond</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">			</span><span class="n">out</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;	swi #103 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			mov&#160;%[out], r0 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="p">]</span><span class="s">&quot;=r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sleep</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;	mov r0,&#160;%[in] </span><span class="se">\n</span><span class="s">\</span>
<span class="s">			swi #101 </span><span class="se">\n</span><span class="s">\</span>
<span class="s">		&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">_start</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">smmio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w">				</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w">				</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">	</span><span class="n">tps</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">tps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTicksPerSecond</span><span class="p">();</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">smmio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;G&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">smmio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;K&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">sleep</span><span class="p">(</span><span class="n">tps</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>This module demonstrates going to sleep instead of busy looping which wastes CPU that could be used for another thread.
</p>
<h3><span class="mw-headline" id="Change_In_Timer_Initialization">Change In Timer Initialization</span></h3>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="w">	</span><span class="n">t0mmio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="mh">0x13000100</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">t0mmio</span><span class="p">[</span><span class="n">REG_LOAD</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KTASKTICKS</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">t0mmio</span><span class="p">[</span><span class="n">REG_BGLOAD</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KTASKTICKS</span><span class="p">;</span><span class="w">			</span>
<span class="w">	</span><span class="n">t0mmio</span><span class="p">[</span><span class="n">REG_CTRL</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CTRL_ENABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CTRL_MODE_PERIODIC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CTRL_SIZE_32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CTRL_DIV_NONE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CTRL_INT_ENABLE</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">t0mmio</span><span class="p">[</span><span class="n">REG_INTCLR</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="mi">0</span><span class="p">;</span><span class="w">		</span><span class="cm">/* make sure interrupt is clear (might not be mandatory) */</span><span class="w"></span>
<span class="w">	</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">tpers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>We now use <i>KTASKTICKS</i> and initialize <i>ks-&gt;tpers</i> which is read by threads using a software interrupts (<i>see exphandler</i>). This allows them to adjust their ticks for the sleep call to sleep for a certain amount of actual real time (<i>see exphandler</i> SWI handler).
</p><p>I also switched to using a 1MHZ timer just because I have not yet figured out how to detect the system clock speed. I have a few ideas but I am currently working on more important things, but it might be a good exercise for the reader to try to do this. The board may allow you to determine the system clock speed. Also, an idea is to use the 1MHZ timer to estimate the system clock synchronized timer 0. This might yield a different value on different systems depending on how the system clock timer is implemented in QEMU, but on real hardware it should always be the same.
</p>
<!-- 
NewPP limit report
Cached time: 20250211135630
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc]
CPU time usage: 0.142 seconds
Real time usage: 2.247 seconds
Preprocessor visited node count: 145/1000000
Post‐expand include size: 914/2097152 bytes
Template argument size: 229/2097152 bytes
Highest expansion depth: 6/100
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 121256/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    1.416      1 -total
100.00%    1.416      1 Template:FirstPerson
 38.76%    0.549      1 Template:NoteBox
-->

<!-- Saved in parser cache with key wikidb:pcache:idhash:3503-0!canonical and timestamp 20250211135628 and revision id 28043.
 -->
</div>
<div class="printfooter" data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.osdev.org/index.php?title=ARM_Integrator-CP_ITPTMME_Phase2&amp;oldid=28043">https://wiki.osdev.org/index.php?title=ARM_Integrator-CP_ITPTMME_Phase2&amp;oldid=28043</a>"</div></div>
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="./Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="https://wiki.osdev.org/index.php?title=Category:Pages_using_deprecated_source_tags&amp;action=edit&amp;redlink=1" class="new" title="Category:Pages using deprecated source tags (page does not exist)">Pages using deprecated source tags</a></li><li><a href="./Category:Articles_Written_in_First_Person" title="Category:Articles Written in First Person">Articles Written in First Person</a></li><li><a href="./Category:ARM" title="Category:ARM">ARM</a></li></ul></div></div>
	</div>
</div>

<div id="mw-navigation">
	<h2>Navigation menu</h2>
	<div id="mw-head">
		

<nav id="p-personal" class="vector-menu mw-portlet mw-portlet-personal vector-user-menu-legacy" aria-labelledby="p-personal-label" role="navigation"  >
	<h3
		id="p-personal-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Personal tools</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="pt-login" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Special:UserLogin&amp;returnto=ARM+Integrator-CP+ITPTMME+Phase2" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o"><span>Log in</span></a></li><li id="pt-darkmode" class="mw-list-item"><a href="ARM_Integrator-CP_ITPTMME_Phase2#" class="ext-darkmode-link"><span>Dark mode</span></a></li></ul>
		
	</div>
</nav>

		<div id="left-navigation">
			

<nav id="p-namespaces" class="vector-menu mw-portlet mw-portlet-namespaces vector-menu-tabs vector-menu-tabs-legacy" aria-labelledby="p-namespaces-label" role="navigation"  >
	<h3
		id="p-namespaces-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Namespaces</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-nstab-main" class="selected mw-list-item"><a href="ARM_Integrator-CP_ITPTMME_Phase2" title="View the content page [c]" accesskey="c"><span>Page</span></a></li><li id="ca-talk" class="new mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Talk:ARM_Integrator-CP_ITPTMME_Phase2&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [t]" accesskey="t"><span>Discussion</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown" aria-labelledby="p-variants-label" role="navigation"  >
	<input type="checkbox"
		id="p-variants-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-variants"
		class="vector-menu-checkbox"
		aria-labelledby="p-variants-label"
	/>
	<label
		id="p-variants-label"
		 aria-label="Change language variant"
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

		</div>
		<div id="right-navigation">
			

<nav id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs vector-menu-tabs-legacy" aria-labelledby="p-views-label" role="navigation"  >
	<h3
		id="p-views-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Views</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-view" class="selected mw-list-item"><a href="ARM_Integrator-CP_ITPTMME_Phase2"><span>Read</span></a></li><li id="ca-viewsource" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=ARM_Integrator-CP_ITPTMME_Phase2&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e"><span>View source</span></a></li><li id="ca-history" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=ARM_Integrator-CP_ITPTMME_Phase2&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown" aria-labelledby="p-cactions-label" role="navigation"  title="More options" >
	<input type="checkbox"
		id="p-cactions-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-cactions"
		class="vector-menu-checkbox"
		aria-labelledby="p-cactions-label"
	/>
	<label
		id="p-cactions-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<div>
			<h3 >
				<label for="searchInput">Search</label>
			</h3>
		<form action="https://wiki.osdev.org/index.php" id="searchform"
			class="vector-search-box-form">
			<div id="simpleSearch"
				class="vector-search-box-inner"
				 data-search-loc="header-navigation">
				<input class="vector-search-box-input"
					 type="search" name="search" placeholder="Search OSDev Wiki" aria-label="Search OSDev Wiki" autocapitalize="sentences" title="Search OSDev Wiki [f]" accesskey="f" id="searchInput"
				>
				<input type="hidden" name="title" value="Special:Search">
				<input id="mw-searchButton"
					 class="searchButton mw-fallbackSearchButton" type="submit" name="fulltext" title="Search the pages for this text" value="Search">
				<input id="searchButton"
					 class="searchButton" type="submit" name="go" title="Go to a page with this exact name if it exists" value="Go">
			</div>
		</form>
	</div>
</div>

		</div>
	</div>
	

<div id="mw-panel">
	<div id="p-logo" role="banner">
		<a class="mw-wiki-logo" href="index.html"
			title="Visit the main page"></a>
	</div>
	

<nav id="p-navigation" class="vector-menu mw-portlet mw-portlet-navigation vector-menu-portal portal" aria-labelledby="p-navigation-label" role="navigation"  >
	<h3
		id="p-navigation-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Navigation</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-mainpage" class="mw-list-item"><a href="index.html" title="Visit the main page [z]" accesskey="z"><span>Main Page</span></a></li><li id="n-portal" class="mw-list-item"><a href="http://forum.osdev.org/" rel="nofollow" title="About the project, what you can do, where to find things"><span>Forums</span></a></li><li id="n-FAQ" class="mw-list-item"><a href="./Category:FAQ"><span>FAQ</span></a></li><li id="n-OS-Projects" class="mw-list-item"><a href="Projects"><span>OS Projects</span></a></li><li id="n-randompage" class="mw-list-item"><a href="https://wiki.osdev.org/Special:Random" title="Load a random page [x]" accesskey="x"><span>Random page</span></a></li></ul>
		
	</div>
</nav>

	

<nav id="p-about" class="vector-menu mw-portlet mw-portlet-about vector-menu-portal portal" aria-labelledby="p-about-label" role="navigation"  >
	<h3
		id="p-about-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">About</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-This-site" class="mw-list-item"><a href="./OSDevWiki:About"><span>This site</span></a></li><li id="n-Joining" class="mw-list-item"><a href="./OSDevWiki:Joining"><span>Joining</span></a></li><li id="n-Editing-help" class="mw-list-item"><a href="./OSDevWiki:Editing"><span>Editing help</span></a></li><li id="n-recentchanges" class="mw-list-item"><a href="./Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r"><span>Recent changes</span></a></li></ul>
		
	</div>
</nav>


<nav id="p-tb" class="vector-menu mw-portlet mw-portlet-tb vector-menu-portal portal" aria-labelledby="p-tb-label" role="navigation"  >
	<h3
		id="p-tb-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Tools</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="t-whatlinkshere" class="mw-list-item"><a href="./Special:WhatLinksHere/ARM_Integrator-CP_ITPTMME_Phase2" title="A list of all wiki pages that link here [j]" accesskey="j"><span>What links here</span></a></li><li id="t-recentchangeslinked" class="mw-list-item"><a href="https://wiki.osdev.org/Special:RecentChangesLinked/ARM_Integrator-CP_ITPTMME_Phase2" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k"><span>Related changes</span></a></li><li id="t-specialpages" class="mw-list-item"><a href="./Special:SpecialPages" title="A list of all special pages [q]" accesskey="q"><span>Special pages</span></a></li><li id="t-print" class="mw-list-item"><a href="javascript:print();" rel="alternate" title="Printable version of this page [p]" accesskey="p"><span>Printable version</span></a></li><li id="t-permalink" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=ARM_Integrator-CP_ITPTMME_Phase2&amp;oldid=28043" title="Permanent link to this revision of this page"><span>Permanent link</span></a></li><li id="t-info" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=ARM_Integrator-CP_ITPTMME_Phase2&amp;action=info" title="More information about this page"><span>Page information</span></a></li></ul>
		
	</div>
</nav>

	
</div>

</div>

<footer id="footer" class="mw-footer" role="contentinfo" >
	<ul id="footer-info">
	<li id="footer-info-lastmod"> This page was last edited on 9 July 2023, at 19:00.</li>
	<li id="footer-info-0">This page has been accessed 1,120 times.</li>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="./OSDev_Wiki:Privacy_policy">Privacy policy</a></li>
	<li id="footer-places-about"><a href="./OSDev_Wiki:About">About OSDev Wiki</a></li>
	<li id="footer-places-disclaimer"><a href="./OSDev_Wiki:General_disclaimer">Disclaimers</a></li>
	<li id="footer-places-mobileview"><a href="https://wiki.osdev.org/index.php?title=ARM_Integrator-CP_ITPTMME_Phase2&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"/></a></li>
</ul>

</footer>

<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.142","walltime":"2.247","ppvisitednodes":{"value":145,"limit":1000000},"postexpandincludesize":{"value":914,"limit":2097152},"templateargumentsize":{"value":229,"limit":2097152},"expansiondepth":{"value":6,"limit":100},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":121256,"limit":5000000},"timingprofile":["100.00%    1.416      1 -total","100.00%    1.416      1 Template:FirstPerson"," 38.76%    0.549      1 Template:NoteBox"]},"cachereport":{"timestamp":"20250211135630","ttl":86400,"transientcontent":false}}});mw.config.set({"wgBackendResponseTime":2355});});</script>
</body>
</html>