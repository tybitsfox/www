<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>Higher Half x86 Bare Bones (Backup) - OSDev Wiki</title>
<script>document.documentElement.className="client-js";RLCONF={"wgBreakFrames":false,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"3bb4b77f0db20d6545392b25","wgCSPNonce":false,"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Higher_Half_x86_Bare_Bones_(Backup)","wgTitle":"Higher Half x86 Bare Bones (Backup)","wgCurRevisionId":23056,"wgRevisionId":23056,"wgArticleId":1745,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Pages using duplicate arguments in template calls","Pages using deprecated source tags","Disputed Pages","Articles Written in First Person","Level 2 Tutorials","Bare bones tutorials"],"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgRelevantPageName":
"Higher_Half_x86_Bare_Bones_(Backup)","wgRelevantArticleId":1745,"wgIsProbablyEditable":false,"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgMFDisplayWikibaseDescriptions":{"search":false,"nearby":false,"watchlist":false,"tagline":false},"wgVisualEditor":{"pageLanguageCode":"en","pageLanguageDir":"ltr","pageVariantFallbacks":"en"},"wgVector2022PreviewPages":[],"wgMediaViewerOnClick":true,"wgMediaViewerEnabledByDefault":true,"wgEditSubmitButtonLabelPublish":false};RLSTATE={"site.styles":"ready","user.styles":"ready","user":"ready","user.options":"loading","ext.pygments":"ready","skins.vector.styles.legacy":"ready","ext.visualEditor.desktopArticleTarget.noscript":"ready","ext.DarkMode.styles":"ready"};RLPAGEMODULES=["site","mediawiki.page.ready","mediawiki.toc","skins.vector.legacy.js","ext.visualEditor.desktopArticleTarget.init","ext.visualEditor.targetLoader","mmv.head","mmv.bootstrap.autostart","ext.DarkMode","ext.moderation.notify",
"ext.moderation.ve","ext.moderation.ajaxhook","ext.moderation.notify.desktop"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.implement("user.options@12s5i",function($,jQuery,require,module){mw.user.tokens.set({"patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});});});</script>
<link rel="stylesheet" href="https://wiki.osdev.org/load.php?lang=en&amp;modules=ext.DarkMode.styles%7Cext.pygments%7Cext.visualEditor.desktopArticleTarget.noscript%7Cskins.vector.styles.legacy&amp;only=styles&amp;skin=vector"/>
<script async="" src="https://wiki.osdev.org/load.php?lang=en&amp;modules=startup&amp;only=scripts&amp;raw=1&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="https://wiki.osdev.org/load.php?lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.39.7"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="viewport" content="width=1000"/>
<link rel="icon" href="favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="OSDev Wiki (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="api.php?action=rsd"/>
<link rel="alternate" type="application/atom+xml" title="OSDev Wiki Atom feed" href="https://wiki.osdev.org/index.php?title=Special:RecentChanges&amp;feed=atom"/>
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Higher_Half_x86_Bare_Bones_Backup rootpage-Higher_Half_x86_Bare_Bones_Backup skin-vector action-view skin-vector-legacy vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled"><div id="mw-page-base" class="noprint"></div>
<div id="mw-head-base" class="noprint"></div>
<div id="content" class="mw-body" role="main">
	<a id="top"></a>
	<div id="siteNotice"></div>
	<div class="mw-indicators">
	</div>
	<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Higher Half x86 Bare Bones (Backup)</span></h1>
	<div id="bodyContent" class="vector-body">
		<div id="siteSub" class="noprint">From OSDev Wiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="Higher_Half_x86_Bare_Bones_(Backup)#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="Higher_Half_x86_Bare_Bones_(Backup)#searchInput">Jump to search</a>
		<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr"><div class="mw-parser-output"><center>
<table style="border: 1px solid #cfcfbf; padding: .0em .25em .0em; background-color: #f0f0ff; text-align: center;">
<tbody><tr>
<td>
<p><font color="black">The factual accuracy of this article or section is <a href="./Category:Disputed_Pages" title="Category:Disputed Pages">disputed</a>.</font><br /><small><font color="red">Please see the relevant discussion on the <a href="./Talk:Higher_Half_x86_Bare_Bones_(Backup)" title="Talk:Higher Half x86 Bare Bones (Backup)">talk page</a>.</font></small>
</p>
</td>
<td>
</td></tr></tbody></table>
</center>
<center>
<table style="border: 1px solid #cfcfbf; margin-top: 25px; margin-bottom: 25px; background-color: #f0f0ff; text-align: center;">
<tbody><tr>
<td>
<p>This page or section refers to its readers or editors using <i>I</i>, <i>my</i>, <i>we</i> or <i>us</i>. It should be <a rel="nofollow" class="external text" href="https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;action=edit">edited</a> to be in an encyclopedic tone.
</p>
</td></tr></tbody></table>
</center>
<center>
<table style="border: 1px solid #cfcfbf; margin-top: 25px; margin-bottom: 25px; background-color: #f0f0ff; text-align: center;">
<tbody><tr>
<td>
<p>This tutorial needs to explain what the code does as tutorials are not just copy paste. You can help out by <a rel="nofollow" class="external text" href="https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;action=edit">editing</a> this page to include more context to what the code does.
</p>
</td></tr></tbody></table>
</center>
<center>
<table style="border: 1px solid #cfcfbf; margin-top: 25px; margin-bottom: 25px; background-color: #f0f0ff; text-align: center;">
<tbody><tr>
<td>
<p><big><b>WAIT! Have you read <a href="Getting_Started" title="Getting Started">Getting Started</a>, <a href="Beginner_Mistakes" title="Beginner Mistakes">Beginner Mistakes</a>, and some of the related <a href="./Category:OS_theory" title="Category:OS theory">OS theory</a>?</b></big>
</p>
</td></tr></tbody></table>
</center><table style="font-size:95%; line-height:1.5em; padding:0.25em; float:right; margin: 0 0 8px 15px; clear:right; border:1px solid #aaaaaa; background:#eee; text-align:center;;"><tbody><tr><th>Difficulty level</th></tr><tr><td><a href="./File:Difficulty_2.png" class="image"><img alt="Difficulty 2.png" src="images/a/a1/Difficulty_2.png" decoding="async" width="46" height="14" data-file-width="46" data-file-height="14" /></a><br />Medium</td></tr></tbody></table>
<p>Here is some sample code for a kernel that is loaded by GRUB and is mapped in the upper half of memory. In this case, the kernel is loaded at 1MB in the physical address space (0x00100000), but is mapped at 3GB + 1MB in the virtual address space (0xC0100000). It is recommended that you have a firm grasp of the contents within the <a href="Bare_bones" class="mw-redirect" title="Bare bones">Bare bones tutorial</a> and <a href="Paging" title="Paging">Paging</a> before attempting this.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="Higher_Half_x86_Bare_Bones_(Backup)#loader.asm"><span class="tocnumber">1</span> <span class="toctext">loader.asm</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="Higher_Half_x86_Bare_Bones_(Backup)#linker.ld"><span class="tocnumber">2</span> <span class="toctext">linker.ld</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="Higher_Half_x86_Bare_Bones_(Backup)#kernel.c"><span class="tocnumber">3</span> <span class="toctext">kernel.c</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="Higher_Half_x86_Bare_Bones_(Backup)#Troubleshooting"><span class="tocnumber">4</span> <span class="toctext">Troubleshooting</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="Higher_Half_x86_Bare_Bones_(Backup)#See_Also"><span class="tocnumber">5</span> <span class="toctext">See Also</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="Higher_Half_x86_Bare_Bones_(Backup)#Articles"><span class="tocnumber">5.1</span> <span class="toctext">Articles</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="loader.asm">loader.asm</span></h2>
<p>This piece of code is taking over control from the Multiboot bootloader. It sets up a page directory with page table entries that identity map the first 4MB, and also map the first 4MB to virtual 3GB. After setting up paging, it unmaps the identity mapping so that the kernel is entirely in the higher half and jumps into the kernel proper.
</p>
<div class="mw-highlight mw-highlight-lang-asm mw-content-ltr" dir="ltr"><pre><span></span><span class="nf">global</span><span class="w"> </span><span class="no">_loader</span><span class="w">                          </span><span class="c1">; Make entry point visible to linker.</span>
<span class="nf">extern</span><span class="w"> </span><span class="no">_main</span><span class="w">                            </span><span class="c1">; _main is defined elsewhere</span>

<span class="c1">; setting up the Multiboot header - see GRUB docs for details</span>
<span class="nf">MODULEALIGN</span><span class="w"> </span><span class="no">equ</span><span class="w">  </span><span class="mi">1</span><span class="err">&lt;&lt;</span><span class="mi">0</span><span class="w">             </span><span class="c1">; align loaded modules on page boundaries</span>
<span class="nf">MEMINFO</span><span class="w">     </span><span class="no">equ</span><span class="w">  </span><span class="mi">1</span><span class="err">&lt;&lt;</span><span class="mi">1</span><span class="w">             </span><span class="c1">; provide memory map</span>
<span class="nf">FLAGS</span><span class="w">       </span><span class="no">equ</span><span class="w">  </span><span class="no">MODULEALIGN</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="no">MEMINFO</span><span class="w">  </span><span class="c1">; this is the Multiboot &#39;flag&#39; field</span>
<span class="nf">MAGIC</span><span class="w">       </span><span class="no">equ</span><span class="w">    </span><span class="mi">0x1BADB002</span><span class="w">     </span><span class="c1">; &#39;magic number&#39; lets bootloader find the header</span>
<span class="nf">CHECKSUM</span><span class="w">    </span><span class="no">equ</span><span class="w"> </span><span class="p">-(</span><span class="no">MAGIC</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">FLAGS</span><span class="p">)</span><span class="w">  </span><span class="c1">; checksum required</span>

<span class="c1">; This is the virtual base address of kernel space. It must be used to convert virtual</span>
<span class="c1">; addresses into physical addresses until paging is enabled. Note that this is not</span>
<span class="c1">; the virtual address where the kernel image itself is loaded -- just the amount that must</span>
<span class="c1">; be subtracted from a virtual address to get a physical address.</span>
<span class="nf">KERNEL_VIRTUAL_BASE</span><span class="w"> </span><span class="no">equ</span><span class="w"> </span><span class="mi">0xC0000000</span><span class="w">                  </span><span class="c1">; 3GB</span>
<span class="nf">KERNEL_PAGE_NUMBER</span><span class="w"> </span><span class="no">equ</span><span class="w"> </span><span class="p">(</span><span class="no">KERNEL_VIRTUAL_BASE</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w">  </span><span class="c1">; Page directory index of kernel&#39;s 4MB PTE.</span>


<span class="nf">section</span><span class="w"> </span><span class="no">.data</span><span class="w"></span>
<span class="nf">align</span><span class="w"> </span><span class="mi">0x1000</span><span class="w"></span>
<span class="nl">BootPageDirectory:</span><span class="w"></span>
<span class="w">    </span><span class="c1">; This page directory entry identity-maps the first 4MB of the 32-bit physical address space.</span>
<span class="w">    </span><span class="c1">; All bits are clear except the following:</span>
<span class="w">    </span><span class="c1">; bit 7: PS The kernel page is 4MB.</span>
<span class="w">    </span><span class="c1">; bit 1: RW The kernel page is read/write.</span>
<span class="w">    </span><span class="c1">; bit 0: P  The kernel page is present.</span>
<span class="w">    </span><span class="c1">; This entry must be here -- otherwise the kernel will crash immediately after paging is</span>
<span class="w">    </span><span class="c1">; enabled because it can&#39;t fetch the next instruction! It&#39;s ok to unmap this page later.</span>
<span class="w">    </span><span class="nf">dd</span><span class="w"> </span><span class="mi">0x00000083</span><span class="w"></span>
<span class="w">    </span><span class="nf">times</span><span class="w"> </span><span class="p">(</span><span class="no">KERNEL_PAGE_NUMBER</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="no">dd</span><span class="w"> </span><span class="mi">0</span><span class="w">                 </span><span class="c1">; Pages before kernel space.</span>
<span class="w">    </span><span class="c1">; This page directory entry defines a 4MB page containing the kernel.</span>
<span class="w">    </span><span class="nf">dd</span><span class="w"> </span><span class="mi">0x00000083</span><span class="w"></span>
<span class="w">    </span><span class="nf">times</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="no">KERNEL_PAGE_NUMBER</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="no">dd</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">; Pages after the kernel image.</span>


<span class="nf">section</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>
<span class="nf">align</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="nl">MultiBootHeader:</span><span class="w"></span>
<span class="w">    </span><span class="nf">dd</span><span class="w"> </span><span class="no">MAGIC</span><span class="w"></span>
<span class="w">    </span><span class="nf">dd</span><span class="w"> </span><span class="no">FLAGS</span><span class="w"></span>
<span class="w">    </span><span class="nf">dd</span><span class="w"> </span><span class="no">CHECKSUM</span><span class="w"></span>

<span class="c1">; reserve initial kernel stack space -- that&#39;s 16k.</span>
<span class="nf">STACKSIZE</span><span class="w"> </span><span class="no">equ</span><span class="w"> </span><span class="mi">0x4000</span><span class="w"></span>

<span class="c1">; setting up entry point for linker</span>
<span class="nf">loader</span><span class="w"> </span><span class="no">equ</span><span class="w"> </span><span class="p">(</span><span class="no">_loader</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="mi">0xC0000000</span><span class="p">)</span><span class="w"></span>
<span class="nf">global</span><span class="w"> </span><span class="no">loader</span><span class="w"></span>

<span class="nl">_loader:</span><span class="w"></span>
<span class="w">    </span><span class="c1">; NOTE: Until paging is set up, the code must be position-independent and use physical</span>
<span class="w">    </span><span class="c1">; addresses, not virtual ones!</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">BootPageDirectory</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="no">KERNEL_VIRTUAL_BASE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">cr3</span><span class="p">,</span><span class="w"> </span><span class="no">ecx</span><span class="w">                                        </span><span class="c1">; Load Page Directory Base Register.</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="no">cr4</span><span class="w"></span>
<span class="w">    </span><span class="nf">or</span><span class="w"> </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="mi">0x00000010</span><span class="w">                          </span><span class="c1">; Set PSE bit in CR4 to enable 4MB pages.</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">cr4</span><span class="p">,</span><span class="w"> </span><span class="no">ecx</span><span class="w"></span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="no">cr0</span><span class="w"></span>
<span class="w">    </span><span class="nf">or</span><span class="w"> </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="mi">0x80000000</span><span class="w">                          </span><span class="c1">; Set PG bit in CR0 to enable paging.</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">cr0</span><span class="p">,</span><span class="w"> </span><span class="no">ecx</span><span class="w"></span>

<span class="w">    </span><span class="c1">; Start fetching instructions in kernel space.</span>
<span class="w">    </span><span class="c1">; Since eip at this point holds the physical address of this command (approximately 0x00100000)</span>
<span class="w">    </span><span class="c1">; we need to do a long jump to the correct virtual address of StartInHigherHalf which is</span>
<span class="w">    </span><span class="c1">; approximately 0xC0100000.</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">StartInHigherHalf</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="no">ecx</span><span class="w">                                                     </span><span class="c1">; NOTE: Must be absolute jump!</span>

<span class="nl">StartInHigherHalf:</span><span class="w"></span>
<span class="w">    </span><span class="c1">; Unmap the identity-mapped first 4MB of physical address space. It should not be needed</span>
<span class="w">    </span><span class="c1">; anymore.</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">dword</span><span class="w"> </span><span class="p">[</span><span class="no">BootPageDirectory</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">invlpg</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="c1">; NOTE: From now on, paging should be enabled. The first 4MB of physical address space is</span>
<span class="w">    </span><span class="c1">; mapped starting at KERNEL_VIRTUAL_BASE. Everything is linked to this address, so no more</span>
<span class="w">    </span><span class="c1">; position-independent code or funny business with virtual-to-physical address translation</span>
<span class="w">    </span><span class="c1">; should be necessary. We now have a higher-half kernel.</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">esp</span><span class="p">,</span><span class="w"> </span><span class="no">stack</span><span class="err">+</span><span class="no">STACKSIZE</span><span class="w">           </span><span class="c1">; set up the stack</span>
<span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="no">eax</span><span class="w">                           </span><span class="c1">; pass Multiboot magic number</span>

<span class="w">    </span><span class="c1">; pass Multiboot info structure -- WARNING: This is a physical address and may not be</span>
<span class="w">    </span><span class="c1">; in the first 4MB!</span>
<span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="no">ebx</span><span class="w"></span>

<span class="w">    </span><span class="nf">call</span><span class="w">  </span><span class="no">_main</span><span class="w">                  </span><span class="c1">; call kernel proper</span>
<span class="w">    </span><span class="nf">hlt</span><span class="w">                          </span><span class="c1">; halt machine should kernel return</span>


<span class="nf">section</span><span class="w"> </span><span class="no">.bss</span><span class="w"></span>
<span class="nf">align</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="nl">stack:</span><span class="w"></span>
<span class="w">    </span><span class="nf">resb</span><span class="w"> </span><span class="no">STACKSIZE</span><span class="w">      </span><span class="c1">; reserve 16k stack on a uint64_t boundary</span>
</pre></div>
<h2><span class="mw-headline" id="linker.ld">linker.ld</span></h2>
<p>This is a little trickier than it was for the <a href="Bare_bones" class="mw-redirect" title="Bare bones">C kernel tutorial</a>, since you need to distinguish between virtual addresses (which will be in the higher half) and load addresses, which GRUB needs to decide where to put your kernel.
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="n">ENTRY</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span><span class="w"></span>
<span class="n">OUTPUT_FORMAT</span><span class="p">(</span><span class="n">elf32</span><span class="o">-</span><span class="n">i386</span><span class="p">)</span><span class="w"></span>

<span class="n">SECTIONS</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="cm">/* The kernel will live at 3GB + 1MB in the virtual</span>
<span class="cm">      address space, which will be mapped to 1MB in the</span>
<span class="cm">      physical address space. */</span><span class="w"></span>
<span class="w">   </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xC0100000</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="p">.</span><span class="n">text</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">AT</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xC0000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="o">*</span><span class="p">(.</span><span class="n">rodata</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="n">ALIGN</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">AT</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(.</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xC0000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="o">*</span><span class="p">(.</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="p">.</span><span class="n">bss</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">AT</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(.</span><span class="n">bss</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xC0000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">_sbss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">       </span><span class="o">*</span><span class="p">(</span><span class="n">COMMON</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="o">*</span><span class="p">(.</span><span class="n">bss</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="n">_ebss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Note that we use loader (and not _loader) as our entry point. This is due to the fact that _loader's address is approximately 0xC0100000, if we try to set our eip to that address it will not find our loader function.
Also note our entry point is not being converted to physical address. GRUB does this conversion when calculating starting value of EIP, and if you attempt to do the translation, you may get your execution when you don't want it or get "entry point isn't in a segment" error.
</p>
<h2><span class="mw-headline" id="kernel.c">kernel.c</span></h2>
<p>Using the <a href="Bare_bones#Writing_a_kernel_in_C" class="mw-redirect" title="Bare bones">kernel.c code</a> from the original bare bones tutorial will work fine, with one small change.  On the fourth line in terminal_initialize(), change:
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="n">terminal_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="mh">0xB8000</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>to
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="n">terminal_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="mh">0xC00B8000</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>This accomodates for the kernel's new offset into higher-half space.  Any direct memory access by the kernel at this point should take place with respect to this offset where necessary.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<dl><dt>I got a page fault (#PF) when accessing my GRUB Multiboot info structure</dt></dl>
<p>The address passed by loader.s is physical, you have to make it virtual to add your virtual base to it. For example, in your loader.s:
</p>
<div class="mw-highlight mw-highlight-lang-asm mw-content-ltr" dir="ltr"><pre><span></span><span class="w">   </span><span class="nf">add</span><span class="w"> </span><span class="no">ebx</span><span class="p">,</span><span class="w"> </span><span class="no">KERNEL_VIRTUAL_BASE</span><span class="w"> </span><span class="c1">; make the address virtual</span>
<span class="w">   </span><span class="nf">push</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="c1">; push it on the stack for _main()</span>
</pre></div>
<p>Don't forget to make all addresses pointing to memory locations in the Multiboot info structure also virtual.
</p>
<h2><span class="mw-headline" id="See_Also">See Also</span></h2>
<h3><span class="mw-headline" id="Articles">Articles</span></h3>
<ul><li><a href="Bare_bones" class="mw-redirect" title="Bare bones">Bare bones</a></li>
<li>An <a href="./User:Glauxosdever/Higher_Half_x86_Bare_Bones" class="mw-redirect" title="User:Glauxosdever/Higher Half x86 Bare Bones">alternate</a> higher half Bare Bones.</li></ul>
<!-- 
NewPP limit report
Cached time: 20250211124642
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc]
CPU time usage: 0.051 seconds
Real time usage: 0.705 seconds
Preprocessor visited node count: 182/1000000
Post‐expand include size: 3387/2097152 bytes
Template argument size: 701/2097152 bytes
Highest expansion depth: 19/100
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 19073/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    7.649      1 -total
 50.69%    3.877      3 Template:If
 49.30%    3.771      1 Template:Rating
 43.93%    3.360      3 Template:Show1
 19.34%    1.479      1 Template:Disputed
 12.66%    0.968      3 Template:NoteBox
 11.89%    0.910      3 Template:Eq
 11.75%    0.899      1 Template:FirstPerson
 11.17%    0.854      1 Template:TutorialExplain
  7.90%    0.604      1 Template:DiscussThis
-->

<!-- Saved in parser cache with key wikidb:pcache:idhash:1745-0!canonical and timestamp 20250211124641 and revision id 23056.
 -->
</div>
<div class="printfooter" data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;oldid=23056">https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;oldid=23056</a>"</div></div>
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="./Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="https://wiki.osdev.org/index.php?title=Category:Pages_using_duplicate_arguments_in_template_calls&amp;action=edit&amp;redlink=1" class="new" title="Category:Pages using duplicate arguments in template calls (page does not exist)">Pages using duplicate arguments in template calls</a></li><li><a href="https://wiki.osdev.org/index.php?title=Category:Pages_using_deprecated_source_tags&amp;action=edit&amp;redlink=1" class="new" title="Category:Pages using deprecated source tags (page does not exist)">Pages using deprecated source tags</a></li><li><a href="./Category:Disputed_Pages" title="Category:Disputed Pages">Disputed Pages</a></li><li><a href="./Category:Articles_Written_in_First_Person" title="Category:Articles Written in First Person">Articles Written in First Person</a></li><li><a href="./Category:Level_2_Tutorials" title="Category:Level 2 Tutorials">Level 2 Tutorials</a></li><li><a href="./Category:Bare_bones_tutorials" title="Category:Bare bones tutorials">Bare bones tutorials</a></li></ul></div></div>
	</div>
</div>

<div id="mw-navigation">
	<h2>Navigation menu</h2>
	<div id="mw-head">
		

<nav id="p-personal" class="vector-menu mw-portlet mw-portlet-personal vector-user-menu-legacy" aria-labelledby="p-personal-label" role="navigation"  >
	<h3
		id="p-personal-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Personal tools</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="pt-login" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Special:UserLogin&amp;returnto=Higher+Half+x86+Bare+Bones+%28Backup%29" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o"><span>Log in</span></a></li><li id="pt-darkmode" class="mw-list-item"><a href="Higher_Half_x86_Bare_Bones_(Backup)#" class="ext-darkmode-link"><span>Dark mode</span></a></li></ul>
		
	</div>
</nav>

		<div id="left-navigation">
			

<nav id="p-namespaces" class="vector-menu mw-portlet mw-portlet-namespaces vector-menu-tabs vector-menu-tabs-legacy" aria-labelledby="p-namespaces-label" role="navigation"  >
	<h3
		id="p-namespaces-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Namespaces</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-nstab-main" class="selected mw-list-item"><a href="Higher_Half_x86_Bare_Bones_(Backup)" title="View the content page [c]" accesskey="c"><span>Page</span></a></li><li id="ca-talk" class="mw-list-item"><a href="./Talk:Higher_Half_x86_Bare_Bones_(Backup)" rel="discussion" title="Discussion about the content page [t]" accesskey="t"><span>Discussion</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown" aria-labelledby="p-variants-label" role="navigation"  >
	<input type="checkbox"
		id="p-variants-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-variants"
		class="vector-menu-checkbox"
		aria-labelledby="p-variants-label"
	/>
	<label
		id="p-variants-label"
		 aria-label="Change language variant"
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

		</div>
		<div id="right-navigation">
			

<nav id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs vector-menu-tabs-legacy" aria-labelledby="p-views-label" role="navigation"  >
	<h3
		id="p-views-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Views</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-view" class="selected mw-list-item"><a href="Higher_Half_x86_Bare_Bones_(Backup)"><span>Read</span></a></li><li id="ca-viewsource" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e"><span>View source</span></a></li><li id="ca-history" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown" aria-labelledby="p-cactions-label" role="navigation"  title="More options" >
	<input type="checkbox"
		id="p-cactions-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-cactions"
		class="vector-menu-checkbox"
		aria-labelledby="p-cactions-label"
	/>
	<label
		id="p-cactions-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<div>
			<h3 >
				<label for="searchInput">Search</label>
			</h3>
		<form action="https://wiki.osdev.org/index.php" id="searchform"
			class="vector-search-box-form">
			<div id="simpleSearch"
				class="vector-search-box-inner"
				 data-search-loc="header-navigation">
				<input class="vector-search-box-input"
					 type="search" name="search" placeholder="Search OSDev Wiki" aria-label="Search OSDev Wiki" autocapitalize="sentences" title="Search OSDev Wiki [f]" accesskey="f" id="searchInput"
				>
				<input type="hidden" name="title" value="Special:Search">
				<input id="mw-searchButton"
					 class="searchButton mw-fallbackSearchButton" type="submit" name="fulltext" title="Search the pages for this text" value="Search">
				<input id="searchButton"
					 class="searchButton" type="submit" name="go" title="Go to a page with this exact name if it exists" value="Go">
			</div>
		</form>
	</div>
</div>

		</div>
	</div>
	

<div id="mw-panel">
	<div id="p-logo" role="banner">
		<a class="mw-wiki-logo" href="index.html"
			title="Visit the main page"></a>
	</div>
	

<nav id="p-navigation" class="vector-menu mw-portlet mw-portlet-navigation vector-menu-portal portal" aria-labelledby="p-navigation-label" role="navigation"  >
	<h3
		id="p-navigation-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Navigation</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-mainpage" class="mw-list-item"><a href="index.html" title="Visit the main page [z]" accesskey="z"><span>Main Page</span></a></li><li id="n-portal" class="mw-list-item"><a href="http://forum.osdev.org/" rel="nofollow" title="About the project, what you can do, where to find things"><span>Forums</span></a></li><li id="n-FAQ" class="mw-list-item"><a href="./Category:FAQ"><span>FAQ</span></a></li><li id="n-OS-Projects" class="mw-list-item"><a href="Projects"><span>OS Projects</span></a></li><li id="n-randompage" class="mw-list-item"><a href="https://wiki.osdev.org/Special:Random" title="Load a random page [x]" accesskey="x"><span>Random page</span></a></li></ul>
		
	</div>
</nav>

	

<nav id="p-about" class="vector-menu mw-portlet mw-portlet-about vector-menu-portal portal" aria-labelledby="p-about-label" role="navigation"  >
	<h3
		id="p-about-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">About</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-This-site" class="mw-list-item"><a href="./OSDevWiki:About"><span>This site</span></a></li><li id="n-Joining" class="mw-list-item"><a href="./OSDevWiki:Joining"><span>Joining</span></a></li><li id="n-Editing-help" class="mw-list-item"><a href="./OSDevWiki:Editing"><span>Editing help</span></a></li><li id="n-recentchanges" class="mw-list-item"><a href="./Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r"><span>Recent changes</span></a></li></ul>
		
	</div>
</nav>


<nav id="p-tb" class="vector-menu mw-portlet mw-portlet-tb vector-menu-portal portal" aria-labelledby="p-tb-label" role="navigation"  >
	<h3
		id="p-tb-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Tools</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="t-whatlinkshere" class="mw-list-item"><a href="https://wiki.osdev.org/Special:WhatLinksHere/Higher_Half_x86_Bare_Bones_(Backup)" title="A list of all wiki pages that link here [j]" accesskey="j"><span>What links here</span></a></li><li id="t-recentchangeslinked" class="mw-list-item"><a href="https://wiki.osdev.org/Special:RecentChangesLinked/Higher_Half_x86_Bare_Bones_(Backup)" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k"><span>Related changes</span></a></li><li id="t-specialpages" class="mw-list-item"><a href="./Special:SpecialPages" title="A list of all special pages [q]" accesskey="q"><span>Special pages</span></a></li><li id="t-print" class="mw-list-item"><a href="javascript:print();" rel="alternate" title="Printable version of this page [p]" accesskey="p"><span>Printable version</span></a></li><li id="t-permalink" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;oldid=23056" title="Permanent link to this revision of this page"><span>Permanent link</span></a></li><li id="t-info" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;action=info" title="More information about this page"><span>Page information</span></a></li></ul>
		
	</div>
</nav>

	
</div>

</div>

<footer id="footer" class="mw-footer" role="contentinfo" >
	<ul id="footer-info">
	<li id="footer-info-lastmod"> This page was last edited on 27 October 2018, at 19:39.</li>
	<li id="footer-info-0">This page has been accessed 5,061 times.</li>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="./OSDev_Wiki:Privacy_policy">Privacy policy</a></li>
	<li id="footer-places-about"><a href="./OSDev_Wiki:About">About OSDev Wiki</a></li>
	<li id="footer-places-disclaimer"><a href="./OSDev_Wiki:General_disclaimer">Disclaimers</a></li>
	<li id="footer-places-mobileview"><a href="https://wiki.osdev.org/index.php?title=Higher_Half_x86_Bare_Bones_(Backup)&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"/></a></li>
</ul>

</footer>

<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.051","walltime":"0.705","ppvisitednodes":{"value":182,"limit":1000000},"postexpandincludesize":{"value":3387,"limit":2097152},"templateargumentsize":{"value":701,"limit":2097152},"expansiondepth":{"value":19,"limit":100},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":19073,"limit":5000000},"timingprofile":["100.00%    7.649      1 -total"," 50.69%    3.877      3 Template:If"," 49.30%    3.771      1 Template:Rating"," 43.93%    3.360      3 Template:Show1"," 19.34%    1.479      1 Template:Disputed"," 12.66%    0.968      3 Template:NoteBox"," 11.89%    0.910      3 Template:Eq"," 11.75%    0.899      1 Template:FirstPerson"," 11.17%    0.854      1 Template:TutorialExplain","  7.90%    0.604      1 Template:DiscussThis"]},"cachereport":{"timestamp":"20250211124642","ttl":86400,"transientcontent":false}}});mw.config.set({"wgBackendResponseTime":806});});</script>
</body>
</html>