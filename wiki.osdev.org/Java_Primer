<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>Java Primer - OSDev Wiki</title>
<script>document.documentElement.className="client-js";RLCONF={"wgBreakFrames":false,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"8b4cab6096c226c01187aeff","wgCSPNonce":false,"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Java_Primer","wgTitle":"Java Primer","wgCurRevisionId":28229,"wgRevisionId":28229,"wgArticleId":3849,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Pages using duplicate arguments in template calls","Pages using deprecated source tags","Level 3 Tutorials","Tutorials","Compilers","Languages","Java"],"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgRelevantPageName":"Java_Primer","wgRelevantArticleId":3849,"wgIsProbablyEditable":false,
"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgMFDisplayWikibaseDescriptions":{"search":false,"nearby":false,"watchlist":false,"tagline":false},"wgVisualEditor":{"pageLanguageCode":"en","pageLanguageDir":"ltr","pageVariantFallbacks":"en"},"wgVector2022PreviewPages":[],"wgMediaViewerOnClick":true,"wgMediaViewerEnabledByDefault":true,"wgEditSubmitButtonLabelPublish":false};RLSTATE={"site.styles":"ready","user.styles":"ready","user":"ready","user.options":"loading","ext.pygments":"ready","skins.vector.styles.legacy":"ready","ext.visualEditor.desktopArticleTarget.noscript":"ready","ext.DarkMode.styles":"ready"};RLPAGEMODULES=["site","mediawiki.page.ready","mediawiki.toc","skins.vector.legacy.js","ext.visualEditor.desktopArticleTarget.init","ext.visualEditor.targetLoader","mmv.head","mmv.bootstrap.autostart","ext.DarkMode","ext.moderation.notify","ext.moderation.ve","ext.moderation.ajaxhook","ext.moderation.notify.desktop"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.implement("user.options@12s5i",function($,jQuery,require,module){mw.user.tokens.set({"patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});});});</script>
<link rel="stylesheet" href="https://wiki.osdev.org/load.php?lang=en&amp;modules=ext.DarkMode.styles%7Cext.pygments%7Cext.visualEditor.desktopArticleTarget.noscript%7Cskins.vector.styles.legacy&amp;only=styles&amp;skin=vector"/>
<script async="" src="https://wiki.osdev.org/load.php?lang=en&amp;modules=startup&amp;only=scripts&amp;raw=1&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="https://wiki.osdev.org/load.php?lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.39.7"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="viewport" content="width=1000"/>
<link rel="icon" href="favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="OSDev Wiki (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="api.php?action=rsd"/>
<link rel="alternate" type="application/atom+xml" title="OSDev Wiki Atom feed" href="https://wiki.osdev.org/index.php?title=Special:RecentChanges&amp;feed=atom"/>
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Java_Primer rootpage-Java_Primer skin-vector action-view skin-vector-legacy vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled"><div id="mw-page-base" class="noprint"></div>
<div id="mw-head-base" class="noprint"></div>
<div id="content" class="mw-body" role="main">
	<a id="top"></a>
	<div id="siteNotice"></div>
	<div class="mw-indicators">
	</div>
	<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Java Primer</span></h1>
	<div id="bodyContent" class="vector-body">
		<div id="siteSub" class="noprint">From OSDev Wiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="Java_Primer#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="Java_Primer#searchInput">Jump to search</a>
		<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr"><div class="mw-parser-output"><table style="font-size:95%; line-height:1.5em; padding:0.25em; float:right; margin: 0 0 8px 15px; clear:right; border:1px solid #aaaaaa; background:#eee; text-align:center;;"><tbody><tr><th>Difficulty level</th></tr><tr><td><a href="./File:Difficulty_3.png" class="image"><img alt="Difficulty 3.png" src="images/c/c1/Difficulty_3.png" decoding="async" width="46" height="14" data-file-width="46" data-file-height="14" /></a><br />Advanced</td></tr></tbody></table>
<p>This is a demonstration tutorial of how you could write an OS using Java. The methods described in here however are quite generic - you can use similar approaches for other bytecoded languages, such as .NET. In addition, this article contains a simple compiler that can be a source of inspiration for any custom languages.
</p><p>Being a demonstration, the method posted here is exceedingly simple and only does the necessary work to make the bundled Java code run. It can not deal with most things one would expect from Java. It does not do garbage collection in any forms, let alone support strings. The code provided here is purposefully limited, so you can play with it a bit to get a feeling, but it is impossible to extend this code to support more key components of the language. 
</p><p>Consider this a throwaway prototype - <b>it's deliberately written in such a fashion that you're forced to rewrite a new one from scratch.</b>
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="Java_Primer#Supporting_a_non-native_language"><span class="tocnumber">1</span> <span class="toctext">Supporting a non-native language</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="Java_Primer#Compiler"><span class="tocnumber">2</span> <span class="toctext">Compiler</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="Java_Primer#HAL_and_Runtime"><span class="tocnumber">3</span> <span class="toctext">HAL and Runtime</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="Java_Primer#A_primitive_kernel"><span class="tocnumber">4</span> <span class="toctext">A primitive kernel</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="Java_Primer#Wrapping_it_all_together"><span class="tocnumber">5</span> <span class="toctext">Wrapping it all together</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="Java_Primer#Multiboot"><span class="tocnumber">5.1</span> <span class="toctext">Multiboot</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="Java_Primer#Linker_script"><span class="tocnumber">5.2</span> <span class="toctext">Linker script</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="Java_Primer#GRUB"><span class="tocnumber">5.3</span> <span class="toctext">GRUB</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="Java_Primer#Build_instructions"><span class="tocnumber">5.4</span> <span class="toctext">Build instructions</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Supporting_a_non-native_language">Supporting a non-native language</span></h2>
<p>Since you have much less to leech from existing compilers, you essentially are in charge of the entire toolchain. There are a number of rough steps:
</p>
<ul><li><b>Define your native ABI</b></li></ul>
<dl><dd><dl><dd>Java and .NET come in bytecode, which are designed for machines that are fundamentally different than your typical register-based hardware. You'll need to understand assembly for your platform, and you'll have to think about how the language structures should be converted to native ones. One of the things this example does is to adhere to the stdcall convention, because it's closer to the virtual java machine than the cdecl that's the default in most compilers.</dd></dl></dd></dl>
<ul><li><b>Create bytecode-to-native compiler</b></li></ul>
<dl><dd><dl><dd>Java comes in bytecode form, and we need a method of converting it to native. Because we are writing an OS at the same time, everything must be compiled ahead of time, and not rely on an existing runtime that expects the existing presence of an OS. Therefore, we write our own compiler. As part of the compiler, we include the org.objectweb.asm that can read .class files and save us from writing significant portions of code.</dd></dl></dd></dl>
<ul><li><b>Compile the compiler</b></li></ul>
<dl><dd><dl><dd>The compiler is of course written in Java as well. We don't need additional languages to add to the bootstrap problem later. Of course this compiler is overly simplistic, and will never be able to compile itself.</dd></dl></dd></dl>
<ul><li><b>Compile managed os to bytecode</b></li></ul>
<dl><dd><dl><dd>Javac is written in Java, so that's obviously the best choice for later porting.</dd></dl></dd></dl>
<ul><li><b>Compile bytecode to native assembly</b></li></ul>
<dl><dd><dl><dd>Now that we have the compiler, we can run it on all our OS classes to generate native code.</dd></dl></dd></dl>
<ul><li><b>Create runtime for things that have to be non-native</b></li></ul>
<dl><dd><dl><dd>Java is memory-safe, which prevents it from implementing a lot of things. A minimal set of startup code is done in native assembly. Everything architecture-specific has to be done in assembly. Some parts you'll need later, such as memory management and exception handling are probably easier to have pure native parts for as well.</dd></dl></dd></dl>
<ul><li><b>Assemble os and runtime</b></li></ul>
<dl><dd><dl><dd>We have everything in machine language form now. We're still reuseing the parts that we can, and in this example we use yasm. You're free to write an assembler in Java later on.</dd></dl></dd></dl>
<ul><li><b>package the final kernel binary</b></li></ul>
<dl><dd><dl><dd>This is done using binutils. Note that there is not a single C compiler in the chain, and again, you can build your own linker in your language - it doesn't really have to do that much.</dd></dl></dd></dl>
<p><br />
</p>
<h2><span class="mw-headline" id="Compiler">Compiler</span></h2>
<p>In bytecoded languages there are several steps before code can be run. Typically you have "the" compiler, which converts your source files into some portable binary, and you have an interpreter that reads those binaries and runs instructions from them. Modern interpreters turn bytecode into native code, as to avoid the <tt>if(instruction = ...)</tt> that takes several cycles while the instruction you'd actually want to execute would otherwise cost you just one CPU instruction. 
</p><p>In the case of an OS, we need to take this a step further. We could run an interpreter, but that's slow. We could compile into native on boot but that needs just as much OS as we actually want to run. Instead, the appropriate solution is to compile to native in advance, so we can just run the code directly from the start.
</p><p>The entirety of a language is still a whole lot to deal with, but for our example it suffices to deal with just integers. That's right, no objects yet!
</p><p>The Java bytecode uses a stack for operations, and a list of locals. These need not be in the same place, but as the x86 only has one hardware stack, we'll be using it as both local stack, call stack, and operation stack. A few tricks are used to make this compiler easier, and in turn, make it difficult to interface with C. Locals in Java terms include the function arguments, and as a result the locals would be split around return addresses. Since the caller doesn't know the storage needed - it doesn't even get the number of arguments for free - the called function should fix this. We also can't put things past the top of the stack because that'll be a big issue with interrupts later. Basically we copy all arguments to the other side of the return address and then we make some room for locals so that they can be indexed by <tt>EBP - 4 * slot_number</tt> where for instance 0 and 1 would be arguments and 2+ would be true locals.
</p><p>The fact that getting the number of arguments is convoluted to perform on the caller's side, we do callee-cleanup using <tt>RET imm</tt> instead of the regular <tt>RET</tt>. Locals is a convoluted issue as well, so we just reserve room for 8 because you're not meant to copy this code anyway.
</p>
<div class="mw-highlight mw-highlight-lang-java mw-content-ltr" dir="ltr"><pre><span></span><span class="c1">// File: compiler/nl/combuster/minijava/Compiler.java</span>
<span class="kn">package</span> <span class="nn">nl.combuster.minijava</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.objectweb.asm.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.objectweb.asm.tree.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Compiler</span>
<span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">readEntireFile</span><span class="p">(</span><span class="n">String</span> <span class="n">filename</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
        <span class="k">try</span> 
        <span class="p">{</span>
            <span class="n">FileInputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
            <span class="kt">byte</span> <span class="n">bytes</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">file</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>
            <span class="n">input</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Unable to read file &quot;</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">writeOutput</span><span class="p">(</span><span class="n">String</span> <span class="n">filename</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">lines</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span> 
        <span class="p">{</span>
            <span class="n">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedWriter</span><span class="p">(</span><span class="k">new</span> <span class="n">FileWriter</span><span class="p">(</span><span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">)));</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">string</span> <span class="p">:</span> <span class="n">lines</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
                <span class="n">writer</span><span class="p">.</span><span class="na">newLine</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">writer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Unable to write output file &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">String</span> <span class="n">classname</span><span class="p">,</span> <span class="n">String</span> <span class="n">method</span><span class="p">,</span> <span class="n">String</span> <span class="n">signature</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// make all these assembly-friendly names. Note that the </span>
        <span class="c1">// constructor is for instance called &lt;init&gt;</span>
        <span class="k">return</span> <span class="n">classname</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;__&quot;</span> <span class="o">+</span> <span class="n">method</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">).</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">jumpgroup</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">output</span><span class="p">,</span> <span class="n">String</span> <span class="n">jumpcode</span><span class="p">,</span> <span class="n">LabelNode</span> <span class="n">dest</span><span class="p">)</span>
    <span class="p">{</span>
    	<span class="n">output</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;pop edx&quot;</span><span class="p">);</span>
    	<span class="n">output</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;pop ecx&quot;</span><span class="p">);</span>
    	<span class="n">output</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;cmp ecx, edx&quot;</span><span class="p">);</span>
    	<span class="n">output</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">jumpcode</span> <span class="o">+</span> <span class="s">&quot; .l&quot;</span> <span class="o">+</span> <span class="n">dest</span><span class="p">.</span><span class="na">getLabel</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Usage: compiler input-file output-file&quot;</span><span class="p">);</span>

        <span class="n">ClassNode</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassNode</span><span class="p">();</span>
        <span class="n">ClassReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassReader</span><span class="p">(</span><span class="n">readEntireFile</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">));</span>
        <span class="n">reader</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">outputdata</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>

        <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;section .text&quot;</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">MethodNode</span> <span class="n">method</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="na">methods</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">method</span><span class="p">.</span><span class="na">visitCode</span><span class="p">();</span>
            <span class="n">String</span> <span class="n">methodname</span> <span class="o">=</span> <span class="n">decorate</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">name</span><span class="p">,</span> <span class="n">method</span><span class="p">.</span><span class="na">name</span><span class="p">,</span> <span class="n">method</span><span class="p">.</span><span class="na">signature</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">method</span><span class="p">.</span><span class="na">access</span> <span class="o">&amp;</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ACC_NATIVE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

            <span class="c1">// prologue</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;; attributes: &quot;</span> <span class="o">+</span> <span class="n">method</span><span class="p">.</span><span class="na">attrs</span><span class="p">);</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;global &quot;</span> <span class="o">+</span> <span class="n">methodname</span><span class="p">);</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">methodname</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="p">);</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;push ebp&quot;</span><span class="p">);</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;mov ebp, esp&quot;</span><span class="p">);</span>

            <span class="kt">int</span> <span class="n">locals</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">localVariables</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">method</span><span class="p">.</span><span class="na">localVariables</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;; locals: + &quot;</span> <span class="o">+</span> <span class="n">locals</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">parameters</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">method</span><span class="p">.</span><span class="na">parameters</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">method</span><span class="p">.</span><span class="na">access</span> <span class="o">&amp;</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ACC_STATIC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">arguments</span><span class="o">++</span><span class="p">;</span> <span class="c1">// hidden &quot;this&quot;</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;; params: + &quot;</span> <span class="o">+</span> <span class="n">arguments</span><span class="p">);</span>
            <span class="c1">// copy params so that they correspond with java indexing and join with the local numbering</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arguments</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;push dword [ebp + &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// do some frame checking for many variables, locals is not of much use...</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;sub esp, 32&quot;</span><span class="p">);</span>

            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">AbstractInsnNode</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">method</span><span class="p">.</span><span class="na">instructions</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span>
            <span class="p">{</span>     
                <span class="n">AbstractInsnNode</span> <span class="n">insn</span> <span class="o">=</span> <span class="n">iterator</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
                <span class="kt">int</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
                <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;   &#160;; &quot;</span> <span class="o">+</span> <span class="n">opcode</span> <span class="o">+</span> <span class="s">&quot; = &quot;</span> <span class="o">+</span> <span class="n">insn</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getSimpleName</span><span class="p">());</span>
                <span class="c1">//outputdata.add(&quot;mov byte [&quot; + (0xb8000 + 156) + &quot;], &#39;0&#39; + &quot; + (opcode&#160;% 10));</span>
                <span class="c1">//outputdata.add(&quot;mov byte [&quot; + (0xb8000 + 154) + &quot;], &#39;0&#39; + &quot; + (opcode / 10)%10);</span>
                <span class="c1">//outputdata.add(&quot;mov byte [&quot; + (0xb8000 + 152) + &quot;], &#39;0&#39; + &quot; + (opcode / 100));</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">LabelNode</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">LabelNode</span> <span class="n">labelinsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">LabelNode</span><span class="p">)</span><span class="n">insn</span><span class="p">;</span>
                    <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;.l&quot;</span> <span class="o">+</span> <span class="n">labelinsn</span><span class="p">.</span><span class="na">getLabel</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">LineNumberNode</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// ignore these</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">VarInsnNode</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// copy a variable</span>
                    <span class="n">VarInsnNode</span> <span class="n">varinsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">VarInsnNode</span><span class="p">)</span> <span class="n">insn</span><span class="p">;</span>
                    <span class="k">switch</span><span class="p">(</span><span class="n">varinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ILOAD</span><span class="p">:</span>
                        <span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ALOAD</span><span class="p">:</span>
                            <span class="c1">// todo: verify offset</span>
                            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;push dword [ebp - &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">varinsn</span><span class="p">.</span><span class="na">var</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                            
                        <span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ISTORE</span><span class="p">:</span>
                        <span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ASTORE</span><span class="p">:</span>
                            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;pop dword [ebp - &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">varinsn</span><span class="p">.</span><span class="na">var</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>

                        <span class="k">default</span><span class="p">:</span>
                            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;Can&#39;t deal with varinsnnode: &quot;</span> <span class="o">+</span> <span class="n">varinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">());</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">MethodInsnNode</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">MethodInsnNode</span> <span class="n">methodinsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">MethodInsnNode</span><span class="p">)</span> <span class="n">insn</span><span class="p">;</span>
                    <span class="n">String</span> <span class="n">calledmethod</span> <span class="o">=</span> <span class="n">decorate</span><span class="p">(</span><span class="n">methodinsn</span><span class="p">.</span><span class="na">owner</span><span class="p">,</span> <span class="n">methodinsn</span><span class="p">.</span><span class="na">name</span><span class="p">,</span> <span class="n">methodinsn</span><span class="p">.</span><span class="na">desc</span><span class="p">);</span>
                    <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;extern &quot;</span> <span class="o">+</span> <span class="n">calledmethod</span><span class="p">);</span>
                    <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;call &quot;</span> <span class="o">+</span> <span class="n">calledmethod</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">methodinsn</span><span class="p">.</span><span class="na">desc</span><span class="p">.</span><span class="na">endsWith</span><span class="p">(</span><span class="s">&quot;V&quot;</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="c1">// not a void return value</span>
                        <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;push eax&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="cm">/*switch (methodinsn.getOpcode())</span>
<span class="cm">                    {</span>
<span class="cm">                        default:</span>
<span class="cm">                            outputdata.add(&quot;Can&#39;t deal with methodcall: &quot; + methodinsn.getOpcode());</span>
<span class="cm">                    }*/</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">IntInsnNode</span><span class="p">)</span>
                <span class="p">{</span>
                	<span class="n">IntInsnNode</span> <span class="n">intinsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">IntInsnNode</span><span class="p">)</span><span class="n">insn</span><span class="p">;</span>
                    <span class="k">switch</span><span class="p">(</span><span class="n">intinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">BIPUSH</span><span class="p">:</span>
                            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;push &quot;</span> <span class="o">+</span> <span class="n">intinsn</span><span class="p">.</span><span class="na">operand</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>

                        <span class="k">default</span><span class="p">:</span>
                            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;Can&#39;t deal with intinsnnode: &quot;</span> <span class="o">+</span> <span class="n">intinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">());</span>
                    <span class="p">}</span>
                	
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">JumpInsnNode</span><span class="p">)</span>
                <span class="p">{</span>
                	<span class="n">JumpInsnNode</span> <span class="n">jmpinsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">JumpInsnNode</span><span class="p">)</span><span class="n">insn</span><span class="p">;</span>
                	
                    <span class="k">switch</span><span class="p">(</span><span class="n">jmpinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">())</span>
                    <span class="p">{</span>
                    	<span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IF_ICMPEQ</span><span class="p">:</span>		<span class="n">jumpgroup</span><span class="p">(</span><span class="n">outputdata</span><span class="p">,</span> <span class="s">&quot;je&quot;</span><span class="p">,</span> <span class="n">jmpinsn</span><span class="p">.</span><span class="na">label</span><span class="p">);</span> 	<span class="k">break</span><span class="p">;</span> <span class="c1">// 159</span>
                    	<span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IF_ICMPNE</span><span class="p">:</span>		<span class="n">jumpgroup</span><span class="p">(</span><span class="n">outputdata</span><span class="p">,</span> <span class="s">&quot;jne&quot;</span><span class="p">,</span> <span class="n">jmpinsn</span><span class="p">.</span><span class="na">label</span><span class="p">);</span> 	<span class="k">break</span><span class="p">;</span> <span class="c1">// 160                    	</span>
                    	<span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IF_ICMPLT</span><span class="p">:</span>		<span class="n">jumpgroup</span><span class="p">(</span><span class="n">outputdata</span><span class="p">,</span> <span class="s">&quot;jb&quot;</span><span class="p">,</span> <span class="n">jmpinsn</span><span class="p">.</span><span class="na">label</span><span class="p">);</span> 	<span class="k">break</span><span class="p">;</span> <span class="c1">// 161</span>
                    	<span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IF_ICMPGE</span><span class="p">:</span>		<span class="n">jumpgroup</span><span class="p">(</span><span class="n">outputdata</span><span class="p">,</span> <span class="s">&quot;jae&quot;</span><span class="p">,</span> <span class="n">jmpinsn</span><span class="p">.</span><span class="na">label</span><span class="p">);</span> 	<span class="k">break</span><span class="p">;</span> <span class="c1">// 162</span>
                    	<span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IF_ICMPGT</span><span class="p">:</span>		<span class="n">jumpgroup</span><span class="p">(</span><span class="n">outputdata</span><span class="p">,</span> <span class="s">&quot;ja&quot;</span><span class="p">,</span> <span class="n">jmpinsn</span><span class="p">.</span><span class="na">label</span><span class="p">);</span> 	<span class="k">break</span><span class="p">;</span> <span class="c1">// 163</span>
                    	<span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IF_ICMPLE</span><span class="p">:</span>		<span class="n">jumpgroup</span><span class="p">(</span><span class="n">outputdata</span><span class="p">,</span> <span class="s">&quot;jbe&quot;</span><span class="p">,</span> <span class="n">jmpinsn</span><span class="p">.</span><span class="na">label</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span> <span class="c1">// 164</span>
                    
                        <span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">GOTO</span><span class="p">:</span> <span class="c1">// 167</span>
                            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;jmp .l&quot;</span> <span class="o">+</span> <span class="n">jmpinsn</span><span class="p">.</span><span class="na">label</span><span class="p">.</span><span class="na">getLabel</span><span class="p">());</span>
                            <span class="k">break</span><span class="p">;</span>

                        <span class="k">default</span><span class="p">:</span>
                            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;Can&#39;t deal with jumpinsnnode: &quot;</span> <span class="o">+</span> <span class="n">jmpinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">());</span>
                    <span class="p">}</span>
                <span class="p">}</span>   
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">LdcInsnNode</span><span class="p">)</span>
                <span class="p">{</span>
                	<span class="n">LdcInsnNode</span> <span class="n">ldcinsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">LdcInsnNode</span><span class="p">)</span> <span class="n">insn</span><span class="p">;</span>
                	<span class="k">if</span> <span class="p">(</span><span class="n">ldcinsn</span><span class="p">.</span><span class="na">cst</span> <span class="k">instanceof</span> <span class="n">Integer</span><span class="p">)</span>
                	<span class="p">{</span>
                		<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;push &quot;</span> <span class="o">+</span> <span class="n">ldcinsn</span><span class="p">.</span><span class="na">cst</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
                	<span class="p">}</span>
                	<span class="k">else</span>
                	<span class="p">{</span>
	                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;Can&#39;t deal with data in ldcinsnnode (&quot;</span> <span class="o">+</span> <span class="n">ldcinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">+</span><span class="s">&quot;): &quot;</span> <span class="o">+</span> <span class="n">ldcinsn</span><span class="p">.</span><span class="na">cst</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getSimpleName</span><span class="p">());</span>
                	<span class="p">}</span>
                <span class="p">}</span>             
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">IincInsnNode</span><span class="p">)</span>
                <span class="p">{</span>
                	<span class="n">IincInsnNode</span> <span class="n">incinsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">IincInsnNode</span><span class="p">)</span> <span class="n">insn</span><span class="p">;</span>
                	<span class="k">switch</span> <span class="p">(</span><span class="n">incinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">())</span>
                	<span class="p">{</span>	
                	    <span class="k">case</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IINC</span><span class="p">:</span>
                	    	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;add dword [ebp - &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">incinsn</span><span class="p">.</span><span class="na">var</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;], &quot;</span> <span class="o">+</span> <span class="n">incinsn</span><span class="p">.</span><span class="na">incr</span><span class="p">);</span>
                	    	<span class="k">break</span><span class="p">;</span>
                		<span class="k">default</span><span class="p">:</span>
                			<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;Can&#39;t deal with iincinsnnode: &quot;</span> <span class="o">+</span> <span class="n">incinsn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">());</span>                			
                	<span class="p">}</span>
                	
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ICONST_M1</span> <span class="o">&amp;&amp;</span> <span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ICONST_5</span><span class="p">)</span> <span class="c1">// 2...8</span>
                <span class="p">{</span>
                    <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;push &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">-</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">ICONST_M1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IADD</span><span class="p">)</span> <span class="c1">// 96</span>
                <span class="p">{</span>
                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;pop edx&quot;</span><span class="p">);</span>
                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;add [esp], edx&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">IMUL</span><span class="p">)</span> <span class="c1">// 104</span>
                <span class="p">{</span>
                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;pop eax&quot;</span><span class="p">);</span>
                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;pop ecx&quot;</span><span class="p">);</span>
                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;imul ecx&quot;</span><span class="p">);</span> <span class="c1">// eax:edx = eax * ecx</span>
                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;push eax&quot;</span><span class="p">);</span>
                <span class="p">}</span>                
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">I2B</span><span class="p">)</span> <span class="c1">// 145</span>
                <span class="p">{</span>
                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;and dword [esp], 0xff&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">RETURN</span><span class="p">)</span>	<span class="c1">// 177</span>
                <span class="p">{</span>
                	<span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;xor eax, eax&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="k">instanceof</span> <span class="n">FrameNode</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;; framenode&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;Can&#39;t deal with &quot;</span> <span class="o">+</span> <span class="n">insn</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getSimpleName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;, fix it (&quot;</span> <span class="o">+</span> <span class="n">insn</span><span class="p">.</span><span class="na">getOpcode</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// epilogue, stdcall to save complexity on decoding methodinsns</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;leave&quot;</span><span class="p">);</span>
            <span class="n">outputdata</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;ret &quot;</span> <span class="o">+</span> <span class="n">arguments</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">writeOutput</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">outputdata</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Yes, that's a compiler in a magic 256 lines of code. The result is Intel syntax assembly, because there already are decent tools for assembly out there that deal with object formats out there. Of course you can write your own later as well.
</p>
<h2><span class="mw-headline" id="HAL_and_Runtime">HAL and Runtime</span></h2>
<p>Almost no programming language has standard constructs for all the things a processor can do, in particular not languages that were designed to be portable and memory-safe. For that reason we are required to add support for that outside of the language. Fortunately, Java does come with one construct specifically design to wrap the language to platform specifics: <tt>native</tt>
</p>
<div class="mw-highlight mw-highlight-lang-java mw-content-ltr" dir="ltr"><pre><span></span><span class="c1">// File: os/nl/combuster/minijavaos/Hal.java</span>
<span class="kn">package</span> <span class="nn">nl.combuster.minijavaos</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hal</span>
<span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">poke</span><span class="p">(</span><span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">byte</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>At some point the OS needs to access memory unsafely, and this is the method we'll use. The native keyword also implies that there is no implementation in java and that it'll come from elsewhere.
</p><p>There are more things that might be difficult to do in straight Java: this example omits memory management in its entirety, but there is still a quirk: Every object subclasses from java.lang.Object. To make matters more complicated, the compiler does not allow us to write java.lang classes in Java. In this case it's a particular chicken-and-egg problem: how would we even compile a class that extends itself? We are in some way forced to treat java.lang.Object special, and basically use its constructor as a terminator for a constructor chain. At a later stage, we might even want to do something more in there, but for now we don't need to. The first piece of native support code deals with these problems:
</p>
<div class="mw-highlight mw-highlight-lang-asm mw-content-ltr" dir="ltr"><pre><span></span><span class="c1">; File: os/hal.asm</span>
<span class="nf">section</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>

<span class="nf">global</span><span class="w"> </span><span class="no">java_lang_Object___init_</span><span class="w"></span>
<span class="nf">global</span><span class="w"> </span><span class="no">nl_combuster_minijavaos_Hal__poke</span><span class="w"></span>

<span class="nl">java_lang_Object___init_:</span><span class="w"></span>
<span class="w">	</span><span class="nf">ret</span><span class="w"></span>

<span class="nl">nl_combuster_minijavaos_Hal__poke:</span><span class="w"></span>
<span class="w">	</span><span class="nf">mov</span><span class="w"> </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span><span class="w"></span>
<span class="w">	</span><span class="nf">mov</span><span class="w"> </span><span class="no">dl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">4</span><span class="p">]</span><span class="w"></span>
<span class="w">	</span><span class="nf">mov</span><span class="w"> </span><span class="p">[</span><span class="no">eax</span><span class="p">],</span><span class="w"> </span><span class="no">dl</span><span class="w"></span>
<span class="w">	</span><span class="nf">ret</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
</pre></div>
<h2><span class="mw-headline" id="A_primitive_kernel">A primitive kernel</span></h2>
<p>"Hello world!" is a very overrated thing. Or is it? Strings are a full-blown object in Java, and passing objects safely is one of the things skipped in the compiler itself. Instead, we can count our numbers to show what we have actually works:
</p>
<div class="mw-highlight mw-highlight-lang-java mw-content-ltr" dir="ltr"><pre><span></span><span class="kn">package</span> <span class="nn">nl.combuster.minijavaos</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Kernel</span>
<span class="p">{</span>
    <span class="kd">public</span> <span class="nf">Kernel</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg1</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">kmain</span><span class="p">()</span>
    <span class="p">{</span>            
    	
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Hal</span><span class="p">.</span><span class="na">poke</span><span class="p">(</span><span class="mh">0xB8000</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>     <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
            <span class="n">Hal</span><span class="p">.</span><span class="na">poke</span><span class="p">(</span><span class="mh">0xB8000</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="mh">0x1F</span><span class="p">);</span> 
        <span class="p">}</span>                
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>This is little more than some simple VGA code, but it demonstrates that we can call Java code, do some calculations, and then call our hardware abstraction layer to complete the little bits Java just couldn't do.
</p>
<h2><span class="mw-headline" id="Wrapping_it_all_together">Wrapping it all together</span></h2>
<p>The last thing we need to do is to glue all the pieces together and stick a bootloader on top of it. <a href="Bare_Bones" title="Bare Bones">Bare Bones</a> has a more extensive description of the process. You might have noticed the full filenames in the source files above, basically we have two projects fairly tightly intertwined with each other, residing in the compiler and os subfolders that serve as the Java source root at the same time. A build folder is added so that you can simply delete that folder to start fresh, without having to worry about finding all your intermediates in between the real sources. In particular, we wouldn't be able to tell which .asm file is original and which one is compiler output without it! 
</p>
<h4><span class="mw-headline" id="Multiboot">Multiboot</span></h4>
<p>We use GRUB as a bootloader, so the mechanics are the same. The only real difference is that we have to cope with the name mangling and be unable to call something kmain.
</p>
<div class="mw-highlight mw-highlight-lang-asm mw-content-ltr" dir="ltr"><pre><span></span><span class="c1">; File: os/multiboot.asm</span>

<span class="c1">; Declare constants used for creating a multiboot header.</span>
<span class="nf">MBALIGN</span><span class="w">     </span><span class="no">equ</span><span class="w">  </span><span class="mi">1</span><span class="err">&lt;&lt;</span><span class="mi">0</span><span class="w">                   </span><span class="c1">; align loaded modules on page boundaries</span>
<span class="nf">MEMINFO</span><span class="w">     </span><span class="no">equ</span><span class="w">  </span><span class="mi">1</span><span class="err">&lt;&lt;</span><span class="mi">1</span><span class="w">                   </span><span class="c1">; provide memory map</span>
<span class="nf">FLAGS</span><span class="w">       </span><span class="no">equ</span><span class="w">  </span><span class="no">MBALIGN</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="no">MEMINFO</span><span class="w">      </span><span class="c1">; this is the Multiboot &#39;flag&#39; field</span>
<span class="nf">MAGIC</span><span class="w">       </span><span class="no">equ</span><span class="w">  </span><span class="mi">0x1BADB002</span><span class="w">             </span><span class="c1">; &#39;magic number&#39; lets bootloader find the header</span>
<span class="nf">CHECKSUM</span><span class="w">    </span><span class="no">equ</span><span class="w"> </span><span class="p">-(</span><span class="no">MAGIC</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">FLAGS</span><span class="p">)</span><span class="w">        </span><span class="c1">; checksum of above, to prove we are multiboot</span>
<span class="w"> </span>
<span class="c1">; Declare a header as in the Multiboot Standard.</span>
<span class="nf">section</span><span class="w"> </span><span class="no">.multiboot</span><span class="w"></span>
<span class="nf">align</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">	</span><span class="nf">dd</span><span class="w"> </span><span class="no">MAGIC</span><span class="w"></span>
<span class="w">	</span><span class="nf">dd</span><span class="w"> </span><span class="no">FLAGS</span><span class="w"></span>
<span class="w">	</span><span class="nf">dd</span><span class="w"> </span><span class="no">CHECKSUM</span><span class="w"></span>
<span class="w"> </span>
<span class="c1">; We&#39;ll need a stack</span>
<span class="nf">section</span><span class="w"> </span><span class="no">.bootstrap_stack</span><span class="p">,</span><span class="w"> </span><span class="no">nobits</span><span class="w"></span>
<span class="nf">align</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="nl">stack_bottom:</span><span class="w"></span>
<span class="nf">resb</span><span class="w"> </span><span class="mi">16384</span><span class="w"></span>
<span class="nl">stack_top:</span><span class="w"></span>
<span class="w"> </span>
<span class="c1">; Kernel entry point</span>
<span class="nf">section</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>
<span class="nf">global</span><span class="w"> </span><span class="no">_start</span><span class="w"></span>
<span class="nl">_start:</span><span class="w"></span>
<span class="w">	</span><span class="nf">mov</span><span class="w"> </span><span class="no">esp</span><span class="p">,</span><span class="w"> </span><span class="no">stack_top</span><span class="w"></span>

<span class="w">	</span><span class="nf">extern</span><span class="w"> </span><span class="no">nl_combuster_minijavaos_Kernel__kmain</span><span class="w"></span>
<span class="w">	</span><span class="nf">call</span><span class="w"> </span><span class="no">nl_combuster_minijavaos_Kernel__kmain</span><span class="w"></span>
<span class="w"> </span>
<span class="w">	</span><span class="nf">cli</span><span class="w"></span>
<span class="nl">.hang:</span><span class="w"></span>
<span class="w">	</span><span class="c1">;hlt</span>
<span class="w">	</span><span class="nf">jmp</span><span class="w"> </span><span class="no">.hang</span><span class="w"></span>
</pre></div>
<h4><span class="mw-headline" id="Linker_script">Linker script</span></h4>
<p>Linking also happens with the same script as <a href="Bare_Bones" title="Bare Bones">Bare Bones</a>
</p>
<div class="mw-highlight mw-highlight-lang-c mw-content-ltr" dir="ltr"><pre><span></span><span class="cm">/* File: os/linker.ld */</span><span class="w"></span>
<span class="cm">/* The bootloader will look at this image and start execution at the symbol</span>
<span class="cm">   designated as the entry point. */</span><span class="w"></span>
<span class="n">ENTRY</span><span class="p">(</span><span class="n">_start</span><span class="p">)</span><span class="w"></span>

<span class="cm">/* Tell where the various sections of the object files will be put in the final</span>
<span class="cm">   kernel image. */</span><span class="w"></span>
<span class="n">SECTIONS</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* Begin putting sections at 1 MiB, a conventional place for kernels to be</span>
<span class="cm">	   loaded at by the bootloader. */</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="n">M</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* First put the multiboot header, as it is required to be put very early</span>
<span class="cm">	   early in the image or the bootloader won&#39;t recognize the file format.</span>
<span class="cm">	   Next we&#39;ll put the .text section. */</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">text</span><span class="w"> </span><span class="n">BLOCK</span><span class="p">(</span><span class="mi">4</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="n">K</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="o">*</span><span class="p">(.</span><span class="n">multiboot</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Read-only data. */</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">rodata</span><span class="w"> </span><span class="n">BLOCK</span><span class="p">(</span><span class="mi">4</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="n">K</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="o">*</span><span class="p">(.</span><span class="n">rodata</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Read-write data (initialized) */</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="n">BLOCK</span><span class="p">(</span><span class="mi">4</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="n">K</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="o">*</span><span class="p">(.</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Read-write data (uninitialized) and stack */</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">bss</span><span class="w"> </span><span class="n">BLOCK</span><span class="p">(</span><span class="mi">4</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="n">K</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="o">*</span><span class="p">(</span><span class="n">COMMON</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="o">*</span><span class="p">(.</span><span class="n">bss</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="o">*</span><span class="p">(.</span><span class="n">bootstrap_stack</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* The compiler may produce other sections, by default it will put them in</span>
<span class="cm">	   a segment with the same name. Simply add stuff here as needed. */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<h4><span class="mw-headline" id="GRUB">GRUB</span></h4>
<p>Some configuration files for GRUB legacy. Doing this with a CD is the easiest way, really:
</p>
<div class="mw-highlight mw-highlight-lang-bash mw-content-ltr" dir="ltr"><pre><span></span><span class="c1"># </span>
<span class="c1"># File: os/grub.cfg</span>
<span class="c1">#</span>
default <span class="m">0</span>
timeout <span class="m">30</span>

<span class="c1"># For booting GNU/Linux</span>
title Java OS 
root <span class="o">(</span><span class="nb">cd</span><span class="o">)</span>
kernel <span class="o">(</span><span class="nb">cd</span><span class="o">)</span>/kernel
</pre></div>
<h4><span class="mw-headline" id="Build_instructions">Build instructions</span></h4>
<p>To simplify things, here's the Makefile that glues all the steps together. This one is a bit more elaborate as it covers for pretty much all the intermediate steps needed. Compile the compiler, make an executable jar file, compile the java files to class files, to assembly files, to object files, to an ELF binary. Include the runtime halfway into the process, then build a CD image with GRUB. 
</p><p>In this example, GRUB is assumed to be preinstalled in /boot where it resides by default on a linux system that has it installed. We also need mkisofs and the binutils step from the <a href="GCC_Cross-Compiler" title="GCC Cross-Compiler">GCC Cross-Compiler</a>. Of course, at some point in time you can decide to write these tools in Java as well
</p>
<div class="mw-highlight mw-highlight-lang-make mw-content-ltr" dir="ltr"><pre><span></span><span class="nv">COMPILER_J</span><span class="o">=</span><span class="k">$(</span>shell find -L compiler -iname <span class="s1">&#39;*.java&#39;</span><span class="k">)</span>
<span class="nv">COMPILER_C</span><span class="o">=</span><span class="k">$(</span>addprefix build/,<span class="k">$(</span>patsubst&#160;%.java,%.class,<span class="k">$(</span>COMPILER_J<span class="k">)))</span>

<span class="nv">OS_J</span><span class="o">:=</span><span class="k">$(</span>shell find -L os -iname <span class="s1">&#39;*.java&#39;</span><span class="k">)</span>
<span class="nv">OS_C</span><span class="o">:=</span><span class="k">$(</span>addprefix build/,<span class="k">$(</span>patsubst&#160;%.java,%.class,<span class="k">$(</span>OS_J<span class="k">)))</span>
<span class="nv">OS_A</span><span class="o">:=</span><span class="k">$(</span>patsubst&#160;%.class,%.asm,<span class="k">$(</span>OS_C<span class="k">))</span> 
<span class="nv">RT_A</span><span class="o">:=</span><span class="k">$(</span>shell find -L os -iname <span class="s1">&#39;*.asm&#39;</span><span class="k">)</span>
<span class="nv">OS_O</span><span class="o">:=</span><span class="k">$(</span>patsubst&#160;%.asm,%.o,<span class="k">$(</span>OS_A<span class="k">))</span>
<span class="nv">RT_O</span><span class="o">:=</span><span class="k">$(</span>addprefix build/,<span class="k">$(</span>patsubst&#160;%.asm,%.o,<span class="k">$(</span>RT_A<span class="k">)))</span>

<span class="nf">default</span><span class="o">:</span> <span class="n">build</span>/<span class="n">compiler</span>.<span class="n">jar</span> <span class="n">build</span>/<span class="n">kernel</span> <span class="n">build</span>/<span class="n">image</span>.<span class="n">iso</span>
	<span class="nb">echo</span> <span class="k">done</span> compiling

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">default</span>

<span class="nf">build/.dir</span><span class="o">:</span> 
	mkdir -p build/compiler
	mkdir -p build/os
	touch build/.dir

<span class="nf">build/compiler.jar</span><span class="o">:</span> <span class="k">$(</span><span class="nv">COMPILER_C</span><span class="k">)</span> <span class="n">compiler</span>/<span class="n">compiler</span>.<span class="n">manifest</span>
	jar cvfm <span class="nv">$@</span> compiler/compiler.manifest -C build/compiler .

<span class="nf">build/compiler/%.class</span><span class="o">:</span> <span class="n">compiler</span>/%.<span class="n">java</span> <span class="n">build</span>/.<span class="n">dir</span>
	javac -d build/compiler -sourcepath compiler $&lt;

<span class="nf">build/os/%.class</span><span class="o">:</span> <span class="n">os</span>/%.<span class="n">java</span> <span class="n">build</span>/.<span class="n">dir</span>
	javac -d build/os -sourcepath os $&lt;

<span class="nf">%.asm</span><span class="o">:</span>%.<span class="n">class</span> <span class="n">build</span>/<span class="n">compiler</span>.<span class="n">jar</span>
	java -jar build/compiler.jar $&lt; <span class="nv">$@</span>

<span class="nf">%.o</span><span class="o">:</span>%.<span class="n">asm</span>
	yasm -f elf -o <span class="nv">$@</span> $&lt;

<span class="nf">build/os/%.o</span><span class="o">:</span> <span class="n">os</span>/%.<span class="n">asm</span> <span class="n">build</span>/.<span class="n">dir</span>
	yasm -f elf -o <span class="nv">$@</span> $&lt;

<span class="nf">build/kernel</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OS_O</span><span class="k">)</span> <span class="k">$(</span><span class="nv">RT_O</span><span class="k">)</span>
	i586-elf-ld -o <span class="nv">$@</span> -T os/linker.ld <span class="k">$(</span>OS_O<span class="k">)</span> <span class="k">$(</span>RT_O<span class="k">)</span>

<span class="nf">build/image.iso</span><span class="o">:</span> <span class="n">build</span>/<span class="n">kernel</span> <span class="n">os</span>/<span class="n">grub</span>.<span class="n">cfg</span> <span class="n">Makefile</span>
	-rm -rf build/iso
	mkdir -p build/iso/boot/grub
	cp build/kernel build/iso/
	cp os/grub.cfg build/iso/boot/grub/menu.lst
	cp /boot/grub/stage2_eltorito build/iso/boot/grub/
	mkisofs -R -b boot/grub/stage2_eltorito -no-emul-boot -boot-load-size <span class="m">4</span> -boot-info-table -o <span class="nv">$@</span> build/iso
</pre></div>
<p>If you paid attention, you'll notice that the JAR step requires a manifest at <tt>compiler/compiler.manifest</tt>. It only really marks it as runnable so that we can use it easily:
</p>
<div class="mw-highlight mw-highlight-lang-bash mw-content-ltr" dir="ltr"><pre><span></span>Main-Class: nl.combuster.minijava.Compiler
</pre></div>
<p>Lastly, the <a rel="nofollow" class="external text" href="http://forge.ow2.org/project/download.php?group_id=23&amp;file_id=20549">one library</a> our compiler uses to do most of its magic. You can just copy the source into the compiler folder and the build script will pick it up.
</p>
<!-- 
NewPP limit report
Cached time: 20250211123524
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc]
CPU time usage: 0.092 seconds
Real time usage: 1.316 seconds
Preprocessor visited node count: 185/1000000
Post‐expand include size: 372/2097152 bytes
Template argument size: 84/2097152 bytes
Highest expansion depth: 23/100
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 63081/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
110.96%    5.171      4 Template:If
100.00%    4.660      1 Template:Rating
100.00%    4.660      1 -total
 97.25%    4.532      4 Template:Show1
 22.62%    1.054      4 Template:Eq
 10.72%    0.500      4 Template:Eq1
-->

<!-- Saved in parser cache with key wikidb:pcache:idhash:3849-0!canonical and timestamp 20250211123522 and revision id 28229.
 -->
</div>
<div class="printfooter" data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.osdev.org/index.php?title=Java_Primer&amp;oldid=28229">https://wiki.osdev.org/index.php?title=Java_Primer&amp;oldid=28229</a>"</div></div>
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="./Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="https://wiki.osdev.org/index.php?title=Category:Pages_using_duplicate_arguments_in_template_calls&amp;action=edit&amp;redlink=1" class="new" title="Category:Pages using duplicate arguments in template calls (page does not exist)">Pages using duplicate arguments in template calls</a></li><li><a href="https://wiki.osdev.org/index.php?title=Category:Pages_using_deprecated_source_tags&amp;action=edit&amp;redlink=1" class="new" title="Category:Pages using deprecated source tags (page does not exist)">Pages using deprecated source tags</a></li><li><a href="./Category:Level_3_Tutorials" title="Category:Level 3 Tutorials">Level 3 Tutorials</a></li><li><a href="./Category:Tutorials" title="Category:Tutorials">Tutorials</a></li><li><a href="./Category:Compilers" title="Category:Compilers">Compilers</a></li><li><a href="./Category:Languages" title="Category:Languages">Languages</a></li><li><a href="https://wiki.osdev.org/index.php?title=Category:Java&amp;action=edit&amp;redlink=1" class="new" title="Category:Java (page does not exist)">Java</a></li></ul></div></div>
	</div>
</div>

<div id="mw-navigation">
	<h2>Navigation menu</h2>
	<div id="mw-head">
		

<nav id="p-personal" class="vector-menu mw-portlet mw-portlet-personal vector-user-menu-legacy" aria-labelledby="p-personal-label" role="navigation"  >
	<h3
		id="p-personal-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Personal tools</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="pt-login" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Special:UserLogin&amp;returnto=Java+Primer" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o"><span>Log in</span></a></li><li id="pt-darkmode" class="mw-list-item"><a href="Java_Primer#" class="ext-darkmode-link"><span>Dark mode</span></a></li></ul>
		
	</div>
</nav>

		<div id="left-navigation">
			

<nav id="p-namespaces" class="vector-menu mw-portlet mw-portlet-namespaces vector-menu-tabs vector-menu-tabs-legacy" aria-labelledby="p-namespaces-label" role="navigation"  >
	<h3
		id="p-namespaces-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Namespaces</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-nstab-main" class="selected mw-list-item"><a href="Java_Primer" title="View the content page [c]" accesskey="c"><span>Page</span></a></li><li id="ca-talk" class="new mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Talk:Java_Primer&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [t]" accesskey="t"><span>Discussion</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown" aria-labelledby="p-variants-label" role="navigation"  >
	<input type="checkbox"
		id="p-variants-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-variants"
		class="vector-menu-checkbox"
		aria-labelledby="p-variants-label"
	/>
	<label
		id="p-variants-label"
		 aria-label="Change language variant"
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

		</div>
		<div id="right-navigation">
			

<nav id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs vector-menu-tabs-legacy" aria-labelledby="p-views-label" role="navigation"  >
	<h3
		id="p-views-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Views</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-view" class="selected mw-list-item"><a href="Java_Primer"><span>Read</span></a></li><li id="ca-viewsource" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Java_Primer&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e"><span>View source</span></a></li><li id="ca-history" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Java_Primer&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown" aria-labelledby="p-cactions-label" role="navigation"  title="More options" >
	<input type="checkbox"
		id="p-cactions-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-cactions"
		class="vector-menu-checkbox"
		aria-labelledby="p-cactions-label"
	/>
	<label
		id="p-cactions-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<div>
			<h3 >
				<label for="searchInput">Search</label>
			</h3>
		<form action="https://wiki.osdev.org/index.php" id="searchform"
			class="vector-search-box-form">
			<div id="simpleSearch"
				class="vector-search-box-inner"
				 data-search-loc="header-navigation">
				<input class="vector-search-box-input"
					 type="search" name="search" placeholder="Search OSDev Wiki" aria-label="Search OSDev Wiki" autocapitalize="sentences" title="Search OSDev Wiki [f]" accesskey="f" id="searchInput"
				>
				<input type="hidden" name="title" value="Special:Search">
				<input id="mw-searchButton"
					 class="searchButton mw-fallbackSearchButton" type="submit" name="fulltext" title="Search the pages for this text" value="Search">
				<input id="searchButton"
					 class="searchButton" type="submit" name="go" title="Go to a page with this exact name if it exists" value="Go">
			</div>
		</form>
	</div>
</div>

		</div>
	</div>
	

<div id="mw-panel">
	<div id="p-logo" role="banner">
		<a class="mw-wiki-logo" href="index.html"
			title="Visit the main page"></a>
	</div>
	

<nav id="p-navigation" class="vector-menu mw-portlet mw-portlet-navigation vector-menu-portal portal" aria-labelledby="p-navigation-label" role="navigation"  >
	<h3
		id="p-navigation-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Navigation</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-mainpage" class="mw-list-item"><a href="index.html" title="Visit the main page [z]" accesskey="z"><span>Main Page</span></a></li><li id="n-portal" class="mw-list-item"><a href="http://forum.osdev.org/" rel="nofollow" title="About the project, what you can do, where to find things"><span>Forums</span></a></li><li id="n-FAQ" class="mw-list-item"><a href="./Category:FAQ"><span>FAQ</span></a></li><li id="n-OS-Projects" class="mw-list-item"><a href="Projects"><span>OS Projects</span></a></li><li id="n-randompage" class="mw-list-item"><a href="https://wiki.osdev.org/Special:Random" title="Load a random page [x]" accesskey="x"><span>Random page</span></a></li></ul>
		
	</div>
</nav>

	

<nav id="p-about" class="vector-menu mw-portlet mw-portlet-about vector-menu-portal portal" aria-labelledby="p-about-label" role="navigation"  >
	<h3
		id="p-about-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">About</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-This-site" class="mw-list-item"><a href="./OSDevWiki:About"><span>This site</span></a></li><li id="n-Joining" class="mw-list-item"><a href="./OSDevWiki:Joining"><span>Joining</span></a></li><li id="n-Editing-help" class="mw-list-item"><a href="./OSDevWiki:Editing"><span>Editing help</span></a></li><li id="n-recentchanges" class="mw-list-item"><a href="./Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r"><span>Recent changes</span></a></li></ul>
		
	</div>
</nav>


<nav id="p-tb" class="vector-menu mw-portlet mw-portlet-tb vector-menu-portal portal" aria-labelledby="p-tb-label" role="navigation"  >
	<h3
		id="p-tb-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Tools</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="t-whatlinkshere" class="mw-list-item"><a href="./Special:WhatLinksHere/Java_Primer" title="A list of all wiki pages that link here [j]" accesskey="j"><span>What links here</span></a></li><li id="t-recentchangeslinked" class="mw-list-item"><a href="https://wiki.osdev.org/Special:RecentChangesLinked/Java_Primer" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k"><span>Related changes</span></a></li><li id="t-specialpages" class="mw-list-item"><a href="./Special:SpecialPages" title="A list of all special pages [q]" accesskey="q"><span>Special pages</span></a></li><li id="t-print" class="mw-list-item"><a href="javascript:print();" rel="alternate" title="Printable version of this page [p]" accesskey="p"><span>Printable version</span></a></li><li id="t-permalink" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Java_Primer&amp;oldid=28229" title="Permanent link to this revision of this page"><span>Permanent link</span></a></li><li id="t-info" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Java_Primer&amp;action=info" title="More information about this page"><span>Page information</span></a></li></ul>
		
	</div>
</nav>

	
</div>

</div>

<footer id="footer" class="mw-footer" role="contentinfo" >
	<ul id="footer-info">
	<li id="footer-info-lastmod"> This page was last edited on 10 July 2023, at 20:34.</li>
	<li id="footer-info-0">This page has been accessed 3,318 times.</li>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="./OSDev_Wiki:Privacy_policy">Privacy policy</a></li>
	<li id="footer-places-about"><a href="./OSDev_Wiki:About">About OSDev Wiki</a></li>
	<li id="footer-places-disclaimer"><a href="./OSDev_Wiki:General_disclaimer">Disclaimers</a></li>
	<li id="footer-places-mobileview"><a href="https://wiki.osdev.org/index.php?title=Java_Primer&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"/></a></li>
</ul>

</footer>

<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.092","walltime":"1.316","ppvisitednodes":{"value":185,"limit":1000000},"postexpandincludesize":{"value":372,"limit":2097152},"templateargumentsize":{"value":84,"limit":2097152},"expansiondepth":{"value":23,"limit":100},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":63081,"limit":5000000},"timingprofile":["110.96%    5.171      4 Template:If","100.00%    4.660      1 Template:Rating","100.00%    4.660      1 -total"," 97.25%    4.532      4 Template:Show1"," 22.62%    1.054      4 Template:Eq"," 10.72%    0.500      4 Template:Eq1"]},"cachereport":{"timestamp":"20250211123524","ttl":86400,"transientcontent":false}}});mw.config.set({"wgBackendResponseTime":1413});});</script>
</body>
</html>