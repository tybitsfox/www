<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>CMake Build System - OSDev Wiki</title>
<script>document.documentElement.className="client-js";RLCONF={"wgBreakFrames":false,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"9b8200f9e7c371dee56cc424","wgCSPNonce":false,"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"CMake_Build_System","wgTitle":"CMake Build System","wgCurRevisionId":28241,"wgRevisionId":28241,"wgArticleId":3187,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Pages using duplicate arguments in template calls","Pages using deprecated source tags","Level 1 Tutorials","Build Tools","Tools"],"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgRelevantPageName":"CMake_Build_System","wgRelevantArticleId":3187,"wgIsProbablyEditable":false,
"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgMFDisplayWikibaseDescriptions":{"search":false,"nearby":false,"watchlist":false,"tagline":false},"wgVisualEditor":{"pageLanguageCode":"en","pageLanguageDir":"ltr","pageVariantFallbacks":"en"},"wgVector2022PreviewPages":[],"wgMediaViewerOnClick":true,"wgMediaViewerEnabledByDefault":true,"wgEditSubmitButtonLabelPublish":false};RLSTATE={"site.styles":"ready","user.styles":"ready","user":"ready","user.options":"loading","ext.pygments":"ready","skins.vector.styles.legacy":"ready","ext.visualEditor.desktopArticleTarget.noscript":"ready","ext.DarkMode.styles":"ready"};RLPAGEMODULES=["site","mediawiki.page.ready","mediawiki.toc","skins.vector.legacy.js","ext.visualEditor.desktopArticleTarget.init","ext.visualEditor.targetLoader","mmv.head","mmv.bootstrap.autostart","ext.DarkMode","ext.moderation.notify","ext.moderation.ve","ext.moderation.ajaxhook","ext.moderation.notify.desktop"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.implement("user.options@12s5i",function($,jQuery,require,module){mw.user.tokens.set({"patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});});});</script>
<link rel="stylesheet" href="https://wiki.osdev.org/load.php?lang=en&amp;modules=ext.DarkMode.styles%7Cext.pygments%7Cext.visualEditor.desktopArticleTarget.noscript%7Cskins.vector.styles.legacy&amp;only=styles&amp;skin=vector"/>
<script async="" src="https://wiki.osdev.org/load.php?lang=en&amp;modules=startup&amp;only=scripts&amp;raw=1&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="https://wiki.osdev.org/load.php?lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.39.7"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="viewport" content="width=1000"/>
<link rel="icon" href="favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="OSDev Wiki (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="api.php?action=rsd"/>
<link rel="alternate" type="application/atom+xml" title="OSDev Wiki Atom feed" href="https://wiki.osdev.org/index.php?title=Special:RecentChanges&amp;feed=atom"/>
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-CMake_Build_System rootpage-CMake_Build_System skin-vector action-view skin-vector-legacy vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled"><div id="mw-page-base" class="noprint"></div>
<div id="mw-head-base" class="noprint"></div>
<div id="content" class="mw-body" role="main">
	<a id="top"></a>
	<div id="siteNotice"></div>
	<div class="mw-indicators">
	</div>
	<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">CMake Build System</span></h1>
	<div id="bodyContent" class="vector-body">
		<div id="siteSub" class="noprint">From OSDev Wiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="CMake_Build_System#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="CMake_Build_System#searchInput">Jump to search</a>
		<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr"><div class="mw-parser-output"><table style="font-size:95%; line-height:1.5em; padding:0.25em; float:right; margin: 0 0 8px 15px; clear:right; border:1px solid #aaaaaa; background:#eee; text-align:center;;"><tbody><tr><th>Difficulty level</th></tr><tr><td><a href="./File:Difficulty_1.png" class="image"><img alt="Difficulty 1.png" src="images/d/d3/Difficulty_1.png" decoding="async" width="46" height="14" data-file-width="46" data-file-height="14" /></a><br />Beginner</td></tr></tbody></table>
<p>CMake is a cross-platform, multi-environment build system which can remove some of the headache from building your operating system. The aim of this page is to help the reader set up his or her build environment to use CMake.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="CMake_Build_System#About_CMake"><span class="tocnumber">1</span> <span class="toctext">About CMake</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="CMake_Build_System#Who_uses_CMake?"><span class="tocnumber">1.1</span> <span class="toctext">Who uses CMake?</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-3"><a href="CMake_Build_System#Getting_Started"><span class="tocnumber">2</span> <span class="toctext">Getting Started</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="CMake_Build_System#Design_Considerations"><span class="tocnumber">2.1</span> <span class="toctext">Design Considerations</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="CMake_Build_System#A_Simple_CMakeLists.txt"><span class="tocnumber">2.2</span> <span class="toctext">A Simple CMakeLists.txt</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="CMake_Build_System#Sub-Project_Isolation"><span class="tocnumber">2.3</span> <span class="toctext">Sub-Project Isolation</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-7"><a href="CMake_Build_System#Applying_CMake_to_your_Operating_System"><span class="tocnumber">3</span> <span class="toctext">Applying CMake to your Operating System</span></a>
<ul>
<li class="toclevel-2 tocsection-8"><a href="CMake_Build_System#Building_Assembly_Code"><span class="tocnumber">3.1</span> <span class="toctext">Building Assembly Code</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="CMake_Build_System#Setting_Appropriate_Build_Options"><span class="tocnumber">3.2</span> <span class="toctext">Setting Appropriate Build Options</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="CMake_Build_System#Build_Profile_Detection"><span class="tocnumber">3.3</span> <span class="toctext">Build Profile Detection</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-11"><a href="CMake_Build_System#See_Also"><span class="tocnumber">4</span> <span class="toctext">See Also</span></a>
<ul>
<li class="toclevel-2 tocsection-12"><a href="CMake_Build_System#Articles"><span class="tocnumber">4.1</span> <span class="toctext">Articles</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="CMake_Build_System#External_Links"><span class="tocnumber">4.2</span> <span class="toctext">External Links</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="About_CMake">About CMake</span></h2>
<p>CMake is makefile generator that allows you to provide a description of your build environment, therefore affording the creation of toolchain-specific build files. It is an open-source project that is largely maintained by KitWare, Inc.
</p>
<h3><span id="Who_uses_CMake.3F"></span><span class="mw-headline" id="Who_uses_CMake?">Who uses CMake?</span></h3>
<p>Because CMake was developed by KitWare, it is closely associated with their software. However, momentum for CMake has steadily been increasing, and some fairly high-profile projects have switched over to it, including:
</p>
<ul><li>The K Desktop Environment</li>
<li>Second Life</li>
<li>Apache QPid</li>
<li>ReactOS</li></ul>
<h2><span class="mw-headline" id="Getting_Started">Getting Started</span></h2>
<h3><span class="mw-headline" id="Design_Considerations">Design Considerations</span></h3>
<p>There are a variety of options at your disposal when you design your CMake project. It is possible to have CMake cater to some of your personal build preferences, and as a result, you should probably ask yourself a few questions:
</p>
<ul><li>Will my build be performed in-source or out-of-source?</li>
<li>How granular is the project? Will there be a bunch of small components I plan to link together?</li>
<li>What prerequisites am I considering for my build?</li>
<li>Will I be generating any code from templates?</li></ul>
<p>The first question is largely one of preference. An <i>in-source</i> build means that the build output will be placed in the same directory as the project. This might be the root directory of the project or (assuming a heirarchical organization) subdirectories associated with the unit being compiled. However, the generated files mingling with sources can be an annoyance, especially when using version-control systems (CMake does not have a <code>cmake clean</code> command). Some people prefer to send the build output to a separate folder, perhaps named "build", or even multiple directories for debug and release builds. This sort of design is called an <i>out-of-source</i> build, and can make building for multiple targets easier and more flexible for all but the simplest projects.
</p><p>Project directory structure is also worth strong consideration. In a quick academic exercise, a flat single-directory layout may be desirable. However, if you plan to go beyond this stage, it may be a good idea to consider leveraging the filesystem to your advantage. Consider the following layout, for instance:
</p>
<pre>src
|
+----+ kernel
|    |
|    +----+ i386
|    |    |
|    |    +---- pc
|    |
|    +----+ arm
|         |
|         +---- rasberrypi
|         +---- beagle
|
+----+ libc
     |
     +---- ...
</pre>
<p>The above might be the natural way of organizing your source code and we can leverage a directory structure like this to our advantage. Consider the following advantages for this directory tree:
</p>
<ul><li>Sub-projects are neatly isolated from one another. Kernel and libc are definitely related, but we might prefer to think of them as separate projects.</li>
<li>ISA-dependent code can be isolated from common code or other ISA-dependent code.</li>
<li>Platform-dependent code (which may add further restrictions to ISA-dependent code) is separated from other platforms sharing the same ISA.</li></ul>
<p>The chances are that if you're building an operating system, you won't have many library dependencies. Most of your dependencies will be related to the toolchain required to build the code. For instance, you will probably want a C compiler, and almost certainly an assembler to go with it. You may write your own tools to simplify the process of creating your operating system, and in that case, you may want to ensure support for other programming environments like Python or Perl. Fortunately, this part can be fairly forgiving: adding dependencies such as these is not terribly difficult, and if you change your mind, the change is easy to implement.
</p>
<h3><span class="mw-headline" id="A_Simple_CMakeLists.txt">A Simple CMakeLists.txt</span></h3>
<p>One of the nice things about CMake is that it affords you several programming concepts that you are already familiar with. As one would expect, CMake lets you perform build configuration through variables, which are typically defined in user-provided files named CMakeLists.txt. The resulting values of these variables, after cmake processing, can conveniently be found in a file called CMakeCache.txt. CMakeCache.txt is generated when you first run CMake on a CMakeLists.txt file and can be tweaked to provide various special build options for your script. However, the preferred method is to use the <code>SET()</code> macro (and other macros) in a CMakeLists.txt file, which defines a variable name with its first argument and the variable's value using the rest of the argument(s).
</p><p>Of course, variables aren't really enough, so CMake provides two kinds of procedures: macros and functions. Functions and macros are very subtly different: functions create their own environment so the variables defined in a function are limited to the scope of the callee and below by default. Macros, on the other hand, will place any variables defined within the macro in the parent's environment. The bulk of CMake is implemented using functions and macros; this permits code reuse that is far superior to the targets provided by make. Note that some of these builtin commands will automatically SET variables on our behalf. This is particularly useful when we want to deal with dependency resolution.
</p><p>A useable CMakeLists.txt can have as little as two lines as code. One of the most important families of macros include <code>ADD_EXECUTABLE()</code> or <code>ADD_LIBRARY()</code>.
Each of these macros take several parameters: the target name as the first parameter and the source file(s) on which the target depends on as the remaining parameter(s).
</p><p>The <code>CMAKE_MINIMUM_REQUIRED()</code> function, which takes the version of CMake necessary to parse the CMakeList.txt file is also required, because that is how CMake can tell whether or not it meets the requirements to parse your script.
</p><p>However, such a script has a key disadvantage: every time we add a new source file, we need to edit CMakeLists.txt to add it. Fortunately, CMake comes with a built in file manipulation interface. In this case, we could use the GLOB operator for the <code>FILE()</code> command, which lets us specify a file globbing pattern to collect all of our source files or file paths into one variable. The addition of this extra line of code can make CMake much more useful.
</p><p>If you have dependencies you need to resolve, CMake can handle that too. The <code>FIND_PACKAGE()</code> command can handle a variety of different types of dependencies, including libraries (like Boost). <code>FIND_PACKAGE()</code> will also attempt to locate a script by the name of <code>Find<i>&lt;1st param&gt;</i>.cmake</code> and handle it appropriately. In instances where <code>FIND_PACKAGE()</code> is unable to resolve the package, it sets a special variable called <code><i>&lt;1st param&gt;</i>_NOTFOUND</code>, which you might use to detect optional dependencies. However, if a dependency is absolutely required, then you can simply supply <code>REQUIRED</code> as the second parameter. Failing to find the package will cause CMake to bail out.
</p><p>You can emit messages back to the console using the <code>MESSAGE()</code> command. Note that this is only run at CMake time. You can use this command for debugging your CMake project. Alternately, if you supply <code>STATUS</code> as the first parameter to this command, it will print out a specialized status message for you.
</p>
<div class="mw-highlight mw-highlight-lang-cmake mw-content-ltr" dir="ltr"><pre><span></span><span class="c"># So CMake can tell whether or not it can process this file</span>
<span class="nb">CMAKE_MINIMUM_REQUIRED</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">2.8.0</span><span class="p">)</span>

<span class="c"># Require Perl (for whatever reason)</span>
<span class="nb">FIND_PACKAGE</span><span class="p">(</span><span class="s">PERL</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>

<span class="nb">MESSAGE</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Hi!&quot;</span><span class="p">)</span>

<span class="c"># Grab all of the C files in src; store in C_SRCS</span>
<span class="nb">FILE</span><span class="p">(</span><span class="s">GLOB</span><span class="w"> </span><span class="s">C_SRCS</span><span class="w"> </span><span class="s">src/*.c</span><span class="p">)</span>

<span class="c"># Note how we obtain this variable&#39;s value!</span>
<span class="nb">ADD_EXECUTABLE</span><span class="p">(</span><span class="s">foo</span><span class="w"> </span><span class="o">${</span><span class="nv">C_SRCS</span><span class="o">}</span><span class="p">)</span>
</pre></div>
<p>This is enough for a small project to generate an executable. Creating the associated Makefile and starting the build is simple:
</p>
<pre>$ cd project/
$ mkdir build
$ cd build/
$ cmake ../
$ make
</pre>
<p>Note that if you chance CMakeLists.txt, you will need to run CMake again. In cases like these, CMake may need to update CMakeCache.txt, for instance. Particularly in the case where you use file globbing find your source files, it is imperative that you do this when you add or delete source files; otherwise, CMake will not pick up the changes, and havoc will break loose.
</p>
<h3><span class="mw-headline" id="Sub-Project_Isolation">Sub-Project Isolation</span></h3>
<p>The previous section discussed a sort of "Hello World" implementation of CMakeLists.txt. Unfortunately, operating system development is rarely in the same class as "Hello World", and the chances are that you have advanced beyond intro computer science. If you're reading this, you more than likely have an idea of how you want to structure your project, and that probably means breaking it into manageable pieces. If you followed the advice from <a href="CMake_Build_System#Design_Considerations">Design Considerations</a>, then it is very likely that you have thought about this a great deal. The real question is how to put this into practice.
</p><p>A common approach involves generating custom build scripts for each sub-project you create. Thus, we have a separate CMakeLists.txt for each sub-project we create, and we link them together in the CMakeLists.txt in the project root. If we adhere to our filesystem layout from above, for instance, we'd have 3 CMakeLists.txt files: one in /, one in /src/kernel, and one in /src/libc. We can link them together with the following:
</p>
<div class="mw-highlight mw-highlight-lang-cmake mw-content-ltr" dir="ltr"><pre><span></span><span class="nb">ADD_SUBDIRECTORY</span><span class="p">(</span><span class="s">src/kernel</span><span class="p">)</span>
<span class="nb">ADD_SUBDIRECTORY</span><span class="p">(</span><span class="s">src/libc</span><span class="p">)</span>
</pre></div>
<p>Using the <code>ADD_SUBDIRECTORY()</code> command is analagous to recursively calling make, and in many cases, this is precisely what happens. Other generators may interpret this command differently: for instance, the MSVC generator might decide to turn these directories into multiple projects within a solution. In either case, the child CMakeLists.txt inherits the environment of the parent so variables are propagated. You can use this to your advantage by doing dependency resolution and setting up critical shared variables in the root CMakeLists.txt file.
</p><p>Alternately, you can leverage the <code>INCLUDE()</code> command to directly insert CMake code into your CMakeLists.txt file at its point of invocation, which can be useful for important small snippets of code into your project. Note that there are some subtle differences between <code>INCLUDE()</code> and <code>ADD_SUBDIRECTORY()</code>:
</p>
<ul><li>You can use <code>INCLUDE()</code> to include any file as CMake code. <code>ADD_SUBDIRECTORY()</code> expects a CMakeLists.txt file in the directory you point it at.</li>
<li><code>INCLUDE()</code> operates from the current working directory. <code>ADD_SUBDIRECTORY()</code> will change the current working directory to the supplied path before evaluating.</li></ul>
<h2><span class="mw-headline" id="Applying_CMake_to_your_Operating_System">Applying CMake to your Operating System</span></h2>
<h3><span class="mw-headline" id="Building_Assembly_Code">Building Assembly Code</span></h3>
<p>Unless you intend to use somebody else's kernel and write your operating system completely from portable code, it is very likely that you will need an assembler. For the kinds of projects that CMake was designed for, this rarely comes up; as an operating system designer, such support is probably critical to your project. Fortunately, some work has been done to address this issue and in most cases you can get away with not only detecting an assembler, but even specifying the syntax it uses. By using the <code>ENABLE_LANGUAGE()</code> command it is possible to turn on support for assembly:
</p>
<div class="mw-highlight mw-highlight-lang-cmake mw-content-ltr" dir="ltr"><pre><span></span><span class="c"># We want an AT&amp;T Syntax Assembler</span>
<span class="nb">ENABLE_LANGUAGE</span><span class="p">(</span><span class="s">ASM-ATT</span><span class="p">)</span>

<span class="nb">ADD_EXECUTABLE</span><span class="p">(</span><span class="s">foo</span><span class="w"> </span><span class="s">bar.s</span><span class="w"> </span><span class="s">baz.s</span><span class="p">)</span>
</pre></div>
<h3><span class="mw-headline" id="Setting_Appropriate_Build_Options">Setting Appropriate Build Options</span></h3>
<p>Depending on your project the stock compiler options may be insufficient for your needs. You may need to supply switches to your toolchain that affect linking or object assembly. CMake provides a number of ways of doing this:
</p>
<ul><li>For C programs, you can use <code>CMAKE_C_FLAGS</code> in the same way you would use <code>$CFLAGS</code> in the context of make. <code>ADD_DEFINITIONS()</code> can also be used, but it is probably inadvisable to do so since a C flag variable exists by default.</li>
<li>For other languages, (including assembly) use <code>CMAKE_<i>&lt;lang&gt;</i>_COMPILE_OBJECT</code>. For instance, if ASM-ATT is enabled, one would modify <code>CMAKE_ASM-ATT_COMPILE_OJBECT</code>.</li>
<li>Link-time options can be set using <code>SET_TARGET_FLAGS(<i>target</i> PROPERTIES LINK_FLAGS "<i>flags</i>")</code>.</li></ul>
<h3><span class="mw-headline" id="Build_Profile_Detection">Build Profile Detection</span></h3>
<p>Remember how we made the claim that the directory structure could be leveraged in order to help make our lives easier? You might have gotten some idea from the directory structure of how this might be accomplished, at least on a conceptual level. Consider the example provided by <i>src/kernel</i>. Here, we have a well-defined hierarchy which allows us to narrow down on varying scopes of the actual kernel implementation. We can split our code into three directories, such that:
</p>
<ul><li><code>/src/kernel/</code> contains the code for the kernel. (platform-indepdendent code might go into this directory).</li>
<li><code>/src/kernel/isa/</code> contains code specifically for the instruction set architecture <i>isa</i> (e.g., i386).</li>
<li><code>/src/kernel/isa/platform/</code> contains code for the <i>platform</i> which is implemented with <i>isa</i>.</li></ul>
<p>Let's consider the ARM branch of our code. While the i386 may see limited usage outside of IBM-compatible PCs, the ARM conversely is found in a number of environments. Many of those environments have their own quirks, such as how the memory bus is physically mapped. Will the kernel binary for a BeagleBone run on a Raspberry Pi? It is possible, but unlikely. Even if it did, what if these two platforms are fundamentally incompatible at some level? We need to take that into consideration. What we need is a macro that does all of the dirty work for us.
</p><p>We can take two approaches to this problem: we can either make the assumption platforms (and ISAs for that matter) share some things in common, or make the assumption that they don't. In the former approach, we might assume that the following is true of platforms:
</p>
<ul><li>Each platform provides a memory layout via a linker script.</li>
<li>Each platform provides a CMake file describing its own build flags.</li>
<li>Each platform provides a number of C or Assembly sources.</li></ul>
<p>And likewise, we might say that each ISA provides:
</p>
<ul><li>A CMake file describing its own build flags.</li>
<li>A number of C or Assembly sources.</li></ul>
<p>So far, so good. We can approach this by writing a function in order to handle loading the right profile. When you write a function, you delimit the function body between the <code>FUNCTION()</code> and <code>ENDFUNCTION()</code> commands. The first parameter to <code>FUNCTION()</code> shall be the name of the function you are defining, and those remaining are formal parameters to the function. 
</p><p>However, there is a slight problem: we need a way to report our findings to the caller. Remember that variables defined in functions go out of scope as soon as the function ends. We could use a macro here at the risk of polluting the namespace but it would be much better if we could export variables to the parent scope. Fortunately, the <code>SET()</code> command accepts <code>PARENT_SCOPE</code> as an optional parameter. When this is used, it means that the variable being set should become part of the parent's environment. Let's write a small build profile function now:
</p>
<div class="mw-highlight mw-highlight-lang-cmake mw-content-ltr" dir="ltr"><pre><span></span><span class="nb">FUNCTION</span><span class="p">(</span><span class="s">LOAD_PROFILE</span><span class="w"> </span><span class="s">ISA</span><span class="w"> </span><span class="s">PLATFORM</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Obtain sources for the ISA</span>
<span class="w">  </span><span class="nb">FILE</span><span class="p">(</span><span class="s">GLOB</span><span class="w"> </span><span class="s">ISA_SRCS</span><span class="w"> </span><span class="s2">&quot;${ISA}/*.c&quot;</span><span class="w"> </span><span class="s2">&quot;${ISA}/*.s&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">FILE</span><span class="p">(</span><span class="s">GLOB</span><span class="w"> </span><span class="s">PLATFORM_SRCS</span><span class="w"> </span><span class="s2">&quot;${ISA}/${PLATFORM}/*.c&quot;</span><span class="w"> </span><span class="s2">&quot;${ISA}/${PLATFORM}/*.s&quot;</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="c"># Load flags associated with ISA and Profile</span>
<span class="w">  </span><span class="nb">INCLUDE</span><span class="p">(</span><span class="s2">&quot;${ISA}/flags.cmake&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">INCLUDE</span><span class="p">(</span><span class="s2">&quot;${ISA}/${PLATFORM}/flags.cmake&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Now export our output variables</span>
<span class="w">  </span><span class="nb">SET</span><span class="p">(</span><span class="s">ISA_SRCS</span><span class="w"> </span><span class="o">${</span><span class="nv">ISA_SRCS</span><span class="o">}</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">  </span><span class="nb">SET</span><span class="p">(</span><span class="s">PLATFORM_SRCS</span><span class="w"> </span><span class="o">${</span><span class="nv">PLATFORM_SRCS</span><span class="o">}</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">  </span><span class="nb">SET</span><span class="p">(</span><span class="s">PLATFORM_LAYOUT</span><span class="w"> </span><span class="s2">&quot;${ISA}/${PLATFORM}/layout.ld&quot;</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>

<span class="w">  </span><span class="c"># And specific flags</span>
<span class="w">  </span><span class="nb">SET</span><span class="p">(</span><span class="s">ISA_C_FLAGS</span><span class="w"> </span><span class="o">${</span><span class="nv">ISA_C_FLAGS</span><span class="o">}</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">  </span><span class="nb">SET</span><span class="p">(</span><span class="s">ISA_ASM_FLAGS</span><span class="w"> </span><span class="o">${</span><span class="nv">ISA_ASM_FLAGS</span><span class="o">}</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">ENDFUNCTION</span><span class="p">(</span><span class="s">LOAD_PROFILE</span><span class="p">)</span>
</pre></div>
<p>Now, all we have to do is call <code>LOAD_PROFILE()</code> with the provided parameters, and we should be able to set up our build environment in a sane manner:
</p>
<div class="mw-highlight mw-highlight-lang-cmake mw-content-ltr" dir="ltr"><pre><span></span><span class="nb">FILE</span><span class="p">(</span><span class="s">GLOB</span><span class="w"> </span><span class="s">GENERIC_SRCS</span><span class="w"> </span><span class="s2">&quot;*.c&quot;</span><span class="p">)</span>

<span class="c"># We could also use CMakeCache variables here!</span>
<span class="nb">LOAD_PROFILE</span><span class="p">(</span><span class="s2">&quot;arm&quot;</span><span class="w"> </span><span class="s2">&quot;raspberrypi&quot;</span><span class="p">)</span>


<span class="c"># Now set up our environment</span>
<span class="nb">ADD_EXECUTABLE</span><span class="p">(</span><span class="s">kernel</span><span class="w"> </span><span class="o">${</span><span class="nv">PLATFORM_SRCS</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ISA_SRCS</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">GENERIC_SRCS</span><span class="o">}</span><span class="p">)</span>

<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_ASM-ATT_COMPILE_OBJECT</span><span class="w"> </span>
<span class="w">  </span><span class="s2">&quot;&lt;CMAKE_ASM-ATT_COMPILER&gt; ${ISA_ASM_FLAGS} ${PLATFORM_ASM_FLAGS} -o &lt;OBJECT&gt; &lt;SOURCE&gt;&quot;</span><span class="p">)</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_C_FLAGS</span><span class="w"> </span><span class="s2">&quot;${ISA_C_FLAGS} ${PLATFORM_C_FLAGS}&quot;</span><span class="p">)</span>
<span class="nb">SET_TARGET_PROPERTIES</span><span class="p">(</span><span class="s">kernel</span><span class="w"> </span><span class="s">PROPERTIES</span><span class="w"> </span><span class="s">LINK_FLAGS</span><span class="w"> </span>
<span class="w">  </span><span class="s2">&quot;-T ${PLATFORM_LAYOUT} -N ${ISA_LINKER_FLAGS} ${PLATFORM_LINKER_FLAGS}&quot;</span><span class="p">)</span>
</pre></div>
<p>Here, we make a reasonable attempt to control the build order, but the truth is, we don't really know exactly what that order should be; it might
be dependent on the platform. For instance, for i386/pc, we might want a multiboot header, which must come within the first 8K of the kernel image. In that case, we must somehow control the ordering. We could have a place <code>FIRST_SRCS()</code> variable present in the platform flags, then use the following loop to extract it from the list:
</p>
<div class="mw-highlight mw-highlight-lang-cmake mw-content-ltr" dir="ltr"><pre><span></span><span class="nb">FOREACH</span><span class="p">(</span><span class="s">I</span><span class="w"> </span><span class="o">${</span><span class="nv">FIRST_SRCS</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Assume path is relative to src/kernel</span>
<span class="w">  </span><span class="nb">LIST</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">TMP_FIRST_SRCS</span><span class="w"> </span><span class="s2">&quot;${CMAKE_CURRENT_LIST_DIR}/${I}&quot;</span>
<span class="s">ENDFOREACH(I</span><span class="p">)</span>

<span class="c"># Now remove any trace of these files from the other lists</span>
<span class="nb">LIST</span><span class="p">(</span><span class="s">REMOVE_ITEM</span><span class="w"> </span><span class="s">ISA_SRCS</span><span class="w"> </span><span class="o">${</span><span class="nv">TMP_FIRST_SRCS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">LIST</span><span class="p">(</span><span class="s">REMOVE_ITEM</span><span class="w"> </span><span class="s">PLATFORM_SRCS</span><span class="w"> </span><span class="o">${</span><span class="nv">TMP_FIRST_SRCS</span><span class="o">}</span><span class="p">)</span>

<span class="c"># During exports:</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">FIRST_SRCS</span><span class="w"> </span><span class="o">${</span><span class="nv">TMP_FIRST_SRCS</span><span class="o">}</span><span class="p">)</span>
</pre></div>
<p>Now, all we have to do is put <code>${FIRST_SRCS}</code> at the head of the list, and we can control the order in which our code is linked.
</p>
<h2><span class="mw-headline" id="See_Also">See Also</span></h2>
<h3><span class="mw-headline" id="Articles">Articles</span></h3>
<ul><li><a href="Makefile" title="Makefile">Makefile</a> - One potential target for CMake. The tried and true method of build management.</li></ul>
<h3><span class="mw-headline" id="External_Links">External Links</span></h3>
<ul><li><a rel="nofollow" class="external text" href="http://www.cmake.org">CMake Offical Page</a> - Contains useful links, including how to download and documentation.</li>
<li><a rel="nofollow" class="external text" href="http://www.cmake.org/Wiki/CMake_Useful_Variables">CMake Useful Variables</a> - Gives names and descriptions of common and useful variables used in CMake.</li>
<li><a rel="nofollow" class="external text" href="http://www.cmake.org/cmake/help/v3.2">CMake Official Documentation</a> - Official documentation all about CMake.</li>
<li><a rel="nofollow" class="external text" href="http://www.cmake.org/Wiki/CMake/Examples">CMake Examples</a> - Examples showing how to perform many common CMake procedures.</li></ul>
<!-- 
NewPP limit report
Cached time: 20250212011008
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc]
CPU time usage: 0.048 seconds
Real time usage: 0.829 seconds
Preprocessor visited node count: 144/1000000
Post‐expand include size: 340/2097152 bytes
Template argument size: 44/2097152 bytes
Highest expansion depth: 15/100
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 9738/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    3.748      1 Template:Rating
100.00%    3.748      1 -total
 84.45%    3.165      2 Template:If
 68.59%    2.571      2 Template:Show1
 22.65%    0.849      2 Template:Eq
 11.02%    0.413      2 Template:Eq1
-->

<!-- Saved in parser cache with key wikidb:pcache:idhash:3187-0!canonical and timestamp 20250212011007 and revision id 28241.
 -->
</div>
<div class="printfooter" data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.osdev.org/index.php?title=CMake_Build_System&amp;oldid=28241">https://wiki.osdev.org/index.php?title=CMake_Build_System&amp;oldid=28241</a>"</div></div>
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="./Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="https://wiki.osdev.org/index.php?title=Category:Pages_using_duplicate_arguments_in_template_calls&amp;action=edit&amp;redlink=1" class="new" title="Category:Pages using duplicate arguments in template calls (page does not exist)">Pages using duplicate arguments in template calls</a></li><li><a href="https://wiki.osdev.org/index.php?title=Category:Pages_using_deprecated_source_tags&amp;action=edit&amp;redlink=1" class="new" title="Category:Pages using deprecated source tags (page does not exist)">Pages using deprecated source tags</a></li><li><a href="./Category:Level_1_Tutorials" title="Category:Level 1 Tutorials">Level 1 Tutorials</a></li><li><a href="./Category:Build_Tools" title="Category:Build Tools">Build Tools</a></li><li><a href="./Category:Tools" title="Category:Tools">Tools</a></li></ul></div></div>
	</div>
</div>

<div id="mw-navigation">
	<h2>Navigation menu</h2>
	<div id="mw-head">
		

<nav id="p-personal" class="vector-menu mw-portlet mw-portlet-personal vector-user-menu-legacy" aria-labelledby="p-personal-label" role="navigation"  >
	<h3
		id="p-personal-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Personal tools</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="pt-login" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Special:UserLogin&amp;returnto=CMake+Build+System" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o"><span>Log in</span></a></li><li id="pt-darkmode" class="mw-list-item"><a href="CMake_Build_System#" class="ext-darkmode-link"><span>Dark mode</span></a></li></ul>
		
	</div>
</nav>

		<div id="left-navigation">
			

<nav id="p-namespaces" class="vector-menu mw-portlet mw-portlet-namespaces vector-menu-tabs vector-menu-tabs-legacy" aria-labelledby="p-namespaces-label" role="navigation"  >
	<h3
		id="p-namespaces-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Namespaces</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-nstab-main" class="selected mw-list-item"><a href="CMake_Build_System" title="View the content page [c]" accesskey="c"><span>Page</span></a></li><li id="ca-talk" class="new mw-list-item"><a href="https://wiki.osdev.org/index.php?title=Talk:CMake_Build_System&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [t]" accesskey="t"><span>Discussion</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown" aria-labelledby="p-variants-label" role="navigation"  >
	<input type="checkbox"
		id="p-variants-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-variants"
		class="vector-menu-checkbox"
		aria-labelledby="p-variants-label"
	/>
	<label
		id="p-variants-label"
		 aria-label="Change language variant"
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

		</div>
		<div id="right-navigation">
			

<nav id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs vector-menu-tabs-legacy" aria-labelledby="p-views-label" role="navigation"  >
	<h3
		id="p-views-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Views</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-view" class="selected mw-list-item"><a href="CMake_Build_System"><span>Read</span></a></li><li id="ca-viewsource" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=CMake_Build_System&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e"><span>View source</span></a></li><li id="ca-history" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=CMake_Build_System&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown" aria-labelledby="p-cactions-label" role="navigation"  title="More options" >
	<input type="checkbox"
		id="p-cactions-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-cactions"
		class="vector-menu-checkbox"
		aria-labelledby="p-cactions-label"
	/>
	<label
		id="p-cactions-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<div>
			<h3 >
				<label for="searchInput">Search</label>
			</h3>
		<form action="https://wiki.osdev.org/index.php" id="searchform"
			class="vector-search-box-form">
			<div id="simpleSearch"
				class="vector-search-box-inner"
				 data-search-loc="header-navigation">
				<input class="vector-search-box-input"
					 type="search" name="search" placeholder="Search OSDev Wiki" aria-label="Search OSDev Wiki" autocapitalize="sentences" title="Search OSDev Wiki [f]" accesskey="f" id="searchInput"
				>
				<input type="hidden" name="title" value="Special:Search">
				<input id="mw-searchButton"
					 class="searchButton mw-fallbackSearchButton" type="submit" name="fulltext" title="Search the pages for this text" value="Search">
				<input id="searchButton"
					 class="searchButton" type="submit" name="go" title="Go to a page with this exact name if it exists" value="Go">
			</div>
		</form>
	</div>
</div>

		</div>
	</div>
	

<div id="mw-panel">
	<div id="p-logo" role="banner">
		<a class="mw-wiki-logo" href="index.html"
			title="Visit the main page"></a>
	</div>
	

<nav id="p-navigation" class="vector-menu mw-portlet mw-portlet-navigation vector-menu-portal portal" aria-labelledby="p-navigation-label" role="navigation"  >
	<h3
		id="p-navigation-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Navigation</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-mainpage" class="mw-list-item"><a href="index.html" title="Visit the main page [z]" accesskey="z"><span>Main Page</span></a></li><li id="n-portal" class="mw-list-item"><a href="http://forum.osdev.org/" rel="nofollow" title="About the project, what you can do, where to find things"><span>Forums</span></a></li><li id="n-FAQ" class="mw-list-item"><a href="./Category:FAQ"><span>FAQ</span></a></li><li id="n-OS-Projects" class="mw-list-item"><a href="Projects"><span>OS Projects</span></a></li><li id="n-randompage" class="mw-list-item"><a href="https://wiki.osdev.org/Special:Random" title="Load a random page [x]" accesskey="x"><span>Random page</span></a></li></ul>
		
	</div>
</nav>

	

<nav id="p-about" class="vector-menu mw-portlet mw-portlet-about vector-menu-portal portal" aria-labelledby="p-about-label" role="navigation"  >
	<h3
		id="p-about-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">About</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-This-site" class="mw-list-item"><a href="./OSDevWiki:About"><span>This site</span></a></li><li id="n-Joining" class="mw-list-item"><a href="./OSDevWiki:Joining"><span>Joining</span></a></li><li id="n-Editing-help" class="mw-list-item"><a href="./OSDevWiki:Editing"><span>Editing help</span></a></li><li id="n-recentchanges" class="mw-list-item"><a href="./Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r"><span>Recent changes</span></a></li></ul>
		
	</div>
</nav>


<nav id="p-tb" class="vector-menu mw-portlet mw-portlet-tb vector-menu-portal portal" aria-labelledby="p-tb-label" role="navigation"  >
	<h3
		id="p-tb-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Tools</span>
	</h3>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="t-whatlinkshere" class="mw-list-item"><a href="./Special:WhatLinksHere/CMake_Build_System" title="A list of all wiki pages that link here [j]" accesskey="j"><span>What links here</span></a></li><li id="t-recentchangeslinked" class="mw-list-item"><a href="https://wiki.osdev.org/Special:RecentChangesLinked/CMake_Build_System" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k"><span>Related changes</span></a></li><li id="t-specialpages" class="mw-list-item"><a href="./Special:SpecialPages" title="A list of all special pages [q]" accesskey="q"><span>Special pages</span></a></li><li id="t-print" class="mw-list-item"><a href="javascript:print();" rel="alternate" title="Printable version of this page [p]" accesskey="p"><span>Printable version</span></a></li><li id="t-permalink" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=CMake_Build_System&amp;oldid=28241" title="Permanent link to this revision of this page"><span>Permanent link</span></a></li><li id="t-info" class="mw-list-item"><a href="https://wiki.osdev.org/index.php?title=CMake_Build_System&amp;action=info" title="More information about this page"><span>Page information</span></a></li></ul>
		
	</div>
</nav>

	
</div>

</div>

<footer id="footer" class="mw-footer" role="contentinfo" >
	<ul id="footer-info">
	<li id="footer-info-lastmod"> This page was last edited on 10 July 2023, at 23:28.</li>
	<li id="footer-info-0">This page has been accessed 2,755 times.</li>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="./OSDev_Wiki:Privacy_policy">Privacy policy</a></li>
	<li id="footer-places-about"><a href="./OSDev_Wiki:About">About OSDev Wiki</a></li>
	<li id="footer-places-disclaimer"><a href="./OSDev_Wiki:General_disclaimer">Disclaimers</a></li>
	<li id="footer-places-mobileview"><a href="https://wiki.osdev.org/index.php?title=CMake_Build_System&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"/></a></li>
</ul>

</footer>

<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.048","walltime":"0.829","ppvisitednodes":{"value":144,"limit":1000000},"postexpandincludesize":{"value":340,"limit":2097152},"templateargumentsize":{"value":44,"limit":2097152},"expansiondepth":{"value":15,"limit":100},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":9738,"limit":5000000},"timingprofile":["100.00%    3.748      1 Template:Rating","100.00%    3.748      1 -total"," 84.45%    3.165      2 Template:If"," 68.59%    2.571      2 Template:Show1"," 22.65%    0.849      2 Template:Eq"," 11.02%    0.413      2 Template:Eq1"]},"cachereport":{"timestamp":"20250212011008","ttl":86400,"transientcontent":false}}});mw.config.set({"wgBackendResponseTime":926});});</script>
</body>
</html>